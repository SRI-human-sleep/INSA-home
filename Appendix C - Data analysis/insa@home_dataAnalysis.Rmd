---
title: "Wearable and mobile technology to characterize daily patterns of sleep, stress, pre-sleep worry and mood in adolescent insomnia - Appendix C: Data analysis code and output"
author: "Luca Menghini, PhD, Dilara Yüksel, PhD, Devin Prouty, PhD, Fiona C Baker PhD, Christopher King, PhD, Massimiliano de Zambotti, PhD"
bibliography: [packagesAn.bib]
nocite: '@*'
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
    css: styles.css
  pdf_document: default
  word_document: default
  theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

# Aims and content

The present document includes the analytical steps implemented to characterize and explore the antecedents of sleep patterns in a sample of older adolescents with (N = 47; 31 girls) and without (N = 46; 28 girls) DSM-5 insomnia.

The data processing pipeline is available from https://sri-human-sleep.github.io/...

Here, we **summarize** the main variables that were collected in the present study, and we conduct **multilevel analysis** to characterize the two groups in terms of sleep architecture, timing, night-to-night variability, and autonomic functioning, as well as to evaluate the reciprocal relationship between sleep and distress in the two groups of adolescents.

<br>

The following R packages are used in this document (see References section):
```{r }
# required packages
packages <- c("ggplot2","gridExtra","lubridate","tidyr","dplyr","tcltk")

# generate packages references
knitr::write_bib(c(.packages(), packages),"packagesAn.bib")

# # run to install missing packages
# xfun::pkg_attach2(packages, message = FALSE); rm(list=ls())
```

<br>
<br>

# 1. Data description

## 1.1. Data loading

Here, we load the day-by-day (`ema`) and the demographic dataset (`demos`) resulting from the processing pipeline linked above.
```{r warning=FALSE,message=FALSE}
# removing all objets from the workspace
rm(list=ls())

# setting system time zone to GMT (for consistent temporal synchronization)
Sys.setenv(tz="GMT")

# loading pre-processed data
load("DATA/datasets/ema_finalClean.RData")
load("DATA/datasets/demos_clean.RData")

# used R packages
library(ggplot2); library(gridExtra); library(lubridate); library(reshape2)
```

<br>

## 1.2. Data recoding

Here, we recode some of the variables to be used in the analyses below:

1. we **operationalize time** by computing `dayNr` and `partdayNr` indexing, respectively, the No. of days since the first day of assessment, and the number of the current day of participation (i.e., without considering missing days)

3. we compute `light.p`, `deep.p`, and `rem.p` quantifying the **percentage of time** in each sleep stage **over** `TST`

4. we compute the `SO.num` and `WakeUp.num` representing the numeric equivalence of `SO` and `WakeUp` (currently in “mm-dd-yyyy hh:mm:ss” format) to indicate **the distance (hours) from midnight**

5. we compute the `TotalSteps1000` variable, quantifying the daily No. of `TotalSteps` in thousands (i.e., 1 `TotalSteps1000` = 1,000 `TotalSteps`) to make values more comparable across variables

6. we create the `weekday` variable, indicating whether the observation was collected during weekdays or weekends

7. we create the `covid19` variable to mark cases observed after the COVID-19 emergency outbreak

<br>

### 1.2.1. Operationalizing time

Here, we operationalize time by computing the variable `dayNr`, indexing the No. of days since the first day of assessment, and `partdayNr`, indexing the number of the current day of participation (i.e., without considering missing days).
```{r message=FALSE,warning=FALSE,fig.width=10,fig.height=5}
# sorting by ID and ActivityDate
ema <- ema[order(ema$ID,ema$ActivityDate,ema$StartTime),]

# computing dayNr and partdayNr
library(dplyr)
ema <- ema %>% group_by(ID) %>% 
  mutate(dayNr=round(as.numeric(difftime(ActivityDate,min(ActivityDate),units="days")))+1)
ema <- as.data.frame(ema)
detach("package:dplyr", unload=TRUE)
ema <- plyr::ddply(ema,c("ID"),transform,partdayNr=seq_along(ID))

# sorting dataset
AD <- which(colnames(ema)=="ActivityDate")
ema <- ema[,c(1:AD,ncol(ema)-1,ncol(ema),(AD+1):(ncol(ema)-2))]
```

<br>

### 1.2.2. % light, deep & REM

Here, we recode the variables `light`, `deep` and `REM` as **percentage of `NREM` and `REM` sleep over `TST`**.
```{r fig.width=10,fig.height=4,warning=FALSE,message=FALSE}
# sanity check (no value > TST)
cat("Sanity check:",nrow(ema[!is.na(ema$light) & (ema$light>ema$TST | ema$deep>ema$TST | ema$rem>ema$TST),])==0)

# sanity check (sum: no value > TST)
ema$totalStages <- apply(ema[,c("light","deep","rem")],1,sum)
cat("Sanity check:",nrow(ema[!is.na(ema$light) & ema$TST!=ema$totalStages,])==0)

# computing percentages
ema$light.p <- 100*ema$light/ema$TST
ema$deep.p <- 100*ema$deep/ema$TST
ema$rem.p <- 100*ema$rem/ema$TST

# sorting dataset columns
AD <- which(colnames(ema)=="rem")
ema <- ema[,c(1:AD,(ncol(ema)-2):ncol(ema),(AD+1):(ncol(ema)-3))]
ema$totalStages <- NULL

# plotting
grid.arrange(ggplot(ema,aes(light))+geom_histogram(),ggplot(ema,aes(light.p))+geom_histogram(),
             ggplot(ema,aes(deep))+geom_histogram(),ggplot(ema,aes(deep.p))+geom_histogram(),
             ggplot(ema,aes(rem))+geom_histogram(),ggplot(ema,aes(rem.p))+geom_histogram(),nrow=3)
```

<br>

### 1.2.3. Numeric timings

Here, we recode the variables `SO` and `WakeUp` as numeric, indicating their relative **distance in hours from midnight**. Positive values will reflect hours after midnight, whereas negative values will reflect hours before midnight.
```{r fig.width=10,fig.height=4,warning=FALSE,message=FALSE}
# isolating hour from date
ema$SO.num <- as.POSIXct(paste(hour(ema$SO),minute(ema$SO)),format="%H %M") 
ema$WakeUp.num <- as.POSIXct(paste(hour(ema$WakeUp),minute(ema$WakeUp)),format="%H %M")

# sorting dataset columns
AD <- which(colnames(ema)=="midSleep")
ema <- ema[,c(1:AD,(ncol(ema)-1):ncol(ema),(AD+1):(ncol(ema)-2))]

# computing distance from midnight
ema$SO.num <- as.numeric(difftime(ema$SO.num,
                                  as.POSIXct(paste(substr(Sys.time(),1,10),"00:00:00"),tz="GMT"),units="hours"))
ema$WakeUp.num <- as.numeric(difftime(ema$WakeUp.num,
                                      as.POSIXct(paste(substr(Sys.time(),1,10),"00:00:00"),tz="GMT"),units="hours"))

# subtracting 24h to cases with values before midnight (i.e., so that positive = after, and negative = before)
ema[!is.na(ema$SO.num) & ema$SO.num>15,"SO.num"] <- 
  ema[!is.na(ema$SO.num) & ema$SO.num>15,"SO.num"] - 24 
ema[!is.na(ema$WakeUp.num) & ema$WakeUp.num>15,"WakeUp.num"] <- 
  ema[!is.na(ema$WakeUp.num) & ema$WakeUp.num>15,"WakeUp.num"] - 24

# plotting
grid.arrange(ggplot(ema,aes(SO.num)) + geom_histogram() + ggtitle("Sleep Onset (hours from 00:00)") + xlim(c(-6,15)),
             ggplot(ema,aes(WakeUp.num)) + geom_histogram() + ggtitle("Wake-up time (hours from 00:00)") + xlim(c(-6,15)))

# sanity check
cat("Sanity check:",
    nrow(ema[!is.na(ema$TIB) & ((ema$SO.num > max(ema$TIB,na.rm=TRUE) & ema$WakeUp.num > max(ema$TIB,na.rm=TRUE)) |
                                  ema$SO.num < (-6) | ema$SO.num > (6)),])==0)
```

<br>

*Comments:*

- `SO` and `WakeUp` have been effectively converted as their distance from midnight

- no cases have `SO.num` or `WakeUp.num` higher than 15, or `SO.num` lower than -6 or higher than 6

<br>

### 1.2.4. TotalSteps1000

Here, we recode the `TotalSteps` variable to be **quantified in thousands of steps** rather than in single steps.
```{r fig.width=10,fig.height=2.5,warning=FALSE,message=FALSE}
# computing TotalSteps1000
ema$TotalSteps1000 <- ema$TotalSteps/1000

# sorting dataset columns
AD <- which(colnames(ema)=="TotalSteps")
ema <- ema[,c(1:AD,ncol(ema),(AD+1):(ncol(ema)-1))]

# plotting
grid.arrange(ggplot(ema,aes(TotalSteps))+geom_histogram(),ggplot(ema,aes(TotalSteps1000))+geom_histogram(),nrow=1)
```

<br>

### 1.2.5. Late responses

Here, we create the variable `diary.nextDay` to mark those cases in which daily diaries were **filled on the following day**, that is we check the No. of cases with **diary `StartedTime` after sleep `EndTime`**, and the No. of cases with **valid diary but not sleep data with a `StartedTime` later than 6 AM**.
```{r fig.width=10,fig.height=2.5,warning=FALSE,message=FALSE}
# marking cases with StartedTime > EndTime
ema[!is.na(ema$dailyStress) & !is.na(ema$TIB),c("diary.nextDay","diary.nextDay2")] <- 0
ema[!is.na(ema$dailyStress) & !is.na(ema$TIB) & ema$StartedTime>ema$EndTime,"diary.nextDay"] <- 1
cat(nrow(ema[!is.na(ema$diary.nextDay) & ema$diary.nextDay==1,]),"diary responses entered after wake up (",
    round(100*nrow(ema[!is.na(ema$diary.nextDay) & ema$diary.nextDay==1,])/nrow(ema[!is.na(ema$StartedTime),]),1),"% )")

# marking cases with StartedTime > 6 AM and < 8 PM
ema$StartedHour <- as.POSIXct(paste(hour(ema$StartedTime),minute(ema$StartedTime)),format="%H %M",tz="GMT") # isolating time
sixPM <- as.POSIXct(paste(substr(Sys.time(),1,10),"06:00:00"),tz="GMT") # 6 AM
ema[!is.na(ema$StartedHour) & ema$StartedHour>sixPM & ema$StartedHour<sixPM+14*60*60,"diary.nextDay2"] <- 1
ema[!is.na(ema$StartedHour) & (ema$StartedHour<=sixPM | ema$StartedHour>=sixPM+14*60*60),"diary.nextDay2"] <- 0
cat(nrow(ema[!is.na(ema$diary.nextDay2) & ema$diary.nextDay2==1,]),"diary responses entered after 6 AM (",
    round(100*nrow(ema[!is.na(ema$diary.nextDay2) & ema$diary.nextDay2==1,])/nrow(ema[!is.na(ema$StartedTime),]),1),
    "% ), of which",nrow(ema[!is.na(ema$diary.nextDay2) & ema$diary.nextDay2==1 &
                               !is.na(ema$diary.nextDay) & ema$diary.nextDay==0,]),"marked with diary.nextDay = 0 (showed below)")

# showing cases with StartedTime > 6 AM and diary.nextDay = 0
ema[!is.na(ema$diary.nextDay2) & ema$diary.nextDay2==1 & !is.na(ema$diary.nextDay) & ema$diary.nextDay==0,
    c("ID","ActivityDate","StartTime","EndTime","StartedTime","diary.nextDay")]

# joining diary.nextDay and diary.nextDay2
ema[!is.na(ema$diary.nextDay2) & ema$diary.nextDay2==1,"diary.nextDay"] <- 1
ema[is.na(ema$diary.nextDay) & !is.na(ema$diary.nextDay2) & ema$diary.nextDay2==0,"diary.nextDay"] <- 0
ema$StartedHour <- ema$diary.nextDay2 <- NULL

# sorting columns
AD <- which(colnames(ema)=="surveyDuration")
ema <- ema[,c(1:AD,ncol(ema),(AD+1):(ncol(ema)-1))]

# printing final info
cat(nrow(ema[!is.na(ema$diary.nextDay) & ema$diary.nextDay==1,]),"diary responses entered after wake up or after 6 AM (",
    round(100*nrow(ema[!is.na(ema$diary.nextDay) & ema$diary.nextDay==1,])/nrow(ema[!is.na(ema$StartedTime),]),1),"% )")
```

<br>

*Comments*:

- in 790 cases (16%), participants filled the diary after sleepLog `WakeUp` time

- in 998 cases (20.2%), participants filled the diary after 6 AM

- overall, in **1,010 cases (25.5%)**, participants filled the diary **on the following day**

<br>

### 1.2.6. weekends

Here, the `ActivityDate` variable is used to **discriminate the observations collected in weekdays** (Tuesday to Friday) **vs weekend days** (Saturday and Sunday). Since sleep habits are mainly influenced by the following day than the previous one (i.e., people go to bed late on Friday, and early on Sunday), we create two variables: `weekday` (marking Saturday and Sunday as "weekend"), and `weekday.sleep` (marking Friday and Saturday as "weekend").
```{r fig.width=10,fig.height=4,message=FALSE}
# extracting weekday from Activity Date
ema$wd <- weekdays(as.Date(ema$ActivityDate))

# creating weekday
ema$weekday <- "weekday"
ema[ema$wd=="sabato" | ema$wd=="domenica","weekday"] <- "weekend"

# creating weekday.sleep
ema$weekday.sleep <- "weekday"
ema[ema$wd=="venerdì" | ema$wd=="sabato","weekday.sleep"] <- "weekend"
ema$wd <- NULL

# sorting dataset
AD <- which(colnames(ema)=="ActivityDate")
ema <- ema[,c(1:AD,ncol(ema)-1,ncol(ema),(AD+1):(ncol(ema)-2))]

# summarizing
ema[,c("weekday","weekday.sleep")] <- lapply(ema[,c("weekday","weekday.sleep")],as.factor)
summary(ema[,c("weekday","weekday.sleep")])
```

<br>

### 1.2.7. COVID-19 emergency

Here, the `ActivityDate` variable is used to create the variable `covid19` **highlighting the cases that were observed during the COVID-19 emergency**, whose beginning in the San Francisco Bay Area was identified at **March 20th, 2020**.
```{r fig.width=10,fig.height=4,message=FALSE}
# creating covid19 variable
ema$covid19 <- "pre-COVID19"
ema[ema$ActivityDate>=as.Date("2020-03-20"),"covid19"] <- "post-COVID19"
ema$covid19 <- factor(ema$covid19,levels=c("pre-COVID19","post-COVID19"))

# sorting dataset columns
ema <- ema[,c(1:AD,ncol(ema),(AD+1):(ncol(ema)-1))]

# plotting
ggplot(ema,aes(ActivityDate)) + geom_histogram() + geom_vline(xintercept=as.Date("2020-03-20"),color="red")

# summarizing cases
summary(ema$covid19) # 2,317 post-COVID19 (37%)

# No. participants with both pre-COVID19 and post-COVID19 observations
pre <- levels(as.factor(as.character(ema[ema$covid19=="pre-COVID19","ID"])))
post <- levels(as.factor(as.character(ema[ema$covid19=="post-COVID19","ID"])))
cat("-",length(pre[!(pre%in%post)]),"participants with only pre-COVID19 observations",
    "\n-",length(post[!(post%in%pre)]),"participants with only post-COVID19 observations",
    "\n-",length(post[post%in%pre]),"participants with both pre- and post-COVID19 observations")
```

<br>

*Comments:*

- the **37%** of the data was collected after the COVID-19 outbreak

- nevertheless, **only seven participants** have data collected **both before and after** the COVID-19 outbreak, with most participants having ended their data collection period before March 20th, 2020, and a smaller group (N = 32) having started four-to-five months later

- consequently, any comparison will be mainly a **comparison between subjects**

<br>

## 1.3. Data dictionary

Here, we describe each variable included in the `ema` dataset.
```{r fig.width=10,fig.height=4,warning=FALSE,message=FALSE}
# removing unuseful variables
toRemove <- c("LogId","SOL","nAwake","fragIndex","midSleep",paste("meanHR",1:3,sep=""),paste("sleepHR",1:3,sep=""),
              paste("HRtimeCoeff",1:3,sep=""),paste("stageHR",c("TST","SOL","WASO"),sep="_"),"majMiss","minMiss")
ema[,toRemove] <- NULL

# changing diary items names
colnames(ema)[which(colnames(ema)=="dailyStress")] <- "stress"
colnames(ema)[which(colnames(ema)=="eveningMood")] <- "mood"
colnames(ema)[which(colnames(ema)=="eveningWorry")] <- "worry"

# changing HR variable names
colnames(ema)[which(colnames(ema)=="stageHR_NREM")] <- "HR_NREM"
colnames(ema)[which(colnames(ema)=="stageHR_REM")] <- "HR_REM"

# showing variables
str(ema)
```

<br>

**INDIVIDUAL-LEVEL VARIABLES**

**Demographics:**

1. `ID` = participants' identification code

2. `sex` = participants' sex ("F" = female, "M" = male)

3. `age` = participants' age (years)

4. `BMI` = participants' BMI (kg*m^(-2))

5. `insomnia` = participants' group (1 = insomnia, 0 = control)

6. `insomnia.group` = participants' insomnia group ("control" = control, "DSM.ins" = DSM insomnia, "sub.ins" = insomnia subthreshold)

<br>

**DAY-LEVEL VARIABLES**

7. `ActivityDate` = day of assessment (date in "mm-dd-yyyy" format)

8. `covid19` = factor indicating whether the observation was collected "pre-COVID19" or "post-COVID19"

9. `weekday` = factor indicating whther the observation was collected during a "weekday" (Mon-Fry) or "weekend" (Sat-Sun)

10. `weekday.sleep` = factor indicating whther the observation was collected during a night preceding a "weekday" (Sun-Thu) or "weekend" (Fry-Sat)

11. `dayNr` = No. of days since the first day of assessment, within participant

12. `partdayNr` = current 'valid' day of assessment

<br>

**sleepLog**

13. `StartTime` = sleep period start hour (in "mm-dd-yyyy hh:mm:ss" format)

14. `EndTime` = sleep period end hour (in "mm-dd-yyyy hh:mm:ss" format)

15. `SleepDataType`: sleep data type originally scored by Fitabase

16. `EBEDataType`: type of EBE data used for manually recomputing sleep measures (i.e., updated by excluding the last wake epochs)

17. `TIB` = time in bed (min) computed as the number of minutes between `StartTime` (i.e., considering missing epochs at the beginning as wake epochs) and the last epoch included in EBE data (i.e., excluding the last wake epochs)

18. `TST` = total sleep time (min)

19. `SE` = sleep efficiency as the percent of `TST` over `TIB` (%)

20. `SO` = sleep onset hour (in "mm-dd-yyyy hh:mm:ss" format) corresponding to the time of the first epoch classified as sleep

21. `WakeUp` = wake-up time (in "mm-dd-yyyy hh:mm:ss" format) corresponding to the time of the last epoch classified as sleep

22. `SO.num` = `SO` expressed as the No. of hours from midnight

23. `WakeUp.num` = `WakeUp` expressed as the No. of hours from midnight

24. `WASO` = wake after sleep onset (min)

25. `light` = No. of minutes classified as 'light' sleep

26. `deep` = No. of minutes classified as 'deep' sleep

27. `rem` = No. of minutes classified as REM sleep

28. `light.p` = Percentage of light sleep over TST

29. `deep.p` = Percentage of deep sleep over TST

30. `rem.p` = Percentage of REM sleep over TST

<br>

**sleepHR**

31.`HR_NREM` = mean HR values (bpm) computed from all epochs categorized as NREM sleep

32. `HR_REM` = mean HR values (bpm) computed from all epochs categorized as REM sleep

<br>

**dailyAct**

33. `TotalSteps` = sum of the No. of steps recoded in each day (recomputed from hourly steps data)

34. `TotalSteps1000` = `TotalSteps` expressed in thousands of steps

<br>

**dailyDiary**

35. `StartedTime` = initiation hour of the diary form (in "mm-dd-yyyy hh:mm:ss" format)

36. `SubmittedTime` = submission hour of the diary form (in "mm-dd-yyyy hh:mm:ss" format)

37. `surveyDuration` = duration of the survey (min)

38. `diary.nextDay` = factor indicating whether diary ratings were entered on the following day (1) or not (0)

39. `stress` = score at the daily stress item (1-5)

40. `worry` = score at the evening worry item (1-5)

41. `mood` = score at the evening Mood item (1-5)

42. `stress_school, ..., stress_other` = stressor categories (0 or 1)

48. `worry_school, ..., worry_other` = sources of worry (0 or 1)

<br>

# 2. Psychometrics

Here, we evaluate the psychometric proprieties of the **psychological distress scale** resulting from the three Likert-type items submitted each evening: `stress`, `mood`, and `worry`.

First, we load the `lavaan` and the `MuMIn` R packages, and we **negatively recode `mood`** so that higher scores reflect negative mood.
```{r fig.width=10,fig.height=4,warning=FALSE,message=FALSE}
library(lavaan); library(MuMIn) # loading lavaan R package

# negatively recoding evening mood (higher values = negative mood)
ema$mood <- 6 - ema$mood
```

<br>

## 2.1. Descriptives

Then, we use the `corr.matrices` function to visualize the correlation matrix of item scores at the overall, between- and within-subject level, and the `itemsICC` function to compute items intraclass correlation coefficients (ICC) for each item. Note that **only cases with complete responses** to each item ware kept in the dataset.

<details><summary>**show corr.matrices**</summary>
<p>
```{r echo=TRUE}
corr.matrices <- function(data=data,IDvar="ID",items=c("stress","worry","mood")){ 
  require(ggplot2); require(dplyr); require(reshape2)
  
  data <- na.omit(data[,c(IDvar,items)])
  data <- plyr::ddply(data,"ID",transform,day=seq_along(ID))
  data <- data %>%
  group_by(ID) %>% # grouping by ID
  mutate(stress.cm = mean(na.omit(stress)), # computing individual mean for any given item
         worry.cm = mean(na.omit(worry)),mood.cm = mean(na.omit(mood)),
         
         stress.dm = stress-stress.cm, # computing within-individual deviations (occasional score - mean score)
         worry.dm = worry-worry.cm, mood.dm = mood-mood.cm)
  
  # Matrix 1 (all scores as independent)
  c1 <- melt(cor(data[,which(colnames(data)=="stress"):which(colnames(data)=="mood")],
                 data[,which(colnames(data)=="stress"):which(colnames(data)=="mood")],
                 use="complete.obs",method="pearson"))
  p1 <- ggplot(c1,aes(x=Var1, y=Var2, fill=value)) + 
    geom_tile() + 
    geom_text(aes(x = Var1, y = Var2, label = round(value,2)),color="black",size=5)+
    ggtitle(paste("Correlation Matrix 1 (all independent); N =",nrow(data)))+labs(x="",y="")+
    scale_fill_gradient2(low="darkblue",high="#f03b20",
                         mid="white",midpoint=0,
                         limit = c(-1,1), space = "Lab",
                         name="Pearson\nCorrelation",
                         guide="legend",
                         breaks=round(seq(1,-1,length.out = 11),2),
                         minor_breaks=round(seq(1,-1,length.out = 11),2)) + theme_minimal() +
    theme(text=element_text(face="bold",size=12))
  
  # Matrix 2 (individual means)
  DATA <- data[data$day==1,]
  c2 <- melt(cor(DATA[,which(colnames(DATA)=="stress.cm"):which(colnames(DATA)=="mood.cm")],
                 DATA[,which(colnames(DATA)=="stress.cm"):which(colnames(DATA)=="mood.cm")],
                 use="complete.obs",method="pearson"))
  p2 <- ggplot(c2,aes(x=Var1, y=Var2, fill=value)) + geom_tile() +
    geom_text(aes(x = Var1, y = Var2, label = round(value,2)),color="black",size=5)+
    ggtitle(paste("Correlation Matrix 2 (individual means); N =",nrow(DATA)))+labs(x="",y="")+
    scale_fill_gradient2(low="darkblue",high="#f03b20",
                         mid="white",midpoint=0,
                         limit = c(-1,1), space = "Lab",
                         name="Pearson\nCorrelation",
                         guide="legend",
                         breaks=round(seq(1,-1,length.out = 11),2),
                         minor_breaks=round(seq(1,-1,length.out = 11),2)) + theme_minimal() +
    theme(text=element_text(face="bold",size=12))
  
  # Matrix 3 (deviations from individual means)
  c3 <- melt(cor(data[,which(colnames(data)=="stress.dm"):which(colnames(data)=="mood.dm")],
                 data[,which(colnames(data)=="stress.dm"):which(colnames(data)=="mood.dm")],
                 use="complete.obs",method="pearson"))
  p3 <- ggplot(c3,aes(x=Var1, y=Var2, fill=value)) + 
    geom_tile() + 
    geom_text(aes(x = Var1, y = Var2, label = round(value,2)),color="black",size=5)+
    ggtitle(paste("Correlation Matrix 3 (mean-centered scores); N =",nrow(data)))+labs(x="",y="")+
    scale_fill_gradient2(low="darkblue",high="#f03b20",
                         mid="white",midpoint=0,
                         limit = c(-1,1), space = "Lab",
                         name="Pearson\nCorrelation",
                         guide="legend",
                         breaks=round(seq(1,-1,length.out = 11),2),
                         minor_breaks=round(seq(1,-1,length.out = 11),2)) + theme_minimal() +
    theme(text=element_text(face="bold",size=12))
  
  return(list(p1,p2,p3))}
```
</p></details>

<details><summary>**show itemsICC**</summary><p>
```{r echo=TRUE}
itemsICC <- function(data,items,IDvar,output="text",digits=2){ require(lme4)
  data <- na.omit(data[,c(IDvar,items)])
  res <- data.frame(item=NA,icc=NA)
  for(i in 1:length(items)){
    m <- lmer(formula=gsub("ID",IDvar,gsub("d1",items[i],"d1~(1|ID)")),data=data) # VAR_between / (VAR_between + VAR_within)
    out <- round(as.data.frame(lme4::VarCorr(m))[1,4]/(as.data.frame(lme4::VarCorr(m))[1,4]+as.data.frame(lme4::VarCorr(m))[2,4]),
                 digits)
    
    # textual output or data.frame
    if(output=="text"){cat(items[i],"ICC =",out,"\n")
    }else{ res <- rbind(res,cbind(item=items[i],icc=out)) }} 
  if(output!="text"){return(res) }}
```
</p></details>

```{r warning=FALSE,message=FALSE,fig.width=11,fig.height=3.5}
# plotting item scores distributions
grid.arrange(ggplot(ema,aes(stress)) + geom_histogram(),
             ggplot(ema,aes(worry)) + geom_histogram(),
             ggplot(ema,aes(mood)) + geom_histogram(),nrow=1)

# correlation matrix considering all observations as independent
corr.matrices(data=ema,IDvar="ID",items=c("stress","worry","mood"))[[1]]
# correlation matrix considering mean scores
corr.matrices(data=ema,IDvar="ID",items=c("stress","worry","mood"))[[2]]
# correlation matrix considering person mean-centered scores
corr.matrices(data=ema,IDvar="ID",items=c("stress","worry","mood"))[[3]]

# computing item ICCs
itemsICC(data=ema,IDvar="ID",items=c("stress","worry","mood"))
```

<br>

*Comments*

- item scores are **quite negatively skewed**, especially in the case of `stress` and `worry`, implying some deviation from the assumption of the MCFA model below

- item scores show a pattern of **positive medium-to-strong correlations**, indicating an **internal coherence** of the scale at both levels, with level-2 (between) correlations being higher than level-1 (within) correlations, as expected

- at level 2 (between), we also observe a **strong correlation between `stress` and `worry`**, in contrast to the moderate correlations shown between `mood` and both `stress` and `worry`

- items **ICCs** show similar values, indicating that most of the variance (from 67 to 75%) is at the **within-individual** level

<br>

## 2.2. Multilevel CFA

Then, we perform a **Multilevel Confirmatory Factor Analysis** (MCFA) by specifying a measurement model that assumes a **configural cluster construct** (with the same mono-factor structure at both levels). Following [Jak & Jorgensen (2017)](#ref), we also test weak and strong **cross-level isomorphism**. The `fit.ind` function is used to optimize model comparison.

<details><summary>**show fit.ind**</summary><p>
```{r echo=TRUE}
fit.ind <- function(model=NA,from_summary=FALSE,type="multilevel",models.names=NA,
                    fits=c("npar","chisq","df","pvalue","rmsea","cfi","srmr_within","srmr_between")){ require(lavaan); require(MuMIn)
  # removing level-specific fit indices when model is "monolevel"
  if(type=="monolevel"){
      fits <- gsub("srmr_within","srmr",fits)
      fits <- fits[fits!="srmr_between"] }
  if(from_summary==FALSE){
    # returning dataframe of models fit indices when more than one model is considered
    if(length(model)>1){
      fit.indices <- fitmeasures(model[[1]])[fits]
      for(i in 2:length(model)){
        fit.indices <- rbind(fit.indices,fitmeasures(model[[i]])[fits]) }
      if(!is.na(models.names[1])){
        row.names(fit.indices) <- models.names }
      return(as.data.frame(fit.indices))
      } else { return(fitmeasures(model)[fits]) }
    
    } else { # in some cases the fit indices are available only from the model's summary 
      quiet <- function(fit) { # this was written by Alicia FRANCO MARTÍNEZ on the lavaan Google group
        sink(tempfile())
        on.exit(sink()) 
        invisible(summary(fit, standardized = TRUE, fit.measures=TRUE))
        } 
      sum <- quiet(model)
      fit.indices <- sum$FIT[fits]
      return(fit.indices)}}
```
</p></details>

<br>

### 2.2.1. Model specification

First, we specify all models of interest.

We start with the preliminary steps suggested by [Hox (2010, chapter 14)](#ref) to evaluate the factor structure at level 2: the following benchmark models imply (1) no specification at level 2 (**Null model**), (2) only variances but not covariances at level 2 (**Independence model**), and (3) a full covariance matrix at level 2 (**Saturated model**).
```{r }
m.null <- 'level: 1
           Distress_w =~ stress + worry + mood
           level: 2
           stress ~~ 0*stress
           worry ~~ 0*worry
           mood ~~ 0*mood'

m.ind <- 'level: 1
          Distress_w =~ stress + worry + mood
          level: 2
          stress ~~ stress
          worry ~~ worry
          mood ~~ mood'

m.sat <- 'level: 1
          Distress_w =~ stress + worry + mood
          level: 2
          stress ~~ stress + worry + mood
          worry ~~ worry + mood
          mood ~~ mood'
```

<br>

Then, we specify the target models: the **configural model** (i.e., same structure at level 1 and 2), the **weak invariance model** (i.e., equivalent factor loading at level 1 and level 2), and the **strong invariance model** (i.e., equivalent factor loadings, and no residual variance at level 2).
```{r }
m.conf <- 'level: 1
           Distress_w =~ stress + worry + mood
           level: 2
           Distress_b =~ stress + worry + mood'

m.weak <- 'level: 1
           Distress_w =~ a*stress + b*worry + c*mood
           level: 2
           Distress_b =~ a*stress + b*worry + c*mood'

m.strong <- 'level: 1
             Distress_w =~ a*stress + b*worry + c*mood
             level: 2
             Distress_b =~ a*stress + b*worry + c*mood
             stress ~~ 0*stress
             worry ~~ 0*worry
             mood ~~ 0*mood'
```

<br>

### 2.2.2. Model fit

Here, we fit the specified models to the observed data.

We start with the **benchmark models**.
```{r }
# selecting only observations with complete dailyDiary responses
dailyDiary <- na.omit(ema[,c("ID","stress","worry","mood")])

# fitting models
fit.null <- cfa(model=m.null,data=dailyDiary,cluster="ID",std.lv=TRUE)
fit.ind <- cfa(model=m.ind,data=dailyDiary,cluster="ID",std.lv=TRUE)
fit.sat <- cfa(model=m.sat,data=dailyDiary,cluster="ID",std.lv=TRUE)
```

<br>

Then, we fit the **target models**.
```{r }
# fitting models
fit.conf <- cfa(model=m.conf,data=dailyDiary,cluster="ID",std.lv=TRUE) # Heywood case
fit.weak <- cfa(model=m.weak,data=dailyDiary,cluster="ID",std.lv=TRUE)
fit.strong <- cfa(model=m.strong,data=dailyDiary,cluster="ID",std.lv=TRUE)
```

<br>

*Comments:*

- participant *s050* has no intraindividual varianec for items *stress* and *worry* (but we keep it for now)

- an **Heywood case** (i.e., estimated negative variance for item *worry*) is observed for the configural model

<br>

#### 2.2.1.1. Heywood cases

Here, we can see that the **Heywood case** does not seem to be caused by structural misspecification (the upper CI for that parameter is positive), but most probably to **sample fluctuations** around a parameter close to zero (see [Kolenikov & Bollen, 2012](#ref)). 
```{r }
# structural misspecification? But upper CI is > 0
parameterestimates(fit.conf)[parameterestimates(fit.conf)$op=="~~" & parameterestimates(fit.conf)$ci.lower<0,
                             c("lhs","level","est","se","ci.lower","ci.upper")]
```

<br>

To solve the problem, we first try to fix the residual variance of item `worry` to the 15% of its estimated variance at level 2 (i.e., var = .15 x rho2_between) (see [Joreskog & Sobrom 1996](#ref)).
```{r }
# estimating lv-2 variance for worry item
library(lme4)
fit <- lmer(worry ~ 1 + (1|ID),data=dailyDiary) # null LMER model
varlv2 <- as.data.frame(lme4::VarCorr(fit))[1,4] # between-subjects variance of item t2

# re-fitting the configural model with the new variance constraint
fit.conf.fix <- cfa(model=gsub("rho2",varlv2*0.15,
                               "level: 1
                                Distress_w =~ stress + worry + mood
                                level: 2
                                Distress_b =~ stress + worry + mood
                                worry ~~ rho2*worry"),data=dailyDiary,cluster='ID',std.lv=TRUE)

# inspecting covariances
parameterestimates(fit.conf.fix)[parameterestimates(fit.conf.fix)$op=="~~" & parameterestimates(fit.conf)$ci.lower<0,
                                 c("lhs","level","est","se","ci.lower","ci.upper")]
```

<br>

*Comments:*

- the re-fitting of the configural model with `worry` variance fixed at the 15% of the total variance at level 2 does no show further improper solutions

- now, item `stress` show a negative lower CI, but the estimate is positive

<br>

For better comparison, we also **re-fit the weak invariance model** with the same constraint.
```{r }
# re-fitting the weak invariance model with the new variance constraint
fit.weak.fix <- cfa(model=gsub("rho2",varlv2*0.15,
                               "level: 1
                                Distress_w =~ a*stress + b*worry + c*mood
                                level: 2
                                Distress_b =~ a*stress + b*worry + c*mood
                                worry ~~ rho2*worry"),data=dailyDiary,cluster='ID',std.lv=TRUE)
```

<br>

As an alternative solution, we inspect the changes in residual variances following the removal of each participant. This is done with the `sample.fluct` and `plot.infl` functions.

<details><summary>**show sample.fluct**</summary><p>
```{r echo=TRUE}
#' @title Influential analysis
#' @param data = data.frame used by the model.
#' @param cluster = Character. Variable name in the data frame defining the cluster in a two-level dataset.
#' @param parameter = Character. "var" for estimated variances, "load" for loadings.
#' @param st = Character indicating the standardization level of loadings: "st.all" or "st.lv".
#' @param n.items = Integer. Number of observed variables considered by the model.
#' @param item.labels = Character vector indicating the labels of the considered observed variables.
#' @param m = Character string specifying the model using the lavaan synthax.

sample.fluct <- function(data=NA,cluster="ID",parameter="var",st="st.all",
                         n.items=3,item.labels=c("stress","worry","mood"),
                         m = 'level: 1
                              Distress_w =~ stress + worry + mood
                              level: 2
                              Distress_b =~ stress + worry + mood'){ require(lavaan); require(tcltk)
  
  # function to estiamte and store estimated parameters
  estTable <- function(data=data,m=m,cluster=cluster){
    
    # model fitting
    m.res <- cfa(model=m,data=data,cluster=cluster,std.lv=TRUE)
    
    # parameters
    if(parameter=="var"){
      p <- parameterestimates(m.res)
      lv1 <- p[p$op=="~~" & p$est!=1 & p$level==1,"est"]
      lv2 <- p[p$op=="~~" & p$est!=1 & p$level==2,"est"]
    } else if(parameter=="load"){
      if(st=="st.all"){
        p <- standardizedsolution(m.res)
        lv1 <- p[p$op=="=~","est.std"][1:n.items]
        lv2 <- p[p$op=="=~","est.std"][(n.items+1):(n.items+n.items)]
        } else if(st=="st.lv"){
          p <- standardizedsolution(m.res,type="std.lv")
          lv1 <- p[p$op=="=~","est.std"][1:n.items]
          lv2 <- p[p$op=="=~","est.std"][(n.items+1):(n.items+n.items)]
    } else{
      lv1 <- p[p$op=="=~" & p$est!=1 & p$level==1,"est"]
      lv2 <- p[p$op=="=~" & p$est!=1 & p$level==2,"est"] }}
    
    # dataframe storing results
    parameters <- data.frame(ID=rep("all",n.items),X=item.labels,lv1=lv1,lv2=lv2,neg.var=rep(1,n.items))
    
    # marking neg.var as "0" when no negative values are highlighted
    if(!any(diag(lavInspect(m.res,"est")[["within"]][["theta"]]) < 0) & 
       !any(diag(lavInspect(m.res,"est")[["ID"]][["theta"]]) < 0)){ 
      parameters[1:n.items,"neg.var"] <- 0 }
    
    return(parameters) }
  
  # extracting baseline parameters
  parameters <- estTable(data=data,m=m,cluster=cluster)

  # replicate parameters estimation by excluding any participant one-by-one
  IDs <- levels(as.factor(as.character(data$ID)))
  pb <- tkProgressBar("Modeling", "Data modeling",0, 100, 50) # progress bar
  for(ID in IDs){ 
    info <- sprintf("%d%% done", round(which(IDs==ID)/length(IDs)*100))
    setTkProgressBar(pb, round(which(IDs==ID)/length(IDs)*100), sprintf("Data modeling", info), info)
    parameters <- rbind(parameters,estTable(data=data[data$ID!=ID,],m=m,cluster=cluster))
    parameters[(nrow(parameters)-n.items+1):nrow(parameters),"ID"] <- as.character(ID)}
  close(pb)
  parameters <- parameters[,c("ID","X","lv1","lv2","neg.var")]
  return(parameters)}
```
</p></details>

<details><summary>**show plot.infl**</summary><p>
```{r echo=TRUE}
#' @title Plotting results of influential analysis
#' @param data = data.frame generated by the influential.analysis function.
#' @param parameter = Character. "var" for estimated variances, "load" for loadings.
#' @param variable = Character indicating the name of the observed variable to be plotted.
#' @param level = Integer indicating if focusing on level 1 or 2 (default).
#' @param threshold_lower = Numeric. Threeshold below which the participants'IDs are showed.
#' @param threshold_upper = Numeric. Threeshold above which the participants'IDs are showed.

plot.infl <- function(data,parameter="var",variable,level=2,
                             threshold_lower=NA,threshold_upper=NA){
  
  require(ggplot2)
  
  if(parameter=="var"){ par <- "variance"} else { par = "loading" }
  if(level==2){ colnames(data)[colnames(data)=="lv2"] <- "par" 
  } else { colnames(data)[colnames(data)=="lv1"] <- "par" }
  
  p <- ggplot(data[data$X==variable,],aes(ID,par))+
  geom_point()+ggtitle(paste(variable,par,"on level",level))+
  geom_point(data=data[data$X==variable & data$ID=="all",],colour="blue",size=5)+
  geom_point(data=data[data$X==variable & data$neg.var==1,],colour="red")+
  theme(axis.text.x = element_blank()) + xlab("")
    
    if(!is.na(threshold_lower) & is.na(threshold_upper)){
      p <- p + geom_text(data=data[data$X==variable & 
                                     data$par < threshold_lower,],
                         aes(label=ID),nudge_x=-5,size=3)
      } else if(is.na(threshold_lower) & !is.na(threshold_upper)){
        p <- p + geom_text(data=data[data$X==variable &
                                       data$par > threshold_upper,],
                           aes(label=ID),nudge_x=-5,size=3)
        } else if(!is.na(threshold_lower) & !is.na(threshold_upper)){
          p <- p + geom_text(data=data[data$X==variable & 
                                         (data$par > threshold_upper |
                                            data$par < threshold_lower),],
                             aes(label=ID),nudge_x=-5,size=3) }
  
  return(p)} 
```
</p></details>

```{r warning=FALSE,message=FALSE}
# estimating parameters
infl <- sample.fluct(data=dailyDiary,parameter="var")

# plotting
plot.infl(data=infl,par="var",variable="worry",level=2,threshold_upper=0)
```

<br>

*Comments:*

- the exclusion of either one among three participants (`s093`, `s021`, `s123`) seems to solve the Heywood case highlighted at level 2 for item `worry`

<br>

Here, we re-specify all target models by excluding participant `s093` (i.e., associated with the lowest variance for `worry`).
```{r }
# fitting models
fit.conf_noInfl1 <- cfa(model=m.conf,data=dailyDiary[dailyDiary$ID!="s093",],cluster="ID",std.lv=TRUE) # Heywood case
fit.weak_noInfl1 <- cfa(model=m.weak,data=dailyDiary[dailyDiary$ID!="s093",],cluster="ID",std.lv=TRUE)
fit.strong_noInfl1 <- cfa(model=m.strong,data=dailyDiary[dailyDiary$ID!="s093",],cluster="ID",std.lv=TRUE)
```

<br>

*Comments:*

- **no more Heywood cases** are highlighted from the models specified without participant `s095`

<br>

### 2.2.3. Model comparison

Here, we compare the models specified above by inspecting their fit indices and information criteria. The `fitInd` function is used to optimize the process.

<details><summary>**show fitInd**</summary><p>
```{r echo=TRUE}
fitInd <- function(model=NA,from_summary=FALSE,type="multilevel",models.names=NA,
                    fits=c("npar","chisq","df","rmsea","cfi","srmr_within","srmr_between")){ 
  require(lavaan); require(MuMIn)
  # removing level-specific fit indices when model is "monolevel"
  if(type=="monolevel"){
      fits <- gsub("srmr_within","srmr",fits)
      fits <- fits[fits!="srmr_between"] }
  if(from_summary==FALSE){
    # returning dataframe of models fit indices when more than one model is considered
    if(length(model)>1){
      fit.indices <- fitmeasures(model[[1]])[fits]
      for(i in 2:length(model)){
        m <- model[[i]]
        fit.indices <- rbind(fit.indices,fitmeasures(m)[fits]) }
      if(!is.na(models.names[1])){
        row.names(fit.indices) <- models.names }
      return(as.data.frame(fit.indices))
      } else { return(fitmeasures(model)[fits]) }
    
    } else { # in some cases the fit indices are available only from the model's summary 
      quiet <- function(fit) { # this was written by Alicia FRANCO MARTÍNEZ on the lavaan Google group
        sink(tempfile())
        on.exit(sink()) 
        invisible(summary(fit, standardized = TRUE, fit.measures=TRUE))
        } 
      sum <- quiet(model)
      fit.indices <- sum$FIT[fits]
      return(fit.indices)}}
```
</p></details>

<br>

### 2.2.3.1. Benchmark models

First, we evaluate the fit of the benchmark models specified for examining the factor structure at level 2.
```{r }
# fit indices
round(fitInd(model=list(fit.null,fit.ind,fit.sat),
              models.names=c("Lv2 Null","Lv2 Independence","Lv2 Saturated")),3)

# AIC also considering the configural model
Weights(AIC(fit.null,fit.ind,fit.sat,fit.conf))

# BIC also considering the configural model
Weights(BIC(fit.null,fit.ind,fit.sat,fit.conf))
```

<br>

*Comments:*

- all benchmark models converged with no problems

- lv2 **Null and Independence** models show **unsatisfactory goodness of fit**, and are rejected, suggesting that there is some interesting structure also at level 2

- **lv2 Saturated model is saturated**, so we cannot use chi-squared-derived fit indices, and we cannot compare it with the configural model (which is also saturated)

<br>

### 2.2.3.2. Target models

Second, we evaluate the target models by keeping in mind that the **configural model is saturated and show an Heywood case** for `worry` at level 2.
```{r }
cbind(round(fitInd(model=c(fit.conf,fit.weak,fit.strong),
                   models.names=c("Configural","Weak Invariance","Strong Invariance")),3),
      AICw=round(Weights(AIC(fit.conf,fit.weak,fit.strong)),3),
      BICw=round(Weights(BIC(fit.conf,fit.weak,fit.strong)),3))
```

<br>

*Comments:*

- the **configural** model is **saturated**, so we cannot evaluate its fit indices, but it shows the **highest AICw and BIC**

- the **weak invariance** model shows acceptable RMSEA, CFI, and SRMR within, but **excessively high SRMR between**, suggesting a **poor fit at level 2**

- the **strong invariance** model is **rejected**

<br>

### 2.2.3.3. Fixed variance

Then, we replicate the model comparison by considering the configural and weak invariance models specified by **constraining the level-2 residual variance** for item `worry` to the 15% of its total variance at level 2.
```{r }
cbind(round(fitInd(model=c(fit.conf.fix,fit.weak.fix,fit.strong),
                   models.names=c("Configural","Weak Invariance","Strong Invariance")),3),
      AICw=round(Weights(AIC(fit.conf.fix,fit.weak.fix,fit.strong)),3),
      BICw=round(Weights(BIC(fit.conf.fix,fit.weak.fix,fit.strong)),3))
```

<br>

*Comments:*

- the **configural** model shows the **best fit indices** and the **highest AICw and BIC**

- the **weak invariance** model shows acceptable RMSEA, CFI, and SRMR within, but **excessively high SRMR between**, suggesting a **poor fit at level 2**

- the **strong invariance** model is **rejected**

<br>

### 2.2.3.4. Excluding s095

Finally, we replicate the model comparison on the models specified without participant `s095`, associated with the lowest (negative) estimate for the level-2 residual variance of item `worry`.
```{r }
cbind(round(fitInd(model=c(fit.conf_noInfl1,fit.weak_noInfl1,fit.strong_noInfl1),
                   models.names=c("Configural","Weak Invariance","Strong Invariance")),3),
      AICw=round(Weights(AIC(fit.conf_noInfl1,fit.weak_noInfl1,fit.strong_noInfl1)),3),
      BICw=round(Weights(BIC(fit.conf_noInfl1,fit.weak_noInfl1,fit.strong_noInfl1)),3))
```

<br>

*Comments:*

- the **configural** model is **saturated**, so we cannot evaluate its fit indices, but it shows the **highest AICw and BIC**

- the **weak invariance** model shows acceptable RMSEA, CFI, and SRMR within, but **excessively high SRMR between**, suggesting a **poor fit at level 2**

- the **strong invariance** model is **rejected**

<br>

### 2.2.3.5. Conclusions

- In all model comparisons, the **configural invariance model** consistently showed the **strongest evidence** in terms of AIC and BIC, and the **best fit indices** when level-2 residual variance for item *worry* is constrained to the 15% of its total variance at level 2 (otherwise the model is saturated, and shows 1 Heywood case).

- In contrast, the **weak invariance model** is consistently associated with **satisfactory fit at level 1 but not at level 2**, as indicated by the unsatisfactory SRMR coefficient at the between level.

- The **strong invariance model** is consistently **rejected** due to the unsatisfactory fit, suggesting that different factors might influence item responses at level 2.

<br>

Thus, **the configural invariance model is selected as the best measurement model** describing the factor structure of the Psychological distress scale.

<br>

### 2.2.4. Loadings

Here, we inspect and compare the standardized factor loadings estimated by the models showing the best fit indices: the configural model (i.e., we consider both its basic fit, and the `conf.fix` and `conf.noInfl1` versions).
```{r }
# fit.conf
(p <- cbind(standardizedsolution(fit.conf)[standardizedsolution(fit.conf)$op=="=~",1:5],
      standardizedsolution(fit.conf.fix)[standardizedsolution(fit.conf)$op=="=~",4:5],
      standardizedsolution(fit.conf_noInfl1)[standardizedsolution(fit.conf)$op=="=~",4:5]))
```

<br>

*Comments:*

- standardized parameters range from **0.54 to 0.99** in all models, suggesting **adequate factorial validity**

- the model with level-2 `worry` residual variance constrained to the 15% of its total variance shows fit indices **from 0.54 to 0.96**, with estimates very close to those estimated by the model without participant s095

<br>

### 2.2.4. Factor scores

Finally, we inspect the **factor scores predicted at the within and between level** by the selected model (i.e., configural model), and we compare the factor scores predicted by `fit.conf.fix` (in blue) and `fit.conf.noInfl1` (in red). Factor scores are then **included in the `ema` dataset**, to be used in the following analyses.
```{r fig.width=10,fig.height=4}
# level 1
hist(lavPredict(fit.conf.fix,level=1),col=rgb(0,0,1,alpha=0.5),breaks=100,main="predicted factor scores lv1")
hist(lavPredict(fit.conf_noInfl1,level=1),add=TRUE,col=rgb(1,0,0,alpha=0.5),breaks=100) 

# level 2
hist(lavPredict(fit.conf.fix,level=2),col=rgb(0,0,1,alpha=0.5),breaks=10,main="predicted factor scores lv2")
hist(lavPredict(fit.conf_noInfl1,level=2),add=TRUE,col=rgb(1,0,0,alpha=0.5),breaks=10) 

# including fit.conf.fix factor scores in the ema dataset (fs)
ema[!is.na(ema$StartedTime),"fs.w"] <- as.numeric(lavPredict(fit.conf.fix,level=1))
demos$fs.b <- as.numeric(lavPredict(fit.conf.fix,level=2))
ema <- plyr::join(ema,demos[,c("ID","fs.b")],type="left",by="ID")

# computing sum of factor scores (cluster mean + within-cluster deviations)
ema$fs <- ema$fs.b + ema$fs.w
```

<br>

*Comments:*

- factor scores are very similar between the two models at level 1, but more differences are highlighted at level 2

- only the factor scores predicted by the `fit.conf.fix` model (i.e., with level-2 residual variance for `worry` being constrained to the 15% of its total variance at level 2) are included in the `ema` dataset

<br>

## 2.3. Reliability

Here, we compute reliability coefficients at both the within and the between level, both based on the MCFA results (following [Geldhof, 2014](#ref)) and based on the generalizability theory (following [Cranford et al., 2006](#ref)). The `MCFArel` and `GTHEORYrel` functions are used to optimize the analyses:

<details><summary>**show MCFArel**</summary>
<p>
```{r echo=TRUE}
#' @title Computing composite reliability index from a MCFA model
#' @param fit = multilevel CFA model.
#' @param level = level of interest (either 1 or 2)
#' @param items = numeric string indicating the items of interest (e.g., 1:3 for items 1, 2 and 3)
#' @param item.labels = character string indicating the names of the items of interest
MCFArel <- function(fit,level,items,item.labels){ require(lavaan)
  if(level==1){ 
    sl <- standardizedsolution(fit)[1:(nrow(standardizedSolution(fit))/2),] # pars within
  } else if(level==2){ 
    sl <- standardizedsolution(fit)[(nrow(standardizedSolution(fit))/2):nrow(standardizedsolution(fit)),] # pars between
  } else { stop("Error: level can be either 1 or 2") }
  sl <- sl$est.std[sl$op == "=~"][items] # standardized loadings of the selected items
  names(sl) <- item.labels # item names
  re <- 1 - sl^2 # residual variances of items
  
  omega <- sum(sl)^2 / (sum(sl)^2 + sum(re)) # composite reliability index
  return(round(omega,2))}
```
</p>
</details>

<details><summary>**show GTHEORYrel**</summary>
<p>
```{r echo=TRUE}
#' @title Computing variance components and reliability indices of a given scale 
#' @param data = dataset
#' @param items = numeric string indicating the items of interest (e.g., 1:3 for items 1, 2 and 3)
#' @param item.labels = character string indicating the names of the items of interest
GTHEORYrel <- function(data,items,latent.lab,what=c("varComp","rel")){ require(lme4)
  
  # creating variable TIME
  data <- plyr::ddply(data,"ID",transform,TIME=seq_along(ID))

  # preparing long dataset with one row per item
  psymetr <- stack(data[,items])
  psymetr$ID <- data$ID
  psymetr$time <- as.factor(data$TIME)
  psymetr <- psymetr[,c(3,4,2,1)]
  colnames(psymetr) <- c("person","time","item","y")
  psymetr <- psymetr[order(psymetr$person,psymetr$time,psymetr$item),]
  
  # random-only GLMM specificiation
  mod1 <- lmer(y ~  1 + (1|person) + (1|time) + (1|item) + 
                 (1|person:time) + (1|person:item) + (1|time:item),data=psymetr)
  
  # variance decomposition
  SIGMAp <- lme4::VarCorr(mod1)[["person"]][1,1]
  SIGMAt <- lme4::VarCorr(mod1)[["time"]][1,1]
  SIGMAi <- lme4::VarCorr(mod1)[["item"]][1,1]
  SIGMAtp <- lme4::VarCorr(mod1)[["person:time"]][1,1]
  SIGMApi <- lme4::VarCorr(mod1)[["person:item"]][1,1]
  SIGMAti <- lme4::VarCorr(mod1)[["time:item"]][1,1]
  SIGMAres <- sigma(mod1)^2
  
  # printing variance components
  vars <- data.frame(Component=c("SIGMAp","SIGMAt","SIGMAi","SIGMAtp","SIGMApi","SIGMAti","SIGMAres","Total"),
                     VAR=c(SIGMAp,SIGMAt,SIGMAi,SIGMAtp,SIGMApi,SIGMAti,SIGMAres,
                           sum(SIGMAp,SIGMAt,SIGMAi,SIGMAtp,SIGMApi,SIGMAti,SIGMAres)))
  vars$VAR <- round(vars$VAR,2)
  vars$perc <- round(100*vars$VAR/vars[nrow(vars),2],2)
  colnames(vars)[2:3] <- c(latent.lab,paste(latent.lab,"%"))
  
  if(what=="varComp"){ return(vars)
    
  }else if(what=="rel"){ # reliability coeff. based on Cranfort et al. (2006)
    rel <- data.frame(measure=latent.lab,
                      # R1F = (varPERSON + varPERSON*ITEM/n.item) / (varPERSON + varPERSON*ITEM/n.item + varERROR/n.item)
                      R1F = (vars[1,2] + vars[5,2]/length(items)) / (vars[1,2] + vars[5,2]/length(items) + vars[7,2]/length(items)),
                      # RkF = (varPERSON + varPERSON*ITEM/n.item) / (varPERSON + varPERSON*ITEM/n.item + varERROR/(n.item*n.occasions))
                      RkF = (vars[1,2] + vars[5,2]/length(items))/ (vars[1,2] + vars[5,2]/length(items) +
                                                                      vars[7,2]/(length(items)*max(data$TIME))),
                      # Rc = varPERSON*TIME / (varPERSON*TIME + varERROR/n.items)
                      Rc = vars[4,2] / (vars[4,2] + vars[7,2]/length(items)))
    rel[,2:ncol(rel)] <- round(rel[,2:ncol(rel)],2)
    return(rel)
    }else { stop("Error: what argument can be either 'varComp' or 'rel'") }}
```
</p>
</details>

<br>

Level-specific reliability indices are computed from the configural invariance model fitted on the whole dataset, but with the level-2 residual variance of item `worry` being constrained to the 15% of its total variance at level 2.
```{r warning=FALSE,message=FALSE}
# MCFA-based reliability
(omega <- data.frame(measure="Psychological distress",
                     omega_w=MCFArel(fit=fit.conf.fix,level=1,items=1:3,
                                     item.labels=c("stress","worry","mood")),
                     omega_b=MCFArel(fit=fit.conf.fix,level=2,items=1:3,
                                     item.labels=c("stress","worry","mood"))))

# G-Theory-based reliability
GTHEORYrel(data=dailyDiary,items=c(which(colnames(dailyDiary)=="stress"),
                                   which(colnames(dailyDiary)=="worry"),
                                   which(colnames(dailyDiary)=="mood")),
           latent.lab="Psychological distress",what="rel")
```

<br>

*Comments:*

- overall, MCFA-based reliability indices are **quite satisfactory** (> .65) although not optimal

- G-Theory-based reliability indices show similar results, with **relatively low although acceptable** between-participants reliability (R1F) and sensitivity to change (Rc)

<br>

## 2.4. Overall conclusion

Although the Psychological Distress scale presents **some problems** (i.e., Heywood case in the configural model, high SRMR between in the weak invariance model suggesting **different factor loadings across levels**, acceptable but not optimal reliability within-subject), it might **work sufficiently well as a continuous measure of psychological distress**.

<br>

## 2.5. Aggregate score

Here, we compute the aggregate `PsyDist` score by averaging the three item scores.
```{r warning=FALSE,message=FALSE,fig.width=10,fig.height=4}
# computing aggregated score
ema$PsyDist <- apply(ema[,c("stress","worry","mood")],1,mean)

# sorting columns
AD <- which(colnames(ema)=="mood")
ema <- ema[,c(1:AD,ncol(ema),ncol(ema)-2,ncol(ema)-1,(AD+1):(ncol(ema)-3))]

# plotting single items vs. aggregate score
grid.arrange(ggplot(ema,aes(stress))+geom_histogram()+ggtitle("stress"),
             ggplot(ema,aes(worry))+geom_histogram()+ggtitle("worry"),
             ggplot(ema,aes(mood))+geom_histogram()+ggtitle("mood"),
             ggplot(ema,aes(PsyDist))+geom_histogram(fill="red")+ggtitle("PsyDist"),nrow=2)

# plotting aggregate score vs. aggregate factor score
ggplot(ema,aes(PsyDist)) + geom_histogram(binwidth=0.1) + 
  geom_histogram(aes(fs,binwidth=0.1),fill=rgb(1,0,0,alpha=0.5)) +
  ggtitle("PsyDist: Observed aggregated scores (black) vs. Aggregated factor scores (red)")
```

<br>

# 3. Descriptives

Here, we summarize and visual inspect each considered variable.

<br>

## 3.1. Sample description

First, we summarize the categorical and continuous **demographic variables** in the `demos` dataset: `sex`, `insomnia`, and `insomnia.group`.
```{r }
# summarizing demographics
summary(demos[,c("sex","insomnia","insomnia.group")])

# sex by insomnia
table(demos[,c("sex","insomnia")])

# sex by insomnia.group
table(demos[,c("sex","insomnia.group")])

# age & BMI
cat("age mean =",mean(demos$age)," sd =",sd(demos$age)," min =",min(demos$age)," max =",max(demos$age),
    "\nBMI mean =",mean(demos$BMI)," sd =",sd(demos$BMI)," min =",min(demos$BMI)," max =",max(demos$BMI))
```

<br>

*Comments*:

- the sample includes 93 adolescents aged from 15.81 to 19.70 years (mean age = 17.91, SD = 0.95; 59 girls, 63%; mean BMI = 21.82, SD = 3.21)

- 47 adolescents (31 girls; 67%) are in the `insomnia` group, whereas 46 (28 girls; 61%) are in the `control` group

- 26 adolescents (20 girls; 77%) met full DSM-5 criteria for insomnia disorder, whereas 21 adolescents (10 girls; 48%) met all the DSM-5 criteria for insomnia disorder except for weekly frequency

<br>

Then, we report the **data collection period** as indexed by the date of the first and last data point.
```{r }
# data collection beginning and end
cat("Start:",as.character(min(ema$ActivityDate))," Stop:",as.character(max(ema$ActivityDate)))
```

<br>

## 3.2. Compliance & response rate

Here, we describe the participants' compliance and response rate for each class of variables.
```{r }
# computing response rate and compliance
compliance <- demos[,c("ID","insomnia")]
compVars <- c("TIB","rem.p","HR_REM","TotalSteps","stress")
for(i in 1:nrow(compliance)){ IDdata <- ema[ema$ID==as.character(compliance[i,"ID"]),]
  for(Var in compVars){ colnames(IDdata)[which(colnames(IDdata)==Var)] <- "Var"
    IDdata.TIB <- IDdata[!is.na(IDdata$TIB),]
    IDdata.DD <- IDdata[!is.na(IDdata$stress),]
    compliance[i,paste(Var,"No",sep=".")] <- nrow(IDdata[!is.na(IDdata$Var),]) # No. of valid data entries per participant
    compliance[i,paste(Var,"RR",sep=".")] <- 100*nrow(IDdata[!is.na(IDdata$Var),])/60 # response rate over 60 days
    compliance[i,paste(Var,"RR.sleep",sep=".")] <- 100*nrow(IDdata.TIB[!is.na(IDdata.TIB$Var),])/nrow(IDdata.TIB) # RR over sleep data
    compliance[i,paste(Var,"RR.diary",sep=".")] <- 100*nrow(IDdata.DD[!is.na(IDdata.DD$Var),])/nrow(IDdata.DD) # RR over diary ratings
    colnames(IDdata)[which(colnames(IDdata)=="Var")] <- Var }}

# adjusting compliance (100% when = or > 60)
compliance$TIB.RR.sleep <- compliance$stress.RR.diary <- 100
for(Var in paste(compVars,"No",sep=".")){ colnames(compliance)[which(colnames(compliance)==Var)] <- "Var"
  if(any(compliance$Var>60)){
    cat("\n\n",nrow(compliance[compliance$Var>60,]),"participants with more than 60 days of",gsub("No","",Var),"(from",
        min(compliance[compliance$Var>60,"Var"]),"to",max(compliance[compliance$Var>60,"Var"]),")")
    compliance[compliance$Var>60,gsub("No","RR",Var)] <- 100 } # fixing response rate to 100
   colnames(compliance)[which(colnames(compliance)=="Var")] <- Var }

# computing compliance info relative to sleep.archit
TIBok <- ema[!is.na(ema$TIB),]
cat(nrow(TIBok),"valid sleep periods:\n",
    " - mean No. per participants =",round(mean(compliance$TIB.No),1),"SD =",round(sd(compliance$TIB.No),1),
    "mean response rate =",round(mean(compliance$TIB.RR),1),"% SD =",round(sd(compliance$TIB.RR),1),"%")
for(Var in compVars){ colnames(TIBok)[which(colnames(TIBok)==Var)] <- "Var"
  colnames(compliance)[which(colnames(compliance)==paste(Var,"RR.sleep",sep="."))] <- "Var"
  cat("\n - ",nrow(TIBok[!is.na(TIBok$Var),]),"also including",Var,"(",
      round(100*nrow(TIBok[!is.na(TIBok$Var),])/nrow(TIBok),1),"%, mean =",
      round(mean(compliance$Var),1),"% SD =",round(sd(compliance$Var),1),"% )")
  colnames(TIBok)[which(colnames(TIBok)=="Var")] <- Var
  colnames(compliance)[which(colnames(compliance)=="Var")] <- paste(Var,"RR.sleep",sep=".") }

# computing compliance info relative to diary ratings
DIARYok <- ema[!is.na(ema$stress),]
cat(nrow(DIARYok),"valid diary entries:\n",
    " - mean No. per participants =",round(mean(compliance$stress.No),1),"SD =",round(sd(compliance$stress.No),1),
    "mean response rate =",round(mean(compliance$stress.RR),1),"% SD =",round(sd(compliance$stress.RR),1),"%")
for(Var in compVars){ colnames(DIARYok)[which(colnames(DIARYok)==Var)] <- "Var"
  colnames(compliance)[which(colnames(compliance)==paste(Var,"RR.diary",sep="."))] <- "Var"
  cat("\n - ",nrow(DIARYok[!is.na(DIARYok$Var),]),"also including",Var,"(",
      round(100*nrow(DIARYok[!is.na(DIARYok$Var),])/nrow(DIARYok),1),"%, mean =",
      round(mean(compliance$Var),1),"% SD =",round(sd(compliance$Var),1),"% )")
  colnames(DIARYok)[which(colnames(DIARYok)=="Var")] <- Var
  colnames(compliance)[which(colnames(compliance)=="Var")] <- paste(Var,"RR.diary",sep=".") }

# No. valid diary but not sleep data
cat(nrow(ema[!is.na(ema$stress) & is.na(ema$TIB),]),"cases with valid diary entry but missing sleep data (",
    round(100*nrow(ema[!is.na(ema$stress) & is.na(ema$TIB),])/nrow(ema[!is.na(ema$stress),]),1),"% )")
```

<br>

*Comments:*

- a total of **5,121 valid sleep periods** were obtained from the EMA protocol, corresponding to an **average compliance of 88.5 ± 20.8%** (note that compliance was rounded at 100% for those participant with more than 60 days in any study variable)

- among the valid sleep periods, **85.9%** were associated with valid **sleep staging** information, **84.5%** with valid **NREM/REM HR** data, **84.2%** with valid **daily steps** data, and **84.6%** with valid **daily diary** data 

- **compliance with the diary protocol** was equal to **87.2 ± 15.5%** (note that compliance was rounded at 100% for those participant with more than 60 days in any study variable), with **599** cases of valid diary data without valid sleep data).

<br>

Then, we mark **seven participants with extremely low No. of responses**, that is with less than 14 days of valid observations for any of the data types.
```{r }
# marking cases with less than 14 observations in any focal variable
compliance$majMiss <- 0
compliance[compliance$TIB.No<14 | compliance$rem.p.No<14 | compliance$HR_REM.No<14 | 
             compliance$TotalSteps.No<14 | compliance$stress.No < 14,"majMiss"] <- 1
ema <- plyr::join(ema,compliance[,c("ID","majMiss")],by="ID",type="left")

# showing compliance: majMiss
compliance[compliance$majMiss==1,c(1,2,seq(3,20,by=4))]
```

<br>

## 3.3. Descriptive statistics

Here, we use the `multidesc` function for computing the descriptive statistics (mean, SD and ICC) of level-1 (daily observations) and level-2 variables (demographics), as well as the mean and SD for each group.

<details><summary>**show multidesc**</summary><p>
```{r }
multidesc <- function(long,wide,cluster="S.ID",lv1,lv2,group,group.labels=NA){ require(Rmisc); require(lme4)
  
  out <- data.frame(Measure=lv1[1],
                    N=summarySE(long,lv1[1],na.rm=TRUE)[,2],
                    Mean=paste(round(summarySE(long,lv1[1],na.rm=TRUE)[,3],2)," (",
                               round(summarySE(long,lv1[1],na.rm=TRUE)[,4],2),")",sep=""))
  if(!is.na(group)){
    colnames(long)[which(colnames(long)==group)] <- colnames(wide)[which(colnames(wide)==group)] <- "group"
    long$group <- as.factor(as.character(long$group))
    wide$group <- as.factor(as.character(wide$group))
    groups <- levels(long$group)
    out$Mean1 = paste(round(summarySE(long[long$group==groups[1],],lv1[1],na.rm=TRUE)[,3],2)," (",
                      round(summarySE(long[long$group==groups[1],],lv1[1],na.rm=TRUE)[,4],2),")",sep="")
    out$Mean2 = paste(round(summarySE(long[long$group==groups[2],],lv1[1],na.rm=TRUE)[,3],2)," (",
                      round(summarySE(long[long$group==groups[2],],lv1[1],na.rm=TRUE)[,4],2),")",sep="") }
  
  for(i in 2:length(lv1)){
    if(!is.na(group)){
      out <- rbind(out,
                 data.frame(Measure=lv1[i],
                            N=summarySE(long,lv1[i],na.rm=TRUE)[,2],
                            Mean=paste(round(summarySE(long,lv1[i],na.rm=TRUE)[,3],2)," (",
                                       round(summarySE(long,lv1[i],na.rm=TRUE)[,4],2),")",sep=""),
                            Mean1=paste(round(summarySE(long[long$group==groups[1],],lv1[i],na.rm=TRUE)[,3],2)," (",
                                        round(summarySE(long[long$group==groups[1],],lv1[i],na.rm=TRUE)[,4],2),")",sep=""),
                            Mean2=paste(round(summarySE(long[long$group==groups[2],],lv1[i],na.rm=TRUE)[,3],2)," (",
                                        round(summarySE(long[long$group==groups[2],],lv1[i],na.rm=TRUE)[,4],2),")",sep="")))
    } else {
      out <- rbind(out,
                 data.frame(Measure=lv1[i],
                            N=summarySE(long,lv1[i],na.rm=TRUE)[,2],
                            Mean=paste(round(summarySE(long,lv1[i],na.rm=TRUE)[,3],2)," (",
                                       round(summarySE(long,lv1[i],na.rm=TRUE)[,4],2),")",sep=""))) }}
  
  # demos data
  for(i in 1:length(lv2)){
    if(!is.na(group)){
      out <- rbind(out,
                   data.frame(Measure=lv2[i],
                              N=summarySE(wide,lv2[i],na.rm=TRUE)[,2],
                              Mean=paste(round(summarySE(wide,lv2[i],na.rm=TRUE)[,3],2)," (",
                                         round(summarySE(wide,lv2[i],na.rm=TRUE)[,4],2),")",sep=""),
                              Mean1=paste(round(summarySE(wide[wide$group==groups[1],],lv2[i],na.rm=TRUE)[,3],2)," (",
                                          round(summarySE(wide[wide$group==groups[1],],lv2[i],na.rm=TRUE)[,4],2),")",sep=""),
                              Mean2=paste(round(summarySE(wide[wide$group==groups[2],],lv2[i],na.rm=TRUE)[,3],2)," (",
                                          round(summarySE(wide[wide$group==groups[2],],lv2[i],na.rm=TRUE)[,4],2),")",sep="")))
    } else {
      out <- rbind(out,
                 data.frame(Measure=lv2[i],
                            N=summarySE(wide,lv2[i],na.rm=TRUE)[,2],
                            Mean=paste(round(summarySE(wide,lv2[i],na.rm=TRUE)[,3],2)," (",
                                       round(summarySE(wide,lv2[i],na.rm=TRUE)[,4],2),")",sep=""))) }}
  
  # ICC
  out$ICC <- NA
  for(i in 1:length(lv1)){
    m <- lmer(formula=gsub("var",lv1[i],gsub("ID",cluster,"var~(1|ID)")),data=long) # VAR_between / (VAR_between + VAR_within)
    out[out$Measure==lv1[i],"ICC"] <- round(as.data.frame(lme4::VarCorr(m))[1,4]/
                                              (as.data.frame(lme4::VarCorr(m))[1,4]+as.data.frame(lme4::VarCorr(m))[2,4]),2)}
  rownames(out) <- gsub(".cm","",rownames(out))
  if(!is.na(group)){ if(!is.na(group.labels)){
    colnames(out)[c(which(colnames(out)=="Mean1"),which(colnames(out)=="Mean2"))] <- group.labels 
    } else{ colnames(out)[c(which(colnames(out)=="Mean1"),which(colnames(out)=="Mean2"))] <-  levels(long$group)  }}
  return(out)}
```
</p></details>

```{r warning=FALSE,message=FALSE}
# selecting lv1 continuous variables
lv1 <- c("TIB","TST","WASO","SE","light.p","deep.p","rem.p", # sleep architecture
         "SO.num","WakeUp.num", # sleep timing
         "HR_NREM","HR_REM", # sleep autonomic functioning
         "TotalSteps1000", # steps
         "stress","worry","mood") # self-report

# selecting lv2 continuous variables
lv2 <- c("age","BMI")

# computing descriptive statistics
desc <- multidesc(long=ema,wide=demos,cluster="ID",lv1=lv1,lv2=lv2,
                  group="insomnia",group.labels=c(paste("Control (N =",nrow(demos[demos$insomnia=="0",]),")",sep=""),
                                                  paste("Insomnia (N = ",nrow(demos[demos$insomnia=="1",]),")",sep="")))
knitr::kable(desc)
```

<br>

*Comments:*

- the sample is characterized by an average TIB of about 7.81 +- 1.54 hours, of which about seven hours of `TST` (mean `SE` around 88%)

- similar summary statistics are shown by the two groups

- ICCs vary between .17 and .75, with **sleep-related HR** showing the highest values, whereas none of the remaining variables shows ICC > .50, suggesting that **most of the variance is at the within-individual level**

<br>

## 3.4. Correlations 

Here, we use the `multicorr` function to compute the inter-individual (shown below the main diagonal) and the intra-individual correlations (shown above the main diagonal) between the focal continuous variables.

<details><summary>**show multicorr**</summary>
<p>
```{r echo=TRUE}
multicorr <- function(long,wide,lv1,lv2,cluster="ID"){ require(Hmisc); require(Rmisc)
  
  colnames(long)[which(colnames(long)==cluster)] <- "ID"
  
  # individual means (lv2) of lv1 variables
  for(VAR in lv1){
    wide <- cbind(wide,newVar=summarySE(long,VAR,"ID",na.rm=TRUE)[,3])
    colnames(wide)[which(colnames(wide)=="newVar")] <- paste(VAR,".cm",sep="") }
  
  # joining individual means (lv2) to the long dataset
  long <- plyr::join(long,
                     wide[,c(which(colnames(wide)==cluster),
                             which(colnames(wide)==paste(lv1[1],
                                                         ".cm",sep="")):which(colnames(wide)==paste(lv1[length(lv1)],
                                                                                                    ".cm",sep="")))],
                     type="left",by="ID")
  
  # mean-centered (lv1) values
  for(VAR in lv1){
    long$newVar <- long[,VAR] - long[,paste(VAR,".cm",sep="")]
    colnames(long)[which(colnames(long)=="newVar")] <- paste(VAR,".dm",sep="") }
  
  # between-subjects correlations (all variables)
  out.b <- rcorr(as.matrix(wide[,c(paste(lv1,".cm",sep=""),lv2)]), type = "pearson")
  rb <- round(out.b$r,2)
  rb[lower.tri(rb)] <- NA
  
  # within-participant correlations (HRV and ESM deviations from individual mean)
  out.w <- rcorr(as.matrix(long[,paste(lv1,".dm",sep="")]), type = "pearson")
  rw <- round(out.w$r,2)
  rw[upper.tri(rw)] <- NA
  
  # filling rb empty cells
  rb[1:length(lv1),1:length(lv1)][lower.tri(rb[1:length(lv1),1:length(lv1)])] <- rw[lower.tri(rw)]
  
  rownames(rb) <- gsub(".cm","",rownames(rb))
  
  return(t(rb))}
```
</p></details>

```{r fig.width=12,fig.height=9,message=FALSE,warning=FALSE}
desc <- cbind(desc,
              multicorr(long=ema,wide=demos,cluster="ID",lv1=lv1,lv2=lv2))
rownames(desc) <- desc$Measure
desc$Measure <- NULL
write.csv(desc,"RESULTS/descriptives.csv") # saving result
desc
```

<br>

Correlations are also plotted below (blue = negative, white = uncorrelated, red = positive):
```{r warning=FALSE,message=FALSE,fig.width=12,fig.height=7}
ggplot(melt(as.matrix(desc[,6:ncol(desc)])),aes(x=Var1, y=Var2, fill=value)) + 
    geom_tile() + 
    geom_text(aes(x = Var1, y = Var2, label = round(value,2)),color="black",size=3.5)+
    ggtitle("Correlation Matrix (above = within-individual, below = between-individuals)")+labs(x="",y="")+
    scale_fill_gradient2(low="darkblue",high="#f03b20",mid="white",
                         midpoint=0,limit = c(-1,1), space = "Lab",
                         name="Pearson\nCorrelation",guide="legend",
                         breaks=round(seq(1,-1,length.out = 11),2),
                         minor_breaks=round(seq(1,-1,length.out = 11),2))+
    theme(text=element_text(face="bold",size=10),legend.position="none",
          axis.text.x=element_text(angle=30))
```

<br>

## 3.5. Univariate distributions

Here, we visualize the **univariate distributions** of the focal variables, for each class of variables.

<br>

### 3.5.1. Sleep architecture

Variables describing **sleep architecture** include `TIB` (min), `TST` (min), `WASO` (min), `SE` (%), `light` (%), `deep` (%), and `rem` (%).
```{r fig.width=12,fig.height=6}
# selecting variables
s.archit <- c("TIB","TST","WASO","SE","light.p","deep.p","rem.p")

# plotting
par(mfrow=c(3,3))
for(Var in s.archit){ hist(ema[,Var],main=Var,xlab="",breaks=30) }

# outliers with WASO > 150 min (23 cases)
nrow(ema[!is.na(ema$TIB) & ema$WASO>150,])

# cases with WASO = 0 (SE = 100%) (8 cases)
nrow(ema[!is.na(ema$TIB) & ema$WASO==0,])
```

<br>

*Comments:*

- `s.archit` variables are quite **normally distributed**

- some **univariate outliers** can be highlighted in both `WASO` (23 cases (0.4%) with WASO > 150 min) and `SE` (14 cases (0.3%) with SE < 70%)

- in a few cases (8), `WASO` is equal to zero, with a `SE` of 100%

<br>

### 3.5.2. Sleep timing

**Sleep timing** variables include `SO` (hours since 00:00) and `WakeUp` (hours since 00:00).
```{r fig.width=12,fig.height=3}
# selecting variables
s.timing <- c("SO.num","WakeUp.num")

# plotting
par(mfrow=c(1,2))
for(Var in s.timing){ hist(ema[,Var],main=Var,xlab="",breaks=30) }
```

<br>

*Comments:*

- `s.timing` variables are quite **normally distributed**, with only a few outliers for `WakeUp.num`

<br>

### 3.5.3. Daily variability

**Night-to-night variability in sleep measures** is operationalized as the **squared successive differences** (*SSD*) between consecutive nights in the main `s.archit` (i.e., `TIB`, `TST`, and `WASO`) and `s.timing` variables (i.e., `SO.num` and `WakeUp.num`).
```{r fig.width=12,fig.height=4,warning=FALSE,message=FALSE}
# selecting s.archit and s.timing variables
sleepVars <- c(s.archit[1:3],s.timing)

# computing squared successive differences (SSD)
for(Var in sleepVars){
  for(i in 2:nrow(ema)){
    if(!is.na(ema[i,Var]) & !is.na(ema[i-1,Var])){ # non-missing current and previous day
      if(ema[i,"ID"] == ema[i-1,"ID"] & ema[i,"dayNr"] == ema[i-1,"dayNr"] + 1){ # same ID and consecutive day
        ema[i,paste(Var,"SSD",sep=".")] <- (ema[i,Var] - ema[i-1,Var])^2 }}}}

# plotting
par(mfrow=c(2,3))
s.variab <- paste(sleepVars,"SSD",sep=".")
for(Var in s.variab){ hist(ema[,Var],main=Var,xlab="",breaks=30) }
```

<br>

*Comments:*

- `s.variab` variables are **highly skewed** and **negatively bounded to zero**

<br>

### 3.5.4. Sleep autonomic func.

Among the variables describing **sleep autonomic functioning** we focus on `stageHR_NREM` and `stageHR_REM`.
```{r fig.width=12,fig.height=3}
# selecting variables
s.auton <- c("HR_NREM","HR_REM")

# plotting
par(mfrow=c(1,2))
for(Var in s.auton){ hist(ema[,Var],main=Var,xlab="",breaks=30) }
```

<br>

*Comments:*

- `s.auton` variables are quite **normally distributed**, with a few outliers with *HR* > 90 bmp

<br>

### 3.5.5. TotalSteps

`TotalSteps1000` quantifies the daily thousands of steps.
```{r fig.width=9,fig.height=3}
# plotting
hist(ema[,"TotalSteps1000"],main="TotalSteps1000",xlab="",breaks=30)
```

<br>

*Comments:*

- `TotalSteps1000` is bounded at zero, and positively skewed, with **outliers** showing > 30 thousants of steps per day

<br>

### 3.5.6. Diary ratings

Pre-sleep diary ratings include the `stress`, the `worry` and the `mood` item ratings (from 1 to 5).
```{r fig.width=11,fig.height=3}
# selecting variables
d.ratings <- c("stress","mood","worry")

# plotting
par(mfrow=c(1,3))
for(Var in d.ratings){ hist(ema[,Var],main=Var,xlab="",breaks=30) }
```

<br>

*Comments:*

- all diary ratings are **ordinal variables** with a **negatively skewed** distribution

<br>

Here, we visualize the distributions of the **aggregated scores** and that of the **factor scores** predicted by the configural invariance MCFA model selected above.
```{r fig.width=10,fig.height=6,message=FALSE,warning=FALSE}
# mean centering PsyDist
demos$PsyDist.cm <- summarySE(ema,measurevar="PsyDist",groupvars="ID",na.rm=TRUE)[,3]
ema <- plyr::join(ema,demos[,c("ID","PsyDist.cm")],by="ID",type="left")
ema$PsyDist.mc <- ema$PsyDist - ema$PsyDist.cm

# plotting
grid.arrange(ggplot(ema,aes(PsyDist))+geom_histogram(),ggplot(ema,aes(fs))+geom_histogram(),
             ggplot(ema[!duplicated(ema$ID),],aes(PsyDist.cm))+geom_histogram(),ggplot(demos,aes(fs.b))+geom_histogram(),
             ggplot(ema,aes(PsyDist.mc))+geom_histogram(),ggplot(ema,aes(fs.w))+geom_histogram(),nrow=3)
```

<br>

## 3.6. Bivariate distributions

Then, we visualize the distribution of each focal variable **against categorical predictors**.

<br>

### 3.6.1. Insomnia {.tabset .tabset-fade .tabset-pills}

Here, we explore the distributions of each continuous variable between insomnia and controls, and between the two insomnia sub-groups.

#### INSOMNIA VS CONTROLS {.tabset .tabset-fade .tabset-pills}

##### Demos
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in c("age","BMI")){ 
  print(ggplot(demos,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

##### s.archit
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.archit){ 
  print(ggplot(ema,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **insomnia group** is characterized by a slightly **longer `TIB` and `TST`**, a **slightly lower `SE`**, a slightly **higher `light.p` and lower `REM.p`** than the control group

<br>

##### s.timing
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.timing){ 
  print(ggplot(ema,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **insomnia group** is characterized by a slightly **later `SO`**, and a slightly **later `WakeUp`** times compared to the control group

<br>

##### s.auton
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.auton){ 
  print(ggplot(ema,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the `insomnia` group is characterized by a slightly **lower HR** both in `HR_NREM` and especially in `HR_REM` compared to the control group

<br>

##### s.variab
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# day-level
for(Var in s.variab){ 
  print(ggplot(ema,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4) +
          ylim(0,max(ema[,Var],na.rm=TRUE)/4))} # higher limit fixed to 1/4 of the variable length for better visualization
```

<br>

*Comments:*

- the two groups show **quite similar** night-to-night variability values

<br>

##### TotalSteps1000
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in "TotalSteps1000"){ 
  print(ggplot(ema,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **insomnia group** is characterized by a slightly **lower `TotalSteps1000` count** compared to the control group

<br>

##### Diary ratings
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# item ratings
for(Var in d.ratings){ 
  print(ggplot(ema,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# aggregated scores
for(Var in c("PsyDist.cm","fs.b")){ 
  print(ggplot(demos,aes_string(x="insomnia",y=Var,fill="insomnia")) + ggtitle(paste(Var,"in controls vs. insomnia")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the two groups are **quite similar** in terms of item ratings and aggregated scores

<br>

#### INSOMNIA GROUPS {.tabset .tabset-fade .tabset-pills}

##### Demos
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in c("age","BMI")){ 
  print(ggplot(demos,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

##### s.archit
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.archit){ 
  print(ggplot(ema,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **no substantial differences** are highlighted between **insomnia groups**, with both showing differences from the control group similar to those highlighted above

- `rem.p`` looks slighlty **higher in the `DSM.ins`** group compared to controls

<br>

##### s.timing
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.timing){ 
  print(ggplot(ema,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **no substantial SO differences** are highlighted between **insomnia groups**, whereas the `DSM.ins` group shows **higher `WakeUp.num`** than the control group

<br>

##### s.auton
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.auton){ 
  print(ggplot(ema,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- both `meanHR` and `sleepHR` values computed from the first part of the night show **lower values in the insomnia groups** (especially the *DSM.ins*) compared to the control group (look substantial)

- this is more evident for the DSM-insomnia group, whereas a **bimodal distribution is shown by the sub-insomnia group**

<br>

##### s.variab
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.variab){ 
  print(ggplot(ema,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4) +
          ylim(0,max(ema[,Var],na.rm=TRUE)/4))} # higher limit fixed to 1/4 of the variable length for better visualization
```

<br>

*Comments:*

- the three groups show **quite similar** night-to-night variability values

<br>

##### TotalSteps1000
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in "TotalSteps1000"){ 
  print(ggplot(ema,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **DSM-insomnia group** is characterized by a slightly **lower `TotalSteps` count** compared to the other two groups

<br>

##### Diary ratings
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# item ratings
for(Var in d.ratings){ 
  print(ggplot(ema,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# aggregated scores
for(Var in c("PsyDist.cm","fs.b")){ 
  print(ggplot(demos,aes_string(x="insomnia.group",y=Var,fill="insomnia.group")) + 
          ggtitle(paste(Var,"in controls vs. insomnia groups")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the two groups are **quite similar** in terms of `PsyDist`, although some variables showing **slightly lower values in the sub-insomnia**, and a **slighlty higher values in the DSM-insomnia** compared to the other groups

<br>

### 3.6.2. Sex {.tabset .tabset-fade .tabset-pills}

Here, we explore the distributions of each continuous variable between girls and boys.

#### Demos
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in c("age","BMI")){ 
  print(ggplot(demos,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **girls are slighly older than boys**

<br>

#### s.archit
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.archit){ 
  print(ggplot(ema,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the two groups are **quite similar**, with the exception of a **slighly lower `TST` and `TIB`, and a slightly higher REM.p in boys** compared to girls

<br>

#### s.timing
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.timing){ 
  print(ggplot(ema,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **`SO` is slightly later in boys** compared to girls, whereas **`WakeUp` times are similar**

<br>

#### s.auton
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.auton){ 
  print(ggplot(ema,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **boys show lower nocturnal HR** compared to girls, across all considered variables (looks substantial)

<br>

#### s.variab
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.variab){ 
  print(ggplot(ema,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4) +
          ylim(0,max(ema[,Var],na.rm=TRUE)/4))} # higher limit fixed to 1/4 of the variable length for better visualization
```

<br>

*Comments:*

- the two groups show **similar distributions**

<br>

#### TotalSteps1000
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in "TotalSteps1000"){ 
  print(ggplot(ema,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **no substantial differences** can be highlighted between the two groups

<br>

#### Diary ratings
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# item ratings
for(Var in d.ratings){ 
  print(ggplot(ema,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# aggregated scores
for(Var in c("PsyDist.cm","fs.b")){ 
  print(ggplot(demos,aes_string(x="sex",y=Var,fill="sex")) + ggtitle(paste(Var,"in females vs. males")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the two groups show **quite similar** distributions, although `fs` is **slightly higher in girls** compared to boys

<br>

### 3.6.3. Weekend {.tabset .tabset-fade .tabset-pills}

Here, we explore the explore the differences between cases observed during **weekend vs weekdays**. Both the `weekday` (weekend = Saturday and Sunday) and the `weekday.sleep` variable (weekend = Friday and Saturday) are explored.

#### s.archit
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# weekday
for(Var in s.archit){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }

# weekday.sleep
for(Var in s.archit){ 
  print(ggplot(ema,aes_string(x="weekday.sleep",y=Var,fill="weekday.sleep")) + 
          ggtitle(paste(Var,"in weekdays vs. weekend (FRY-SAT)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4) +
          theme(legend.position = "none")) }
```

<br>

*Comments:*

- **weekend days show slightly longer `TIB` and `TST`** than weekdays, with slightly larger differences when considering **Friday and Saturday** as weekend, rather than Saturday and Sunday

<br>

#### s.timing
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# weekday
for(Var in s.timing){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }

# weekday.sleep
for(Var in s.timing){ 
  print(ggplot(ema,aes_string(x="weekday.sleep",y=Var,fill="weekday.sleep")) + 
          ggtitle(paste(Var,"in weekdays vs. weekend (FRY-SAT)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }
```

<br>

*Comments:*

- **weekend days show later `SO` and `WakeUp` times** compared to weekdays, with **substantially larger differences when considering Friday and Saturday** as weekend, rather than Saturday and Sunday

<br>

#### s.auton
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# weekday
for(Var in s.auton){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }

# weekday.sleep
for(Var in s.auton){ 
  print(ggplot(ema,aes_string(x="weekday.sleep",y=Var,fill="weekday.sleep")) +
          ggtitle(paste(Var,"in weekdays vs. weekend (FRY-SAT)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }
```

<br>

*Comments:*

- weekdays and weekend days are **quite similar** in terms of sleep-related HR

<br>

#### s.variab
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.variab){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4) +
          ylim(0,max(ema[,Var],na.rm=TRUE)/4))} # higher limit fixed to 1/4 of the variable length for better visualization
```

<br>

*Comments:*

- **no substantial differences** can be highlighted between weekdays and weekend days

<br>

#### TotalSteps1000
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# weekday
for(Var in "TotalSteps1000"){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }

# weekday.sleep
for(Var in "TotalSteps1000"){ 
  print(ggplot(ema,aes_string(x="weekday.sleep",y=Var,fill="weekday.sleep")) +
          ggtitle(paste(Var,"in weekdays vs. weekend (FRY-SAT)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)+
          theme(legend.position = "none")) }
```

<br>

*Comments:*

- **weekend days show slightly lower TotalSteps** compared with weekdays, but **only when considering Saturday and Sunday** as weekend

<br>

#### Diary ratings
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# weekday - item ratings
for(Var in d.ratings){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# weekday.sleep - item ratings
for(Var in d.ratings){ 
  print(ggplot(ema,aes_string(x="weekday.sleep",y=Var,fill="weekday.sleep")) + 
          ggtitle(paste(Var,"in weekdays vs. weekend (FRY-SAT)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# weekday - aggregated scores
for(Var in c("PsyDist","fs.w")){ 
  print(ggplot(ema,aes_string(x="weekday",y=Var,fill="weekday")) + ggtitle(paste(Var,"in weekdays vs. weekend (SAT-SUN)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# weekday.sleep - aggregated scores
for(Var in c("PsyDist","fs.w")){ 
  print(ggplot(ema,aes_string(x="weekday.sleep",y=Var,fill="weekday.sleep")) + 
          ggtitle(paste(Var,"in weekdays vs. weekend (FRY-SAT)")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **weekend days show slightly lower `PsyDist`** than weekdays, especially when considering the **factor scores at the within level** with **Friday and Saturday** as weekend days

<br>

### 3.6.4. COVID-19 {.tabset .tabset-fade .tabset-pills}

Here, we explore the differences between cases observed before and during the COVID-19 emergency (i.e., after March 20th, 2020).

#### s.archit
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.archit){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **post-COVID-19** period is associated with **longer `TIB` and `TST`** compared to the pre-COVID-19 period, whereas difference in other `s.archit` variables do not seem substantial

<br>

#### s.timing
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.timing){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- **`SO` and especially `WakeUp` are substantially delayed in the post-COVID-19 period** compared to the pre-COVID-19 period. 

<br>

#### s.auton
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.auton){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **post-COVID-19 period shows slightly lower sleep-related HR** than the pre-COVID-19 period, especially in terms of `stageHR_REM`

<br>

#### s.variab
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in s.variab){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4) +
          ylim(0,max(ema[,Var],na.rm=TRUE)/4))} # higher limit fixed to 1/4 of the variable length for better visualization
```

<br>

*Comments:*

- the two periods show **quite similar** night-to-night variability values

<br>

#### TotalSteps1000
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
for(Var in "TotalSteps1000"){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **post-COVID-19 period shows substantially lower No. of steps** compared to the pre-COVID-19 period

<br>

#### Diary ratings
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# item ratings
for(Var in d.ratings){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# aggregated scores
for(Var in c("PsyDist","fs.w")){ 
  print(ggplot(ema,aes_string(x="covid19",y=Var,fill="covid19")) + ggtitle(paste(Var,"pre- and post-covid19 lockdown")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the **post-COVID-19 period shows slightly higher PsyDist** compared to the pre-COVID-19 period, especially in terms of factor scores

<br>

### 3.6.5. Late responses {.tabset .tabset-fade .tabset-pills}

Finally, we explore the differences between diary ratings obtained **before bedtime** and those obtained **on the following day**.

#### Diary ratings
```{r echo=TRUE,fig.width=5,fig.height=4,warning=FALSE}
# item ratings
ema$diary.nextDay <- as.factor(ema$diary.nextDay)
for(Var in d.ratings){ 
  print(ggplot(ema[!is.na(ema$diary.nextDay),],aes_string(x="diary.nextDay",y=Var,fill="diary.nextDay")) + 
          ggtitle(paste(Var,"bedtime vs. next day diary entries")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }

# aggregated scores
for(Var in c("PsyDist","fs.w")){ 
  print(ggplot(ema[!is.na(ema$diary.nextDay),],aes_string(x="diary.nextDay",y=Var,fill="diary.nextDay")) + 
          ggtitle(paste(Var,"bedtime vs. next day diary entries")) +
          geom_point(col="gray",position = position_jitter(width = .15)) + geom_violin(alpha=.4)) }
```

<br>

*Comments:*

- the distributions of diary ratings are **quite similar** when entered before bedtime or on the following day

<br>

## 3.7. Stress, Mood, & Worry

Here, we descriptively characterize the sample and the subgroups of participants (based on `sex`, `insomnia`, and `insomnia.group`) in terms of pre-sleep `stress`, `worry`, and `mood` as well as in terms of sources of `stress` and `worry`.

<br>

### 3.7.1. Stress

Here, we describe the `stress` variable in the sample, and across the subgroups of participants.
```{r echo=TRUE,fig.width=11,fig.height=6,warning=FALSE,message=FALSE}
# plotting
grid.arrange(ggplot(ema[!is.na(ema$stress),],aes(x=as.factor(stress))) + geom_histogram(stat="count") + ggtitle("stress in the sample") + 
               geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat = "count", vjust = -0.25) + ylim(0,1700),
             ggplot(ema,aes(stress,fill=sex)) + geom_histogram(position=position_dodge(0.5)),
             ggplot(ema,aes(stress,fill=insomnia)) + geom_histogram(position=position_dodge(0.5)),
             ggplot(ema,aes(stress,fill=insomnia.group)) +  geom_histogram(position=position_dodge(0.5)),nrow=2)

# computing mean and SD in the sample and by group
summarySE(ema,measurevar="stress",na.rm=TRUE)[,1:4] # stress in the sample
summarySE(ema,measurevar="stress",groupvars="sex",na.rm=TRUE)[,1:4] # stress by sex
summarySE(ema,measurevar="stress",groupvars="insomnia",na.rm=TRUE)[,1:4] # stress by insomnia
summarySE(ema,measurevar="stress",groupvars="insomnia.group",na.rm=TRUE)[,1:4] # stress by insomnia.group

# very or extremely stressful
ema[!is.na(ema$stress) & ema$stress<4,"stress.VE"] <- 0
ema[!is.na(ema$stress) & ema$stress>=4,"stress.VE"] <- 1
ema$stress.VE <- as.factor(ema$stress.VE)
df <- ema[!is.na(ema$stress),]
grid.arrange(ggplot(df,aes(x=stress.VE)) + geom_histogram(stat="count") + 
               ggtitle("very/estremely stressed in the sample") + ylim(0,4500) +
               geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = -0.25),
             ggplot(df,aes(stress.VE,fill=sex)) + geom_histogram(stat="count",position=position_dodge(0.5)),
             ggplot(df,aes(stress.VE,fill=insomnia)) + geom_histogram(stat="count",position=position_dodge(0.5)),
             ggplot(df,aes(stress.VE,fill=insomnia.group)) +  geom_histogram(stat="count",position=position_dodge(0.5)),nrow=2)

# summarizing stress.VE
cat(nrow(df[df$stress.VE==1,]),"cases with very or extreme stress,",
    round(100*nrow(df[df$stress.VE==1,])/nrow(df),2),"%\n",
    nrow(df[df$insomnia==0 & df$stress.VE==1,]),"cases with very or extreme stress controls ratings,",
    round(100*nrow(df[df$insomnia==0 & df$stress.VE==1,])/nrow(df[df$insomnia==1,]),2),"% of controls ratings\n",
    nrow(df[df$insomnia==1 & df$stress.VE==1,]),"cases with very or extreme stress insomnia ratings,",
    round(100*nrow(df[df$insomnia==1 & df$stress.VE==1,])/nrow(df[df$insomnia==1,]),2),"% of insomnia ratings")
```

<br>

*Comments:*

- in the **12.3% of the days adolescents reported being 'very' or 'extremely stressed'**, with slightly higher percentages in `insomnia` (15%) than in controls (9%)

<br>

### 3.7.2. stress sources

Here, we describe the sources reported by participants for the `stress` variable in the sample, and across the subgroups of participants. Note that many responses are missing, with unbalanced numbers of missing responses for each category. Here, we recode all categories (with the exception of `stress_COVID`, that was added later than the others, and thus not considered in the present analyses) by **giving value zero when the score to one or more of the remaining categories was not missing**.
```{r echo=TRUE,fig.width=5,fig.height=3,warning=FALSE,message=FALSE}
# showing summary (original)
ema$stress_COVID <- NULL # removing stress_COVID
stressSources <- colnames(ema)[which(substr(colnames(ema),1,7)=="stress_")]
summary(ema[!is.na(ema$stress),stressSources])

# assigning zero when 1+ of the other scores are not missing
ema[,stressSources] <- lapply(ema[,stressSources],as.character) # from factor to numeric
ema[,stressSources] <- lapply(ema[,stressSources],as.numeric)
ema$stress_total <- rowSums(ema[,stressSources],na.rm=TRUE) # computing total score
ema[is.na(ema$stress_school) & !is.na(ema$stress_total),"stress_school"] <- 0
ema[is.na(ema$stress_family) & !is.na(ema$stress_total),"stress_family"] <- 0
ema[is.na(ema$stress_health) & !is.na(ema$stress_total),"stress_health"] <- 0
ema[is.na(ema$stress_peers) & !is.na(ema$stress_total),"stress_peers"] <- 0
ema[is.na(ema$stress_other) & !is.na(ema$stress_total),"stress_other"] <- 0
ema[,stressSources] <- lapply(ema[,stressSources],as.factor) # back to factor

# showing summary (updated)
summary(ema[!is.na(ema$stress),stressSources])

# plotting variables in the sample
for(Var in stressSources){
  print(ggplot(ema[!is.na(ema$stress),],aes_string(x=Var)) + geom_histogram(stat="count",fill="gray") + 
               ggtitle(paste(Var,"in the sample")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = 1.2))}

# plotting variables only in cases with stress > 1
for(Var in stressSources){
  print(ggplot(ema[!is.na(ema$stress) & ema$stress>1,],aes_string(x=Var)) + geom_histogram(stat="count",fill="yellow") + 
               ggtitle(paste(Var,"in the sample when stress > 1")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = 1.2))}

# plotting variables only in cases with stress = Very or Extremely stressed
for(Var in stressSources){
  print(ggplot(ema[!is.na(ema$stress) & ema$stress>3,],aes_string(x=Var)) + geom_histogram(stat="count",fill="red") + 
               ggtitle(paste(Var,"in the sample when stress > 3")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = 1.2))}
```

<br>

*Comments*:

- the most frequently reported sources of stress are ***school*** (63% of times with `stress` > 1, 70% of times with `stress` > 3) and ***other*** (38% of times with `stress` > 1, 44% of times with `stress` > 3).

<br>

Finally, we visualize the frequency of each source of stress by `sex`, `insomnia`, and `insomnia.group`.
```{r echo=TRUE,fig.width=5,fig.height=3,warning=FALSE,message=FALSE}
# plotting variables by sex
for(Var in stressSources){
  print(ggplot(ema[!is.na(ema$stress) & ema$stress > 1,],aes_string(x="sex",fill=Var)) + 
          geom_histogram(stat="count",position="dodge") + ggtitle(paste(Var,"by sex")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))),stat="count", vjust = 1.2,position="identity"))}

# plotting variables by insomnia
for(Var in stressSources){
  print(ggplot(ema[!is.na(ema$stress) & ema$stress > 1,],aes_string(x="insomnia",fill=Var)) + 
          geom_histogram(stat="count",position="dodge") + ggtitle(paste(Var,"by insomnia")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))),stat="count", vjust = 1.2,position="identity"))}

# plotting variables by insomnia.group
for(Var in stressSources){
  print(ggplot(ema[!is.na(ema$stress) & ema$stress > 1,],aes_string(x="insomnia.group",fill=Var)) + 
          geom_histogram(stat="count",position="dodge") + ggtitle(paste(Var,"by insomnia.group")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))),stat="count", vjust = 1.2,position="identity"))}
```

<br>

### 3.7.3. worry

Here, we describe the `worry` variable in the sample, and across the subgroups of participants.
```{r echo=TRUE,fig.width=11,fig.height=6,warning=FALSE,message=FALSE}
# plotting
grid.arrange(ggplot(ema[!is.na(ema$worry),],aes(x=as.factor(worry))) + geom_histogram(stat="count") + 
               ggtitle("worry in the sample") + 
               geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat = "count", vjust = -0.25) + ylim(0,1700),
             ggplot(ema,aes(worry,fill=sex)) + geom_histogram(position=position_dodge(0.5)),
             ggplot(ema,aes(worry,fill=insomnia)) + geom_histogram(position=position_dodge(0.5)),
             ggplot(ema,aes(worry,fill=insomnia.group)) +  geom_histogram(position=position_dodge(0.5)),nrow=2)

# computing mean and SD in the sample and by group
summarySE(ema,measurevar="worry",na.rm=TRUE)[,1:4] # worry in the sample
summarySE(ema,measurevar="worry",groupvars="sex",na.rm=TRUE)[,1:4] # worry by sex
summarySE(ema,measurevar="worry",groupvars="insomnia",na.rm=TRUE)[,1:4] # worry by insomnia
summarySE(ema,measurevar="worry",groupvars="insomnia.group",na.rm=TRUE)[,1:4] # worry by insomnia.group

# very or extremely stressful
ema[!is.na(ema$worry) & ema$worry<4,"worry.VE"] <- 0
ema[!is.na(ema$worry) & ema$worry>=4,"worry.VE"] <- 1
ema$worry.VE <- as.factor(ema$worry.VE)
df <- ema[!is.na(ema$worry),]
grid.arrange(ggplot(df,aes(x=worry.VE)) + geom_histogram(stat="count") + 
               ggtitle("worry in the sample") + ylim(0,4500) +
               geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = -0.25),
             ggplot(df,aes(worry.VE,fill=sex)) + geom_histogram(stat="count",position=position_dodge(0.5)),
             ggplot(df,aes(worry.VE,fill=insomnia)) + geom_histogram(stat="count",position=position_dodge(0.5)),
             ggplot(df,aes(worry.VE,fill=insomnia.group)) +  geom_histogram(stat="count",position=position_dodge(0.5)),nrow=2)

# summarizing worry.VE
cat(nrow(df[df$worry.VE==1,]),"cases with very or extreme worry,",
    round(100*nrow(df[df$worry.VE==1,])/nrow(df),2),"%\n",
    nrow(df[df$insomnia==0 & df$worry.VE==1,]),"cases with very or extreme worry controls ratings,",
    round(100*nrow(df[df$insomnia==0 & df$worry.VE==1,])/nrow(df[df$insomnia==1,]),2),"% of controls ratings\n",
    nrow(df[df$insomnia==1 & df$worry.VE==1,]),"cases with very or extreme worry insomnia ratings,",
    round(100*nrow(df[df$insomnia==1 & df$worry.VE==1,])/nrow(df[df$insomnia==1,]),2),"% of insomnia ratings")
```

<br>

*Comments:*

- in the **12.6% of the days adolescents reported being 'very' or 'extremely worried'**, with slightly higher percentages in `insomnia` (14%) than in controls (10%)

<br>

### 3.7.4. worry sources

Here, we describe the sources reported by participants for the `worry` variable in the sample, and across the subgroups of participants. Note that many responses are missing, with unbalanced numbers of missing responses for each category. Here, we recode all categories (with the exception of `stress_COVID`, that was added later than the others) by **giving value zero when the score to one or more of the remaining categories was not missing**.
```{r echo=TRUE,fig.width=5,fig.height=3,warning=FALSE,message=FALSE}
# showing summary (original)
ema$worry_COVID <- NULL # removing worry_COVID
worrySources <- colnames(ema)[which(substr(colnames(ema),1,6)=="worry_")]
summary(ema[!is.na(ema$worry),worrySources])

# assigning zero when other scores are not missing
ema[,worrySources] <- lapply(ema[,worrySources],as.character) # from factor to numeric
ema[,worrySources] <- lapply(ema[,worrySources],as.numeric)
ema$worry_total <- rowSums(ema[,worrySources],na.rm=TRUE) # computing total score
ema[is.na(ema$worry_school) & !is.na(ema$worry_total),"worry_school"] <- 0
ema[is.na(ema$worry_family) & !is.na(ema$worry_total),"worry_family"] <- 0
ema[is.na(ema$worry_health) & !is.na(ema$worry_total),"worry_health"] <- 0
ema[is.na(ema$worry_peer) & !is.na(ema$worry_total),"worry_peer"] <- 0
ema[is.na(ema$worry_sleep) & !is.na(ema$worry_total),"worry_sleep"] <- 0
ema[is.na(ema$worry_other) & !is.na(ema$worry_total),"worry_other"] <- 0
ema[,worrySources] <- lapply(ema[,worrySources],as.factor) # back to factor

# showing summary (updated)
summary(ema[!is.na(ema$worry),worrySources])

# plotting variables in the sample
for(Var in worrySources){
  print(ggplot(ema[!is.na(ema$worry),],aes_string(x=Var)) + geom_histogram(stat="count",fill="gray") + 
               ggtitle(paste(Var,"in the sample")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = 1.2))}

# plotting variables only in cases with worry > 1
for(Var in worrySources){
  print(ggplot(ema[!is.na(ema$worry) & ema$worry>1,],aes_string(x=Var)) + geom_histogram(stat="count",fill="yellow") + 
               ggtitle(paste(Var,"in the sample when worry > 1")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = 1.2))}

# plotting variables only in cases with worry = Very or Extremely stressed
for(Var in worrySources){
  print(ggplot(ema[!is.na(ema$worry) & ema$worry>3,],aes_string(x=Var)) + geom_histogram(stat="count",fill="red") + 
               ggtitle(paste(Var,"in the sample when worry > 3")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = 1.2))}
```

<br>

*Comments*:

- the most frequently reported sources of stress are ***school*** (66% of times with `worry` > 1, 76% of times with `worry` > 3) and ***other*** (38% of times with `worry` > 1, 43% of times with `worry` > 3).

<br>

Here, we plot the frequency of each source of stress by `sex`, `insomnia`, and `insomnia.group`.
```{r echo=TRUE,fig.width=5,fig.height=3,warning=FALSE,message=FALSE}
# plotting variables by sex
for(Var in worrySources){
  print(ggplot(ema[!is.na(ema$worry) & ema$worry > 1,],aes_string(x="sex",fill=Var)) + 
          geom_histogram(stat="count",position="dodge") + ggtitle(paste(Var,"by sex")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))),stat="count", vjust = 1.2,position="identity"))}

# plotting variables by insomnia
for(Var in worrySources){
  print(ggplot(ema[!is.na(ema$worry) & ema$worry > 1,],aes_string(x="insomnia",fill=Var)) + 
          geom_histogram(stat="count",position="dodge") + ggtitle(paste(Var,"by insomnia")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))),stat="count", vjust = 1.2,position="identity"))}

# plotting variables by insomnia.group
for(Var in worrySources){
  print(ggplot(ema[!is.na(ema$worry) & ema$worry > 1,],aes_string(x="insomnia.group",fill=Var)) + 
          geom_histogram(stat="count",position="dodge") + ggtitle(paste(Var,"by insomnia.group")) +
          geom_text(aes(label = scales::percent((..count..)/sum(..count..))),stat="count", vjust = 1.2,position="identity"))}
```

<br>

### 3.7.5. Sources of stress & worry

Here, we generate an aggregate plot integrating stress source, stress level, and group comparisons.
```{r echo=TRUE,fig.width=6,fig.height=4,warning=FALSE,message=FALSE}
# stress
ss.df <- ema[!is.na(ema$stress) & ema$stress>1,] # selecting data
ss.df$stressSource <- "Multiple" # Multiple sources when stress_total > 1
ss.df[ss.df$stress_school==1 & ss.df$stress_total==1,"stressSource"] <- "School" # single source only when stress_total = 1
ss.df[ss.df$stress_family==1 & ss.df$stress_total==1,"stressSource"] <- "Family"
ss.df[ss.df$stress_peers==1 & ss.df$stress_total==1,"stressSource"] <- "Peers"
ss.df[ss.df$stress_health==1 & ss.df$stress_total==1,"stressSource"] <- "Health"
ss.df[ss.df$stress_other==1 & ss.df$stress_total==1,"stressSource"] <- "Other"
ss.df[ss.df$stress_total==0,"stressSource"] <- "Other" # other when unspecified source of stress (N = 25)
ss.df$stressSource <- factor(ss.df$stressSource,levels=c("School","Family","Peers","Health","Other","Multiple"))
ss.df$Stress <- "Not so/somwhat stressful" # recoding stress in two categories
ss.df[ss.df$stress>3,"Stress"] <- "Very/Extremely stressful"
ss.df$Stress <- factor(ss.df$Stress,levels=c("Very/Extremely stressful","Not so/somwhat stressful"))
ss.df$insomnia <- as.factor(gsub("0","Controls",gsub("1","Insomnia",ss.df$insomnia))) # recoding insomnia for plotting
p1 <- ggplot(ss.df, aes(stressSource, fill = Stress)) + geom_histogram(stat="count") + # plotting
  facet_wrap("insomnia") + labs(y="No. of observations") + guides(fill=guide_legend(title="Daily stress")) + 
  theme(axis.text.x = element_text(angle=45),axis.title.x=element_blank())

# worry
ws.df <- ema[!is.na(ema$worry) & ema$worry>1,] # selecting data
ws.df$worrySource <- "Multiple" # Multiple sources when worry_total > 1
ws.df[ws.df$worry_school==1 & ws.df$worry_total==1,"worrySource"] <- "School"
ws.df[ws.df$worry_family==1 & ws.df$worry_total==1,"worrySource"] <- "Family"
ws.df[ws.df$worry_peer==1 & ws.df$worry_total==1,"worrySource"] <- "Peers"
ws.df[ws.df$worry_health==1 & ws.df$worry_total==1,"worrySource"] <- "Health"
ws.df[ws.df$worry_sleep==1 & ws.df$worry_total==1,"worrySource"] <- "Sleep"
ws.df[ws.df$worry_other==1 & ws.df$worry_total==1,"worrySource"] <- "Other"
ws.df[ws.df$worry_total==0,"worrySource"] <- "Other" # other when unspecified source of worry (N = 25)
ws.df$worrySource <- factor(ws.df$worrySource,levels=c("School","Family","Peers","Health","Sleep","Other","Multiple"))
ws.df$Worry <- "Not so/somwhat worried" # recoding worry in two categories
ws.df[ws.df$worry>3,"Worry"] <- "Very/Extremely worried"
ws.df$Worry <- factor(ws.df$Worry,levels=c("Very/Extremely worried","Not so/somwhat worried"))
ws.df$insomnia <- as.factor(gsub("0","Controls",gsub("1","Insomnia",ws.df$insomnia))) # recoding insomnia for plotting
p2 <- ggplot(ws.df, aes(worrySource, fill = Worry)) + geom_histogram(stat="count") + # plotting
  facet_wrap("insomnia") + labs(y="No. of observations") + guides(fill=guide_legend(title="Pre-sleep worry")) + 
  theme(axis.text.x = element_text(angle=45),axis.title.x=element_blank())

# final plot
p <- grid.arrange(p1,p2,nrow=2)
ggsave(filename="RESULTS/Figure2.tiff",plot=p,dpi=500)
```

<br>

### 3.7.6. mood

Here, we describe the `mood` variable in the sample, and across the subgroups of participants.
```{r echo=TRUE,fig.width=11,fig.height=6,warning=FALSE,message=FALSE}
# plotting
grid.arrange(ggplot(ema[!is.na(ema$mood),],aes(x=as.factor(mood))) + geom_histogram(stat="count") + 
               ggtitle("mood in the sample") + 
               geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat = "count", vjust = -0.25),
             ggplot(ema,aes(mood,fill=sex)) + geom_histogram(position=position_dodge(0.5)),
             ggplot(ema,aes(mood,fill=insomnia)) + geom_histogram(position=position_dodge(0.5)),
             ggplot(ema,aes(mood,fill=insomnia.group)) +  geom_histogram(position=position_dodge(0.5)),nrow=2)

# computing mean and SD in the sample and by group
summarySE(ema,measurevar="mood",na.rm=TRUE)[,1:4] # mood in the sample
summarySE(ema,measurevar="mood",groupvars="sex",na.rm=TRUE)[,1:4] # mood by sex
summarySE(ema,measurevar="mood",groupvars="insomnia",na.rm=TRUE)[,1:4] # mood by insomnia
summarySE(ema,measurevar="mood",groupvars="insomnia.group",na.rm=TRUE)[,1:4] # mood by insomnia.group

# somehow bad/bad mood
ema[!is.na(ema$mood) & ema$mood<4,"mood.VE"] <- 0
ema[!is.na(ema$mood) & ema$mood>=4,"mood.VE"] <- 1
ema$mood.VE <- as.factor(ema$mood.VE)
df <- ema[!is.na(ema$mood),]
grid.arrange(ggplot(df,aes(x=mood.VE)) + geom_histogram(stat="count") + 
               ggtitle("mood in the sample") + ylim(0,4500) +
               geom_text(aes(label = scales::percent((..count..)/sum(..count..))), stat="count", vjust = -0.25),
             ggplot(df,aes(mood.VE,fill=sex)) + geom_histogram(stat="count",position=position_dodge(0.5)),
             ggplot(df,aes(mood.VE,fill=insomnia)) + geom_histogram(stat="count",position=position_dodge(0.5)),
             ggplot(df,aes(mood.VE,fill=insomnia.group)) +  geom_histogram(stat="count",position=position_dodge(0.5)),nrow=2)

# summarizing mood.VE
cat(nrow(df[df$mood.VE==1,]),"cases with very or extreme mood,",
    round(100*nrow(df[df$mood.VE==1,])/nrow(df),2),"%\n",
    nrow(df[df$insomnia==0 & df$mood.VE==1,]),"cases with very or extreme mood controls ratings,",
    round(100*nrow(df[df$insomnia==0 & df$mood.VE==1,])/nrow(df[df$insomnia==1,]),2),"% of controls ratings\n",
    nrow(df[df$insomnia==1 & df$mood.VE==1,]),"cases with very or extreme mood insomnia ratings,",
    round(100*nrow(df[df$insomnia==1 & df$mood.VE==1,])/nrow(df[df$insomnia==1,]),2),"% of insomnia ratings")
```

<br>

*Comments:*

- in the **14.46% of the days adolescents reported being 'somehow bad' or 'bad' mood**, with slightly higher percentages in `insomnia` (14.63%) than in controls (13.49%)

<br>

# 4. Modeling

Here, we use **generalized linear mixed-effects regression** (GLMER) models to examine the following relationships:

1. `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables are predicted by meaningful covariates (Model M1: `SO.num`, `TotalSteps1000`, `weekday`, and `BMI`), the `insomnia` group (M2), participants' `sex` (M3), and the interaction between `sex` and `insomnia` groups (M4), in order to **characterize sleep between groups**

2. daily diary ratings (`stress`, `worry`, and `mood`) and the aggregate ratings (`PsyDist` and `fs`) are predicted by meaningful covariates (M1: `TotalSteps1000` and `weekday`), the `insomnia` group (M2), participants' `sex` (M3), and the interaction between `sex` and `insomnia` groups (M4), in order to **characterize stress, worry, and mood between groups**

3. `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables measured at day *i* are predicted by the predictors selected in step 1 in addition to the diary ratings (`stress`, `worry`, `mood`, `PsyDist`, and `fs`) measured at day *i* (M5), and diary ratings measured at day *i+1* (M6), in order to **evaluate the direct and bidirectional relationship between sleep and psychological distress**. Finally, the interaction between diary ratings and *insomnia* is included in model M7

<br>

For each step and each outcome variable, models are specified by using alternative distribution families based on the nature of the outcome, inspected to evaluate **model fit**, **compared** in terms of likelihood and strength of evidence, and inspected to check the results of the selected model.

Note that all **level-1** continuous predictors are centered to the individual mean (**mean-centered**, `mc`), whereas all **level-2** continuous predictors are centered to the grand average (**grand-mean-centered**, `gmc`***`).

Finally, several **robustness checks** are performed to account for the arbitrariness of data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the `insomnia` variable, (2) the inclusion of `covid19` as a further covariate, (3) the exclusion of participants with extreme missing data (`majMiss`), (4) the exclusion of the `TotalSteps1000` variable from the analyses, (5) the use of **alternative family distributions** for those variables not showing optimal fit, and (6) the exclusion of diary ratings entered on the following day (`lateResp`).

The following R packages and functions are used.
```{r message=FALSE,warning=FALSE}
library(lme4); library(ordinal); library(reshape2); library(MuMIn); library(sjPlot); library(ggplot2); library(Rmisc);
```

<details><summary>**glmerAn**</summary>
<p>
```{r }
#' @title Generalized linear (mixed-effects) regression analysis
#' @param modelType = type of model: GLM, mixed-effects (GLMER), or cumulative link mixedm odel (CLMM)
#' @param long = long-form dataset (data.frame) considered if modelType = GLMER or CLMM
#' @param wide = wide-form dataset (data.frame) 
#' @param resp = name of the response variable (character)
#' @param fix.eff = character vector of names of the predictor(s)
#' @param cluster.ID = name of the cluster variable considered if modelType = GLMER or CLMM (default: "ID")
#' @param timeVar = name of the variable indexing time, considered if modelType = GLMER (defult: "ActivityDate")
#' @param REML = argument from the lme4::lmer() function, see ?lmer
#' @param ran.eff = character string indicating the random effect by using the lme4 syntax (defult: "(1|ID)")
#' @param family = character string indicating the name of the GLM(ER) family to be used in the models (default: "normal")
#' @param link =character string indicating the name of the GLM(ER) link function to be used in the models (default: "identity")
#' @param nAGQ = argument from the lme4::glmer() function, see ?glmer
#' @param mc.predictors = character vector of names of the predictors to be mean-centered
#' @param gmc.predictors = character vector of names of the predictors to be grand-mean-centered
#' @param outputs = character vector of the desired otucomes: "fit" for model diagnostics, "mComp" for model comparison, "coeff" for the coefficient table, "plotEff" for the effect plot(s), and "key.res" for the key results
#' @param coeff.models = name of the predictor(s) whose corresponding model(s) should be considered for the "coeff" output
#' @param transform = argument from sjPlot::tab_model(), see ?tab_model
#' @param coeff.models = model(s) to be considered for the "coeff" output
#' @param plot.model = name of the predictor(s) whose model(s) should be considered for the "plotEff" output
#' @param plot.pred = name of the predictor(s) to be plotted
#' @param show.data = argument from sjPlot::plot_model(), see ?plot_model
#' @param dot.size = argument from sjPlot::plot_model(), see ?plot_model
#' @param dodge = argument from sjPlot::plot_model(), see ?plot_model
#' @param dot.size = argument from sjPlot::plot_model(), see ?plot_model
#' @param ci.lv = argument from sjPlot::plot_model(), see ?plot_model
#' @param y.lim = numeric vector of length 2 indicating the limits of the y-axis
#' @param return.plot = booean. Should the plot be returned by the function? (default: FALSE)
#' @param key.model = name of the predictor(s) whose model(s) should be considered for the "key.res" output
#' @param key.predictor = name of the predictor to be considered by the "key.res" output
#' @param digits = number of digits for all numeric ouputs
#' @param messages = boolean indicating whether a message should be printed for each operation (defult: FALSE)
glmerAn <- function(modelType=c("GLM","GLMER"),long,wide,resp,fix.eff,cluster.ID="ID",timeVar="ActivityDate",REML=FALSE,
                    ran.eff="(1|ID)",family="normal",link="identity",nAGQ=1,mc.predictors=NA,gmc.predictors=NA,
                    outputs=c("fit","mComp","coeff","plotEff","key.results"),coeff.models=NA,transform=NULL,
                    plot.model=NA,plot.pred="all",show.data=FALSE,dot.size=1,dodge=0,ci.lv=.95,y.lim=NA,return.plot=FALSE,
                    key.model=NA,key.predictor=NA,digits=3,messages=TRUE){ 
  
  if(messages==TRUE){ cat("Running",modelType,"analysis of",resp,"...") }
  
  # data preparation ..................................................................................................................
  if(messages==TRUE){ cat("\n\nPreparing data...") }
  
  # participants' ID recoding as factor
  colnames(long)[which(colnames(long)==cluster.ID)] <- colnames(wide)[which(colnames(wide)==cluster.ID)] <- "ID"
  long$ID <- as.factor(as.character(long$ID))
  wide$ID <- as.factor(as.character(wide$ID))
  wide <- wide[order(wide$ID),] # sorting wide by ID
  colnames(long)[which(colnames(long)==timeVar)] <- "time" # time variable
  long <- long[order(long$ID,long$time),] # sorting long by ID and time
  if(nlevels(long$ID)!=nlevels(wide$ID)){ stop(message="Error: different No. of participants in long and wide datasets") }
  
  # listwise deletion
  if(modelType%in%c("GLMER","CLMM")){ memory <- long 
    for(Var in c(resp,fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)])){ colnames(long)[which(colnames(long)==Var)] <- "Var"
      long <- long[!is.na(long$Var),] # removing obs. with missing response in any resp or fix.eff variable
      colnames(long)[which(colnames(long)=="Var")] <- Var }
    long$ID <- as.factor(as.character(long$ID))
    wide <- wide[wide$ID%in%levels(long$ID),] # excluding wide IDs not included in long IDs
    if(messages==TRUE){ cat("\n - Excluding",nrow(memory)-nrow(long),"incomplete observations (",
                            round(100*(nrow(memory)-nrow(long))/nrow(memory),1),
                            "% ) in the response var. or in any of the predictors,\n   and",
                            nlevels(memory$ID)-nlevels(long$ID),"participants with no complete variables") }
  } else { memory <- wide
    for(Var in c(resp,fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)])){ colnames(wide)[which(colnames(wide)==Var)] <- "Var"
      wide <- wide[!is.na(wide$Var),]
      colnames(wide)[which(colnames(wide)=="Var")] <- Var }
    if(messages==TRUE){ cat("\n - Excluding",nrow(memory)-nrow(wide),"participants with no complete variables") }}
  
  # mean-centering predictors
  if(!is.na(gmc.predictors[1])){ if(messages==TRUE){ cat("\n - Grand-mean-centering",paste(gmc.predictors,collapse=" , ")) }
    for(Var in gmc.predictors){  colnames(wide)[which(colnames(wide)==Var)] <- "Var" 
      wide$Var.gmc <- wide$Var - mean(wide$Var,na.rm=TRUE) # computing gmc values
      colnames(wide) <- gsub("Var",Var,colnames(wide))
      long <- plyr::join(long,wide[,c("ID",paste(Var,"gmc",sep="."))],type="left",by="ID") # joining gmc to long dataset
      fix.eff <- gsub(Var,paste(Var,"gmc",sep="."),fix.eff) }} # updating labels in fix.eff (from Var to Var.gmc)
  if(!is.na(mc.predictors[1])){ if(messages==TRUE){ cat("\n - Mean-centering",paste(mc.predictors,collapse=" , ")) }
    suppressMessages(suppressWarnings(require(Rmisc))) 
    for(Var in mc.predictors){ colnames(long)[which(colnames(long)==Var)] <- "Var" 
      wide$Var.cm <- suppressWarnings(summarySE(long,measurevar="Var",groupvars="ID",na.rm=TRUE)[,3]) # cluster means
      long <- plyr::join(long,wide[,c("ID","Var.cm")],type="left",by="ID") # joining cm to long dataset
      long$Var.mc <- long$Var - long$Var.cm # computing mc values
      colnames(long) <- gsub("Var",Var,colnames(long)) 
      fix.eff <- gsub(Var,paste(Var,"mc",sep="."),fix.eff) }} # updating labels in fix.eff (from Var to Var.mc)
  long <- long[,!duplicated(colnames(long))] # removing duplicated columns (don't know why)

  # modeling .........................................................................................................................
  
  # creating model formulas
  formulas <- character()
  if(modelType=="GLM"){ ran.eff <- "1" }
  null.f <- paste(resp,"~",ran.eff) # creating null model formula
  for(i in 1:length(fix.eff)){ # creating other formulas
    if(i==1){ formulas[i] <- paste(resp,"~",fix.eff[1]) } else { formulas[i] <- paste(formulas[i-1],"+",fix.eff[i])  }}
  if(modelType%in%c("GLMER","CLMM")){ if(!is.na(ran.eff)){ formulas <- paste(formulas,"+",ran.eff)
      if(substr(ran.eff,2,2)!="1"){ ranSlope <- paste(fix.eff[which(grepl(ran.eff,fix.eff))])[1]
        null.f <- gsub(ranSlope,"1",null.f)  # removing random slope from models without the related predictor
        for(i in 1:length(formulas)){ 
          if(!(grepl(ranSlope,gsub(paste(ranSlope,"[|]",sep=""),"",formulas[i])))){ 
            formulas[i] <- gsub(paste(ranSlope,"[|]",sep=""),"1|",formulas[i]) }}}
    } else { stop(message="Error: GLMER model type without ran.eff specification") }}
  if(messages==TRUE){ cat("\n\nModel specification:\n - model M0 (null):",null.f)
    for(i in 1:length(formulas)){ cat("\n - model M",i,": ",formulas[i],sep="")}}
  
  # fitting models
  models <- list()
  if(modelType=="GLM"){ if(messages==TRUE){ cat("\n\nFitting GLM models of",resp,"on",nrow(wide),"participants \n   using the",
                                                family,"family with the",link,"link function...") }
    if(family=="normal" & link=="identity"){ null.m <- lm(as.formula(null.f),data=wide) # normal family
      for(i in 1:length(formulas)){ models[[i]] <- lm(formula=as.formula(formulas[i]),data=wide) }
      } else if (family=="gamma") { null.m <- glm(as.formula(null.f),data=wide,family=Gamma(link=link),nAGQ=nAGQ) # gamma family
        for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=Gamma(link=link)) }
        } else if(family=="normal" & link!="identity"){  
          null.m <- glm(as.formula(null.f),data=wide,family=gaussian(link=link)) # normal with other link functions
          for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=gaussian(link=link)) }
        } else if(family=="binomial"){ 
          null.m <- glm(as.formula(null.f),data=wide,family=binomial(link=link)) # logistic regression
          for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=binomial(link=link))}
        } else { stop(message="Error: only normal, gamma, and binomial family are allowed, 
                      with identity, inverse, and log link functions") }
  } else if(modelType=="GLMER"){ suppressMessages(suppressWarnings(require(lme4)))
    if(messages==TRUE){ cat("\n\nFitting",modelType,"models of",resp,"on",nrow(long),"observations from",
                            nlevels(as.factor(as.character(long$ID))),"participants \n   using the",family,
                            "family with the",link,"link function using",ifelse(REML==FALSE,"ML","REML"),"estimator...") }
    if(family=="normal" & link=="identity"){ null.m <- lmer(as.formula(null.f),data=long,REML=REML) # normal  identity
      for(i in 1:length(formulas)){ models[[i]] <- lmer(formula=as.formula(formulas[i]),data=long,REML=REML) }
      } else if (family=="gamma") { null.m <- glmer(as.formula(null.f),data=long,family=Gamma(link=link),nAGQ=nAGQ) # gamma
        for(i in 1:length(formulas)){ models[[i]]<-glmer(formula=as.formula(formulas[i]),data=long,family=Gamma(link=link),nAGQ=nAGQ) }
        } else if(family=="normal" & link!="identity"){ 
          null.m <- glmer(as.formula(null.f),data=long,family=gaussian(link=link),nAGQ=nAGQ) # normal with other links
          for(i in 1:length(formulas)){ models[[i]] <- glmer(formula=as.formula(formulas[i]),data=long,
                                                             family=gaussian(link=link),nAGQ=nAGQ) }
        } else if(family=="binomial"){ null.m <- glmer(as.formula(null.f),data=long,family=binomial(link=link),nAGQ=nAGQ) # logistic
          for(i in 1:length(formulas)){ models[[i]] <- glmer(formula=as.formula(formulas[i]),data=long,
                                                             family=binomial(link=link),nAGQ=nAGQ)}
        } else { stop(message="Error: only normal, logistic, and gamma family are allowed, 
                               with identity, inverse, and log link functions") }
  } else if(modelType=="CLMM"){ suppressMessages(suppressWarnings(require(ordinal))) # cumulative link mixed models
    if(messages==TRUE){ cat("\n\nFitting",modelType,"models of",resp,"on",nrow(long),"observations from",
                            nlevels(as.factor(as.character(long$ID))),"participants \n   using Cumulative Link Mixed Models") }
    long[,resp] <- factor(long[,resp],ordered=TRUE) # response variable as ordered factor
    null.m <- suppressWarnings(clmm(as.formula(gsub("~","~ 1 +",null.f)),data=long)) # suppress formula warning (bugged)
    for(i in 1:length(formulas)){ models[[i]] <- suppressWarnings(clmm(formula=as.formula(formulas[i]),data=long,nAGQ=nAGQ)) }
  } else { stop(message="Error: modelType can only be 'GLM', 'GLMER', or 'CLMM'") }
  
  # outputs..........................................................................................................................
  if(messages==TRUE){ cat("\n\nGenerating models outputs...") }
  
  # model diagnostics
  if("fit"%in%outputs & modelType!="CLMM"){ if(messages==TRUE){ cat("\n\n - Plotting diagnostics of the most complex model:") }
    suppressMessages(suppressWarnings(require(sjPlot))); suppressMessages(suppressWarnings(require(ggplot2)))
    fit <- models[[length(models)]] # most complex model
    if(modelType=="GLMER"){ dat <- long } else { dat <- wide } # fitted dataset
    plots <- list()
    if(family=="normal" & link=="identity"){ p <- plot_model(fit,type="diag",dot.size=dot.size) # LM(ER) diagnostics (normal)
      if(modelType=="GLMER"){ p[[2]] <- p[[2]]$ID } 
      suppressMessages(plot_grid(p,tags=TRUE,margin=c(0,0,0,0)))
    } else { if(family=="binomial"){ # logistic regression
      dat$logit <- log(predict(fit,type="response")/(1-predict(fit,type="response"))) # computing logit
      for(Var in fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)]){ # plotting logit by each continuous predictor
        if(class(dat[,Var])=="numeric"){  plots[[length(plots)+1]] <- ggplot(dat,aes_string(x=Var,y="logit")) + 
          geom_point(size=dot.size) + suppressMessages(stat_smooth(method="loess")) + ggtitle("Logit by",Var) }}
      } else { plots[[length(plots)+1]] <- ggplot(data.frame(residuals=residuals(fit,type="deviance")), # deviance residuals QQ plot
                                                  aes(sample=residuals)) + stat_qq(size=dot.size) + stat_qq_line() +
        labs(x="Theoretical qualtiles (normal distr.)",y="Sample quantiles") + ggtitle("Deviance Residuals' normal QQ plot") 
      plots[[length(plots)+1]] <- ggplot(fortify.merMod(fit), aes(.fitted, resid(fit,type="deviance"))) + geom_point() +
        suppressMessages(stat_smooth(method="loess"))+geom_hline(yintercept=0, col="red", linetype="dashed") +
        labs(x="Fitted values",y="Residuals") + ggtitle("Deviance residuals vs. fitted values") }
      p <- plot_model(fit,type="diag",dot.size=dot.size) # random effects with GLMER
      if(modelType=="GLMER"){ p <- p$ID }
      plots[[length(plots)+1]] <- p + ggtitle("Random effects' normal QQ plot") }
    if(family!="binomial"){ type <- ifelse(family=="gamma","deviance","pearson") # deviance residuals with gamma
      for(Var in fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)]){ # homoscedasticity: residuals by levels of categorical pred.
      if(class(dat[,Var])=="factor"){ Dat <- cbind(dat,residuals=resid(fit,type=type),Var=dat[,Var],Resp=dat[,resp])
         plots[[length(plots)+1]] <- ggplot(Dat,aes_string(x="Var",y="residuals")) + 
           ggtitle(paste(type,"residuals by",Var,"\n mean =",paste(round(with(Dat, tapply(Resp, Var, mean)),1),collapse=", "),
                         ", SD =",paste(round(with(Dat, tapply(Resp, Var, sd)),1),collapse=", "))) + xlab(Var) +
           geom_point(size=dot.size,position=position_jitter(),color="gray") + geom_violin(alpha=0.3) }}}
    suppressMessages(plot_grid(plots,tags=TRUE,margin=rep(0,4))) 
    cat("\n  Printing Variance Inflation Factors (VIF):\n")
    suppressMessages(suppressWarnings(require(car))) # variance inflation factors
    print(vif(fit)) }
  
  # model comparison - likelihood ratio test & Akaike weight
  if("mComp"%in%outputs | "key.results"%in%outputs){ 
    if(messages==TRUE){ cat("\n\n - Running likelihood ratio test:") } # likelihood ratio test
    suppressMessages(suppressWarnings(require(knitr))); suppressMessages(suppressWarnings(require(MuMIn))) 
    if(modelType=="CLMM"){ lrt <- as.data.frame(ordinal:::anova.clm(null.m,models[[1]])) # use anova.clm() to avoid env. issue
    } else { lrt <- as.data.frame(suppressMessages(anova(null.m,models[[1]]))) }
    for(i in 1:(length(models)-1)){ if(length(models)>=(i+1)){
      if(modelType=="CLMM"){ lrt <- rbind(lrt,as.data.frame(ordinal:::anova.clm(models[[i]],models[[i+1]]))[2,]) 
      } else { lrt <- rbind(lrt,as.data.frame(suppressMessages(anova(models[[i]],models[[i+1]])))[2,]) }}}
    rownames(lrt) <- c("Null model",fix.eff)
    for(i in nrow(lrt):2){ if(lrt[i,ncol(lrt)] < .05){ if(messages==TRUE){ cat("\n   Selected model:",rownames(lrt)[i]) }
                             break }}
    if("mComp"%in%outputs){ print(kable(round(lrt,digits))) }
    AICs <- lrt[1:2,"AIC"] # Akaike weight
    if(messages==TRUE){ cat("\n\n - Computing Aw coefficients for each model vs. all previous models:") 
      cat("\n   - null model vs.",fix.eff[1],": =",round(Weights(AICs),digits)[1],
          "\n   -",fix.eff[1],"vs. null model =",round(Weights(AICs),digits)[2]) }
    if(length(models)>1){ for(i in 3:nrow(lrt)){ AICs <- c(AICs,lrt[i,"AIC"])
      if(messages==TRUE){ cat("\n   -",row.names(lrt)[i],"=",round(Weights(AICs),digits)[length(AICs)]) }}}
    if(messages==TRUE){ cat("\n   Selected model:",row.names(lrt[which(lrt$AIC==min(lrt$AIC)),])) }
    if("key.results"%in%outputs){ 
      key <- lrt[which(grepl(key.predictor,row.names(lrt))),] # key results
      if(nrow(key)>1){ key <- key[1,] }
      key.results <- data.frame(sig.LRT=key[,ncol(key)]<0.05,higher.Aw=key$AIC==min(AICs[1:(which(fix.eff==key.predictor)+1)])) }} 
  
  # estimated parameters from key.model
  if("key.results"%in%outputs){
    modSummary <- summary(models[[which(fix.eff==key.model)]])
    modSummary <- modSummary$coefficients
    if(modelType=="CLMM"){ modSummary <- modSummary[nlevels(long[,resp]):nrow(modSummary),] }
    key <- modSummary[which(grepl(key.predictor,row.names(modSummary))),3][1] # taking only first coeff for key.results
    key.results <- cbind(key.results,t.196=abs(key)>1.96,t=key) }
  if("coeff"%in%outputs){ if(messages==TRUE){ suppressMessages(suppressWarnings(require(knitr)))
    cat("\n\n - Printing estimated coefficients for models",paste(coeff.models,collapse=" , "))}
    suppressMessages(suppressWarnings(require(XML))); suppressMessages(suppressWarnings(require(sjPlot)))
    out <- data.frame(readHTMLTable(htmlParse(tab_model(models[which(fix.eff%in%coeff.models)],transform=transform,
                                                        show.icc=FALSE,show.p=FALSE,show.stat=TRUE,show.re.var=FALSE,
                                                        show.ci=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
                                                        string.est="B (SE)",string.stat="t")))[1])
    colnames(out) <- out[1,]
    out <- out[-1,] # sorting rows and columns
    out <- rbind(out[which(!substr(out$Predictors,1,3)%in%c("SD ","Cor")),],
                 out[which(substr(out$Predictors,1,3)=="SD "),],out[which(substr(out$Predictors,1,4)=="Cor "),])
    print(knitr::kable(out)) }
  
  # plotting effects
  if("plotEff"%in%outputs){ if(messages==TRUE){ cat("\n\n - Plotting effect(s) estimated by model",which(fix.eff==plot.model)) }
    suppressMessages(suppressWarnings(require(sjPlot))); suppressMessages(suppressWarnings(require(ggplot2)))
    if(plot.pred[1]=="all"){ fix.eff.plot <- fix.eff } else { fix.eff.plot <- plot.pred }
    if(length(fix.eff.plot)==1){ if(grepl(":",plot.pred)){ 
        terms <- c(strsplit(plot.pred,split=":")[[1]][1],strsplit(plot.pred,split=":")[[1]][2]) 
      } else { terms <- fix.eff[which(fix.eff==fix.eff.plot)] } 
      p <- plot_model(models[[which(fix.eff==fix.eff.plot)]],type="pred",terms=terms,ci.lv=ci.lv,dodge=dodge,
                      show.data=show.data,dot.size=dot.size,jitter=0.15) + ggtitle(paste(resp,"by",fix.eff.plot,fix.eff.plot))
      if(!is.na(y.lim[1])){ p <- p + ylim(y.lim) }
      if(return.plot==TRUE){ return(p) } else { print(p) } # returning or printing the plot 
    } else { plots <- list()
      for(i in 1:length(fix.eff.plot)){ if(grepl(":",fix.eff.plot[i],fixed=TRUE)==FALSE){ # predicted effects conditioned on ran.eff.
          p <- plot_model(models[[i]],type="pred",terms=fix.eff.plot[i],show.data=show.data,dot.size=dot.size,ci.lv=ci.lv,
                          colors="gray",jitter=0.15,dodge=dodge)
        } else { p <- plot_model(models[[i]],type="pred",terms=strsplit(fix.eff.plot[i],split=":")[[1]],ci.lv=ci.lv,dodge=dodge) }
                 plots[[i]] <- p + ggtitle(paste(resp,"by",fix.eff.plot[i])) }
      plot_grid(plots,tags=TRUE,margin=rep(0,4)) }}
  
  # returning key results (sig. LRT, Aw higher than previous model, t > 1.96)
  if("key.results"%in%outputs){ return(key.results) }}
```
</p></details>

Fits GLM(ER) models and prints the core numeric and graphical ouputs considered for the analyses.

<details><summary>**key.resPlot**</summary>
<p>
```{r }
key.resPlot <- function(res=NA,robCheck=NA,levels=c(s.archit,s.timing,paste(s.variab,"c",sep=""),s.auton)){ 
  suppressMessages(suppressWarnings(require(ggplot2)))
  
  # setting color scale
  res[res$t.196==TRUE & res$sig.LRT==TRUE & res$higher.Aw==TRUE,"Value"] <- 10 # 10 = substantial effect
  res[res$t.196==TRUE & ((res$sig.LRT==FALSE & res$higher.Aw==TRUE) | 
                           res$sig.LRT==TRUE & res$higher.Aw==FALSE),"Value"] <- 7.5 # 7.5 = substantial but LRT n.s. OR lower Aw
  res[res$t.196==TRUE & res$sig.LRT==FALSE & res$higher.Aw==FALSE,"Value"] <- 5 # 5 = substantial but both LRT n.s. AND lower Aw
  res[res$t.196==FALSE & ((res$sig.LRT==TRUE & res$higher.Aw==TRUE) | (res$sig.LRT==TRUE & res$higher.Aw==FALSE) |
                            res$sig.LRT==FALSE & res$higher.Aw==TRUE),"Value"] <- 2.5 # 2.5 = unsubstantial and LRT n.s. OR lower Aw
  res[res$t.196==FALSE & res$sig.LRT==FALSE & res$higher.Aw==FALSE,"Value"] <- 1 # 1 = no evidence at all
  res$Measure <- factor(res$measure,levels=levels) # Measures as factor
  
  # plotting
  if(is.na(robCheck)){ # single set of analyses
    ggplot(res,aes(x=Measure,y=as.factor(1),fill=Value)) + geom_tile() + geom_text(aes(label=round(t,2))) +
      scale_fill_gradient2(low="red",high="lightgreen",mid="yellow",midpoint=5,limit = c(1,10), space = "Lab") + 
      labs(x="",y="") + theme(legend.position = "none",axis.text.y = element_blank(),axis.text.x=element_text(angle=45))
  } else { require(reshape2) # multiple robustness checks
    colnames(res)[which(colnames(res)==robCheck)] <- "robCheck"
    ggplot(res,aes(x=Measure, y=as.factor(robCheck), fill=Value)) + geom_tile() + geom_text(aes(label=round(t,2))) +
      scale_fill_gradient2(low="red",high="lightgreen",mid="yellow",midpoint=5,limit = c(1,10), space = "Lab") + 
      labs(x="",y="") + theme(legend.position = "none",axis.text.x=element_text(angle=45)) }}
```
</p></details>

Visualizes the key results (Aw, LRT, and *t* value) obtained with the *glmerAn* function.

<br>

## 5.1. Sleep characterization

Here, `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables are predicted by (1) meaningful covariates (`SO.num`, `TotalSteps1000`, `weekday`, and `BMI`), (2) the `insomnia` group, (3) participants' `sex`, and (4) the interaction between `sex` and `insomnia` groups, in order to **characterize sleep between groups**
```{r fig.width=12,fig.height=8}
predictors <- c("SO.num","TotalSteps1000","weekday.sleep","BMI","insomnia","sex","sex:insomnia")
```

<br>

### 5.1.1. Sleep architecture {.tabset .tabset-fade .tabset-pills}

`s.archit` variables are modeled by considering the subset of complete `s.archit` and `TotalSteps1000`.

#### TIB

`TIB` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,
                                   modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                   outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`***, ***`weekday.sleep`***, and ***`sex`*** are associated with a **significant LRT**, whereas only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **stronger evidence** in terms of Aw

- a large negative effect is estimated for ***`SO.num`*** (shorter `TST` for later than usual `SO`), whereas a large positive effect is estimated for ***`weekday`*** (longer `TST` during weekend), and a small but substantial effect is estimated for ***`sex`*** (longer `TST` for males than females). Neither `insomnia` nor `TotalSteps1000`, `BMI`, or the interaction between `insomnia` and `sex` show a substantial effect

<br>

#### TST

`TST` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`***, ***`weekday.sleep`***, and ***`sex`*** are associated with a **significant LRT**, whereas the inclusion of ***`SO.num`***, ***`TotalSteps1000`***, ***`weekday.sleep`***, and ***`sex`*** are associated with a **stronger evidence** in terms of Aw

- a large negative effect is estimated for ***`SO.num`*** (shorter `TST` for later than usual `SO`), whereas a large positive effect is estimated for ***`weekday`*** (longer `TST` during weekend), and a small but substantial effect is estimated for ***`sex`**` (longer `TST` for males than females). Neither `insomnia` nor `TotalSteps1000`, `BMI` or the interaction between `insomnia` and `sex` show a substantial effect

- overall, `TST` shows the same pattern of results than `TIB`

<br>

#### WASO

`WASO` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- whereas (1) **random effects** are quite **normally distributed**, a (2) **marked deviation** from normality can be seen in the **upper tail of the residuals distribution**. Thus, we conduct the main analyses by relying on normality, whereas the **gamma will be checked in the [robustness check](#robcheck)**. The residuals show (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **significant LRT** and a **stronger evidence** in terms of Aw

- a large negative effect is estimated for ***`SO.num`*** (shorter `WASO` for later than usual `SO`), whereas a large positive effect is estimated for **`weekday`*** (longer `WASO` during weekend). None of the remaining predictors, including `insomnia` and its interaction with `sex`, show a substantial effect

<br>

#### SE

`SE` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("SO.num.mc","insomnia","sex","sex:insomnia"), # showing selected model + models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite normally distributed, although a **marked deviation from normality** can be seen in the **lower tail** of the residuals distribution (i.e., SE is bounded at 100), with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** is associated with a significant LRT, whereas both ***`SO.num`*** and ***`TotalSteps1000`*** are associated with **stronger evidence** in terms of higher Aw

- a substantial positive effect is only estimated for ***`SO.num`*** (higher `SE` for later than usual `SO`), whereas none of the remaining predictors shows a substantial effect

<br>

#### light.p

`light.p` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("BMI.gmc","insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`BMI`*** is associated with a **significant LRT**, whereas both ***`TotalSteps1000`*** and ***`BMI`*** are associated with **stronger evidence** in terms of Aw

- a substantial negative effect is estimated only for ***`BMI`*** (lower `light.p` for participants with higher `BMI`), whereas none of the remaining predictors shows a substantial effect 

<br>

#### deep.p

`deep.p` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("SO.num.mc","insomnia","sex","sex:insomnia"), # selected model + models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** is associated with a **significant LRT**, whereas both ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **stronger evidence** in terms of Aw

- a substantial positive effect is only estimated for ***`SO.num`*** (higher `deep.p` for later than usual SO), whereas none of the remaining predictors shows a substantial effect

<br>

#### rem.p

`rem.p` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** is associated with a **significant LRT**, whereas ***`SO.num`***, ***`TotalSteps1000`***, ***`weekday.sleep`***, and ***`BMI`*** are associated with a **stronger evidence** in terms of Aw

- a substantial negative effect is only estimated for ***`SO.num`*** (higher `rem.p` for earlier than usual `SO`), whereas none of the remaining predictors shows a substantial effect

<br>

### 5.1.2. Sleep timing {.tabset .tabset-fade .tabset-pills}

`s.timing` variables are modeled by considering the subset of complete `s.timing` and `TotalSteps1000`.

#### SO.num

`SO.num` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals. Obviously, `SO.num` is not included as a covariate in model M1.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors[2:length(predictors)],
        modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors[2:length(predictors)],
                                         modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite some **marked deviations in the tails** of the residuals distribution, with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`***, ***`BMI`*** and ***`sex`*** are associated with a **significant LRT**, whereas ***`TotalSteps1000`***, ***`weekday.sleep`***, ***`BMI`*** and ***`sex`*** show higher Aw than the previous models

- a relatively large effect is estimated for ***`weekday`*** (later `SO` during weekend), whereas small but substantial effects are estimated for ***`TotalSteps1000`*** (earlier `SO` in days with more steps than usual), ***`BMI`*** (earlier `SO` for participants with higher `BMI`), and ***`sex`*** (later `SO` for boys than for girls). Neither `insomnia` nor its interaction with `sex` show a substantial effect.

<br>

#### WakeUp.num

`WakeUp.num` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite some **marked deviations in the tails** of the residuals distribution, with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values

- only ***`SO.num`***, ***`weekday.sleep`***, and ***`BMI`*** are associated with a **significant LRT**, whereas ***`TotalSteps1000`***, ***`SO.num`***, ***`weekday.sleep`***, and ***`BMI`*** show **higher Aw** than the previous models

- a large positive effect is estimated for ***`SO.num`*** (later `WakeUp` time for later than usual `SO`) and ***`weekday`*** (later `WakeUp` time during weekend), whereas a small but substantial effect is estimated for ***`BMI`*** (earlier `WakeUp` time for participants with higher `BMI`). Neither `insomnia` nor its interaction with `sex` show a substantial effect.

<br>

### 5.1.3. Daily variability {.tabset .tabset-fade .tabset-pills}

`s.variab` variables are modeled by considering the subset of complete `s.timing` and `TotalSteps1000`, and only those days with **nonmissing current and previous-day sleep variables**.

#### TIB.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `TIB.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have TIB.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$TIB.SSDc <- ema$TIB.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log", # Gamma family with log link function
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",
        outputs="plotEff",plot.model="insomnia",dot.size=2)

# keeping key results
res <- rbind(res,
             cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of the residuals distribution) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of ***`SO.num`***, ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`weekday.sleep`*** (higher `TIB.SSD` during weekend), ***`BMI`*** (higher `TIB.SSD` in participants with higher `BMI`), and ***`insomnia`*** (lower `TST.SSD` in the `insomnia` compared to the control group. Neither `sex` nor its interaction with `insomnia` show a substantial effect

<br>

#### TST.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `TST.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have TST.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$TST.SSDc <- ema$TST.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log", # Gamma family with log link function
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tail** of the residuals distribution) with (2) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD are proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of ***`SO.num`***, ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`weekday.sleep`*** (higher `TST.SSD` during weekend), ***`BMI`*** (higher `TST.SSD` in participants with higher `BMI`), and ***`insomnia`*** (lower `TST.SSD` in the `insomnia` compared to the control group. Neither `sex` nor its interaction with `insomnia` show a substantial effect

- results are **highly consistent** with those reported for `TIB.SSD`

<br>

#### WASO.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `WASO.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have WASO.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$WASO.SSDc <- ema$WASO.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log",nAGQ=0, # Gamma family with log link function, nAGQ = 0 to reach convergence
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("weekday.sleep","insomnia","sex"),transform="exp", # selected model + models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",nAGQ=0,
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",nAGQ=0,
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **small deviations in the lower tail** and some **marked deviations in the upper tail** of the residuals distribution) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, the (4) **SD are slightly proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **significant LRT** and show **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`SO.num`*** (higher variability for earlier than usual `SO`) and ***`weekday.sleep`*** (higher `WASO.SSD` during weekend). Neither `insomnia` nor its interaction with `sex` show a substantial effect

<br>

#### SO.num.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are initially modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `SO.num.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have `SO.num.SSD` = 0). Note that `SO.num` is not included as a covariate predicting `SO.num.SSD`
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$SO.num.SSDc <- ema$SO.num.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors[2:length(predictors)],
        modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log", # Gamma family with log link function
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors[2:length(predictors)],
        mc.predictors="TotalSteps1000",gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE,show.data=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="SO.num.SSDc",glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors[2:length(predictors)],
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",
                                         mc.predictors="TotalSteps1000",gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution, and in the upper tail of the random effects) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, the (4) **SD are slightly proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`*** and ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`weekday.sleep`*** (higher `SO.num.SSD` during weekend) and ***`insomnia`*** (lower `SO.num.SSD` in the `insomnia` compared to the control group. Neither `sex` nor its interaction with `insomnia` show a substantial effect

<br>

#### WakeUp.num.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `WakeUp.num.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have WakeUp.num.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$WakeUp.num.SSDc <- ema$WakeUp.num.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log",nAGQ=0, # Gamma family with log link function, nAGQ=0 to reach convergence
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("BMI.gmc","insomnia","sex"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",nAGQ=0,
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE,show.data=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="WakeUp.num.SSDc",glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",nAGQ=0,
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of the residuals distribution) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, the (4) **SD are proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`*** and ***`BMI`*** are associated with a **significant LRT**, whereas the inclusion of ***`weekday.sleep`***, ***`BMI`***, and ***`sex`*** are associated with a **stronger evidence** in terms of Aw

- a substantial effect is only estimated for ***`weekday.sleep`*** (higher `WakeUp.num.SSD` during weekend) whereas neither `insomnia` nor its interaction with `sex` show a substantial effect

<br>

### 5.1.4. Sleep autonomic func. {.tabset .tabset-fade .tabset-pills}

`s.auton` variables are modeled by considering the subset of complete `s.auton` and `TotalSteps1000`.

#### HR_NREM

`HR_NREM` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite a positive **deviation in the upper tail** of the residuals distribution, with (3) **homogeneity** between the variances across *sex* and *insomnia* levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- **all predictors but** ***`SO.num`*** **and** ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of **all variables but** ***`SO.num`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`TotalSleep1000`*** (higher `stageHR_NREM` for higher than usual `TotalSleep1000`), ***`weekday.sleep`*** (higher `stageHR_NREM` during weekends), ***`BMI`*** (higher `stageHR_NREM` for participants with higher `BMI`), ***`sex`*** (higher `stageHR_NREM` in girls compared to boys), and its **interaction with** ***`insomnia`*** (lower `stageHR_NREM` in insomnia girls compared to control girls)

<br>

#### HR_REM

`HR_REM` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- results are **highly consistent** with those reported for `HR_NREM`, with the only differences that `HR_REM` is also positively predicted by ***`SO.num`***, and not substantially associated with `BMI` or `weekday.sleep`

<br>

### 5.1.5. Summary of results

Here, we use the `key.resPlot` function to graphically summarize the results obtained from the models above. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=2}
key.resPlot(res)
```

<br>

*Comments:*

- the analysis of sleep characterization highlighted substantial differences between the insomnia and the control group for `TIB.SSD`, `TST.SSD`, and `SO.num.SSD` (with lower night-to-night variability for the insomnia than the control group)

- **substantial but less evident** (i.e., LRT > 0.05) differences are highlighted for `HR_NREM` and `HR_REM`, with the **interactive model** predicting **lower HR in female insomnia** than in female control, but no differences between boys

- **none of the remaining sleep outcomes** show significant LRT, higher Aw, and substantial relationships for the *insomnia* predictor

<br>

### 5.1.6. Robustness checks {#robcheck}

Here, we conduct several **robustness checks** to account for the arbitrariness of our data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the insomnia variable, (2) the inclusion of the `covid19` variable as a further covariate, (3) the exclusion of participants with **extreme missing data**, (4) the **exclusion of** `TotalSteps1000`, (5) the use of **alternative family distributions** for the analyses.

Here, we select the predictors, and the sleep outcomes.
```{r,fig.width=12,fig.height=3}
# predictors
PREdictors <- predictors[1:(length(predictors)-2)] # excluding sex and interactive model

# sleep outcomes
sleepVars <- c(s.archit[2:length(s.archit)],s.timing,paste(s.variab,"c",sep=""),s.auton)
```

<br>

#### 5.1.6.1. insomnia.group

Here, we inspect the results obtained by considering the `insomnia.group` (i.e., 46 controls, 26 DSM.ins and 21 sub.ins) rather than the *insomnia* variable (i.e., 46 controls vs. 47 insomnia). 

The figure below shows the t-values associated with the group differences between **full DSM insomnia** and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){ if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # family
  if(grepl("SO.num",sleepVar)){ Predictors <- gsub("insomnia","insomnia.group",PREdictors)[2:length(PREdictors)] # insomnia.group
     } else { Predictors <- gsub("insomnia","insomnia.group",PREdictors) }
  if(grepl("HR",sleepVar)){ key.model="sex" # adding sex with s.auton variables
    Predictors <- c(Predictors,"sex") }else{ key.model <- "insomnia.group" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to reach convergence
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia.group",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res$robCheck <- "Original"
res2$robCheck <- "insomnia.group"
RES <- rbind(res,res2)

# plotting robustness check
key.resPlot(RES,robCheck = "robCheck")
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most sleep outcomes

- the only differences are highlighted for `TST.SSD`, showing a no longer significant LRT (but still higher Aw and substantial t), and `HR_NREM` and `HR_REM`, showing a no longer higher Aw (but still substantial t)

<br>

#### 5.1.6.2. COVID-19 emergency

Here, we inspect the results obtained by including the `covid19` variable **as a further covariate**. As shown in section 1.2.8, the `covid19` factor discriminates the data collected `pre-COVID19` (63%) and the data collected `post-COVID19` (37%). The covariate is included **at the first step** (model M1, before `SO.num`).

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=c("covid19",PREdictors),
                                    modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){ if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # family
  if(grepl("SO.num",sleepVar)){ Predictors <- c("covid19",PREdictors[2:length(PREdictors)]) # predictors + covid19
     } else { Predictors <- c("covid19",PREdictors) }
  if(grepl("HR",sleepVar)){ key.model="sex" # adding sex with s.auton variables
     Predictors <- c("covid19",PREdictors,"sex") } else { key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "covid19"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","covid19"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` and `s.auton` outcomes, with a no longer substantial main effect on `SO.num.SSD`, `HR_NREM`, and `HR_REM`

<br>

Here, we can see that the `post-COVID19` data collection period is characterized by longer `TIB` and `TST` (but not `WASO`), slightly lower `rem.p`, later `SO` and `WakeUp` times, lower `SO.num.SSD`, and lower `HR_REM` compared to the pre-COVID19 period.
```{r fig.width=4,fig.height=3,warning=FALSE,message=FALSE}
# plotting difference by covid (model M1)
for(sleepVar in c("TIB",sleepVars)){
  if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  if(grepl("SO.num",sleepVar)){ Predictors <- c("covid19","TotalSteps1000","weekday.sleep","BMI")
     } else { Predictors <- c("covid19","SO.num","TotalSteps1000","weekday.sleep","BMI") }
  if(grepl("HR",sleepVar)){ key.model="sex" }else{ key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc","SO.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family=fam[1],link=fam[2],nAGQ=nAGQ,
        outputs="plotEff",plot.model="insomnia",plot.pred="covid19",messages=FALSE,dot.size=3,dodge=0.5) }
```

<br>

In conclusion, the results of this robustness check were **partially inconsistent** with those obtained with the main analyses, questioning the generalizability of the results observed for `SO.num.SSD` and for the main effect of `insomnia` on both `s.auton` outcomes.

<br>

#### 5.1.6.3. Low compliance

Here, we inspect the results obtained by **excluding seven participants** (7.5%) with **less than two weeks of valid observations in any data type**. In section 3.2, these participants were marked with `majMiss` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$majMiss!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days from",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=PREdictors,
                                    modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the other sleep outcomes
for(sleepVar in sleepVars){
  if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  if(grepl("SO.num",sleepVar)){ Predictors <- PREdictors[2:length(PREdictors)] } else { Predictors <- PREdictors }
  if(grepl("HR",sleepVar)){ Predictors <- c(Predictors,"sex")
    key.model="sex" }else{ key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc","SO.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "majMiss"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **overall inconsistent** with the main analyses 

- the main differences is highlighted for `SO.num.SSD`, showing **no more substantial** group differences. Note, however, that `nAGQ` **was set to zero** to reach convergence in `SO.num.SSD` models, resulting in higher standard errors that might have masked the effect

<br>

#### 5.1.6.4. TotalStep1000

Here, we inspect the results obtained by **excluding** `TotalSteps1000` **from the models predictors**. This is done in order to replicate the analyses by including cases with invalid daily steps data (thus, with higher sample size).

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=PREdictors[PREdictors!="TotalSteps1000"],
                                    modelType=c("GLMER"),mc.predictors="SO.num",gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  if(grepl("SO.num",sleepVar)){ Predictors <- PREdictors[PREdictors!="TotalSteps1000" & PREdictors!="SO.num"]
     } else { Predictors <- PREdictors[PREdictors!="TotalSteps1000"] }
  if(grepl("HR",sleepVar)){ key.model="sex" 
    Predictors <- c(Predictors,"sex") }else{ key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc","TIB.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "no-TotalSteps"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` and `s.auton` outcomes, with a no longer substantial main effect on `TIB.SSD`, `HR_NREM`, and `HR_REM`

- note, however, that `nAGQ` **was set to zero** to reach convergence in *TIB.SSD* models, resulting in higher standard errors that might have masked the effect

<br>

Here, we can see that the differences in *HR_NREM* and *HR_REM* are **no longer substantial**, whereas differences in *TIB.SSD* are **smaller but still quite substantial**, as it is **substantial** the **interaction between sex and insomnia** on *s.auton* variables. 
```{r fig.width=10,fig.height=6,warning=FALSE,message=FALSE,echo=FALSE}
              # plotting HR_NREM (without covid19)
plot_grid(list(glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=c(PREdictors,"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_NREM (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=c(PREdictors[which(PREdictors!="TotalSteps1000")],"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000"),
               
               # plotting HR_REM (without covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=c(PREdictors,"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_REM (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=c(PREdictors[which(PREdictors!="TotalSteps1000")],"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000")),
          tags=TRUE,margin=rep(0,4))

              # plotting HR_NREM interaction (without covid19)
plot_grid(list(glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_NREM interaction (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors[which(predictors!="TotalSteps1000")],
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000"),
               
               # plotting HR_REM interaction (without covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_REM interaction (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors[which(predictors!="TotalSteps1000")],
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000")),
          tags=TRUE,margin=rep(0,4))
```

<br>

In conclusion, the results of this robustness check were **overall consistent** with those obtained with the main analyses, although questioning the generalizability of the results observed for `TIB.SSD` and (slightly less) `s.auton` outcomes.

<br>

#### 5.1.6.5. Family distribution

Here, we replicate the models predicting those variables that showed poor fit in the model diagnostics above by re-specifying the models with different distribution families and link functions:

- `WASO`: initially modeled by assuming a normal distribution for residuals, despite the highlighted deviation in the upper tail of the distribution. Since `WASO` is bounded at zero and positively skewed, we inspect how results change when assuming a **gamma distribution**. Here, we can see that the **fit does not clearly improve** when the family distribution is changed.
```{r,fig.width=8,fig.height=6}
# WASO: normal vs. gamma (not optimal fit in both cases)
ema$WASOc <- ema$WASO + 0.001
p1 <- lmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema)
p2 <- glmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0)
p4 <- glmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=gaussian("log"),nAGQ=0)
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red")
qqnorm(resid(p3),main="qqnorm residuals - Gamm(inverse"); qqline(resid(p3),col="red") 
qqnorm(resid(p4),main="qqnorm residuals - Normal(log)"); qqline(resid(p4),col="red")
```

<br>

- `s.variab`: modeled by assuming a **gamma distribution**. Here, we re-specify the models by assuming normality (although it can be seen that the **fit is strongly impaired**).
```{r,fig.width=8,fig.height=3}
# TST.SSDc: normal vs. gamma (clearly better fit for gamma)
p1 <- lmer(TST.SSDc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema)
p2 <- glmer(TST.SSDc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"))
p2 <- glmer(TST.SSDc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"))
par(mfrow=c(1,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
```

<br>

- `s.auton`: modeled by assuming a normal distribution, but showing marked deviations in the upper tail. Again, these are re-modeled by assuming a **gamma distribution**. Here, we can see that the **fit does not clearly improve** when the family distribution is changed.
```{r,fig.width=8,fig.height=6}
# HR_NREM: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema)
p2 <- glmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0)
p3 <- glmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0)
p4 <- glmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0)

par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 
```

<br>

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001
res2 <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=PREdictors,nAGQ=0, # nAGQ = 0 to reach convergence
                                    modelType=c("GLMER"),family="gamma",link="log",
                                    mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in c(paste(s.variab,"c",sep=""),s.auton)){
  if(grepl("SSD",sleepVar)){ fam <- c("normal","identity") }else{ fam <- c("gamma","log") }
  if(grepl("HR",sleepVar)){ key.model="sex" 
    Predictors <- c(PREdictors,"sex") }else{ key.model <- "insomnia" 
                                             Predictors <- PREdictors
                                             nAGQ <- 0 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "familyDistr"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` and `s.auton` outcomes, with a no longer substantial main effect on `TST.SSD`, and no longer significant LRT (bust still higher Aw and substantial *t*) for `HR_NREM` and `HR_REM`

<br>

#### 5.1.6.6. Summary of results

Here, we summarize the results from all robustness checks. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=5}
key.resPlot(RES,robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses (`sarchit` and `s.timing`) are **highly consistent** across the robustness checks

- the lower `s.variab` in `TIB`, `TST`, and `SO` highlighted for the `insomnia` group shows **some inconsistencies**, especially for `SO.num.SSD` (whose effect is no longer substantial following the exclusion of `majMiss` participants, or the inclusion of `covid19`)

- **more consistent** results are found for `TST.SSD` (only affected by the distribution family, but with a better fit for the main analyses than the robustness checks) and `TIB.SSD` (whose group differences are no longer substantial when `TotalSteps` are excluded from the model, likely due to the lack of convergence with nAGQ = 1)

- results for `s.auton` variables are **apparently even more inconsistent** than those shown by `s.variab`, with the main effect of `insomnia` showing low generalizability across different analytical strategies, and especially for `HR_NREM`; however, it should be noted that the **interaction between** `sex` **and** `insomnia` is **consistently** observed over all robustness checks   

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, with `SO.SSD` showing the **less consistent relationship** with `insomnia`.

<br>

## 5.2. Diary ratings

Here, bedtime ratings of `stress`, `worry`, and `mood` are predicted by (1) meaningful covariates (`TotalSteps1000` and `weekday`), (2) the `insomnia` group, (3) participants’ `sex`, and (4) the interaction between `sex` and insomnia `groups`, in order **to characterize the two groups in terms of pre-sleep psychological states**.
```{r fig.width=12,fig.height=8}
predictors <- c("TotalSteps1000","weekday.sleep","insomnia","sex","sex:insomnia")
```

In addition to considering the **raw item scores**, we replicate the models by using the aggregated values (`PsyDist`) and the factor scores (`fs`) predicted by the MCFA model specified above.

<br>

### 5.2.1. Raw item scores {.tabset .tabset-fade .tabset-pills}

Daily diary item scores are modeled by considering the subset of complete `dailyDiary` and `TotalSteps1000`. Due to the **ordinal nature** of these single-item measures, we do not use normality-based GLMER. Instead, we **binary transform each item score** (i.e., 0 = score lower than or equal to 3, 1 = score higher than 3), and we use **logistic regression**.
```{r }
# recoding stress, worry, and mood in two categories
ema[!is.na(ema$stress),c("stress.cat","worry.cat","mood.cat")] <- 0
ema[!is.na(ema$stress) & ema$stress>3,"stress.cat"] <- 1
ema[!is.na(ema$worry) & ema$worry>3,"worry.cat"] <- 1
ema[!is.na(ema$mood) & ema$mood>3,"mood.cat"] <- 1

# summarizing the categorical recoded variables
summary(as.factor(ema$stress.cat))
summary(as.factor(ema$worry.cat))
summary(as.factor(ema$mood.cat))
```

<br>

*Comments:*

- in the 12-to-14% of the cases, *stress*, *worry*, and *mood* were rated as 3 or higher

<br>

Here, we use the *glmerAn* function to conduct logistic regression for each item score.

#### STRESS

`stress` is a one-item ordinal variable, and it was dicotomized to be modeled by assuming a **binomial distribution** for the residuals (i.e., **logistic regression**).
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        family="binomial",link="logit",transform="exp", # logistic regression (exponentiated coefficients = odds ratios)
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia")

# keeping key results
res <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=predictors,
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",dot.size=3,messages=FALSE))
```

<br>

*Comments:*

- the logistic regression assumption of (1) **linearity between logit and continuous predictors** generally holds, although the slightly higher logit for weekend days, insomnia, and females; (2) random effects are **quite normally distributed**, with only a **slight deviation from normality in the lower tail** of the random intercept distribution; there is (3) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`TotalSteps1000`*** and ***`weekday.sleep`*** are associated with a **significant LRT**, whereas the inclusion of **all variables but the interactive term** are associated with a **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`TotalSteps1000`*** (lower `stress` for higher than usual `TotalSteps`), and ***`weekday.sleep`*** (lower `stress` on weekend days than on weekdays). Neither `insomnia` nor `sex` or their interaction show a substantial effect (i.e., despite the slightly higher `stress` in insomnia than in controls, and especially in insomnia girls compared to control girls, these differences are not substantial)

<br>

#### WORRY

`worry` is a one-item ordinal variable, and it was dicotomized to be modeled by assuming a **binomial distribution** for the residuals (i.e., **logistic regression**).
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="worry.cat",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        family="binomial",link="logit",transform="exp", # logistic regression (exponentiated coefficients = odds ratios)
        nAGQ=0, # nAGQ = 0 to reach convergence in the interactive model
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia")

# keeping key results
res <- rbind(res,cbind(measure="worry.cat",glmerAn(long=ema,wide=demos,resp="worry.cat",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",dot.size=3,messages=FALSE)))
```

<br>

*Comments:*

- the logistic regression assumption of (1) **linear independence between logit and continuous predictors** generally holds, although the slightly higher logit for weekend days, insomnia, and females; random effects are **quite normally distributed**, with only a **slight deviation from normality in the lower tail** of the random intercept distribution; there is (3) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`*** are associated with a **significant LRT** and a **stronger evidence** in terms of Aw

- a substantial effect is only estimated for ***`weekday.sleep`*** (lower `worry` on weekend days than on weekdays). Neither `insomnia` nor `sex`, or their interaction show a substantial effect (i.e., despite the slightly higher `worry` in insomnia than in controls, and especially in insomnia girls compared to control girls, these differences are not substantial)

<br>

#### MOOD

`mood` is a one-item ordinal variable, and it was dicotomized to be modeled by assuming a **binomial distribution** for the residuals (i.e., **logistic regression**).
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="mood.cat",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        family="binomial",link="logit",transform="exp", # logistic regression (exponentiated coefficients = odds ratios)
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia")

# keeping key results
res <- rbind(res,cbind(measure="mood.cat",glmerAn(long=ema,wide=demos,resp="mood.cat",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",dot.size=3,messages=FALSE)))
```

<br>

*Comments:*

- the assumption of (1) **linear independence between logit and continuous predictors** generally holds; (2) random effects are **quite normally distributed**, with only a **slight deviation from normality in the lower tail** of the random intercept distribution; there is (3) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`TotalSteps1000`*** and ***`weekday.sleep`*** are associated with a **significant LRT**, whereas **all predictors but** `insomnia` **and** `sex` show **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`TotalSteps1000`*** (lower bad `mood` for higher than usual `TotalSteps`), ***`weekday.sleep`*** (lower bad `mood` on weekend days than on weekdays), and ***`sex`*** (lower bad `mood` in boys compared to girls), but only if the interaction is not included in the model. Neither `insomnia` nor `sex`, or their interaction show a substantial effect

<br>

### 5.2.2. Aggregate scores {.tabset .tabset-fade .tabset-pills}

Here, we replicate the analyses by considering the aggregate (i.e., mean) score of `stress`, `worry`, and `mood` (`PsyDist`), and the factor scores predicted by the MCFA model selected above.

#### PsyDist

`PsyDist` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="PsyDist",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,cbind(measure="PsyDist",glmerAn(long=ema,wide=demos,resp="PsyDist",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the upper tail** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`TotalSteps1000`*** and ***`weekday.sleep`*** are associated with a **significant LRT** and **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`TotalSteps1000`*** (lower `PsyDist` for higher than usual `TotalSteps`), and ***`weekday.sleep`*** (lower `PsyDist` on weekend days than on weekdays). Neither `insomnia` nor `sex`, or their interaction show a substantial effect

<br>

#### fs

`fs` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="fs",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,cbind(measure="fs",glmerAn(long=ema,wide=demos,resp="fs",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- results are **highly consistent** with those reported for `PsyDist`, with the only difference that `sex` shows higher Aw and a substantial effect

<br>

### 5.2.3. Summary of results

Here, we use the `key.resPlot` function to graphically summarize the results obtained from the models above. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of `insomnia`). The figure below uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, and |t| > 1.96 ) are shown in **green**

- those relationships showing a **|t| > 1.96** but either a nonsignificant LRT **or** a lower Aw than the previous model are shown in **light green** (or lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT **and** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT **or** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT **and** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=2}
key.resPlot(res,levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the analysis of pre-sleep `stress`, `worry`, and `mood` ratings characterization did not highlight **any substantial difference** between the insomnia and the control group, with only a (slightly) higher Aw (but non-significant LRT and unsubstantial effect) for the model including `insomnia` for predicting `stress`

<br>

### 5.2.4. Robustness checks {#robcheck}

Here, we conduct several **robustness checks** to account for the arbitrariness of our data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the insomnia variable, (2) the inclusion of the `covid19` variable as a further covariate, (3) the exclusion of participants with **extreme missing data**, (4) the **exclusion of** `TotalSteps1000`, (5) the use of **alternative family distributions** for the analyses.

<br>

#### 5.2.4.1. insomnia.group

Here, we inspect the results obtained by considering the `insomnia.group` (i.e., 46 controls, 26 DSM.ins and 21 sub.ins) rather than the `insomnia` variable (i.e., 46 controls vs. 47 insomnia). 

The figure below shows the t-values associated with the group differences between **full DSM insomnia** and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
PREdictors <- predictors[1:(length(predictors)-2)] # excluding sex and interactive model
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,
             cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                            family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                            modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res$robCheck <- "Original"
res2$robCheck <- "insomnia.group"
RES <- rbind(res,res2)

# plotting robustness check
key.resPlot(RES,robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses for most sleep outcomes

- the most relevant differences are shown for `stress.cat`, `worry.cat`, and `fs`, now showing **significant LRT**, **higher Aw** and a **substantial difference** for `insomnia` (i.e., higher `stress`, `worry`, and `fs` for the full DSM insomnia group compared to controls)

<br>

Here, we can see that the **differences in** `stress`, `worry`, and `fs` **are substantial**, and **driven by the full DSM insomnia subgroup**, whereas no substantial differences are estimated between the control and the sub-threshold insomnia group.
```{r fig.width=10,fig.height=6,warning=FALSE,message=FALSE,echo=FALSE}
plot_grid(list(glmerAn(long=ema,wide=demos,resp="stress.cat",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",family="binomial",link="logit",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",transform="exp",
                       plot.model="insomnia.group",plot.pred="insomnia.group",dot.size=3),
               glmerAn(long=ema,wide=demos,resp="worry.cat",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",family="binomial",link="logit",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",transform="exp",
                       plot.model="insomnia.group",plot.pred="insomnia.group",dot.size=3),
               glmerAn(long=ema,wide=demos,resp="mood.cat",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",family="binomial",link="logit",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",transform="exp",
                       plot.model="insomnia.group",plot.pred="insomnia.group",dot.size=3)))
```
```{r fig.width=5,fig.height=6,warning=FALSE,message=FALSE,echo=FALSE}
plot_grid(list(glmerAn(long=ema,wide=demos,resp="PsyDist",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",
                       plot.model="insomnia.group",plot.pred="insomnia.group",show.data=TRUE),
               glmerAn(long=ema,wide=demos,resp="fs",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",
                       plot.model="insomnia.group",plot.pred="insomnia.group",show.data=TRUE)))
```

<br>

In conclusion, the results of this robustness check were **inconsistent** with those obtained with the main analyses, showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group.

<br>

#### 5.2.4.2. COVID-19 emergency

Here, we inspect the results obtained by including the `covid19` variable **as a further covariate**. As shown in section 1.2.8, the `covid19` factor discriminates the data collected `pre-COVID19` (63%) and the data collected `post-COVID19` (37%). The covariate is included **at the first step** (model M1, before `SO.num`).

The figure below shows the t-values associated with the group differences between **full DSM insomnia** and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=c("covid19",PREdictors),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=c("covid19",PREdictors),
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "covid19"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","covid19"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most outcomes

- the only difference is that with `covid19` the model predicting `stress` by `insomnia` is not even associated with higher Aw

<br>

Here, we can see that the `post-COVID19` data collection period **does not show substantial differences** compared to the `pre-COVID19` period, with only slightly higher `stress`.
```{r fig.width=4,fig.height=3,warning=FALSE,message=FALSE}
# plotting difference by covid (model M1)
for(diaryVar in c("stress.cat","worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=c("covid19",PREdictors[1:2]),
        mc.predictors="TotalSteps1000",modelType="GLMER",family=fam[1],link=fam[2],
        outputs="plotEff",plot.model="insomnia",plot.pred="covid19",messages=FALSE,dot.size=3) }
```

<br>

In conclusion, the results of this robustness check were **highly consistent** with those obtained with the main analyses, with **no substantial group differences** in any variable, and no substantial differences between pre- and post-COVID19.

<br>

As a further check, we also inspect the results of the `covid19` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",
                                           fix.eff=c("covid19",gsub("insomnia","insomnia.group",PREdictors)),
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                           family="binomial",link="logit",messages=FALSE,
                                           outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,
                                                    fix.eff=c("covid19",gsub("insomnia","insomnia.group",PREdictors)),
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "covid19.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","covid19.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **in line** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

- in addition, substantial differences in `PsyDist` (but not in `mood`) are found when considering `covid19` as a further covariate

<br>

#### 5.2.4.3. Low compliance

Here, we inspect the results obtained by **excluding seven participants** (7.5%) with **less than two weeks of valid observations in any data type**. In section 3.2, these participants were marked with `majMiss` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$majMiss!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days, ",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=PREdictors,
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000", family="binomial",link="logit",
                                           outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,fix.eff=PREdictors,
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "majMiss"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","majMiss"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most outcomes

- the only difference is that without `majMiss` the model predicting `stress` by `insomnia` is not even associated with higher Aw

<br>

As a further check, we also inspect the results of the `majMiss` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                           family="binomial",link="logit",messages=FALSE,
                                           outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "majMiss.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","majMiss.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

<br>

#### 5.2.4.4. TotalStep1000

Here, we inspect the results obtained by **excluding** `TotalSteps1000` **from the models predictors**. This is done in order to replicate the analyses by including cases with invalid daily steps data (thus, with higher sample size).

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=c("weekday.sleep","insomnia","sex"),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=c("weekday.sleep","insomnia","sex"),
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "no-TotalSteps"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","no-TotalSteps"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses, with the only exception of `stress.cat`, whose model including `insomnia` now shows **significant LRT** and a **substantial positive effect** (i.e., higher `stress` in insomnia compared to controls)

- none of the remaining variables show substantial differences, with almost identical results than those obtained with the main analyses

<br>

As a further check, we also inspect the results of the `majMiss` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=c("weekday.sleep","insomnia.group","sex"),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",messages=FALSE,
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,fix.eff=c("weekday.sleep","insomnia.group","sex"),
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "no-TotalSteps.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","no-TotalSteps.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

<br>

#### 5.2.4.5. Family distribution  {.tabset .tabset-fade .tabset-pills}

Here, we replicate the models predicting those variables that showed poor fit in the model diagnostics above by re-specifying the models with different distribution families and link functions:

##### NORMAL

- `stress`, `worry`, and `mood`: initially dichotomized, and modeled with a **logistic regression**. Here, we can see that the fit of the **normal** istribution (i.e., assuming item scores as they were continuous) is **quite acceptable** and better than that shown by the *gamma* family
```{r,fig.width=8,fig.height=6}
# stress: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0) # nAGQ = 0 to converge
p4 <- glmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0) # nAGQ = 0 to converge
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 

# worry: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0) # nAGQ = 0 to converge
p4 <- glmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0) # nAGQ = 0 to converge
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 

# mood: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0) # nAGQ = 0 to converge
p4 <- glmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0) # nAGQ = 0 to converge
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 
```

<br>

- `PsyDist`: modeled by assuming a **normal distribution** for the residuals. Here, we re-specify the models by assuming a **gamma distributon**, which shows a **slightly better fit** (note that `PsyDist` is positively skewed)
```{r,fig.width=8,fig.height=6}
# PsyDist: normal vs. gamma (better fit for gamma)
p1 <- lmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0)
p3 <- glmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"))
p4 <- glmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0)
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 
```

<br>

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either M2 (main effect of `insomnia`), and using a **normal** and a **gamma** distribution for modeling raw item scores and the aggregate score, respectively. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=PREdictors,
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),fix.eff=PREdictors,
                                                    family=fam[1],link=fam[2],nAGQ=0, # nAGQ = 0 to reach convergence with PsyDist
                                                    key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "distr.Normal.Gamma"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.Normal.Gamma"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

As a further check, we also inspect the results of the *distr.Normal.Gamma* robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist")){
  if(diaryVar=="PsyDist"){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                                    family=fam[1],link=fam[2],nAGQ=0, # nAGQ = 0 to reach convergence with PsyDist
                                                    key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "distr.Normal.Gamma.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.Normal.Gamma.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and (also) `PsyDist` between the full DSM insomnia and the control group

<br>

##### ORDINAL REGRESSION

Here, we account for the **ordinal nature** of item ratings by replicating the analyses by using **cumulative link mixed models** (CLMM). The figure below uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=PREdictors,
                                           modelType=c("CLMM"),mc.predictors="TotalSteps1000",
                                           outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat")){
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),fix.eff=PREdictors,
                                                    modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
                                                    key.model="insomnia",key.predictor="insomnia",outputs="key.results"))) }
# joining with the main results
res2$robCheck <- "distr.CLMM"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.CLMM"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

As a further check, we also inspect the results of the *distr.CLMM* robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("CLMM"),mc.predictors="TotalSteps1000",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                                    key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("CLMM"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "distr.CLMM.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.CLMM.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress` and `worry` between the full DSM insomnia and the control group

<br>

Here, we inspect the differences in the *insomnia* effect estimated by the CLMM models specified with the *insomnia* and the *insomnia.group* predictor. The figures below show that, whereas no substantial differences are estimated between the insomnia and the control group in almost any response category, **substantial differences are estimated in** `stress` **and** `worry` **between the full DSM insomnia and the control group**, with the former showing lower probability of rating `stress` and `mood` as 1, and higher probability of rating them as 3, compared to the latter.
```{r fig.width=10,fig.height=6,warning=FALSE,message=FALSE}
# plotting stress by insomnia (CLMM)
glmerAn(long=ema,wide=demos,resp="stress",fix.eff=PREdictors,modelType=c("CLMM"),mc.predictors="TotalSteps1000",
        outputs=c("coeff","plotEff"),plot.model="insomnia",plot.pred="insomnia",coeff.models="insomnia",messages=FALSE)
# plotting stress by insomnia.group (CLMM)
glmerAn(long=ema,wide=demos,resp="stress",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
        modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
        outputs=c("coeff","plotEff"),plot.model="insomnia.group",plot.pred="insomnia.group",coeff.models="insomnia.group")

# plotting worry by insomnia (CLMM)
glmerAn(long=ema,wide=demos,resp="worry",fix.eff=PREdictors,modelType=c("CLMM"),mc.predictors="TotalSteps1000",
        outputs=c("coeff","plotEff"),plot.model="insomnia",plot.pred="insomnia",coeff.models="insomnia",messages=FALSE)
# plotting worry by insomnia.group (CLMM)
glmerAn(long=ema,wide=demos,resp="worry",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
        modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
        outputs=c("coeff","plotEff"),plot.model="insomnia.group",plot.pred="insomnia.group",coeff.models="insomnia.group")

# plotting mood by insomnia (CLMM)
glmerAn(long=ema,wide=demos,resp="mood",fix.eff=PREdictors,modelType=c("CLMM"),mc.predictors="TotalSteps1000",
        outputs=c("coeff","plotEff"),plot.model="insomnia",plot.pred="insomnia",coeff.models="insomnia",messages=FALSE)
# plotting mood by insomnia.group (CLMM)
glmerAn(long=ema,wide=demos,resp="mood",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
        modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
        outputs=c("coeff","plotEff"),plot.model="insomnia.group",plot.pred="insomnia.group",coeff.models="insomnia.group")
```

<br>

#### 5.2.4.6. Late responses

Here, we inspect the results obtained by **excluding 1,010 cases** (20.5%) in which participants **filled the diary on the following day**. In section 1.2.6, these cases were marked with `diary.nextDay` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$diary.nextDay!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days, ",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=PREdictors,
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  if(diaryVar=="worry.cat"){ nAGQ=0 } else { nAGQ=1 } # nAGQ = 0 for worry.cat to reach convergence
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,fix.eff=PREdictors,nAGQ=nAGQ,
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "lateResp"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","lateResp"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most outcomes

<br>

As a further check, we also inspect the results of the `lateResp` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                           family="binomial",link="logit",messages=FALSE,
                                           outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  if(diaryVar=="worry.cat"){ nAGQ=0 } else { nAGQ=1 } # nAGQ = 0 for worry.cat to reach convergence
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),nAGQ=nAGQ,
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "lateResp.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","lateResp.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

<br>

#### 5.2.4.7. Summary of results

Here, we summarize the results from all robustness checks. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=6}
key.resPlot(RES[!grepl(".insomnia.group",RES$robCheck),],robCheck = "robCheck",
            levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the **null results** observed from the main analyses for `mood` and `PsyDist` are **highly consistent** with those obtained from the main analyses

- in contrast, the inclusion of `insomnia.group` resulted in **substantial group differences** (i.e., higher `stress`, `worry`, and `fs`) between the **full DSM insomnia** subgroup and the control group, but not between the latter and the insomnia sub-threshold subgroup

- group differences in `stress` ratings were **substantial** also when `TotalSteps1000` was excluded form the models

<br>

Here, we can see that the substantial differences in `stress`, `worry`, and `fs` are **highly consistent across all robustness checks** including the `insomnia.group` term.
```{r,fig.width=12,fig.height=5}
key.resPlot(RES[grepl(".insomnia.group",RES$robCheck),],robCheck = "robCheck",
            levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

In conclusion, the results obtained with the main analyses are **overall robust**, but the `insomnia.group` variable shows **substantial and consistent differences** that were not observed for the `insomnia` variable.

<br>

## 5.3. Sleep by diary ratings

Here, `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables are predicted by the **predictors selected in step 1** in addition to (1) the **diary ratings** measured at **day** ***i***, and (2) the **diary ratings** measured at **day** ***i+1***, in order to evaluate the direct and bidirectional relationship between sleep and psychological distress, as well as (3) the **interaction** between previous day diary ratings and `insomnia`. A **random slope** is also included to account for the individual variability in the relationship between diary ratings and sleep.

Here, we code the **next day diary ratings**.
```{r fig.width=8,fig.height=4,warning=FALSE,message=FALSE}
# selecting all diaryVars variables
diaryVars <- c("stress","worry","mood","PsyDist","fs.w")

# computing lead variables (i.e., next day, "nd")
library(dplyr)
for(i in 1:length(diaryVars)){
  colnames(ema)[colnames(ema)==diaryVars[i]] <- "variable"
  ema <- ema %>% group_by(ID) %>% mutate(variable.nd=dplyr::lead(variable,n=1,default=NA)) # computing lead var
  ema[ema$dayNr!=ema$partdayNr,"variable.nd"] <- NA # removing lagged values in cases when dayNr != partdayNr
  colnames(ema) <- gsub("variable",diaryVars[i],colnames(ema)) }
ema <- as.data.frame(ema)
detach("package:dplyr", unload=TRUE)

# correlation between PsyDist and PsyDist.nd: .34-.50 (quite high) -> risk for multicollinearity?
cor(ema$stress,ema$stress.nd,use="complete.obs")
cor(ema$worry,ema$worry.nd,use="complete.obs")
cor(ema$mood,ema$mood.nd,use="complete.obs")
cor(ema$PsyDist,ema$PsyDist.nd,use="complete.obs")
cor(ema$fs.w,ema$fs.w.nd,use="complete.obs")

# printing info
cat(nrow(ema),"total cases\n",nrow(ema[!is.na(ema$TIB),]),"with sleep.timing\n",
    nrow(ema[!is.na(ema$TIB) & !is.na(ema$PsyDist),]),"with both sleep.timing and PsyDist\n",
    nrow(ema[!is.na(ema$TIB) & !is.na(ema$PsyDist) & !is.na(ema$PsyDist.nd),]),"with sleep.timing, PsyDist, and PsyDist.nd")

# changing variable name for better compatibility with the function below
colnames(ema)[which(colnames(ema)%in%c("stress.nd","worry.nd","mood.nd","PsyDist.nd","fs.w.nd"))] <- 
  c("s.nd","w.nd","m.nd","P.nd","f.nd")
```

<br>

### 5.3.1. Sleep architecture {.tabset .tabset-fade .tabset-pills}

`s.archit` variables are modeled by considering the subset of complete `s.archit` and `dailyDiary` data, whereas `dailyAct` **data are ignored** since none of the `s.archit` variables was substantially predicted by `TotalSteps1000`. `Sex` is excluded as well, since it only predicted small differences in some `s.archit`, but not in diary ratings.

#### TIB

In section 5.1, `TIB` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (shorter `TIB` for later than usual `SO`) and ***`weekday.sleep`*** (longer `TIB` during weekend). Note that the **random slope for** `stress` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
# selecting core predictors
res <- res.nd <- res.int <- list() # empty list of key results
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TIB by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" # removing random slopes due to convergence problems
     } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") } # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) } 
  
  # saving key results (considering M3 which showed higher Aw than M2 for all predictors)
  res[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff, # day i (M3)
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[2],messages=FALSE))
  res.nd[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff, # day i+1 (M3)
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE))
  res.int[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff, # interaction (M4)
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- ***`SO.num`***, ***`weekday.sleep`***, **all raw and aggregate diary ratings**, and **next day** ***`stress`*** are associated with a **significant LRT**, whereas **stronger evidence** in terms of Aw is also shown by **next day** ***`PsyDist`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** (with the weakest effect estimated for `mood`), and **next day** ***`stress`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

#### TST

In section 5.1, `TST` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (shorter `TST` for later than usual `SO`) and ***`weekday.sleep`*** (longer `TST` during weekend). Note that the **random slope for** `mood` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TST by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  if(diaryVars[i]=="mood"){ ran.eff <- "(1|ID)" # removing random slopes due to convergence problems
     } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") } # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  # saving key results (considering M3 which showed higher Aw than M2 for all predictors)
  res[[i]] <- rbind(res[[i]],cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,ran.eff=ran.eff, #day i
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[2],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,ran.eff=ran.eff, #i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- ***`SO.num`***, ***`weekday.sleep`***, **all raw and aggregate diary ratings**, and **next day** ***`stress`*** are associated with a **significant LRT**, whereas **stronger evidence** in terms of Aw is also shown by **next day** ***`PsyDist`*** and ***`fs`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** (with the weakest effect estimated for `mood`), and **next day** ***`stress`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

- overall, the results are **highly consistent** with those reported for `TIB`

<br>

#### WASO

In section 5.1, `WASO` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (shorter `WASO` for later than usual `SO`) and ***`weekday.sleep`*** (longer `WASO` during weekend). Note that the **random slope for** `mood` is not included due to **convergence problems** (singular fit).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WASO by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="mood"){ ran.eff <- "(1|ID)" } # removing random slope for mood to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  
  # saving key results (considering M3 for stress and PsyDist which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]%in%c("stress","PsyDist","fs.w"),2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,ran.eff=ran.eff, # day i
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`SO.num`***, ***`weekday.sleep`***, ***`stress`***, ***`worry`*** (but not `mood`), ***`PsyDist`***, ***`fs`***, and **next day** ***`stress`*** are associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** with the only exception of `mood` and `stress` (only substantial in model M2 but not in the selected model M3), and for **next day** `stress`; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

#### SE

In section 5.1, `SE` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`SO.num`*** (higher `SE` for later than usual `SO`). Note that the **random slope for** `worry` and `mood` are not included due to convergence problems (singular fit).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing SE by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood")){ ran.eff <- "(1|ID)" } # removing random slope for stress and mood to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }

  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,ran.eff=ran.eff, # day i
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))

  # showing analysis
  glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite normally distributed, although a **marked deviation from normality** can be seen in the **lower tail** of the residuals distribution (i.e., SE is bounded at 100), with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- only ***`SO.num`*** is associated with a significant LRT, and showed **stronger evidence** in terms of Aw

- coherently, ***`SO.num`*** is the only predictor showing a substantial relationship with `SE`

<br>

#### light.p

In section 5.1, `light.p` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`BMI`*** (lower `light.p` for participants with higher `BMI`). Note that the **random slope for** `worry` is not included due to **convergence problems** (singular fit).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing light.p by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  if(diaryVars[i]=="worry"){ ran.eff <- "(1|ID)" # removing random slopes due to convergence problems
     } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") } # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",
                                                                   fix.eff=predictors,ran.eff=ran.eff, # day i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
                                           ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          outputs=outputs,ran.eff=ran.eff, # including random slope 
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of both distributions) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`BMI`*** is the only predictor associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- coherently, ***`BMI`*** is the only predictor showing a substantial relationship with `light.p`

<br>

#### deep.p

In section 5.1, `deep.p` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`SOL.num`*** (higher `deep.p` for later `SO` than usual). Note that **no random slopes are included** due to **convergence problems**
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing deep.p by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- "(1|ID)" # no random slopes due to convergence problems
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) } 
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",
                                                                  fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,
                                           ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,
                                           outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- ***`SO.num`*** is the only predictor associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- coherently, ***`SO.num`*** is the only predictor showing a substantial relationship with `deep.p`

<br>

#### rem.p

In section 5.1, `rem.p` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`SOL.num`*** (lower `rem.p` for later than usual `SO`). Note that the **random slope for** ***`stress`*** and ***`PsyDist`*** is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing rem.p by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("stress","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slope for stress to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) } 
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`SO.num`*** is the only predictor associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- coherently, ***`SO.num`*** is the only predictor showing a substantial relationship with `rem.p`

<br>

### 5.3.2. Sleep timing {.tabset .tabset-fade .tabset-pills}

`s.timing` variables are modeled by considering the subset of complete `s.timing` and `dailyDiary` data, whereas `dailyAct` data are ignored since none of the `s.archit` variables was substantially predicted by `TotalSteps1000` (i.e., it negatively predicted `SO.num` but the relationship was small and not supported by the Aw and the LRT). `sex` is excluded as well, for parsimony, and since it only predicted small differences in `SO.num`, but not in diary ratings.

#### SO.num

In section 5.1, `SO.num` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (later `SO.num` during weekend), ***`TotalSteps`*** (earlier `SO.num` in days with more steps than usual), ***`BMI`*** (earlier `SO.num` for participants with higher `BMI`), and ***`sex`*** (later `SO.num` for boys compared to girls). Here, we do not include `sex` and `TotalSteps1000` for parsimony, and because the latter was not selected based on the LRT or the Aw, and showed the less substantial effect in section 5.1.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing SO.num by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",
                                                                  fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite some **marked deviations in the tails** of the residuals distribution, with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`weekday.sleep`***, ***`BMI`***, and **all raw and aggregate diary ratings** (but not next day ratings) are associated with a **significant LRT**, whereas **stronger evidence** in terms of Aw is also shown by **next day** ***`stress`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings with the only exception of** ***`stress`***; whereas neither next day ratings nor `insomnia`, or its interaction with diary ratings showed a substantial effect

<br>

#### WakeUp.num

In section 5.1, `WakeUp.num` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (later `WakeUp.num` for later than usual `SO`), ***`weekday.sleep`*** (later `WakeUp.num` during weekend), and ***`BMI`*** (earlier `WakeUp.num` for participants with higher BMI). Note that the **random slope for** `stress` and `mood` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WakeUp.num by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" } # removing random slope for PsyDist to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  # saving key results (considering M3 for stress, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]=="stress",2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",
                                                                fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",
                                                                      fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the both distributions) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- ***`SO.num`***, ***`weekday.sleep`***, ***`BMI`***, **all raw and aggregate diary ratings**, and **next day** ***`stress`*** are associated with a **significant LRT**, and **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** (with the weakest effect estimated for `mood`), and **next day** ***`stress`*** and ***`PsyDist`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

### 5.3.3. Daily variability {.tabset .tabset-fade .tabset-pills}

`s.variab` variables are modeled by considering the subset of complete `s.variab` and `dailyDiary` data, whereas `dailyAct` data are ignored since none of the `s.variab` variables was substantially predicted by `TotalSteps1000`. Note that all models are specified with `nAGQ = 0` due to **convergence problems**, implying quite conservative estimates with large standard errors.

#### TIB.SSD

In section 5.1, `TIB.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `TIB.SSD` during weekend), ***`BMI`*** (higher `TIB.SSD` for participants with higher `BMI`), and ***`insomnia`*** (lower `TIB.SSD` for insomnia than controls, even when controlling for `sex`). Here, insomnia is added after diary ratings for better consistency with the other models.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TIB.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results (considering M3 for stress and PsyDist, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]%in%c("stress","PsyDist","fs.w"),2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",
                                             fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          family="gamma",link="log",transform="exp",nAGQ=0,outputs=outputs,ran.eff=ran.eff, # nAGQ = 0 to reach convergence
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress*

- ***`weekday.sleep`***, ***`BMI`***, ***`insomnia`***, ***`stress`***, and **next day** ***`PsyDist`*** are associated with a **significant LRT**, whereas ***`weekday.sleep`***, ***`BMI`***, ***`insomnia`***, ***`stress`***, ***`PsyDist`***, and **next day** ***`stress`***,  ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- however, only the effects reported in section 5.1 are substantial, and ***`insomnia`*** **is no longer substantially associated** with `TIB` after the inclusion of any diary rating in the model (possibly due to `nAGQ=0`)

<br>

#### TST.SSD

In section 5.1, `TST.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `TST.SSD` during weekend), ***`BMI`*** (higher `TST.SSD` for participants with higher `BMI`), and ***`insomnia`*** (lower `TST.SSD` for insomnia than controls, even when controlling for `sex`). Here, insomnia is added after diary ratings for better consistency with the other models.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TST.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) } 
  
  # saving key results (considering M3 for mood and PsyDist, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]%in%c("mood","PsyDist","fs.w"),2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",
                                             fix.eff=predictors,ran.eff=ran.eff, # day i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          family="gamma",link="log",transform="exp",nAGQ=0,outputs=outputs,ran.eff=ran.eff, # nAGQ = 0 to reach convergence
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- ***`weekday.sleep`***, ***`BMI`***, ***`stress`***, and **next day** ***`PsyDist`***, and ***`fs`*** are associated with a **significant LRT**, and showed **stronger evidence** in terms of Aw; significant LRT is also shown by **next day** ***`mood`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **next day** ***`Mood`***, ***`PsyDist`***, and ***`fs`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect; in particular, ***`insomnia`*** **is no longer substantially associated** with *TST* after the inclusion of any diary rating in the model (possibly due to `nAGQ=0`)

<br>

#### WASO.SSD

In section 5.1, `WASO.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`SO.num`*** (lower `WASO.SSD` for later than usual SO) and ***`weekday.sleep`*** (higher `WASO.SSD` during weekend).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WASO.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",
                                             fix.eff=predictors,ran.eff=ran.eff, # day i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors, # GLMER with mean-centered pred.
          family="gamma",link="log",transform="exp",nAGQ=0,outputs=outputs,ran.eff=ran.eff, # nAGQ = 0 to reach covergence
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **significant LRT**, and showed **stronger evidence** in terms of Aw

- coherently, only the effects reported in section 5.1 are substantial

<br>

#### SO.num.SSD

In section 5.1, `SO.num.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `SO.num.SSD` during weekend), and ***`insomnia`*** (lower `SO.num.SSD` for insomnia than controls, even when controlling for `sex`). Here, insomnia is added after diary ratings for better consistency with the other models.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing SO.num.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="SO.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,ran.eff=ran.eff, # nAGQ = 0 to reach convergence
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="SO.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,ran.eff=ran.eff, # day i+1
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="SO.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **marked deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- only ***`weekday.sleep`*** and ***`insomnia`*** are associated with a **significant LRT**, whereas only ***`weekday.sleep`*** showed **stronger evidence** in terms of Aw

- coherently, only ***`weekday.sleep`*** shows a substantial effect; in particular,***`insomnia`*** **is no longer substantially associated** with `SO.num.SSD` after the inclusion of any diary rating in the model (possibly due to `nAGQ=0`)

<br>

#### WakeUp.num.SSD

In section 5.1, `WakeUp.num.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `WakeUp.num.SSD` during weekend).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WakeUp.num.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results (considering M3, which showed sig. LRT and/or higher AW compared to M2)
  res[[i]] <- rbind(res[[i]],cbind(measure="WakeUp.num.SSDc",
       glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,nAGQ=0, # nAGQ = 0 to reach convergence
               modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",
               outputs="key.results",key.predictor=keys[1],key.model=keys[2],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WakeUp.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,
               modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
               outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WakeUp.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0
          outputs=outputs,ran.eff=ran.eff, coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- ***`weekday.sleep`*** and **all next day raw and aggregate diary ratings** are associated with a **significant LRT**, whereas ***weekday.sleep***, ***`stress`***, ***`PsyDist`***, and **next day** ***`stress`***, ***`mood`***, ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all next day raw and aggregate diary ratings** (with the weakest effect estimated for `stress`), whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

### 5.3.4. Sleep autonomic func. {.tabset .tabset-fade .tabset-pills}

`s.auton` variables are modeled by considering the subset of complete `s.auton`, `dailyDiary`, and `dailyAct` data.

#### HR_NREM

In section 5.1, `HR_NREM` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`TotalSleep1000`*** (higher `HR_NREM` for higher than usual `TotalSleep1000`), ***`weekday.sleep`*** (higher `HR_NREM` during weekends), ***`BMI`*** (higher `stageHR_TST` for participants with higher `BMI`), ***`sex`*** (higher `stageHR_TST` in girls compared to boys), and the **interaction** between `insomnia` and `sex` (lower `stageHR_TST` in female insomnia compared to control insomnia). Contrarily to the other analyses, here `sex` is included (since it is an important predictor), while `insomnia` is added after diary ratings for better consistency. Note that the **random slope for** `worry` and `fs` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing HR_NREM by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("TotalSteps1000","weekday.sleep","BMI","sex",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","fs.w")){ ran.eff <- "(1|ID)" } # removing random slope for fs to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "TotalSteps1000" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("TotalSteps1000",diaryVars[i],nd) }
  
  # saving key results (considering M3 for mood, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]=="mood",2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",
                                             fix.eff=predictors,ran.eff=ran.eff,gmc.predictors="BMI",
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",
                                             fix.eff=predictors,ran.eff=ran.eff,gmc.predictors="BMI",
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite a **marked deviation in the upper tail** of the residuals distribution, with (3) **homogeneity** between the variances across *sex* and *insomnia* levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`TotalSteps1000`***, ***`weekday.sleep`***, ***`BMI`***, ***`sex`***, ***`insomnia`***, ***`stress`***, **next day** ***`mood`***, and **the interactive terms** (but not with `mood`) are associated with a **significant LRT**, whereas ***`TotalSteps1000`***, ***`weekday.sleep`***, ***`BMI`***, ***`sex`***, ***`insomnia`***, ***`stress`***, and **the interactive term with** ***`stress`***, ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, a **substantial positive effect** is only estimated for **next day** ***`mood`***, and by the **interaction between** ***`insomnia`*** **and** ***`stress`***, ***`worry`***, **and** ***`fs`***

<br>

#### HR_REM

In section 5.1, `HR_REM` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (higher `HR_REM` for later than usual `SO`), ***`TotalSleep1000`*** (higher `HR_NREM` for higher than usual `TotalSleep1000`), ***`sex`*** (higher `stageHR_TST` in girls compared to boys), and the **interaction** between `insomnia` and `sex` (lower `stageHR_TST` in female insomnia compared to control insomnia). Contrarily to the other analyses, here `sex` is included (since it is an important predictor), while `insomnia` is added after diary ratings for better consistency. Note that the **random slope for** `worry` and `mood` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing HR_REM by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","TotalSteps1000","sex",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood")){ ran.eff <- "(1|ID)" } # removing random slope for mood to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # selecting mean-centered pred. (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  
  # saving key results (considering M3 for mood, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]=="mood",2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",
                                             fix.eff=predictors,ran.eff=ran.eff,gmc.predictors="BMI",
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite a **marked deviation in the upper tail** of the residuals distribution, with (3) **homogeneity** between the variances across *sex* and *insomnia* levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`SO.num`***, ***`TotalSteps1000`***, ***`sex`***, ***`insomnia`***, ***`stress`***, ***`PsyDist`***, ***`fs`***, and **next day** ***`mood`*** are associated with a **significant LRT**, whereas ***`SO.num`***, ***`TotalSteps1000`***, ***`sex`***, ***`insomnia`***, ***`stress`***, ***`PsyDist`***, ***`fs`***, and **next day** ***`stress`***, ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, a **substantial positive effect** is only estimated for ***`stress`*** and **next day** ***`mood`***

<br>

### 5.3.5. Summary of results {.tabset .tabset-fade .tabset-pills}

Here, we use the `key.resPlot` function to graphically summarize the results obtained from the models above. The figure below shows the t-values associated with the `*diary ratings preceding** the sleep periods by considering either model M2 (main effect of **previous day diary ratings**) or model M3 (main effect of the **next day diary ratings**). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, and |t| > 1.96 ) are shown in **green**

- those relationships showing a **|t| > 1.96** but either a nonsignificant LRT **or** a lower Aw than the previous model are shown in **light green** (or lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT **and** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT **or** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT **and** lower Aw than the previous models are shown in **red**

#### PREVIOUS DAY
```{r,fig.width=12,fig.height=4}
# all results in one data.frame
RES <- rbind(cbind(res[[1]],pred=rep("stress",16)),cbind(res[[2]],pred=rep("worry",16)),
             cbind(res[[3]],pred=rep("mood",16)),cbind(res[[4]],pred=rep("PsyDist",16)),
             cbind(res[[5]],pred=rep("fs.w",16)))
RES$pred <- factor(RES$pred,levels=c("fs.w","PsyDist","mood","worry","stress"))

# stress
key.resPlot(RES,robCheck="pred")
```

<br>

*Comments:*

- the analysis of the relationships between sleep outcomes and diary ratings highlighted **substantial negative relationships** between previous day diary ratings and `TIB` (negatively related to all ratings), `TST` and `WakeUp.num` (related to all ratings but `mood`), `WASO` (only substantially related with `worry` and `PsyDist`), and `SO.num` (only insubstantially related to `stress`)

- a substantial positive relationship is also observed between `stress` and `HR_REM`

<br>

#### NEXT DAY
```{r,fig.width=12,fig.height=4}
# all results in one data.frame
RES.nd <- rbind(cbind(res.nd[[1]],pred=rep("stress",16)),cbind(res.nd[[2]],pred=rep("worry",16)),
                cbind(res.nd[[3]],pred=rep("mood",16)),cbind(res.nd[[4]],pred=rep("PsyDist",16)),
                cbind(res.nd[[5]],pred=rep("fs.w",16)))
RES.nd$pred <- factor(RES.nd$pred,levels=c("fs.w","PsyDist","mood","worry","stress"))

# stress
key.resPlot(RES.nd,robCheck="pred")
```

<br>

*Comments:*

- the analysis of the relationships between sleep outcomes and next day diary ratings highlighted **substantial negative relationships** between the **next day** `stress` ratings and `TIB`, `TST`, `WASO`, and `WakeUp.num`

- `WakeUp.num.SSD` is negatively associated with **all next day ratings** (although the relationship with `worry` is not supported by the Aw)

- `TIB.SSD` and `TST.SSD` only show some substantial negative relationships with **next day** `PsyDist`

- **next day** `mood` ratings show a negative relationship with `TST.SSD`, and a positive relationship with both `HR_NREM`, and `HR_REM`, although some of them was not supported by higher Aw than the previous model

<br>

#### INTERACTION
```{r,fig.width=12,fig.height=4}
# all results in one data.frame
RES.int <- rbind(cbind(res.int[[1]],pred=rep("stress",16)),cbind(res.int[[2]],pred=rep("worry",16)),
                cbind(res.int[[3]],pred=rep("mood",16)),cbind(res.int[[4]],pred=rep("PsyDist",16)),
                cbind(res.int[[5]],pred=rep("fs.w",16)))
RES.int$pred <- factor(RES.int$pred,levels=c("fs.w","PsyDist","mood","worry","stress"))

# stress
key.resPlot(RES.int,robCheck="pred")
```

<br>

*Comments:*

- the analysis of the interactive model highlighted **substantial interactions** between `insomnia` and `stress`, `worry`, and `fs` only in predicting `HR_NREM` (i.e., stronger positive relationship between diary ratings and `HR_NREM` in `insomnia` compared to controls)

- none of the other sleep outcomes are substantially predicted by the interactive terms

<br>

### 5.3.6. Robustness checks {#robcheck}

Here, we conduct several **robustness checks** to account for the arbitrariness of our data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the insomnia variable, (2) the inclusion of the `covid19` variable as a further covariate, (3) the exclusion of participants with **extreme missing data**, (4) the **exclusion of** `TotalSteps1000`, (5) the use of **alternative family distributions** for the analyses.

In addition to the `glmerAn` and the `keyResPlot` functions reported in section 5.1.6, we also use the `predSelect` function to **select the covariates** of each sleep outcome, based on the results in section 5.1.

<details><summary>**show** ***predSelect***</summary>
<p>
```{r }
predSelect <- function(sleepVar){ 
  
  # SE, deep.p, and rem.p were only predicted by SO.num
  if(sleepVar%in%c("SE","deep.p","rem.p")){ 
    predictors <- c("SO.num") 
    
    # SO.num.SSDc and WakeUp.num.SSDc were only predicted by weekday.sleep
    } else if(sleepVar%in%c("SO.num.SSDc","WakeUp.num.SSDc")){
      predictors <- "weekday.sleep"
      
      # light.p was only predicted by BMI
      } else if(sleepVar=="light.p"){ 
        predictors <- "BMI"
    
        # SO.num, TIB.SSDc, and TST.SSDc were predicted by weekday.sleep and BMI
        } else if(sleepVar%in%c("SO.num","TIB.SSDc","TST.SSDc")){
          predictors <- c("weekday.sleep","BMI")
          
          # WakeUp.num was predicted by SO.num, weekday.sleep, and BMI
          } else if(sleepVar=="WakeUp.num"){ 
            predictors <- c("SO.num","weekday.sleep","BMI")
            
            # HR_NREM was predicted by TotalSteps1000, weekday.sleep, BMI, and sex
            } else if(sleepVar=="HR_NREM"){
              predictors <- c("TotalSteps1000","weekday.sleep","BMI","sex")
              
              # HR_NREM was predicted by SO.num, TotalSteps1000, and sex
              } else if(sleepVar=="HR_REM"){ 
                predictors <- c("SO.num","TotalSteps1000","sex")
                
                # all remaining sleep outcomes were predicted by SO.num and weekday.sleep
                } else { predictors <- c("SO.num","weekday.sleep") }
  
  return(predictors)}
```
</p></details>

<br>

<br>

#### 5.3.6.1. insomnia.group

Here, we inspect the results on the ***interactive term*** obtained by considering the ***insomnia.group*** (i.e., 46 controls, 26 DSM.ins and 21 sub.ins) rather than the `insomnia` variable (i.e., 46 controls vs. 47 insomnia). 

The figure below shows the t-values associated with the interactive term for each sleep outcome and diary predictor, by considering model M4 (interactive model). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Note that the **random slope for** `stress` on `SO.num`, that for `worry` on `WASO`, and that for `fs` on `WakeUp.num`, `WASO.SSD`, and `HR_NREM` were not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia.group",paste(diaryVars[i],"insomnia.group",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(diaryVars[i],".mc:insomnia.group",sep="") 
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    key <- paste(diaryVars[i],":insomnia.group",sep="")
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia.group",key)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" |
       (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","SO.num")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) | 
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WakeUp.num","WASO.SSDc","HR_NREM"))){ ran.eff <- "(1|ID)"
    } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    key <- paste(diaryVars[i],".mc:insomnia.group",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}

# plotting robustness check
RES.int <- list()
for(i in 1:length(res.int)){
  res.int[[i]]$robCheck <- "Original"
  res2[[i]]$robCheck <- "insomnia.group"
  RES.int[[i]] <- rbind(res.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]],robCheck = "robCheck") + ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most sleep outcomes

- the only difference is that even the **interactions on** `HR_NREM` **are not substantial**, and that `worry` is now **substantially associated** with both `TIB.SSD` and `TST.SSD`

<br>

#### 5.3.6.2. COVID-19 emergency {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by including the `covid19` variable **as a further covariate**. As shown in section 1.2.8, the `covid19` factor discriminates the data collected `pre-COVID19` (63%) and the data collected `post-COVID19` (37%). The covariate is included **at the first step** (model M1, before the first predictor). 

The figures below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

##### PREVIOUS DAY

Note that the **random slope for** `stress` on `HR_NREM`, that of `worry` on `rem.p`, and that of `fs.w` on `rem.p` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  key.pred <- paste(diaryVars[i],".mc",sep="") # selecting target predictor (previous day ratings) and target model (M2 or M3)
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  key.model <- paste(nd,".mc",sep="") # selecting model including next day day rating 
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c("covid19",predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    key.pred <- paste(diaryVars[i],".mc",sep="") # M2 (previous day rating)
    if(sleepVar=="WakeUp.num.SSDc" | (diaryVars[i]=="stress"  & sleepVar%in%c("TST","WASO","WakeUp.num")) | # M3 (next day ratings)
       (diaryVars[i]=="mood"  & sleepVar%in%c("TST.SSDc","HR_NREM","HR_REM")) |
       (diaryVars[i]=="PsyDist"  & sleepVar%in%c("WakeUp.num","TIB.SSDc","TST.SSDc","WakeUp.SSDc")) |
       (diaryVars[i]=="fs.w"  & sleepVar=="TST.SSDc")){ key.model <- paste(nd,"mc",sep=".") 
       } else { key.model <- paste(diaryVars[i],"mc",sep=".") } 
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","HR_NREM")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("rem.p"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",
                               key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}

# plotting robustness check
RES.pd <- list()
for(i in 1:length(res)){
  res[[i]]$robCheck <- "Original"
  res2[[i]]$robCheck <- "covid19"
  RES.pd[[i]] <- rbind(res[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]],robCheck = "robCheck") + ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

- the only difference is highlighted for `SO.num` (showing no longer substantial relationship with `worry`)

<br>

##### NEXT DAY

Note that the **random slope for** `stress` on `HR_NREM`, that of `worry` on `rem.p`, and that of `fs.w` on `rem.p` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(nd,".mc",sep="") # selecting model including next day day rating
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c("covid19",predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key <- paste(nd,".mc",sep="") # selecting target predictor (next day rating) and target model (M3)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","rem.p","HR_NREM")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("rem.p"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}

# plotting robustness check
RES.nd <- list()
for(i in 1:length(res)){
  res.nd[[i]]$robCheck <- "Original"
  res2[[i]]$robCheck <- "covid19"
  RES.nd[[i]] <- rbind(res.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","covid19"),],
                    robCheck = "robCheck") + ggtitle(paste("Next day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

In conclusion, the results of this robustness check were **highly consistent** with those obtained with the main analyses, although **questioning the generalizability of the relationships observed between next day** `PsyDist` **and** `WakeUp.num`.

<br>

##### INTERACTION

Note that the **random slope for** `stress` on `TST`, `HR_NREM`, that of `Worry` on `rem.p`, and that of `fs` on `rem.p`, and `HR_NREM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],":insomnia",sep="")
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",key)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID) "}
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M4)
    key <- paste(diaryVars[i],":insomnia",sep="")
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c("covid19",predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia",key)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","rem.p","HR_NREM","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("SE","rem.p")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("rem.p","HR_NREM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "covid19"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","covid19"),],robCheck = "robCheck") + 
          ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses for most sleep outcomes

- the main difference is that the **interactive term** for `PsyDist` is substantial on `HR_NREM` with the inclusion of *covid19* as a further covariate

<br>

#### 5.3.6.3. Low compliance {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by **excluding seven participants** (7.5%) with **less than two weeks of valid observations in any data type**. In section 3.2, these participants were marked with `majMiss` = 1. 

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

##### PREVIOUS DAY

Note that the **random slope for** `stress` on `TST`, that for `worry` on `WASO`, that for `PsyDist` on `SE` and `light.p`, and that of `fs` on `light.p` and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$majMiss!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days, ",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    key.pred <- paste(diaryVars[i],".mc",sep="") # M2 (previous day rating)
    if(sleepVar=="WakeUp.num.SSDc" | (diaryVars[i]=="stress"  & sleepVar%in%c("TST","WASO","WakeUp.num")) | # M3 (next day ratings)
       (diaryVars[i]=="mood"  & sleepVar%in%c("TST.SSDc","HR_NREM","HR_REM")) |
       (diaryVars[i]=="PsyDist"  & sleepVar%in%c("WakeUp.num","TIB.SSDc","TST.SSDc","WakeUp.SSDc")) |
       (diaryVars[i]=="fs.w"  & sleepVar=="TST.SSDc")){ key.model <- paste(nd,"mc",sep=".") 
    } else { key.model <- paste(diaryVars[i],"mc",sep=".") }
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","SE","light.p"))|
       (diaryVars[i]=="fs.w" & sleepVar%in%c("light.p","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",
                               key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}

# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "majMiss"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `mood`, whose relationship with `TIB` is **no longer substantial** after the exclusion of participants with `majMiss`

- similarly, the relationship between `worry` and `SO.num` is **no longer substantial**

<br>

##### NEXT DAY

Note that the **random slope for** `stress` on `TST`, that for `worry` on `WASO`, that for `PsyDist` on `SE` and `light.p`, and that of `fs` on `light.p` and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(nd,".mc",sep="") # selecting model including next day day rating
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","SE","light.p"))|
       (diaryVars[i]=="fs.w" & sleepVar%in%c("light.p","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(nd,".mc",sep="") # selecting target predictor (next day rating) and target model (M3)
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # selecting family distribution
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "majMiss"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck") + 
           ggtitle(paste("Next day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the main differences are highlighted for `TST.SSD` (showing no longer substantial relationship with **next day** `mood`), `TIB.SSD` (showing no longer substantial relationship with **next day** `PsyDist`), and `WakeUp.num.SSDc` (showing no longer substantial relationship with **next day** `stress`)

<br>

##### INTERACTION

Note that the **random slope for** `stress` on `TST`, that for `worry` on `WASO` and `rem.p`, that for `mood` on `HR_NREM`, that for `PsyDist` on `SE` and `light.p`, and that of `fs` on `light.p` and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],":insomnia",sep="")
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",key)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M4)
    key <- paste(diaryVars[i],":insomnia",sep="")
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia",key)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","SE","light.p"))|
       (diaryVars[i]=="fs.w" & sleepVar%in%c("light.p","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "majMiss"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck") + 
          ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the only difference is that the interactions between `insomnia` and `worry` on both `rem.p` and `HR_REM` are no longer substantial (although nor really diminished) after the exclusion of `majMiss` participants

<br>

#### 5.3.6.4. TotalStep1000 {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by **excluding** `TotalSteps1000` **from the models predictors**. This is done in order to replicate the analyses by including cases with invalid daily steps data (thus, with higher sample size). Note that for these analyses, `TotalSteps1000` was only included in `HR_NREM` models.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

##### PREVIOUS DAY

Note that the **random slope for** `mood` is not included due to **convergence problems**, in addition to the random slopes removed above.
```{r,fig.width=12,fig.height=3}
# computing key results for HR_NREM
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("weekday.sleep","BMI","sex",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="mood"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- key.pred } # model M3 only for mood
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c(diaryVars[i],nd) }
  
  # updating results
  res2[[i]] <- cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "no-TotalSteps"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the only difference is that `stress` now shows a **substantial positive relationship** with `HR_NREM`

<br>

##### NEXT DAY

Note that the **random slope for** `mood` is not included due to **convergence problems**.
```{r,fig.width=12,fig.height=3}
# computing key results for HR_NREM
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("weekday.sleep","BMI","sex",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(nd,".mc",sep="") # next day rating
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c(diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "no-TotalSteps"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck") + 
           ggtitle(paste("Next day day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

##### INTERACTION

Note that the **random slope for** `mood` is not included due to **convergence problems**.
```{r,fig.width=12,fig.height=3}
# computing key results for HR_NREM
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],":insomnia",sep="")
  predictors <- c("weekday.sleep","BMI","sex",diaryVars[i],nd,"insomnia",key)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c(diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                           modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "no-TotalSteps"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck") + 
           ggtitle(paste("Next day day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses: the **interaction** between `insomnia` and both `worry` and `fs` are **no longer substantial**

- in contrast, the interaction between `insomnia` and `PsyDist` becomes substantial with the removal of `TotalSteps1000`

<br>

#### 5.3.6.5. Family distribution {.tabset .tabset-fade .tabset-pills}

Here, we replicate the models predicting those variables that showed poor fit in the model diagnostics above by re-specifying the models with different distribution families and link functions. As done in section 5.1.6.6, we model:

- `WASO` and both `s.auton` outcomes by using the **gamma distribution**

- all `s.variab` outcomes by assuming a **normal distribution**

<br>

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

##### PREVIOUS DAY

Note that the **random slope for** `worry` on `SO.num.SSD`, that for `mood` and `PsyDist` on `TIB.SSD`, `TST.SSD`, and `SO.num.SSD`, that of `fs` on `TIB.SSD` and `SO.num.SSD`, and **all random slopes on** `WASO.SSD` and `WakeUp.num.SSD` are not included due to **convergence problems**. Moreover, the model predicting `TIB.SSD` by `fs` does not converge even when excluding its random slope.
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001 # adding little constant to have no zero values
res2 <- list()
for(i in 1:length(diaryVars)){
  # selecting predictors (up to model M3)
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" }
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                            family="gamma",link="log", # gamma with log link function
                                            mc.predictors=mc.predictors,
                                            outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE,
                                            nAGQ=0)) } # nAGQ = 0 to reach convergence
# computing key results for s.variab
for(sleepVar in paste(s.variab,"c",sep="")){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
    if(sleepVar=="WakeUp.num.SSDc" | (sleepVar=="TIB.SSDc" & diaryVars[i]=="PsyDist") |
       (sleepVar=="TST.SSDc" & diaryVars[i]%in%c("mood","PsyDist","fs.w"))){ key.model <- paste(nd,"mc",sep=".") 
       } else { key.model <- paste(diaryVars[i],"mc",sep=".") } 
    # removing random slopes for those models showing convergence problems
    if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc") |
       (diaryVars[i]=="worry" & sleepVar=="SO.num.SSDc") |
       (diaryVars[i]%in%c("mood","PsyDist") & sleepVar%in%c("TIB.SSDc","TST.SSDc","SO.num.SSDc")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("TIB.SSDc","SO.num.SSDc"))){ ran.eff <- "(1|ID)" 
    } else {  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")  }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
    
    # updating results
    if(!(sleepVar=="TIB.SSDc" & diaryVars[i]=="fs.w")){ # model that doesn't converge even without random slope
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="normal",link="identity", # normal with identity funct
                               outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}}

# computing key results for s.auton
for(sleepVar in s.auton){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
    if(diaryVars[i]=="mood"){ key.model <- paste(nd,"mc",sep=".") } else { key.model <- paste(diaryVars[i],"mc",sep=".") } 
    ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="gamma",link="log", # normal with identity funct
                               outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE,
                               nAGQ=0))) }} # nAGQ = 0 to reach convergence
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "familyDistr"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the main differences are highlighted for `stress`, whose relationship with `WASO` **becomes substantial** when modeled by assuming a **gamma distribution** for residuals, whereas its relationship with `HR_REM` **becomes not substantial** when modeled with the same assumption

<br>

##### NEXT DAY

Note that the **random slope for** `worry` on `SO.num.SSD`, that for `mood` and `PsyDist` on `TIB.SSD`, `TST.SSD`, and `SO.num.SSD`, that of `fs` on `TIB.SSD` and `SO.num.SSD`, and **all random slopes on** `WASO.SSD` and `WakeUp.num.SSD` are not included due to **convergence problems**. Moreover, the model predicting `TIB.SSD` by `fs` does not converge even when excluding its random slope.
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001 # adding little constant to have no zero values
res2 <- list()
for(i in 1:length(diaryVars)){
  # selecting predictors (model M3)
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" }
  key <- paste(nd,".mc",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                            family="gamma",link="log",mc.predictors=mc.predictors,  # gamma with log link function
                                            outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                                            nAGQ=0)) } # nAGQ = 0 to reach convergence
# computing key results for s.variab
for(sleepVar in paste(s.variab,"c",sep="")){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M3)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key <- paste(nd,".mc",sep="")
    # removing random slopes for those models showing convergence problems
    if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc") |
       (diaryVars[i]=="worry" & sleepVar=="SO.num.SSDc") |
       (diaryVars[i]%in%c("mood","PsyDist") & sleepVar%in%c("TIB.SSDc","TST.SSDc","SO.num.SSDc")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("TIB.SSDc","SO.num.SSDc"))){ ran.eff <- "(1|ID)" 
    } else {  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")  }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
    
    # updating results
    if(!(sleepVar=="TIB.SSDc" & diaryVars[i]=="fs.w")){ # model that doesn't converge even without random slope
      res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="normal",link="identity", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}}

# computing key results for s.auton
for(sleepVar in s.auton){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M3)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key <- paste(nd,"mc",sep=".") 
    ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="gamma",link="log", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                               nAGQ=0))) }} # nAGQ = 0 to reach convergence

# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "familyDistr"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` outcomes, with **no longer substantial relationships** between **next day** `worry` and `WakeUp.num.SSD`, between **next day** `PsyDist` and both `TIB.SSD` and `TST.SSD`, and between **next day** `fs` and `TST.SSD` when modeled by assuming a **normal** distribution for residuals

<br>

##### INTERACTION

Note that the **random slope for** `worry` on `SO.num.SSD`, that for `mood` and `PsyDist` on `TIB.SSD`, `TST.SSD`, and `SO.num.SSD`, that of `fs` on `TIB.SSD` and `SO.num.SSD`, and **all random slopes on** `WASO.SSD` and `WakeUp.num.SSD` are not included due to **convergence problems**. Moreover, the model predicting `TIB.SSD` by `fs` does not converge even when excluding its random slope.
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001 # adding little constant to have no zero values
res2 <- list()
for(i in 1:length(diaryVars)){
  # selecting predictors (model M4)
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,gsub(".mc","",key))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  # updating results
  res2[[i]] <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                            family="gamma",link="log", # gamma with log link function
                                            mc.predictors=mc.predictors,
                                            outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                                            nAGQ=0)) } # nAGQ = 0 to reach convergence
# computing key results for s.variab
for(sleepVar in paste(s.variab,"c",sep="")){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M4)
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,gsub(".mc","",key))
    # removing random slopes for those models showing convergence problems
    if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc") |
       (diaryVars[i]=="worry" & sleepVar=="SO.num.SSDc") |
       (diaryVars[i]%in%c("mood","PsyDist") & sleepVar%in%c("TIB.SSDc","TST.SSDc","SO.num.SSDc")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("TIB.SSDc","SO.num.SSDc"))){ ran.eff <- "(1|ID)" 
    } else {  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")  }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
    
    # updating results
    if(!(sleepVar=="TIB.SSDc" & diaryVars[i]=="fs.w")){ # model that doesn't converge even without random slope
      res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="normal",link="identity", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}}

# computing key results for s.auton
for(sleepVar in s.auton){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M4)
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,gsub(".mc","",key))
    ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="gamma",link="log", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                               nAGQ=0))) }} # nAGQ = 0 to reach convergence
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "familyDistr"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main difference is is that the **interaction** between `insomnia` and both `worry` and `fs` are **no longer substantial** (similarly to what resulted in section 5.3.6.5), whereas the interaction with `stress` is still substantial although not supported by the Aw

<br>

#### 5.3.6.6. Late responses {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by **excluding 1,010 cases** (25.5%) in which participants **filled the diary on the following day**. In section 1.2.6, these cases were marked with `diary.nextDay` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

##### PREVIOUS DAY

Note that the **random slope for** `mood` on `TIB`, `rem.p`, and `HR_NREM`, and that of `fs` on `WASO.SSD`, `HR_NREM`, and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# excluding cases with diary responses in the next day
EMA <- ema[ema$diary.nextDay!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days,",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" } # removing random slope for mood to reach convergence
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    key.pred <- paste(diaryVars[i],".mc",sep="") # M2 (previous day rating)
    if(sleepVar=="WakeUp.num.SSDc" | (diaryVars[i]=="stress"  & sleepVar%in%c("TST","WASO","WakeUp.num")) | # M3 (next day ratings)
       (diaryVars[i]=="mood"  & sleepVar%in%c("TST.SSDc","HR_NREM","HR_REM")) |
       (diaryVars[i]=="PsyDist"  & sleepVar%in%c("WakeUp.num","TIB.SSDc","TST.SSDc","WakeUp.SSDc")) |
       (diaryVars[i]=="fs.w"  & sleepVar=="TST.SSDc")){ key.model <- paste(nd,"mc",sep=".") 
       } else { key.model <- paste(diaryVars[i],"mc",sep=".") }
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","rem.p","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WASO.SSDc","HR_NREM","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",
                               key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}

# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "lateResp"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","lateResp"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `mood`, whose relationships with `TIB` is **no longer substantial** after the exclusion of participants with `majMiss`, similarly to the results in section 5.3.6.3.

<br>

##### NEXT DAY

Note that the **random slope for** `mood` on `TIB`, `rem.p`, and `HR_NREM`, and that of `fs` on `WASO.SSD`, `HR_NREM`, and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  key <- paste(nd,".mc",sep="") # selecting model including next day day rating
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","rem.p","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WASO.SSDc","HR_NREM","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(nd,".mc",sep="") # selecting target predictor (next day rating) and target model (M3)
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # selecting family distribution
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "lateResp"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","lateResp"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- with the exclusion of **late responses`, **next day** `stress` is now negatively related with `SO.num`, `TIB.SSDc`, and `TST.SSD`

- in contrast, **next day** `mood` is no longer substantially associated with both `TST.SSD` and `HR_NREM`

- a few unsubstantial changes are observed also for the relationships between **next day** `fs` and both `TIB.SSD` and `TST.SSD`

<br>

##### INTERACTION

Note that the **random slope for** `stress` on `HR_NREM` and `HR_REM`, that of `mood` on `TIB`, `rem.p`, and `HR_NREM`, and that of `fs` on `WASO.SSD`, `HR_NREM`, and `HR_REM`, are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M4)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","HR_NREM","HR_REM")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","rem.p","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WASO.SSDc","HR_NREM","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "lateResp"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","lateResp"),],robCheck = "robCheck") + 
          ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the only difference is that with the removal of **lateResp** the interaction between `insomnia` and `mood` on `WASO.SSDc`, and that between `insomnia` and `PsyDist` on `HR_NREM` become **substantial**

- in contrast, the interaction with `worry` on `rem.p` is strongly diminished, becoming not substantial

<br>

#### 5.3.6.7. Summary of results {.tabset .tabset-fade .tabset-pills}

Here, we summarize the results from all robustness checks. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

The robustness checks are separately visualized for each effect of interest.

##### PREVIOUS DAY 
```{r,fig.width=12,fig.height=5}
# stress
key.resPlot(RES.pd[[1]],robCheck = "robCheck")

# worry
key.resPlot(RES.pd[[2]],robCheck = "robCheck")

# mood
key.resPlot(RES.pd[[3]],robCheck = "robCheck")

# PsyDist
key.resPlot(RES.pd[[4]],robCheck = "robCheck")

# fs
key.resPlot(RES.pd[[5]],robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses (especially on `s.archit` and `s.variab`) are **highly consistent** across the robustness checks

- the **most consistent effects** are those of `stress`, `worry`, and `PsyDist` on `TIB`, `TST`, and `WakeUp.num`, in addition to the negative relationship between `SO.num` and both `mood` and `PsyDist`, and that between `WASO` and both `worry` and `PsyDist`

- the positive relationship between `stress` and `HR_REM` is also relatively **consistent**, but diminished by the exclusion of **lateResp** and by the use of the **gamma** distribution

- **lower consistency** is shown by the relationship between `mood` and `TIB` (not substantial in 2 out of 4 robustness checks), and that between `worry` and `SO.num` (not substantial in 2 out of 4)

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, indicating **consistent negative relationships** between diary ratings and `TIB`, `TST`, `WASO`, `SO.num`, and `WakeUp.num`, in addition to a positive relationship between `stress` and `HR_REM`.

<br>

##### NEXT DAY 
```{r,fig.width=12,fig.height=5}
# stress
key.resPlot(RES.nd[[1]],robCheck = "robCheck")

# worry
key.resPlot(RES.nd[[2]],robCheck = "robCheck")

# mood
key.resPlot(RES.nd[[3]],robCheck = "robCheck")

# PsyDist
key.resPlot(RES.nd[[4]],robCheck = "robCheck")

# fs
key.resPlot(RES.nd[[5]],robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses (especially on `s.archit` and `s.variab`) are **highly consistent** across the robustness checks

- the **most consistent effects** are those of **next day** `stress` on `TIB`, `TST`, `WASO`, and `WakeUp.num`, those of `mood` on both `HR_NREM` and `HR_REM`, and those of all diary ratings on `Wake.up.num.SSD`

- **lower consistency** is shown by the relationship between `mood` and `TST.SSD` (not substantial in 2 out of 5 robustness checks), and that between `PsyDist` and `TIB.SSD` (not substantial in 2 out of 5)

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, indicating **consistent negative relationships** between **next day** `stress` and `TIB`, `TST`, `WASO`, and `WakeUp.num`, between `mood` and both `HR_NREM` and `HR_REM`, and between `WakeUp.num.SSD` and all diary ratings.

<br>

##### INTERACTION
```{r,fig.width=12,fig.height=6}
# stress
key.resPlot(RES.int[[1]],robCheck = "robCheck")

# worry
key.resPlot(RES.int[[2]],robCheck = "robCheck")

# mood
key.resPlot(RES.int[[3]],robCheck = "robCheck")

# PsyDist
key.resPlot(RES.int[[4]],robCheck = "robCheck")

# fs
key.resPlot(RES.int[[5]],robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses are **highly consistent** across the robustness checks

- the interaction between `stress` and `insomnia` on `HR_NREM` is **quite consistent** (substantial in 6 out of 7 robustness check)

- **lower consistency** is shown by the interaction between *insomnia* and `worry` (substantial in 3 out of 7 robustness checks) and that with `fs` (substantial in 3 out of 7 robustness checks)

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, indicating **consistent cross-level interactions** between `insomnia` **and** `stress` on `HR_NREM`

<br>

# 6. Final outputs

Here, we summarize the results obtained from the regression analyses conducted above.

<br>

## 6.1. Sleep characterization

First, we aimed at characterizing sleep patterns in adolescents with and without insomnia. This was done by specifying models in which 
`s.archit`, `s.timing`, `s.variab`, and `s.auton` variables were predicted by (1) meaningful covariates (`SO.num`, `TotalSteps1000`, `weekday`, and `BMI`), (2) `insomnia`, (3) participants’ `sex`, and (4) the **interaction** between `sex` and `insomnia`.

<br>

The results indicated: 

- **no substantial relationships between** `insomnia` **and any** `s.archit` **or** `s.timing` **variable**

- most `s.archit` (i.e., `TIB`, `TST`, `WASO`) and `s.timing` (i.e., `WakeUp.num`) variables were negatively predicted by `SO.num` (whereas it positively predicted `SE`) and showed higher values during weekend compared to weekdays (also affecting `SO.num`), with boys showing shorter `TIB` and `TST`, and later `SO.num` than girls

- `deep.p` and `rem.p` variables were only predicted by `SO.num` (positively associated with %`deep` and negatively associated with %`rem` sleep)

- `BMI` negatively predicted `light.p`, `SO.num`, and `WakeUp.num`

<br>

- some `s.variab` variables, namely `TIB.SSD`, `TST.SSD`, and `SO.SSD` were **lower in** `insomnia` than in controls, although the results for `SO.SSD` showed some inconsistency after the removal of participants with extreme missing data and the inclusion of `covid19` as a further predictor

- all `s.varab` variables were higher in weekend days, with some (`TIB.SSD`, `TST.SSD`) being positively predicted by `BMI`, and others (`WASO.SSD`) being negatively predicted by `SO.num`

<br>

- **both** `s.auton` variables were substantially predicted by the **interaction between** `insomnia` **and** `sex`, with **lower HR in female insomnia than female controls** but not between males

- in contrast, the main effect of `insomnia` was less substantial and consistent

- both `s.auton` variables were positively predicted by `TotalSteps1000`, while `HR_NREM` was positively predicted by `weekday.sleep` and `BMI`, whereas `HR_REM` was positively precited by `SO.num`

<br>

**Conclusion:**

Overall, our results **do not support** a distinction between insomnia and controls in terms of objective sleep parameters, with the exception of some distinctions in terms of **night-to-night variability**.

<br>

Here, we visualize representative examples of the most substantial and consistent results.
```{r fig.width=7,fig.height=4.5,warning=FALSE,message=FALSE}
predictors <- c("TotalSteps1000","weekday.sleep","BMI","insomnia")
dat <- ema
dat$insomnia <- as.factor(gsub("1","Insomnia",gsub("0","Controls",dat$insomnia)))
dat$sex <- factor(gsub("M","Boys",gsub("F","Girls",dat$sex)),levels=c("Girls","Boys"))
p <- grid.arrange(glmerAn(long=dat,wide=demos,resp="TST.SSDc",fix.eff=c("SO.num",predictors),modelType="GLMER",
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",family="gamma",link="log",
                       outputs="plotEff",plot.model="insomnia",plot.pred="insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=1.3) + ggtitle("") + labs(x="",y=expression(TST~SSD~(min^2))),
               glmerAn(long=dat,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,modelType="GLMER",family="gamma",link="log",
                       mc.predictors=c("TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",
                       outputs="plotEff",plot.model="insomnia",plot.pred="insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=1.3) + ggtitle("") + labs(x="",y=expression(SO~SSD~(hours^2))),
               glmerAn(long=dat,wide=demos,resp="HR_NREM",fix.eff=c("SO.num",predictors,"sex","sex:insomnia"),modelType="GLMER",
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=0.5) + ggtitle("") + labs(x="",y=expression(NREM~HR~(bpm))) +
                 theme(legend.title=element_blank(),legend.position=c(0.65,0.85),
                       legend.direction = "horizontal"),
               glmerAn(long=dat,wide=demos,resp="HR_REM",fix.eff=c("SO.num",predictors,"sex","sex:insomnia"),modelType="GLMER",
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=0.5) + ggtitle("") + labs(x="",y=expression(REM~HR~(bpm))) + 
                 theme(legend.title=element_blank(),legend.position=c(0.65,0.85),
                       legend.direction = "horizontal"),nrow=2)
ggsave(filename="RESULTS/Figure3.tiff",plot=p,dpi=500) # saving figure for the manuscript
```



<br>

## 6.2. Diary ratings

Second, we aimed at characterizing the patterns of `stress`, `worry`, and `mood` among adolescents with and without insomnia. This was done by specifying models predicting diary ratings by (1) meaningful covariates (`TotalSteps1000` and `weekday`), (2) the `insomnia` group, (3) participants' `sex`, and (4) the interaction between `sex` and `insomnia` groups.

<br>

The results indicated: 

- **no substantial relationships between** `insomnia` **and any diary rating**

- however, a better examination of the three `insomnia.group` subgroups revealed a main effect of insomnia, with **higher** `stress`, `worry`, and `fs` **in the** `DSM.insomnia` **group compared to the control group**, and no difference between the partial DSM and the control group; such subgroup differences were **consistent** across all robustness checks

- in addition, lower `stress`, `worry`, and bad `mood` were predicted by `weekend` days, whereas higher-than-usual `TotalSteps1000` predicted lower `stress` and bad `mood`

<br>

**Conclusion:**

Overall, our results consistently showed **higher** `stress`, `worry`, and `fs` in the full `DSM.insomnia` subgroup compared to the control group, but **no differences when the two subgroup are joined**

<br>

## 6.3. Sleep by diary ratings

Third, we aimed at evaluating the direct and bidirectional relationship between sleep and psychological distress, and the interaction between the latter and insomnia. This was done by specifying models predicting `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables measured at day `i` by the selected model in step 1 in addition to (1) `PsyDist` measured at day `i`, and (2) `PsyDist` measured at day `i+1`, as well as (3) the interaction between `PsyDist` and `insomnia`.

<br>

### 6.3.1. Previous day

The results indicated:

- substantial **negative relationships** were between some `sleep.archit` and `sleep.timing` variables (i.e., `TIB`, `TST`, and `WakeUp.num`) and `stress`, `worry`, and `PsyDist`, whereas **earlier** `SO.num` was substantially predicted by `worry` and `mood`, and shorter `WASO` was only predicted by previous day `worry` and `PsyDist`

- a **positive relationship** was also found between **previous day** `stress` ratings and `HR_REM`

- in contrast, **no substantial relationships** were found between previous diary ratings and both **sleep stages** and `s.variab` outcomes

- overall, the results obtained for previous day single item ratings were **consistent with those found for aggregate ratings**, and across the **robustness checks**, with the exception of the relationships found for `mood` (insubstantial in 2 to 3 out of 4 robustness checks) and that found between `worry` and `SO` (insubstantial in 2 out of 4 checks)

<br>

Here, we generate the outputs of representative examples of sleep outcomes only predicted by previous day ratings, that is the models predicting `TIB`, `TST`, and `WakeUp.num` by `worry`.
```{r fig.width=7,fig.height=5,warning=FALSE,message=FALSE}
# preparing data
dat <- ema[!is.na(ema$TIB) & !is.na(ema$worry),] # removing incomplete cases
demos$SO.num.cm <- summarySE(dat,measurevar="SO.num",groupvars="ID",na.rm=TRUE)[,3] # worry & SO individual means
demos$worry.cm <- summarySE(dat,measurevar="worry",groupvars="ID",na.rm=TRUE)[,3]
demos$BMI.gmc <- demos$BMI - mean(demos$BMI) # grand-mean centering BMI
dat <- plyr::join(dat,demos[,c("ID","worry.cm","SO.num.cm","BMI.gmc")],by="ID",type="left")
dat$SO.num.mc <- dat$SO.num - dat$SO.num.cm # mean-centering worry & SO
dat$worry.mc <- dat$worry - dat$worry.cm

# modeling
fit1 <- lmer(TIB ~ SO.num.mc + weekday.sleep + worry.mc + (worry.mc|ID),data=dat,REML=FALSE) # TIB by worry
fit2 <- lmer(TST ~ SO.num.mc + weekday.sleep + worry.mc + (worry.mc|ID),data=dat,REML=FALSE) # TST by worry
fit3 <- lmer(WakeUp.num ~ SO.num.mc + weekday.sleep + BMI.gmc + worry.mc + (worry.mc|ID),data=dat,REML=FALSE) # WakeUp.num by worry

# showing models
tab_model(fit1,fit2,fit3,
          show.p=FALSE,show.stat=FALSE,show.icc=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
          string.est="B (SE)")

# computing profile-likelihood CI
confint.merMod(fit1,method="profile")
confint.merMod(fit2,method="profile")
confint.merMod(fit3,method="profile")
```

<br>

### 6.3.2. Next day

The results indicated:

- some `s.archit` and `s.timing` variables (i.e., `TIB`, `TST`, and `WakeUp.num`) were **bidirectionally associated with** `stress`, with higher-than-usual previous day and next day `stress` predicting shorter `TIB` and `TST`, and earlier `WakeUp` time

- `WASO` was only (negatively) related to **next day** `stress` but not to previous day `stress`; similarly, `HR_NREM` and `HR_REM` were positively associated with **next day** `mood` but not with previous day `mood`

- `WakeUp.num.SSD` was negatively associated with **all next day diary ratings**, whereas relationships between next day ratings and other `s.variab` outcomes were less consistent

- overall, these results were **consistent across the robustness checks** but **not replicated by the aggregate diary ratings**

<br>

### 6.3.3. Interaction

The results indicated:

- a substantial **interaction** between `insomnnia` and **previous day ratings** was only found for `stress` on `HR_NREM`, such that `stress` predicted higher `HR_NREM` in the insomnia but not the control group; this result was **overall consistent** across the robustness checks, becoming not substantial only when considering the `insomnia.group`

- a similar but **less consistent** result was found for `worry` and `fs`

- none of the other diary ratings and sleep outcomes showed substantial interactions, consistently across the robustness checks

<br>

Here, we generate the outputs of representative examples of sleep outcomes predicted by the **next day** and the **interactive term**, that is the models predicting `TST`, `WakeUp.num` and `HR_NREM` by `stress`.
```{r fig.width=7,fig.height=5,warning=FALSE,message=FALSE}
# preparing data
dat1 <- ema[!is.na(ema$TST) & !is.na(ema$stress) & !is.na(ema$s.nd),] # removing incomplete cases
datwide <- summarySE(dat1,measurevar="stress",groupvars="ID",na.rm=TRUE)[,c(1,3)] # ind means
colnames(datwide)[2] <- "stress.cm"
datwide$s.nd.cm <- summarySE(dat1,measurevar="s.nd",groupvars="ID",na.rm=TRUE)[,3] # individual means
datwide <- plyr::join(datwide,demos[,c("ID","SO.num.cm","BMI.gmc")],by="ID",type="left")
dat1 <- plyr::join(dat1,datwide[,c("ID","stress.cm","s.nd.cm","SO.num.cm","BMI.gmc")],by="ID",type="left")
dat1$SO.num.mc <- dat1$SO.num - dat1$SO.num.cm # mean-centering SO and stress
dat1$stress.mc <- dat1$stress - dat1$stress.cm
dat1$s.nd.mc <- dat1$s.nd - dat1$s.nd.cm
# same operation for HR_NREM
dat2 <- ema[!is.na(ema$HR_NREM) & !is.na(ema$stress) & !is.na(ema$s.nd) & !is.na(ema$TotalSteps1000),]
datwide <- datwide[datwide$ID%in%dat2$ID,]
datwide$TotalSteps1000.cm <- summarySE(dat2,measurevar="TotalSteps1000",groupvars="ID",na.rm=TRUE)[,3] 
dat2 <- plyr::join(dat2,datwide[,c("ID","stress.cm","s.nd.cm","SO.num.cm","TotalSteps1000.cm","BMI.gmc")],
                   by="ID",type="left")
dat2$SO.num.mc <- dat2$SO.num - dat2$SO.num.cm # mean-centering SO and stress
dat2$TotalSteps1000.mc <- dat2$TotalSteps1000 - dat2$TotalSteps1000.cm
dat2$stress.mc <- dat2$stress - dat2$stress.cm
dat2$s.nd.mc <- dat2$s.nd - dat2$s.nd.cm

# modeling
fit1 <- lmer(TST ~ SO.num.mc + weekday.sleep + stress.mc + s.nd.mc + (stress.mc|ID), # TST 
             data=dat1,REML=FALSE) 
fit2 <- lmer(WakeUp.num ~ SO.num.mc + weekday.sleep + BMI.gmc + stress.mc + s.nd.mc + (stress.mc|ID), # WakeUp.num
             data=dat1,REML=FALSE)
fit3 <- lmer(HR_NREM ~ TotalSteps1000.mc + weekday.sleep + BMI.gmc + sex + insomnia + # HR_NREM
               stress.mc + s.nd.mc + stress.mc:insomnia + (stress.mc|ID),
             data=dat2,REML=FALSE)

# showing models
tab_model(fit1,fit2,fit3,
          show.p=FALSE,show.stat=FALSE,show.icc=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
          string.est="B (SE)")

# computing profile-likelihood CI
confint.merMod(fit1,method="profile")
confint.merMod(fit2,method="profile")
confint.merMod(fit3,method="profile")
```

<br>

# References {#ref}

- Cranford, J. A., Shrout, P. E., Iida, M., Rafaeli, E., Yip, T., & Bolger, N. (2006). A Procedure for Evaluating Sensitivity to Within-Person Change: Can Mood Measures in Diary Studies Detect Change Reliably? *Personality and Social Psychology Bulletin*, 32(7), 917–929. https://doi.org/10.1177/0146167206287721

- Geldhof, G. J., Preacher, K. J., & Zyphur, M. J. (2014). Reliability estimation in a multilevel confirmatory factor analysis framework. *Psychological Methods*, 19(1), 72–91. https://doi.org/10.1037/a0032138

- Green, J. A. (2021). Too many zeros and/or highly skewed? A tutorial on modelling health behaviour as count data with Poisson and negative binomial regression. *Health Psychology and Behavioral Medicine, 9*(1), 436-455. https://doi.org/10.1080/21642850.2021.1920416

- Hox, J. J. (2010). *Multilevel Analysis: Techniques and Applications (2nd ed.)*. Routledge.

- Jak, S., & Jorgensen, T. D. (2017). Relating Measurement Invariance, Cross-Level Invariance, and Multilevel Reliability. *Frontiers in Psychology*, 8(OCT), 1–9. https://doi.org/10.3389/fpsyg.2017.01640

- Menghini, L., Yuksel, D., Goldstone, A., Baker, F. C., & de Zambotti, M. (2021). Performance of Fitbit Charge 3 against polysomnography in measuring sleep in adolescent boys and girls. *Chronobiology International*, 38(7):1010-1022. https://doi.org/10.1080/07420528.2021.1903481

- Ng, V. K., & Cribbie, R. A. (2017). Using the gamma generalized linear model for modeling continuous, skewed and heteroscedastic outcomes in psychology. *Current Psychology, 36*(2), 225-235. https://doi.org/10.1007/s12144-015-9404-0

<br>

## R packages
