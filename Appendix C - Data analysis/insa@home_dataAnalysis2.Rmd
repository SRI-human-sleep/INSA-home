---
title: "Wearable and mobile technology to characterize daily patterns of sleep, stress, pre-sleep worry and mood in adolescent insomnia - Appendix C: Data analysis code and output"
subtitle: "Part 2: Characterization of sleep and diary ratings"
author: "Luca Menghini, PhD, Dilara YÃ¼ksel, PhD, Devin Prouty, PhD, Fiona C Baker PhD, Christopher King, PhD, Massimiliano de Zambotti, PhD"
bibliography: [packagesAn.bib]
nocite: '@*'
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
    css: styles.css
  pdf_document: default
  word_document: default
  theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

# Aims and content

The present document includes the analytical steps implemented to characterize and explore the antecedents of sleep patterns in a sample of older adolescents with (N = 47; 31 girls) and without (N = 46; 28 girls) DSM-5 insomnia.

The data processing pipeline is [depicted at this page](https://sri-human-sleep.github.io/INSA-home/Appendix%20B%20-%20Data%20pre-processing/insa%40home_dataProcessing.html), whereas the first part of data analysis (data preparation, psychometrics, and descriptives) is [depicted at this page](https://sri-human-sleep.github.io/INSA-home/Appendix%20C%20-%20Data%20analysis/insa%40home_dataAnalysis1.html). The latter script resulted in the following long-form `ema` and wide-form `demos` datasets:
```{r }
# removing all objets from the workspace
rm(list=ls())

# loading datasets exported at the end of the first Data Analysis script
load("emaFINAL.RData")
load("demosFINAL.RData")

# setting system time zone to GMT (for consistent temporal synchronization)
Sys.setenv(tz="GMT")
```

<br>

Here, we use **generalized linear mixed-effects regression** (GLMER) models to examine the following relationships:

1. `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables are predicted by meaningful covariates (Model M1: `SO.num`, `TotalSteps1000`, `weekday`, and `BMI`), the `insomnia` group (M2), participants' `sex` (M3), and the interaction between `sex` and `insomnia` groups (M4), in order to **characterize sleep between groups**.

2. daily diary ratings (`stress`, `worry`, and `mood`) and the aggregate ratings (`PsyDist` and `fs`) are predicted by meaningful covariates (M1: `TotalSteps1000` and `weekday`), the `insomnia` group (M2), participants' `sex` (M3), and the interaction between `sex` and `insomnia` groups (M4), in order to **characterize stress, worry, and mood between groups**.

3. sleep measures are predicted by diary ratings. This analyses are [depicted in Part 3]((https://sri-human-sleep.github.io/INSA-home/Appendix%20C%20-%20Data%20analysis/insa%40home_dataAnalysis3.html).

<br>

For each step and each outcome variable, models are specified by using alternative distribution families based on the nature of the outcome, inspected to evaluate **model fit**, **compared** in terms of likelihood and strength of evidence, and inspected to check the results of the selected model.

Note that all **level-1** continuous predictors are centered to the individual mean (**mean-centered**, `mc`), whereas all **level-2** continuous predictors are centered to the grand average (**grand-mean-centered**, `gmc`).

Finally, several **robustness checks** are performed to account for the arbitrariness of data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the `insomnia` variable, (2) the inclusion of `covid19` as a further covariate, (3) the exclusion of participants with extreme missing data (marked with `majMiss = 1`), (4) the exclusion of the `TotalSteps1000` variable from the analyses, (5) the use of **alternative family distributions** for those variables not showing optimal fit, and (6) the exclusion of diary ratings entered on the following day (marked with `lateResp = 1`).

<br>

The following R packages and functions are used.
```{r message=FALSE,warning=FALSE}
# required packages
packages <- c("dplyr","Rmisc","lme4","ordinal","sjPlot","ggplot2","car","knitr","MuMIn","knitr","XML","sjPlot","reshape2")

# generate packages references
knitr::write_bib(c(.packages(), packages),"packagesAn.bib")

# # run to install missing packages
# xfun::pkg_attach2(packages, message = FALSE); rm(list=ls())

# loading mainly used packages
library(lme4); library(ordinal); library(reshape2); library(MuMIn); library(sjPlot); library(ggplot2); library(Rmisc)
```

<details><summary>**`glmerAn`** (from https://github.com/Luca-Menghini/LuMenPsy.Rfunctions )</summary>
<p>
```{r }
#' @title Generalized linear (mixed-effects) regression analysis
#' @param modelType = type of model: GLM, mixed-effects (GLMER), or cumulative link mixedm odel (CLMM)
#' @param long = long-form dataset (data.frame) considered if modelType = GLMER or CLMM
#' @param wide = wide-form dataset (data.frame) 
#' @param resp = name of the response variable (character)
#' @param fix.eff = character vector of names of the predictor(s)
#' @param cluster.ID = name of the cluster variable considered if modelType = GLMER or CLMM (default: "ID")
#' @param timeVar = name of the variable indexing time, considered if modelType = GLMER (defult: "ActivityDate")
#' @param REML = argument from the lme4::lmer() function, see ?lmer
#' @param ran.eff = character string indicating the random effect by using the lme4 syntax (defult: "(1|ID)")
#' @param family = character string indicating the name of the GLM(ER) family to be used in the models (default: "normal")
#' @param link =character string indicating the name of the GLM(ER) link function to be used in the models (default: "identity")
#' @param nAGQ = argument from the lme4::glmer() function, see ?glmer
#' @param mc.predictors = character vector of names of the predictors to be mean-centered
#' @param gmc.predictors = character vector of names of the predictors to be grand-mean-centered
#' @param outputs = character vector of the desired otucomes: "fit" for model diagnostics, "mComp" for model comparison, "coeff" for the coefficient table, "plotEff" for the effect plot(s), and "key.res" for the key results
#' @param coeff.models = name of the predictor(s) whose corresponding model(s) should be considered for the "coeff" output
#' @param transform = argument from sjPlot::tab_model(), see ?tab_model
#' @param coeff.models = model(s) to be considered for the "coeff" output
#' @param plot.model = name of the predictor(s) whose model(s) should be considered for the "plotEff" output
#' @param plot.pred = name of the predictor(s) to be plotted
#' @param show.data = argument from sjPlot::plot_model(), see ?plot_model
#' @param dot.size = argument from sjPlot::plot_model(), see ?plot_model
#' @param dodge = argument from sjPlot::plot_model(), see ?plot_model
#' @param dot.size = argument from sjPlot::plot_model(), see ?plot_model
#' @param ci.lv = argument from sjPlot::plot_model(), see ?plot_model
#' @param y.lim = numeric vector of length 2 indicating the limits of the y-axis
#' @param return.plot = booean. Should the plot be returned by the function? (default: FALSE)
#' @param key.model = name of the predictor(s) whose model(s) should be considered for the "key.res" output
#' @param key.predictor = name of the predictor to be considered by the "key.res" output
#' @param digits = number of digits for all numeric ouputs
#' @param messages = boolean indicating whether a message should be printed for each operation (defult: FALSE)
glmerAn <- function(modelType=c("GLM","GLMER"),long,wide,resp,fix.eff,cluster.ID="ID",timeVar="ActivityDate",REML=FALSE,
                    ran.eff="(1|ID)",family="normal",link="identity",nAGQ=1,mc.predictors=NA,gmc.predictors=NA,
                    outputs=c("fit","mComp","coeff","plotEff","key.results"),coeff.models=NA,transform=NULL,
                    plot.model=NA,plot.pred="all",show.data=FALSE,dot.size=1,dodge=0,ci.lv=.95,y.lim=NA,return.plot=FALSE,
                    key.model=NA,key.predictor=NA,digits=3,messages=TRUE){ 
  
  if(messages==TRUE){ cat("Running",modelType,"analysis of",resp,"...") }
  
  # data preparation ..................................................................................................................
  if(messages==TRUE){ cat("\n\nPreparing data...") }
  
  # participants' ID recoding as factor
  colnames(long)[which(colnames(long)==cluster.ID)] <- colnames(wide)[which(colnames(wide)==cluster.ID)] <- "ID"
  long$ID <- as.factor(as.character(long$ID))
  wide$ID <- as.factor(as.character(wide$ID))
  wide <- wide[order(wide$ID),] # sorting wide by ID
  colnames(long)[which(colnames(long)==timeVar)] <- "time" # time variable
  long <- long[order(long$ID,long$time),] # sorting long by ID and time
  if(nlevels(long$ID)!=nlevels(wide$ID)){ stop(message="Error: different No. of participants in long and wide datasets") }
  
  # listwise deletion
  if(modelType%in%c("GLMER","CLMM")){ memory <- long 
    for(Var in c(resp,fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)])){ colnames(long)[which(colnames(long)==Var)] <- "Var"
      long <- long[!is.na(long$Var),] # removing obs. with missing response in any resp or fix.eff variable
      colnames(long)[which(colnames(long)=="Var")] <- Var }
    long$ID <- as.factor(as.character(long$ID))
    wide <- wide[wide$ID%in%levels(long$ID),] # excluding wide IDs not included in long IDs
    if(messages==TRUE){ cat("\n - Excluding",nrow(memory)-nrow(long),"incomplete observations (",
                            round(100*(nrow(memory)-nrow(long))/nrow(memory),1),
                            "% ) in the response var. or in any of the predictors,\n   and",
                            nlevels(memory$ID)-nlevels(long$ID),"participants with no complete variables") }
  } else { memory <- wide
    for(Var in c(resp,fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)])){ colnames(wide)[which(colnames(wide)==Var)] <- "Var"
      wide <- wide[!is.na(wide$Var),]
      colnames(wide)[which(colnames(wide)=="Var")] <- Var }
    if(messages==TRUE){ cat("\n - Excluding",nrow(memory)-nrow(wide),"participants with no complete variables") }}
  
  # mean-centering predictors
  if(!is.na(gmc.predictors[1])){ if(messages==TRUE){ cat("\n - Grand-mean-centering",paste(gmc.predictors,collapse=" , ")) }
    for(Var in gmc.predictors){  colnames(wide)[which(colnames(wide)==Var)] <- "Var" 
      wide$Var.gmc <- wide$Var - mean(wide$Var,na.rm=TRUE) # computing gmc values
      colnames(wide) <- gsub("Var",Var,colnames(wide))
      long <- plyr::join(long,wide[,c("ID",paste(Var,"gmc",sep="."))],type="left",by="ID") # joining gmc to long dataset
      fix.eff <- gsub(Var,paste(Var,"gmc",sep="."),fix.eff) }} # updating labels in fix.eff (from Var to Var.gmc)
  if(!is.na(mc.predictors[1])){ if(messages==TRUE){ cat("\n - Mean-centering",paste(mc.predictors,collapse=" , ")) }
    suppressMessages(suppressWarnings(require(Rmisc))) 
    for(Var in mc.predictors){ colnames(long)[which(colnames(long)==Var)] <- "Var" 
      wide$Var.cm <- suppressWarnings(summarySE(long,measurevar="Var",groupvars="ID",na.rm=TRUE)[,3]) # cluster means
      long <- plyr::join(long,wide[,c("ID","Var.cm")],type="left",by="ID") # joining cm to long dataset
      long$Var.mc <- long$Var - long$Var.cm # computing mc values
      colnames(long) <- gsub("Var",Var,colnames(long)) 
      fix.eff <- gsub(Var,paste(Var,"mc",sep="."),fix.eff) }} # updating labels in fix.eff (from Var to Var.mc)
  long <- long[,!duplicated(colnames(long))] # removing duplicated columns (don't know why)

  # modeling .........................................................................................................................
  
  # creating model formulas
  formulas <- character()
  if(modelType=="GLM"){ ran.eff <- "1" }
  null.f <- paste(resp,"~",ran.eff) # creating null model formula
  for(i in 1:length(fix.eff)){ # creating other formulas
    if(i==1){ formulas[i] <- paste(resp,"~",fix.eff[1]) } else { formulas[i] <- paste(formulas[i-1],"+",fix.eff[i])  }}
  if(modelType%in%c("GLMER","CLMM")){ if(!is.na(ran.eff)){ formulas <- paste(formulas,"+",ran.eff)
      if(substr(ran.eff,2,2)!="1"){ ranSlope <- paste(fix.eff[which(grepl(ran.eff,fix.eff))])[1]
        null.f <- gsub(ranSlope,"1",null.f)  # removing random slope from models without the related predictor
        for(i in 1:length(formulas)){ 
          if(!(grepl(ranSlope,gsub(paste(ranSlope,"[|]",sep=""),"",formulas[i])))){ 
            formulas[i] <- gsub(paste(ranSlope,"[|]",sep=""),"1|",formulas[i]) }}}
    } else { stop(message="Error: GLMER model type without ran.eff specification") }}
  if(messages==TRUE){ cat("\n\nModel specification:\n - model M0 (null):",null.f)
    for(i in 1:length(formulas)){ cat("\n - model M",i,": ",formulas[i],sep="")}}
  
  # fitting models
  models <- list()
  if(modelType=="GLM"){ if(messages==TRUE){ cat("\n\nFitting GLM models of",resp,"on",nrow(wide),"participants \n   using the",
                                                family,"family with the",link,"link function...") }
    if(family=="normal" & link=="identity"){ null.m <- lm(as.formula(null.f),data=wide) # normal family
      for(i in 1:length(formulas)){ models[[i]] <- lm(formula=as.formula(formulas[i]),data=wide) }
      } else if (family=="gamma") { null.m <- glm(as.formula(null.f),data=wide,family=Gamma(link=link),nAGQ=nAGQ) # gamma family
        for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=Gamma(link=link)) }
        } else if(family=="normal" & link!="identity"){  
          null.m <- glm(as.formula(null.f),data=wide,family=gaussian(link=link)) # normal with other link functions
          for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=gaussian(link=link)) }
        } else if(family=="binomial"){ 
          null.m <- glm(as.formula(null.f),data=wide,family=binomial(link=link)) # logistic regression
          for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=binomial(link=link))}
        } else { stop(message="Error: only normal, gamma, and binomial family are allowed, 
                      with identity, inverse, and log link functions") }
  } else if(modelType=="GLMER"){ suppressMessages(suppressWarnings(require(lme4)))
    if(messages==TRUE){ cat("\n\nFitting",modelType,"models of",resp,"on",nrow(long),"observations from",
                            nlevels(as.factor(as.character(long$ID))),"participants \n   using the",family,
                            "family with the",link,"link function using",ifelse(REML==FALSE,"ML","REML"),"estimator...") }
    if(family=="normal" & link=="identity"){ null.m <- lmer(as.formula(null.f),data=long,REML=REML) # normal  identity
      for(i in 1:length(formulas)){ models[[i]] <- lmer(formula=as.formula(formulas[i]),data=long,REML=REML) }
      } else if (family=="gamma") { null.m <- glmer(as.formula(null.f),data=long,family=Gamma(link=link),nAGQ=nAGQ) # gamma
        for(i in 1:length(formulas)){ models[[i]]<-glmer(formula=as.formula(formulas[i]),data=long,family=Gamma(link=link),nAGQ=nAGQ) }
        } else if(family=="normal" & link!="identity"){ 
          null.m <- glmer(as.formula(null.f),data=long,family=gaussian(link=link),nAGQ=nAGQ) # normal with other links
          for(i in 1:length(formulas)){ models[[i]] <- glmer(formula=as.formula(formulas[i]),data=long,
                                                             family=gaussian(link=link),nAGQ=nAGQ) }
        } else if(family=="binomial"){ null.m <- glmer(as.formula(null.f),data=long,family=binomial(link=link),nAGQ=nAGQ) # logistic
          for(i in 1:length(formulas)){ models[[i]] <- glmer(formula=as.formula(formulas[i]),data=long,
                                                             family=binomial(link=link),nAGQ=nAGQ)}
        } else { stop(message="Error: only normal, logistic, and gamma family are allowed, 
                               with identity, inverse, and log link functions") }
  } else if(modelType=="CLMM"){ suppressMessages(suppressWarnings(require(ordinal))) # cumulative link mixed models
    if(messages==TRUE){ cat("\n\nFitting",modelType,"models of",resp,"on",nrow(long),"observations from",
                            nlevels(as.factor(as.character(long$ID))),"participants \n   using Cumulative Link Mixed Models") }
    long[,resp] <- factor(long[,resp],ordered=TRUE) # response variable as ordered factor
    null.m <- suppressWarnings(clmm(as.formula(gsub("~","~ 1 +",null.f)),data=long)) # suppress formula warning (bugged)
    for(i in 1:length(formulas)){ models[[i]] <- suppressWarnings(clmm(formula=as.formula(formulas[i]),data=long,nAGQ=nAGQ)) }
  } else { stop(message="Error: modelType can only be 'GLM', 'GLMER', or 'CLMM'") }
  
  # outputs..........................................................................................................................
  if(messages==TRUE){ cat("\n\nGenerating models outputs...") }
  
  # model diagnostics
  if("fit"%in%outputs & modelType!="CLMM"){ if(messages==TRUE){ cat("\n\n - Plotting diagnostics of the most complex model:") }
    suppressMessages(suppressWarnings(require(sjPlot))); suppressMessages(suppressWarnings(require(ggplot2)))
    fit <- models[[length(models)]] # most complex model
    if(modelType=="GLMER"){ dat <- long } else { dat <- wide } # fitted dataset
    plots <- list()
    if(family=="normal" & link=="identity"){ p <- plot_model(fit,type="diag",dot.size=dot.size) # LM(ER) diagnostics (normal)
      if(modelType=="GLMER"){ p[[2]] <- p[[2]]$ID } 
      suppressMessages(plot_grid(p,tags=TRUE,margin=c(0,0,0,0)))
    } else { if(family=="binomial"){ # logistic regression
      dat$logit <- log(predict(fit,type="response")/(1-predict(fit,type="response"))) # computing logit
      for(Var in fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)]){ # plotting logit by each continuous predictor
        if(class(dat[,Var])=="numeric"){  plots[[length(plots)+1]] <- ggplot(dat,aes_string(x=Var,y="logit")) + 
          geom_point(size=dot.size) + suppressMessages(stat_smooth(method="loess")) + ggtitle("Logit by",Var) }}
      } else { plots[[length(plots)+1]] <- ggplot(data.frame(residuals=residuals(fit,type="deviance")), # deviance residuals QQ plot
                                                  aes(sample=residuals)) + stat_qq(size=dot.size) + stat_qq_line() +
        labs(x="Theoretical qualtiles (normal distr.)",y="Sample quantiles") + ggtitle("Deviance Residuals' normal QQ plot") 
      plots[[length(plots)+1]] <- ggplot(fortify.merMod(fit), aes(.fitted, resid(fit,type="deviance"))) + geom_point() +
        suppressMessages(stat_smooth(method="loess"))+geom_hline(yintercept=0, col="red", linetype="dashed") +
        labs(x="Fitted values",y="Residuals") + ggtitle("Deviance residuals vs. fitted values") }
      p <- plot_model(fit,type="diag",dot.size=dot.size) # random effects with GLMER
      if(modelType=="GLMER"){ p <- p$ID }
      plots[[length(plots)+1]] <- p + ggtitle("Random effects' normal QQ plot") }
    if(family!="binomial"){ type <- ifelse(family=="gamma","deviance","pearson") # deviance residuals with gamma
      for(Var in fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)]){ # homoscedasticity: residuals by levels of categorical pred.
      if(class(dat[,Var])=="factor"){ Dat <- cbind(dat,residuals=resid(fit,type=type),Var=dat[,Var],Resp=dat[,resp])
         plots[[length(plots)+1]] <- ggplot(Dat,aes_string(x="Var",y="residuals")) + 
           ggtitle(paste(type,"residuals by",Var,"\n mean =",paste(round(with(Dat, tapply(Resp, Var, mean)),1),collapse=", "),
                         ", SD =",paste(round(with(Dat, tapply(Resp, Var, sd)),1),collapse=", "))) + xlab(Var) +
           geom_point(size=dot.size,position=position_jitter(),color="gray") + geom_violin(alpha=0.3) }}}
    suppressMessages(plot_grid(plots,tags=TRUE,margin=rep(0,4))) 
    cat("\n  Printing Variance Inflation Factors (VIF):\n")
    suppressMessages(suppressWarnings(require(car))) # variance inflation factors
    print(vif(fit)) }
  
  # model comparison - likelihood ratio test & Akaike weight
  if("mComp"%in%outputs | "key.results"%in%outputs){ 
    if(messages==TRUE){ cat("\n\n - Running likelihood ratio test:") } # likelihood ratio test
    suppressMessages(suppressWarnings(require(knitr))); suppressMessages(suppressWarnings(require(MuMIn))) 
    if(modelType=="CLMM"){ lrt <- as.data.frame(ordinal:::anova.clm(null.m,models[[1]])) # use anova.clm() to avoid env. issue
    } else { lrt <- as.data.frame(suppressMessages(anova(null.m,models[[1]]))) }
    for(i in 1:(length(models)-1)){ if(length(models)>=(i+1)){
      if(modelType=="CLMM"){ lrt <- rbind(lrt,as.data.frame(ordinal:::anova.clm(models[[i]],models[[i+1]]))[2,]) 
      } else { lrt <- rbind(lrt,as.data.frame(suppressMessages(anova(models[[i]],models[[i+1]])))[2,]) }}}
    rownames(lrt) <- c("Null model",fix.eff)
    for(i in nrow(lrt):2){ if(lrt[i,ncol(lrt)] < .05){ if(messages==TRUE){ cat("\n   Selected model:",rownames(lrt)[i]) }
                             break }}
    if("mComp"%in%outputs){ print(kable(round(lrt,digits))) }
    AICs <- lrt[1:2,"AIC"] # Akaike weight
    if(messages==TRUE){ cat("\n\n - Computing Aw coefficients for each model vs. all previous models:") 
      cat("\n   - null model vs.",fix.eff[1],": =",round(Weights(AICs),digits)[1],
          "\n   -",fix.eff[1],"vs. null model =",round(Weights(AICs),digits)[2]) }
    if(length(models)>1){ for(i in 3:nrow(lrt)){ AICs <- c(AICs,lrt[i,"AIC"])
      if(messages==TRUE){ cat("\n   -",row.names(lrt)[i],"=",round(Weights(AICs),digits)[length(AICs)]) }}}
    if(messages==TRUE){ cat("\n   Selected model:",row.names(lrt[which(lrt$AIC==min(lrt$AIC)),])) }
    if("key.results"%in%outputs){ 
      key <- lrt[which(grepl(key.predictor,row.names(lrt))),] # key results
      if(nrow(key)>1){ key <- key[1,] }
      key.results <- data.frame(sig.LRT=key[,ncol(key)]<0.05,higher.Aw=key$AIC==min(AICs[1:(which(fix.eff==key.predictor)+1)])) }} 
  
  # estimated parameters from key.model
  if("key.results"%in%outputs){
    modSummary <- summary(models[[which(fix.eff==key.model)]])
    modSummary <- modSummary$coefficients
    if(modelType=="CLMM"){ modSummary <- modSummary[nlevels(long[,resp]):nrow(modSummary),] }
    key <- modSummary[which(grepl(key.predictor,row.names(modSummary))),3][1] # taking only first coeff for key.results
    key.results <- cbind(key.results,t.196=abs(key)>1.96,t=key) }
  if("coeff"%in%outputs){ if(messages==TRUE){ suppressMessages(suppressWarnings(require(knitr)))
    cat("\n\n - Printing estimated coefficients for models",paste(coeff.models,collapse=" , "))}
    suppressMessages(suppressWarnings(require(XML))); suppressMessages(suppressWarnings(require(sjPlot)))
    out <- data.frame(readHTMLTable(htmlParse(tab_model(models[which(fix.eff%in%coeff.models)],transform=transform,
                                                        show.icc=FALSE,show.p=FALSE,show.stat=TRUE,show.re.var=FALSE,
                                                        show.ci=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
                                                        string.est="B (SE)",string.stat="t")))[1])
    colnames(out) <- out[1,]
    out <- out[-1,] # sorting rows and columns
    out <- rbind(out[which(!substr(out$Predictors,1,3)%in%c("SD ","Cor")),],
                 out[which(substr(out$Predictors,1,3)=="SD "),],out[which(substr(out$Predictors,1,4)=="Cor "),])
    print(knitr::kable(out)) }
  
  # plotting effects
  if("plotEff"%in%outputs){ if(messages==TRUE){ cat("\n\n - Plotting effect(s) estimated by model",which(fix.eff==plot.model)) }
    suppressMessages(suppressWarnings(require(sjPlot))); suppressMessages(suppressWarnings(require(ggplot2)))
    if(plot.pred[1]=="all"){ fix.eff.plot <- fix.eff } else { fix.eff.plot <- plot.pred }
    if(length(fix.eff.plot)==1){ if(grepl(":",plot.pred)){ 
        terms <- c(strsplit(plot.pred,split=":")[[1]][1],strsplit(plot.pred,split=":")[[1]][2]) 
      } else { terms <- fix.eff[which(fix.eff==fix.eff.plot)] } 
      p <- plot_model(models[[which(fix.eff==fix.eff.plot)]],type="pred",terms=terms,ci.lv=ci.lv,dodge=dodge,
                      show.data=show.data,dot.size=dot.size,jitter=0.15) + ggtitle(paste(resp,"by",fix.eff.plot,fix.eff.plot))
      if(!is.na(y.lim[1])){ p <- p + ylim(y.lim) }
      if(return.plot==TRUE){ return(p) } else { print(p) } # returning or printing the plot 
    } else { plots <- list()
      for(i in 1:length(fix.eff.plot)){ if(grepl(":",fix.eff.plot[i],fixed=TRUE)==FALSE){ # predicted effects conditioned on ran.eff.
          p <- plot_model(models[[i]],type="pred",terms=fix.eff.plot[i],show.data=show.data,dot.size=dot.size,ci.lv=ci.lv,
                          colors="gray",jitter=0.15,dodge=dodge)
        } else { p <- plot_model(models[[i]],type="pred",terms=strsplit(fix.eff.plot[i],split=":")[[1]],ci.lv=ci.lv,dodge=dodge) }
                 plots[[i]] <- p + ggtitle(paste(resp,"by",fix.eff.plot[i])) }
      plot_grid(plots,tags=TRUE,margin=rep(0,4)) }}
  
  # returning key results (sig. LRT, Aw higher than previous model, t > 1.96)
  if("key.results"%in%outputs){ return(key.results) }}
```
</p></details>

Fits GLM(ER) models and prints the core numeric and graphical ouputs considered for the analyses.

<details><summary>**`key.resPlot`** (from https://github.com/Luca-Menghini/LuMenPsy.Rfunctions )</summary>
<p>
```{r }
key.resPlot <- function(res=NA,robCheck=NA,levels=c(s.archit,s.timing,paste(s.variab,"c",sep=""),s.auton)){ 
  suppressMessages(suppressWarnings(require(ggplot2)))
  
  # setting color scale
  res[res$t.196==TRUE & res$sig.LRT==TRUE & res$higher.Aw==TRUE,"Value"] <- 10 # 10 = substantial effect
  res[res$t.196==TRUE & ((res$sig.LRT==FALSE & res$higher.Aw==TRUE) | 
                           res$sig.LRT==TRUE & res$higher.Aw==FALSE),"Value"] <- 7.5 # 7.5 = substantial but LRT n.s. OR lower Aw
  res[res$t.196==TRUE & res$sig.LRT==FALSE & res$higher.Aw==FALSE,"Value"] <- 5 # 5 = substantial but both LRT n.s. AND lower Aw
  res[res$t.196==FALSE & ((res$sig.LRT==TRUE & res$higher.Aw==TRUE) | (res$sig.LRT==TRUE & res$higher.Aw==FALSE) |
                            res$sig.LRT==FALSE & res$higher.Aw==TRUE),"Value"] <- 2.5 # 2.5 = unsubstantial and LRT n.s. OR lower Aw
  res[res$t.196==FALSE & res$sig.LRT==FALSE & res$higher.Aw==FALSE,"Value"] <- 1 # 1 = no evidence at all
  res$Measure <- factor(res$measure,levels=levels) # Measures as factor
  
  # plotting
  if(is.na(robCheck)){ # single set of analyses
    ggplot(res,aes(x=Measure,y=as.factor(1),fill=Value)) + geom_tile() + geom_text(aes(label=round(t,2))) +
      scale_fill_gradient2(low="red",high="lightgreen",mid="yellow",midpoint=5,limit = c(1,10), space = "Lab") + 
      labs(x="",y="") + theme(legend.position = "none",axis.text.y = element_blank(),axis.text.x=element_text(angle=45))
  } else { require(reshape2) # multiple robustness checks
    colnames(res)[which(colnames(res)==robCheck)] <- "robCheck"
    ggplot(res,aes(x=Measure, y=as.factor(robCheck), fill=Value)) + geom_tile() + geom_text(aes(label=round(t,2))) +
      scale_fill_gradient2(low="red",high="lightgreen",mid="yellow",midpoint=5,limit = c(1,10), space = "Lab") + 
      labs(x="",y="") + theme(legend.position = "none",axis.text.x=element_text(angle=45)) }}
```
</p></details>

Visualizes the key results (Aw, LRT, and *t* value) obtained with the *glmerAn* function.

<br>

# 1. Sleep characterization

Here, `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables are predicted by (1) meaningful covariates (`SO.num`, `TotalSteps1000`, `weekday`, and `BMI`), (2) the `insomnia` group, (3) participants' `sex`, and (4) the interaction between `sex` and `insomnia` groups, in order to **characterize sleep between groups**.
```{r fig.width=12,fig.height=8}
predictors <- c("SO.num","TotalSteps1000","weekday.sleep","BMI","insomnia","sex","sex:insomnia")
```

<br>

## 1.1. Sleep architecture {.tabset .tabset-fade .tabset-pills}

`s.archit` variables are modeled by considering the subset of complete `s.archit` and `TotalSteps1000`.
```{r fig.width=12,fig.height=8}
s.archit <- c("TIB","TST","WASO","SE","light.p","deep.p","rem.p")
```

### TIB

`TIB` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,
                                   modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                   outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`***, ***`weekday.sleep`***, and ***`sex`*** are associated with a **significant LRT**, whereas only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **stronger evidence** in terms of Aw

- a large negative effect is estimated for ***`SO.num`*** (shorter `TST` for later than usual `SO`), whereas a large positive effect is estimated for ***`weekday`*** (longer `TST` during weekend), and a small but substantial effect is estimated for ***`sex`*** (longer `TST` for males than females). Neither `insomnia` nor `TotalSteps1000`, `BMI`, or the interaction between `insomnia` and `sex` show a substantial effect

<br>

### TST

`TST` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`***, ***`weekday.sleep`***, and ***`sex`*** are associated with a **significant LRT**, whereas the inclusion of ***`SO.num`***, ***`TotalSteps1000`***, ***`weekday.sleep`***, and ***`sex`*** are associated with a **stronger evidence** in terms of Aw

- a large negative effect is estimated for ***`SO.num`*** (shorter `TST` for later than usual `SO`), whereas a large positive effect is estimated for ***`weekday`*** (longer `TST` during weekend), and a small but substantial effect is estimated for ***`sex`**` (longer `TST` for males than females). Neither `insomnia` nor `TotalSteps1000`, `BMI` or the interaction between `insomnia` and `sex` show a substantial effect

- overall, `TST` shows the same pattern of results than `TIB`

<br>

### WASO

`WASO` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- whereas (1) **random effects** are quite **normally distributed**, a (2) **marked deviation** from normality can be seen in the **upper tail of the residuals distribution**. Thus, we conduct the main analyses by relying on normality, whereas the **gamma will be checked in the [robustness check](#robcheck)**. The residuals show (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **significant LRT** and a **stronger evidence** in terms of Aw

- a large negative effect is estimated for ***`SO.num`*** (shorter `WASO` for later than usual `SO`), whereas a large positive effect is estimated for **`weekday`*** (longer `WASO` during weekend). None of the remaining predictors, including `insomnia` and its interaction with `sex`, show a substantial effect

<br>

### SE

`SE` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("SO.num.mc","insomnia","sex","sex:insomnia"), # showing selected model + models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite normally distributed, although a **marked deviation from normality** can be seen in the **lower tail** of the residuals distribution (i.e., SE is bounded at 100), with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** is associated with a significant LRT, whereas both ***`SO.num`*** and ***`TotalSteps1000`*** are associated with **stronger evidence** in terms of higher Aw

- a substantial positive effect is only estimated for ***`SO.num`*** (higher `SE` for later than usual `SO`), whereas none of the remaining predictors shows a substantial effect

<br>

### light.p

`light.p` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("BMI.gmc","insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`BMI`*** is associated with a **significant LRT**, whereas both ***`TotalSteps1000`*** and ***`BMI`*** are associated with **stronger evidence** in terms of Aw

- a substantial negative effect is estimated only for ***`BMI`*** (lower `light.p` for participants with higher `BMI`), whereas none of the remaining predictors shows a substantial effect 

<br>

### deep.p

`deep.p` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("SO.num.mc","insomnia","sex","sex:insomnia"), # selected model + models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** is associated with a **significant LRT**, whereas both ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **stronger evidence** in terms of Aw

- a substantial positive effect is only estimated for ***`SO.num`*** (higher `deep.p` for later than usual SO), whereas none of the remaining predictors shows a substantial effect

<br>

### rem.p

`rem.p` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** is associated with a **significant LRT**, whereas ***`SO.num`***, ***`TotalSteps1000`***, ***`weekday.sleep`***, and ***`BMI`*** are associated with a **stronger evidence** in terms of Aw

- a substantial negative effect is only estimated for ***`SO.num`*** (higher `rem.p` for earlier than usual `SO`), whereas none of the remaining predictors shows a substantial effect

<br>

## 1.2. Sleep timing {.tabset .tabset-fade .tabset-pills}

`s.timing` variables are modeled by considering the subset of complete `s.timing` and `TotalSteps1000`.
```{r fig.width=12,fig.height=8}
s.timing <- c("SO.num","WakeUp.num")
```

### SO.num

`SO.num` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals. Obviously, `SO.num` is not included as a covariate in model M1.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors[2:length(predictors)],
        modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors[2:length(predictors)],
                                         modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite some **marked deviations in the tails** of the residuals distribution, with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`***, ***`BMI`*** and ***`sex`*** are associated with a **significant LRT**, whereas ***`TotalSteps1000`***, ***`weekday.sleep`***, ***`BMI`*** and ***`sex`*** show higher Aw than the previous models

- a relatively large effect is estimated for ***`weekday`*** (later `SO` during weekend), whereas small but substantial effects are estimated for ***`TotalSteps1000`*** (earlier `SO` in days with more steps than usual), ***`BMI`*** (earlier `SO` for participants with higher `BMI`), and ***`sex`*** (later `SO` for boys than for girls). Neither `insomnia` nor its interaction with `sex` show a substantial effect.

<br>

### WakeUp.num

`WakeUp.num` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite some **marked deviations in the tails** of the residuals distribution, with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values

- only ***`SO.num`***, ***`weekday.sleep`***, and ***`BMI`*** are associated with a **significant LRT**, whereas ***`TotalSteps1000`***, ***`SO.num`***, ***`weekday.sleep`***, and ***`BMI`*** show **higher Aw** than the previous models

- a large positive effect is estimated for ***`SO.num`*** (later `WakeUp` time for later than usual `SO`) and ***`weekday`*** (later `WakeUp` time during weekend), whereas a small but substantial effect is estimated for ***`BMI`*** (earlier `WakeUp` time for participants with higher `BMI`). Neither `insomnia` nor its interaction with `sex` show a substantial effect.

<br>

## 1.3. Daily variability {.tabset .tabset-fade .tabset-pills}

`s.variab` variables are modeled by considering the subset of complete `s.timing` and `TotalSteps1000`, and only those days with **nonmissing current and previous-day sleep variables**.
```{r fig.width=12,fig.height=8}
s.variab <- paste(c(s.archit[1:3],s.timing),"SSD",sep=".")
```

### TIB.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `TIB.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have TIB.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$TIB.SSDc <- ema$TIB.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log", # Gamma family with log link function
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",
        outputs="plotEff",plot.model="insomnia",dot.size=2)

# keeping key results
res <- rbind(res,
             cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of the residuals distribution) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of ***`SO.num`***, ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`weekday.sleep`*** (higher `TIB.SSD` during weekend), ***`BMI`*** (higher `TIB.SSD` in participants with higher `BMI`), and ***`insomnia`*** (lower `TST.SSD` in the `insomnia` compared to the control group. Neither `sex` nor its interaction with `insomnia` show a substantial effect

<br>

### TST.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `TST.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have TST.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$TST.SSDc <- ema$TST.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log", # Gamma family with log link function
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tail** of the residuals distribution) with (2) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD are proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of ***`SO.num`***, ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`weekday.sleep`*** (higher `TST.SSD` during weekend), ***`BMI`*** (higher `TST.SSD` in participants with higher `BMI`), and ***`insomnia`*** (lower `TST.SSD` in the `insomnia` compared to the control group. Neither `sex` nor its interaction with `insomnia` show a substantial effect

- results are **highly consistent** with those reported for `TIB.SSD`

<br>

### WASO.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `WASO.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have WASO.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$WASO.SSDc <- ema$WASO.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log",nAGQ=0, # Gamma family with log link function, nAGQ = 0 to reach convergence
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("weekday.sleep","insomnia","sex"),transform="exp", # selected model + models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",nAGQ=0,
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",nAGQ=0,
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **small deviations in the lower tail** and some **marked deviations in the upper tail** of the residuals distribution) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, the (4) **SD are slightly proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **significant LRT** and show **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`SO.num`*** (higher variability for earlier than usual `SO`) and ***`weekday.sleep`*** (higher `WASO.SSD` during weekend). Neither `insomnia` nor its interaction with `sex` show a substantial effect

<br>

### SO.num.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are initially modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `SO.num.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have `SO.num.SSD` = 0). Note that `SO.num` is not included as a covariate predicting `SO.num.SSD`
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$SO.num.SSDc <- ema$SO.num.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors[2:length(predictors)],
        modelType=c("GLMER"),mc.predictors="TotalSteps1000",gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log", # Gamma family with log link function
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors[2:length(predictors)],
        mc.predictors="TotalSteps1000",gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE,show.data=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="SO.num.SSDc",glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors[2:length(predictors)],
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",
                                         mc.predictors="TotalSteps1000",gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution, and in the upper tail of the random effects) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, the (4) **SD are slightly proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`*** and ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of ***`weekday.sleep`***, ***`BMI`***, and ***`insomnia`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`weekday.sleep`*** (higher `SO.num.SSD` during weekend) and ***`insomnia`*** (lower `SO.num.SSD` in the `insomnia` compared to the control group. Neither `sex` nor its interaction with `insomnia` show a substantial effect

<br>

### WakeUp.num.SSD

All `s.variab` variables are **positively skewed and bounded at zero**, thus they are modeled by assuming a **gamma distribution** with a **log link function**. A constant is added to all `WakeUp.num.SSD` values to adhere with the gamma assumption of positive-only values (i.e., 10 cases have WakeUp.num.SSD = 0).
```{r fig.width=12,fig.height=8}
# adding constant to each value
ema$WakeUp.num.SSDc <- ema$WakeUp.num.SSD + 0.001 

# running analysis
glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        family="gamma",link="log",nAGQ=0, # Gamma family with log link function, nAGQ=0 to reach convergence
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("BMI.gmc","insomnia","sex"),transform="exp", # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# plotting effects without observed data (zoom in)
glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family="gamma",link="log",nAGQ=0,
        outputs="plotEff",plot.model="insomnia",dot.size=2,messages=FALSE,show.data=FALSE)

# keeping key results
res <- rbind(res,
             cbind(measure="WakeUp.num.SSDc",glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
                                         modelType=c("GLMER"),family="gamma",link="log",transform="exp",nAGQ=0,
                                         mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of the residuals distribution) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, the (4) **SD are proportional to the means** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`*** and ***`BMI`*** are associated with a **significant LRT**, whereas the inclusion of ***`weekday.sleep`***, ***`BMI`***, and ***`sex`*** are associated with a **stronger evidence** in terms of Aw

- a substantial effect is only estimated for ***`weekday.sleep`*** (higher `WakeUp.num.SSD` during weekend) whereas neither `insomnia` nor its interaction with `sex` show a substantial effect

<br>

## 1.4. Sleep autonomic func. {.tabset .tabset-fade .tabset-pills}

`s.auton` variables are modeled by considering the subset of complete `s.auton` and `TotalSteps1000`.
```{r fig.width=12,fig.height=8}
s.auton <- c("HR_NREM","HR_REM")
```

### HR_NREM

`HR_NREM` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite a positive **deviation in the upper tail** of the residuals distribution, with (3) **homogeneity** between the variances across *sex* and *insomnia* levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- **all predictors but** ***`SO.num`*** **and** ***`insomnia`*** are associated with a **significant LRT**, whereas the inclusion of **all variables but** ***`SO.num`*** are associated with a **stronger evidence** in terms of Aw

- substantial effects are estimated for ***`TotalSleep1000`*** (higher `stageHR_NREM` for higher than usual `TotalSleep1000`), ***`weekday.sleep`*** (higher `stageHR_NREM` during weekends), ***`BMI`*** (higher `stageHR_NREM` for participants with higher `BMI`), ***`sex`*** (higher `stageHR_NREM` in girls compared to boys), and its **interaction with** ***`insomnia`*** (lower `stageHR_NREM` in insomnia girls compared to control girls)

<br>

### HR_REM

`HR_REM` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,
             cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,
                                         modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                         outputs="key.results",key.predictor="insomnia",key.model="sex",messages=FALSE)))
```

<br>

*Comments:*

- results are **highly consistent** with those reported for `HR_NREM`, with the only differences that `HR_REM` is also positively predicted by ***`SO.num`***, and not substantially associated with `BMI` or `weekday.sleep`

<br>

## 1.5. Summary of results

Here, we use the `key.resPlot` function to graphically summarize the results obtained from the models above. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=2}
key.resPlot(res)
```

<br>

*Comments:*

- the analysis of sleep characterization highlighted substantial differences between the insomnia and the control group for `TIB.SSD`, `TST.SSD`, and `SO.num.SSD` (with lower night-to-night variability for the insomnia than the control group)

- **substantial but less evident** (i.e., LRT > 0.05) differences are highlighted for `HR_NREM` and `HR_REM`, with the **interactive model** predicting **lower HR in female insomnia** than in female control, but no differences between boys

- **none of the remaining sleep outcomes** show significant LRT, higher Aw, and substantial relationships for the *insomnia* predictor

<br>

## 1.6. Robustness checks {#robcheck}

Here, we conduct several **robustness checks** to account for the arbitrariness of our data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the insomnia variable, (2) the inclusion of the `covid19` variable as a further covariate, (3) the exclusion of participants with **extreme missing data**, (4) the **exclusion of** `TotalSteps1000`, (5) the use of **alternative family distributions** for the analyses.

Here, we select the predictors, and the sleep outcomes.
```{r,fig.width=12,fig.height=3}
# predictors
PREdictors <- predictors[1:(length(predictors)-2)] # excluding sex and interactive model

# sleep outcomes
sleepVars <- c(s.archit[2:length(s.archit)],s.timing,paste(s.variab,"c",sep=""),s.auton)
```

<br>

### 1.6.1. insomnia.group

Here, we inspect the results obtained by considering the `insomnia.group` (i.e., 46 controls, 26 DSM.ins and 21 sub.ins) rather than the *insomnia* variable (i.e., 46 controls vs. 47 insomnia). 

The figure below shows the t-values associated with the group differences between **full DSM insomnia** and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){ if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # family
  if(grepl("SO.num",sleepVar)){ Predictors <- gsub("insomnia","insomnia.group",PREdictors)[2:length(PREdictors)] # insomnia.group
     } else { Predictors <- gsub("insomnia","insomnia.group",PREdictors) }
  if(grepl("HR",sleepVar)){ key.model="sex" # adding sex with s.auton variables
    Predictors <- c(Predictors,"sex") }else{ key.model <- "insomnia.group" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to reach convergence
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia.group",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res$robCheck <- "Original"
res2$robCheck <- "insomnia.group"
RES <- rbind(res,res2)

# plotting robustness check
key.resPlot(RES,robCheck = "robCheck")
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most sleep outcomes

- the only differences are highlighted for `TST.SSD`, showing a no longer significant LRT (but still higher Aw and substantial t), and `HR_NREM` and `HR_REM`, showing a no longer higher Aw (but still substantial t)

<br>

### 1.6.2. COVID-19 emergency

Here, we inspect the results obtained by including the `covid19` variable **as a further covariate**. As shown in section 1.2.8, the `covid19` factor discriminates the data collected `pre-COVID19` (63%) and the data collected `post-COVID19` (37%). The covariate is included **at the first step** (model M1, before `SO.num`).

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=c("covid19",PREdictors),
                                    modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){ if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # family
  if(grepl("SO.num",sleepVar)){ Predictors <- c("covid19",PREdictors[2:length(PREdictors)]) # predictors + covid19
     } else { Predictors <- c("covid19",PREdictors) }
  if(grepl("HR",sleepVar)){ key.model="sex" # adding sex with s.auton variables
     Predictors <- c("covid19",PREdictors,"sex") } else { key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "covid19"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","covid19"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` and `s.auton` outcomes, with a no longer substantial main effect on `SO.num.SSD`, `HR_NREM`, and `HR_REM`

<br>

Here, we can see that the `post-COVID19` data collection period is characterized by longer `TIB` and `TST` (but not `WASO`), slightly lower `rem.p`, later `SO` and `WakeUp` times, lower `SO.num.SSD`, and lower `HR_REM` compared to the pre-COVID19 period.
```{r fig.width=4,fig.height=3,warning=FALSE,message=FALSE}
# plotting difference by covid (model M1)
for(sleepVar in c("TIB",sleepVars)){
  if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  if(grepl("SO.num",sleepVar)){ Predictors <- c("covid19","TotalSteps1000","weekday.sleep","BMI")
     } else { Predictors <- c("covid19","SO.num","TotalSteps1000","weekday.sleep","BMI") }
  if(grepl("HR",sleepVar)){ key.model="sex" }else{ key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc","SO.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,
        mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",family=fam[1],link=fam[2],nAGQ=nAGQ,
        outputs="plotEff",plot.model="insomnia",plot.pred="covid19",messages=FALSE,dot.size=3,dodge=0.5) }
```

<br>

In conclusion, the results of this robustness check were **partially inconsistent** with those obtained with the main analyses, questioning the generalizability of the results observed for `SO.num.SSD` and for the main effect of `insomnia` on both `s.auton` outcomes.

<br>

### 1.6.3. Low compliance

Here, we inspect the results obtained by **excluding seven participants** (7.5%) with **less than two weeks of valid observations in any data type**. In section 3.2, these participants were marked with `majMiss` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$majMiss!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days from",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=PREdictors,
                                    modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the other sleep outcomes
for(sleepVar in sleepVars){
  if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  if(grepl("SO.num",sleepVar)){ Predictors <- PREdictors[2:length(PREdictors)] } else { Predictors <- PREdictors }
  if(grepl("HR",sleepVar)){ Predictors <- c(Predictors,"sex")
    key.model="sex" }else{ key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc","SO.num.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "majMiss"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **overall inconsistent** with the main analyses 

- the main differences is highlighted for `SO.num.SSD`, showing **no more substantial** group differences. Note, however, that `nAGQ` **was set to zero** to reach convergence in `SO.num.SSD` models, resulting in higher standard errors that might have masked the effect

<br>

### 1.6.4. TotalStep1000

Here, we inspect the results obtained by **excluding** `TotalSteps1000` **from the models predictors**. This is done in order to replicate the analyses by including cases with invalid daily steps data (thus, with higher sample size).

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**

- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=PREdictors[PREdictors!="TotalSteps1000"],
                                    modelType=c("GLMER"),mc.predictors="SO.num",gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  if(grepl("SO.num",sleepVar)){ Predictors <- PREdictors[PREdictors!="TotalSteps1000" & PREdictors!="SO.num"]
     } else { Predictors <- PREdictors[PREdictors!="TotalSteps1000"] }
  if(grepl("HR",sleepVar)){ key.model="sex" 
    Predictors <- c(Predictors,"sex") }else{ key.model <- "insomnia" }
  if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc","TIB.SSDc")){ nAGQ <- 0 }else{ nAGQ <- 1 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "no-TotalSteps"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` and `s.auton` outcomes, with a no longer substantial main effect on `TIB.SSD`, `HR_NREM`, and `HR_REM`

- note, however, that `nAGQ` **was set to zero** to reach convergence in *TIB.SSD* models, resulting in higher standard errors that might have masked the effect

<br>

Here, we can see that the differences in *HR_NREM* and *HR_REM* are **no longer substantial**, whereas differences in *TIB.SSD* are **smaller but still quite substantial**, as it is **substantial** the **interaction between sex and insomnia** on *s.auton* variables. 
```{r fig.width=10,fig.height=6,warning=FALSE,message=FALSE,echo=FALSE}
              # plotting HR_NREM (without covid19)
plot_grid(list(glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=c(PREdictors,"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_NREM (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=c(PREdictors[which(PREdictors!="TotalSteps1000")],"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000"),
               
               # plotting HR_REM (without covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=c(PREdictors,"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_REM (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=c(PREdictors[which(PREdictors!="TotalSteps1000")],"sex"),
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex",plot.pred="insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000")),
          tags=TRUE,margin=rep(0,4))

              # plotting HR_NREM interaction (without covid19)
plot_grid(list(glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_NREM interaction (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors[which(predictors!="TotalSteps1000")],
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000"),
               
               # plotting HR_REM interaction (without covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("with TotalSteps1000"),
               # plotting HR_REM interaction (with covid19)
               glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors[which(predictors!="TotalSteps1000")],
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",modelType="GLMER",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,dot.size=3,
                       return.plot=TRUE) + ggtitle("without TotalSteps1000")),
          tags=TRUE,margin=rep(0,4))
```

<br>

In conclusion, the results of this robustness check were **overall consistent** with those obtained with the main analyses, although questioning the generalizability of the results observed for `TIB.SSD` and (slightly less) `s.auton` outcomes.

<br>

### 1.6.5. Family distribution

Here, we replicate the models predicting those variables that showed poor fit in the model diagnostics above by re-specifying the models with different distribution families and link functions:

- `WASO`: initially modeled by assuming a normal distribution for residuals, despite the highlighted deviation in the upper tail of the distribution. Since `WASO` is bounded at zero and positively skewed, we inspect how results change when assuming a **gamma distribution**. Here, we can see that the **fit does not clearly improve** when the family distribution is changed.
```{r,fig.width=8,fig.height=6}
# WASO: normal vs. gamma (not optimal fit in both cases)
ema$WASOc <- ema$WASO + 0.001
p1 <- lmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema)
p2 <- glmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0)
p4 <- glmer(WASOc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=gaussian("log"),nAGQ=0)
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red")
qqnorm(resid(p3),main="qqnorm residuals - Gamm(inverse"); qqline(resid(p3),col="red") 
qqnorm(resid(p4),main="qqnorm residuals - Normal(log)"); qqline(resid(p4),col="red")
```

<br>

- `s.variab`: modeled by assuming a **gamma distribution**. Here, we re-specify the models by assuming normality (although it can be seen that the **fit is strongly impaired**).
```{r,fig.width=8,fig.height=3}
# TST.SSDc: normal vs. gamma (clearly better fit for gamma)
p1 <- lmer(TST.SSDc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema)
p2 <- glmer(TST.SSDc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"))
p2 <- glmer(TST.SSDc~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"))
par(mfrow=c(1,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
```

<br>

- `s.auton`: modeled by assuming a normal distribution, but showing marked deviations in the upper tail. Again, these are re-modeled by assuming a **gamma distribution**. Here, we can see that the **fit does not clearly improve** when the family distribution is changed.
```{r,fig.width=8,fig.height=6}
# HR_NREM: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema)
p2 <- glmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0)
p3 <- glmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0)
p4 <- glmer(HR_NREM~SO.num+TotalSteps1000+weekday.sleep+BMI+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0)

par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 
```

<br>

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001
res2 <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=PREdictors,nAGQ=0, # nAGQ = 0 to reach convergence
                                    modelType=c("GLMER"),family="gamma",link="log",
                                    mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(sleepVar in c(paste(s.variab,"c",sep=""),s.auton)){
  if(grepl("SSD",sleepVar)){ fam <- c("normal","identity") }else{ fam <- c("gamma","log") }
  if(grepl("HR",sleepVar)){ key.model="sex" 
    Predictors <- c(PREdictors,"sex") }else{ key.model <- "insomnia" 
                                             Predictors <- PREdictors
                                             nAGQ <- 0 } # nAGQ = 0 to converge
  res2 <- rbind(res2,
             cbind(measure=sleepVar,glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=Predictors,nAGQ=nAGQ,
                                            family=fam[1],link=fam[2],key.model=key.model,key.predictor="insomnia",
                                            modelType=c("GLMER"),mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "familyDistr"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck")
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` and `s.auton` outcomes, with a no longer substantial main effect on `TST.SSD`, and no longer significant LRT (bust still higher Aw and substantial *t*) for `HR_NREM` and `HR_REM`

<br>

### 1.6.6. Summary of results

Here, we summarize the results from all robustness checks. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=5}
key.resPlot(RES,robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses (`sarchit` and `s.timing`) are **highly consistent** across the robustness checks

- the lower `s.variab` in `TIB`, `TST`, and `SO` highlighted for the `insomnia` group shows **some inconsistencies**, especially for `SO.num.SSD` (whose effect is no longer substantial following the exclusion of `majMiss` participants, or the inclusion of `covid19`)

- **more consistent** results are found for `TST.SSD` (only affected by the distribution family, but with a better fit for the main analyses than the robustness checks) and `TIB.SSD` (whose group differences are no longer substantial when `TotalSteps` are excluded from the model, likely due to the lack of convergence with nAGQ = 1)

- results for `s.auton` variables are **apparently even more inconsistent** than those shown by `s.variab`, with the main effect of `insomnia` showing low generalizability across different analytical strategies, and especially for `HR_NREM`; however, it should be noted that the **interaction between** `sex` **and** `insomnia` is **consistently** observed over all robustness checks   

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, with `SO.SSD` showing the **less consistent relationship** with `insomnia`.

<br>

# 2. Diary ratings

Here, bedtime ratings of `stress`, `worry`, and `mood` are predicted by (1) meaningful covariates (`TotalSteps1000` and `weekday`), (2) the `insomnia` group, (3) participantsâ `sex`, and (4) the interaction between `sex` and insomnia `groups`, in order **to characterize the two groups in terms of pre-sleep psychological states**.
```{r fig.width=12,fig.height=8}
predictors <- c("TotalSteps1000","weekday.sleep","insomnia","sex","sex:insomnia")
```

In addition to considering the **raw item scores**, we replicate the models by using the aggregated values (`PsyDist`) and the factor scores (`fs`) predicted by the MCFA model specified above.

<br>

## 2.1. Raw item scores {.tabset .tabset-fade .tabset-pills}

Daily diary item scores are modeled by considering the subset of complete `dailyDiary` and `TotalSteps1000`. Due to the **ordinal nature** of these single-item measures, we do not use normality-based GLMER. Instead, we **binary transform each item score** (i.e., 0 = score lower than or equal to 3, 1 = score higher than 3), and we use **logistic regression**.
```{r }
# recoding stress, worry, and mood in two categories
ema[!is.na(ema$stress),c("stress.cat","worry.cat","mood.cat")] <- 0
ema[!is.na(ema$stress) & ema$stress>3,"stress.cat"] <- 1
ema[!is.na(ema$worry) & ema$worry>3,"worry.cat"] <- 1
ema[!is.na(ema$mood) & ema$mood>3,"mood.cat"] <- 1

# summarizing the categorical recoded variables
summary(as.factor(ema$stress.cat))
summary(as.factor(ema$worry.cat))
summary(as.factor(ema$mood.cat))
```

<br>

*Comments:*

- in the 12-to-14% of the cases, *stress*, *worry*, and *mood* were rated as 3 or higher

<br>

Here, we use the *glmerAn* function to conduct logistic regression for each item score.

### STRESS

`stress` is a one-item ordinal variable, and it was dicotomized to be modeled by assuming a **binomial distribution** for the residuals (i.e., **logistic regression**).
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        family="binomial",link="logit",transform="exp", # logistic regression (exponentiated coefficients = odds ratios)
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia")

# keeping key results
res <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=predictors,
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",dot.size=3,messages=FALSE))
```

<br>

*Comments:*

- the logistic regression assumption of (1) **linearity between logit and continuous predictors** generally holds, although the slightly higher logit for weekend days, insomnia, and females; (2) random effects are **quite normally distributed**, with only a **slight deviation from normality in the lower tail** of the random intercept distribution; there is (3) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`TotalSteps1000`*** and ***`weekday.sleep`*** are associated with a **significant LRT**, whereas the inclusion of **all variables but the interactive term** are associated with a **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`TotalSteps1000`*** (lower `stress` for higher than usual `TotalSteps`), and ***`weekday.sleep`*** (lower `stress` on weekend days than on weekdays). Neither `insomnia` nor `sex` or their interaction show a substantial effect (i.e., despite the slightly higher `stress` in insomnia than in controls, and especially in insomnia girls compared to control girls, these differences are not substantial)

<br>

### WORRY

`worry` is a one-item ordinal variable, and it was dicotomized to be modeled by assuming a **binomial distribution** for the residuals (i.e., **logistic regression**).
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="worry.cat",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        family="binomial",link="logit",transform="exp", # logistic regression (exponentiated coefficients = odds ratios)
        nAGQ=0, # nAGQ = 0 to reach convergence in the interactive model
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia")

# keeping key results
res <- rbind(res,cbind(measure="worry.cat",glmerAn(long=ema,wide=demos,resp="worry.cat",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",dot.size=3,messages=FALSE)))
```

<br>

*Comments:*

- the logistic regression assumption of (1) **linear independence between logit and continuous predictors** generally holds, although the slightly higher logit for weekend days, insomnia, and females; random effects are **quite normally distributed**, with only a **slight deviation from normality in the lower tail** of the random intercept distribution; there is (3) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`weekday.sleep`*** are associated with a **significant LRT** and a **stronger evidence** in terms of Aw

- a substantial effect is only estimated for ***`weekday.sleep`*** (lower `worry` on weekend days than on weekdays). Neither `insomnia` nor `sex`, or their interaction show a substantial effect (i.e., despite the slightly higher `worry` in insomnia than in controls, and especially in insomnia girls compared to control girls, these differences are not substantial)

<br>

### MOOD

`mood` is a one-item ordinal variable, and it was dicotomized to be modeled by assuming a **binomial distribution** for the residuals (i.e., **logistic regression**).
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="mood.cat",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        family="binomial",link="logit",transform="exp", # logistic regression (exponentiated coefficients = odds ratios)
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia")

# keeping key results
res <- rbind(res,cbind(measure="mood.cat",glmerAn(long=ema,wide=demos,resp="mood.cat",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",dot.size=3,messages=FALSE)))
```

<br>

*Comments:*

- the assumption of (1) **linear independence between logit and continuous predictors** generally holds; (2) random effects are **quite normally distributed**, with only a **slight deviation from normality in the lower tail** of the random intercept distribution; there is (3) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`TotalSteps1000`*** and ***`weekday.sleep`*** are associated with a **significant LRT**, whereas **all predictors but** `insomnia` **and** `sex` show **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`TotalSteps1000`*** (lower bad `mood` for higher than usual `TotalSteps`), ***`weekday.sleep`*** (lower bad `mood` on weekend days than on weekdays), and ***`sex`*** (lower bad `mood` in boys compared to girls), but only if the interaction is not included in the model. Neither `insomnia` nor `sex`, or their interaction show a substantial effect

<br>

## 2.2. Aggregate scores {.tabset .tabset-fade .tabset-pills}

Here, we replicate the analyses by considering the aggregate (i.e., mean) score of `stress`, `worry`, and `mood` (`PsyDist`), and the factor scores predicted by the MCFA model selected above.

### PsyDist

`PsyDist` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="PsyDist",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,cbind(measure="PsyDist",glmerAn(long=ema,wide=demos,resp="PsyDist",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the upper tail** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- only ***`TotalSteps1000`*** and ***`weekday.sleep`*** are associated with a **significant LRT** and **stronger evidence** in terms of Aw

- substantial effects are only estimated for ***`TotalSteps1000`*** (lower `PsyDist` for higher than usual `TotalSteps`), and ***`weekday.sleep`*** (lower `PsyDist` on weekend days than on weekdays). Neither `insomnia` nor `sex`, or their interaction show a substantial effect

<br>

### fs

`fs` is quite normally distributed, thus it is modeled by assuming a **normal distribution** for the residuals.
```{r fig.width=12,fig.height=8}
glmerAn(long=ema,wide=demos,resp="fs",fix.eff=predictors,
        modelType=c("GLMER"),mc.predictors="TotalSteps1000", # GLMER with mean-centered pred.
        outputs=c("fit","mComp","coeff","plotEff"),
        coeff.models=c("insomnia","sex","sex:insomnia"), # showing all models including insomnia
        plot.model="insomnia",show.data=TRUE)

# keeping key results
res <- rbind(res,cbind(measure="fs",glmerAn(long=ema,wide=demos,resp="fs",fix.eff=predictors[1:(length(predictors)-1)],
                                   modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                   outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE)))
```

<br>

*Comments:*

- results are **highly consistent** with those reported for `PsyDist`, with the only difference that `sex` shows higher Aw and a substantial effect

<br>

## 2.3. Summary of results

Here, we use the `key.resPlot` function to graphically summarize the results obtained from the models above. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of `insomnia`). The figure below uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, and |t| > 1.96 ) are shown in **green**

- those relationships showing a **|t| > 1.96** but either a nonsignificant LRT **or** a lower Aw than the previous model are shown in **light green** (or lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT **and** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT **or** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT **and** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=2}
key.resPlot(res,levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the analysis of pre-sleep `stress`, `worry`, and `mood` ratings characterization did not highlight **any substantial difference** between the insomnia and the control group, with only a (slightly) higher Aw (but non-significant LRT and unsubstantial effect) for the model including `insomnia` for predicting `stress`

<br>

## 2.4. Robustness checks {#robcheck}

Here, we conduct several **robustness checks** to account for the arbitrariness of our data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the insomnia variable, (2) the inclusion of the `covid19` variable as a further covariate, (3) the exclusion of participants with **extreme missing data**, (4) the **exclusion of** `TotalSteps1000`, (5) the use of **alternative family distributions** for the analyses.

<br>

### 2.4.1. insomnia.group

Here, we inspect the results obtained by considering the `insomnia.group` (i.e., 46 controls, 26 DSM.ins and 21 sub.ins) rather than the `insomnia` variable (i.e., 46 controls vs. 47 insomnia). 

The figure below shows the t-values associated with the group differences between **full DSM insomnia** and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
PREdictors <- predictors[1:(length(predictors)-2)] # excluding sex and interactive model
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,
             cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                            family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                            modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                            outputs="key.results",messages=FALSE))) }
# joining with the main results
res$robCheck <- "Original"
res2$robCheck <- "insomnia.group"
RES <- rbind(res,res2)

# plotting robustness check
key.resPlot(RES,robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses for most sleep outcomes

- the most relevant differences are shown for `stress.cat`, `worry.cat`, and `fs`, now showing **significant LRT**, **higher Aw** and a **substantial difference** for `insomnia` (i.e., higher `stress`, `worry`, and `fs` for the full DSM insomnia group compared to controls)

<br>

Here, we can see that the **differences in** `stress`, `worry`, and `fs` **are substantial**, and **driven by the full DSM insomnia subgroup**, whereas no substantial differences are estimated between the control and the sub-threshold insomnia group.
```{r fig.width=10,fig.height=6,warning=FALSE,message=FALSE,echo=FALSE}
plot_grid(list(glmerAn(long=ema,wide=demos,resp="stress.cat",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",family="binomial",link="logit",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",transform="exp",
                       plot.model="insomnia.group",plot.pred="insomnia.group",dot.size=3),
               glmerAn(long=ema,wide=demos,resp="worry.cat",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",family="binomial",link="logit",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",transform="exp",
                       plot.model="insomnia.group",plot.pred="insomnia.group",dot.size=3),
               glmerAn(long=ema,wide=demos,resp="mood.cat",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",family="binomial",link="logit",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",transform="exp",
                       plot.model="insomnia.group",plot.pred="insomnia.group",dot.size=3)))
```
```{r fig.width=5,fig.height=6,warning=FALSE,message=FALSE,echo=FALSE}
plot_grid(list(glmerAn(long=ema,wide=demos,resp="PsyDist",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",
                       plot.model="insomnia.group",plot.pred="insomnia.group",show.data=TRUE),
               glmerAn(long=ema,wide=demos,resp="fs",
                       fix.eff=gsub("insomnia","insomnia.group",predictors)[1:(length(predictors)-2)],
                       mc.predictors="TotalSteps1000",modelType="GLMER",return.plot=TRUE,
                       outputs=c("mComp","coeff","plotEff"),coeff.models="insomnia.group",
                       plot.model="insomnia.group",plot.pred="insomnia.group",show.data=TRUE)))
```

<br>

In conclusion, the results of this robustness check were **inconsistent** with those obtained with the main analyses, showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group.

<br>

### 2.4.2. COVID-19 emergency

Here, we inspect the results obtained by including the `covid19` variable **as a further covariate**. As shown in section 1.2.8, the `covid19` factor discriminates the data collected `pre-COVID19` (63%) and the data collected `post-COVID19` (37%). The covariate is included **at the first step** (model M1, before `SO.num`).

The figure below shows the t-values associated with the group differences between **full DSM insomnia** and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=c("covid19",PREdictors),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=c("covid19",PREdictors),
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "covid19"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","covid19"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most outcomes

- the only difference is that with `covid19` the model predicting `stress` by `insomnia` is not even associated with higher Aw

<br>

Here, we can see that the `post-COVID19` data collection period **does not show substantial differences** compared to the `pre-COVID19` period, with only slightly higher `stress`.
```{r fig.width=4,fig.height=3,warning=FALSE,message=FALSE}
# plotting difference by covid (model M1)
for(diaryVar in c("stress.cat","worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=c("covid19",PREdictors[1:2]),
        mc.predictors="TotalSteps1000",modelType="GLMER",family=fam[1],link=fam[2],
        outputs="plotEff",plot.model="insomnia",plot.pred="covid19",messages=FALSE,dot.size=3) }
```

<br>

In conclusion, the results of this robustness check were **highly consistent** with those obtained with the main analyses, with **no substantial group differences** in any variable, and no substantial differences between pre- and post-COVID19.

<br>

As a further check, we also inspect the results of the `covid19` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",
                                           fix.eff=c("covid19",gsub("insomnia","insomnia.group",PREdictors)),
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                           family="binomial",link="logit",messages=FALSE,
                                           outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,
                                                    fix.eff=c("covid19",gsub("insomnia","insomnia.group",PREdictors)),
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "covid19.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","covid19.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **in line** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

- in addition, substantial differences in `PsyDist` (but not in `mood`) are found when considering `covid19` as a further covariate

<br>

### 2.4.3. Low compliance

Here, we inspect the results obtained by **excluding seven participants** (7.5%) with **less than two weeks of valid observations in any data type**. In section 3.2, these participants were marked with `majMiss` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$majMiss!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days, ",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=PREdictors,
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000", family="binomial",link="logit",
                                           outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,fix.eff=PREdictors,
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "majMiss"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","majMiss"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most outcomes

- the only difference is that without `majMiss` the model predicting `stress` by `insomnia` is not even associated with higher Aw

<br>

As a further check, we also inspect the results of the `majMiss` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                           family="binomial",link="logit",messages=FALSE,
                                           outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "majMiss.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","majMiss.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

<br>

### 2.4.4. TotalStep1000

Here, we inspect the results obtained by **excluding** `TotalSteps1000` **from the models predictors**. This is done in order to replicate the analyses by including cases with invalid daily steps data (thus, with higher sample size).

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress.cat",fix.eff=c("weekday.sleep","insomnia","sex"),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=diaryVar,fix.eff=c("weekday.sleep","insomnia","sex"),
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "no-TotalSteps"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","no-TotalSteps"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses, with the only exception of `stress.cat`, whose model including `insomnia` now shows **significant LRT** and a **substantial positive effect** (i.e., higher `stress` in insomnia compared to controls)

- none of the remaining variables show substantial differences, with almost identical results than those obtained with the main analyses

<br>

As a further check, we also inspect the results of the `majMiss` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=c("weekday.sleep","insomnia.group","sex"),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",family="binomial",link="logit",messages=FALSE,
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,fix.eff=c("weekday.sleep","insomnia.group","sex"),
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "no-TotalSteps.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","no-TotalSteps.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

<br>

### 2.4.5. Family distribution  {.tabset .tabset-fade .tabset-pills}

Here, we replicate the models predicting those variables that showed poor fit in the model diagnostics above by re-specifying the models with different distribution families and link functions:

#### NORMAL

- `stress`, `worry`, and `mood`: initially dichotomized, and modeled with a **logistic regression**. Here, we can see that the fit of the **normal** istribution (i.e., assuming item scores as they were continuous) is **quite acceptable** and better than that shown by the *gamma* family
```{r,fig.width=8,fig.height=6}
# stress: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0) # nAGQ = 0 to converge
p4 <- glmer(stress~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0) # nAGQ = 0 to converge
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 

# worry: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0) # nAGQ = 0 to converge
p4 <- glmer(worry~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0) # nAGQ = 0 to converge
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 

# mood: normal vs. gamma (unoptimal fit in both cases)
p1 <- lmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0) # nAGQ = 0 to converge
p3 <- glmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"),nAGQ=0) # nAGQ = 0 to converge
p4 <- glmer(mood~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0) # nAGQ = 0 to converge
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 
```

<br>

- `PsyDist`: modeled by assuming a **normal distribution** for the residuals. Here, we re-specify the models by assuming a **gamma distributon**, which shows a **slightly better fit** (note that `PsyDist` is positively skewed)
```{r,fig.width=8,fig.height=6}
# PsyDist: normal vs. gamma (better fit for gamma)
p1 <- lmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema)
p2 <- glmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("log"),nAGQ=0)
p3 <- glmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("identity"))
p4 <- glmer(PsyDist~TotalSteps1000+weekday.sleep+insomnia+(1|ID),data=ema,family=Gamma("inverse"),nAGQ=0)
par(mfrow=c(2,2))
qqnorm(resid(p1),main="qqnorm residuals - Normal"); qqline(resid(p1),col="red") 
qqnorm(resid(p2,type="deviance"),main="qqnorm residuals - Gamma(log)"); qqline(resid(p2),col="red") 
qqnorm(resid(p3,type="deviance"),main="qqnorm residuals - Gamma(identity)"); qqline(resid(p3),col="red") 
qqnorm(resid(p4,type="deviance"),main="qqnorm residuals - Gamma(inverse)"); qqline(resid(p4),col="red") 
```

<br>

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either M2 (main effect of `insomnia`), and using a **normal** and a **gamma** distribution for modeling raw item scores and the aggregate score, respectively. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=PREdictors,
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),fix.eff=PREdictors,
                                                    family=fam[1],link=fam[2],nAGQ=0, # nAGQ = 0 to reach convergence with PsyDist
                                                    key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "distr.Normal.Gamma"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.Normal.Gamma"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

As a further check, we also inspect the results of the *distr.Normal.Gamma* robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist")){
  if(diaryVar=="PsyDist"){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                                    family=fam[1],link=fam[2],nAGQ=0, # nAGQ = 0 to reach convergence with PsyDist
                                                    key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "distr.Normal.Gamma.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.Normal.Gamma.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and (also) `PsyDist` between the full DSM insomnia and the control group

<br>

#### ORDINAL REGRESSION

Here, we account for the **ordinal nature** of item ratings by replicating the analyses by using **cumulative link mixed models** (CLMM). The figure below uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=PREdictors,
                                           modelType=c("CLMM"),mc.predictors="TotalSteps1000",
                                           outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat")){
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),fix.eff=PREdictors,
                                                    modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
                                                    key.model="insomnia",key.predictor="insomnia",outputs="key.results"))) }
# joining with the main results
res2$robCheck <- "distr.CLMM"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.CLMM"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

As a further check, we also inspect the results of the *distr.CLMM* robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=ema,wide=demos,resp="stress",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                    modelType=c("CLMM"),mc.predictors="TotalSteps1000",
                                    outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group",messages=FALSE))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=ema,wide=demos,resp=gsub(".cat","",diaryVar),
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                                    key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("CLMM"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "distr.CLMM.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","distr.CLMM.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress` and `worry` between the full DSM insomnia and the control group

<br>

Here, we inspect the differences in the *insomnia* effect estimated by the CLMM models specified with the *insomnia* and the *insomnia.group* predictor. The figures below show that, whereas no substantial differences are estimated between the insomnia and the control group in almost any response category, **substantial differences are estimated in** `stress` **and** `worry` **between the full DSM insomnia and the control group**, with the former showing lower probability of rating `stress` and `mood` as 1, and higher probability of rating them as 3, compared to the latter.
```{r fig.width=10,fig.height=6,warning=FALSE,message=FALSE}
# plotting stress by insomnia (CLMM)
glmerAn(long=ema,wide=demos,resp="stress",fix.eff=PREdictors,modelType=c("CLMM"),mc.predictors="TotalSteps1000",
        outputs=c("coeff","plotEff"),plot.model="insomnia",plot.pred="insomnia",coeff.models="insomnia",messages=FALSE)
# plotting stress by insomnia.group (CLMM)
glmerAn(long=ema,wide=demos,resp="stress",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
        modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
        outputs=c("coeff","plotEff"),plot.model="insomnia.group",plot.pred="insomnia.group",coeff.models="insomnia.group")

# plotting worry by insomnia (CLMM)
glmerAn(long=ema,wide=demos,resp="worry",fix.eff=PREdictors,modelType=c("CLMM"),mc.predictors="TotalSteps1000",
        outputs=c("coeff","plotEff"),plot.model="insomnia",plot.pred="insomnia",coeff.models="insomnia",messages=FALSE)
# plotting worry by insomnia.group (CLMM)
glmerAn(long=ema,wide=demos,resp="worry",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
        modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
        outputs=c("coeff","plotEff"),plot.model="insomnia.group",plot.pred="insomnia.group",coeff.models="insomnia.group")

# plotting mood by insomnia (CLMM)
glmerAn(long=ema,wide=demos,resp="mood",fix.eff=PREdictors,modelType=c("CLMM"),mc.predictors="TotalSteps1000",
        outputs=c("coeff","plotEff"),plot.model="insomnia",plot.pred="insomnia",coeff.models="insomnia",messages=FALSE)
# plotting mood by insomnia.group (CLMM)
glmerAn(long=ema,wide=demos,resp="mood",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
        modelType=c("CLMM"),mc.predictors="TotalSteps1000",messages=FALSE,
        outputs=c("coeff","plotEff"),plot.model="insomnia.group",plot.pred="insomnia.group",coeff.models="insomnia.group")
```

<br>

### 2.4.6. Late responses

Here, we inspect the results obtained by **excluding 1,010 cases** (20.5%) in which participants **filled the diary on the following day**. In section 1.2.6, these cases were marked with `diary.nextDay` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$diary.nextDay!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days, ",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=PREdictors,
                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                    family="binomial",link="logit",
                                    outputs="key.results",key.predictor="insomnia",key.model="insomnia",messages=FALSE))

# computing key results for the following sleep outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  if(diaryVar=="worry.cat"){ nAGQ=0 } else { nAGQ=1 } # nAGQ = 0 for worry.cat to reach convergence
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,fix.eff=PREdictors,nAGQ=nAGQ,
                                                    family=fam[1],link=fam[2],key.model="insomnia",key.predictor="insomnia",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "lateResp"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","lateResp"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most outcomes

<br>

As a further check, we also inspect the results of the `lateResp` robustness check by considering `insomnia.group`.
```{r,fig.width=12,fig.height=3}
# computing key results for stress
res2 <- cbind(measure="stress.cat",glmerAn(long=EMA,wide=DEMOS,resp="stress.cat",fix.eff=gsub("insomnia","insomnia.group",PREdictors),
                                           modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                           family="binomial",link="logit",messages=FALSE,
                                           outputs="key.results",key.predictor="insomnia.group",key.model="insomnia.group"))

# computing key results for the following diary outcomes
for(diaryVar in c("worry.cat","mood.cat","PsyDist","fs")){
  if(diaryVar%in%c("PsyDist","fs")){ fam <- c("normal","identity") }else{ fam <- c("binomial","logit") }
  if(diaryVar=="worry.cat"){ nAGQ=0 } else { nAGQ=1 } # nAGQ = 0 for worry.cat to reach convergence
  res2 <- rbind(res2,cbind(measure=diaryVar,glmerAn(long=EMA,wide=DEMOS,resp=diaryVar,
                                                    fix.eff=gsub("insomnia","insomnia.group",PREdictors),nAGQ=nAGQ,
                                                    family=fam[1],link=fam[2],key.model="insomnia.group",key.predictor="insomnia.group",
                                                    modelType=c("GLMER"),mc.predictors="TotalSteps1000",
                                                    outputs="key.results",messages=FALSE))) }
# joining with the main results
res2$robCheck <- "lateResp.insomnia.group"
RES <- rbind(RES,res2)

# plotting robustness check
key.resPlot(RES[RES$robCheck%in%c("Original","lateResp.insomnia.group"),],
            robCheck = "robCheck",levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the results are **highly consistent** with our first sanity check (section 5.2.4.1), showing **substantial differences in** `stress`, `worry`, and `fs` between the full DSM insomnia and the control group

<br>

### 2.4.7. Summary of results

Here, we summarize the results from all robustness checks. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering model M2 (main effect of *insomnia*). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**
```{r,fig.width=12,fig.height=6}
key.resPlot(RES[!grepl(".insomnia.group",RES$robCheck),],robCheck = "robCheck",
            levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

*Comments:*

- the **null results** observed from the main analyses for `mood` and `PsyDist` are **highly consistent** with those obtained from the main analyses

- in contrast, the inclusion of `insomnia.group` resulted in **substantial group differences** (i.e., higher `stress`, `worry`, and `fs`) between the **full DSM insomnia** subgroup and the control group, but not between the latter and the insomnia sub-threshold subgroup

- group differences in `stress` ratings were **substantial** also when `TotalSteps1000` was excluded form the models

<br>

Here, we can see that the substantial differences in `stress`, `worry`, and `fs` are **highly consistent across all robustness checks** including the `insomnia.group` term.
```{r,fig.width=12,fig.height=5}
key.resPlot(RES[grepl(".insomnia.group",RES$robCheck),],robCheck = "robCheck",
            levels=c("stress.cat","worry.cat","mood.cat","PsyDist","fs"))
```

<br>

In conclusion, the results obtained with the main analyses are **overall robust**, but the `insomnia.group` variable shows **substantial and consistent differences** that were not observed for the `insomnia` variable.

<br>

# References {#ref}

- Cranford, J. A., Shrout, P. E., Iida, M., Rafaeli, E., Yip, T., & Bolger, N. (2006). A Procedure for Evaluating Sensitivity to Within-Person Change: Can Mood Measures in Diary Studies Detect Change Reliably? *Personality and Social Psychology Bulletin*, 32(7), 917â929. https://doi.org/10.1177/0146167206287721

- Geldhof, G. J., Preacher, K. J., & Zyphur, M. J. (2014). Reliability estimation in a multilevel confirmatory factor analysis framework. *Psychological Methods*, 19(1), 72â91. https://doi.org/10.1037/a0032138

- Green, J. A. (2021). Too many zeros and/or highly skewed? A tutorial on modelling health behaviour as count data with Poisson and negative binomial regression. *Health Psychology and Behavioral Medicine, 9*(1), 436-455. https://doi.org/10.1080/21642850.2021.1920416

- Hox, J. J. (2010). *Multilevel Analysis: Techniques and Applications (2nd ed.)*. Routledge.

- Jak, S., & Jorgensen, T. D. (2017). Relating Measurement Invariance, Cross-Level Invariance, and Multilevel Reliability. *Frontiers in Psychology*, 8(OCT), 1â9. https://doi.org/10.3389/fpsyg.2017.01640

- Menghini, L., Yuksel, D., Goldstone, A., Baker, F. C., & de Zambotti, M. (2021). Performance of Fitbit Charge 3 against polysomnography in measuring sleep in adolescent boys and girls. *Chronobiology International*, 38(7):1010-1022. https://doi.org/10.1080/07420528.2021.1903481

- Ng, V. K., & Cribbie, R. A. (2017). Using the gamma generalized linear model for modeling continuous, skewed and heteroscedastic outcomes in psychology. *Current Psychology, 36*(2), 225-235. https://doi.org/10.1007/s12144-015-9404-0

<br>

## R packages
