---
title: "Wearable and mobile technology to characterize daily patterns of sleep, stress, pre-sleep worry and mood in adolescent insomnia - Appendix C: Data analysis code and output"
subtitle: "Part 3: Relationships between sleep measures and diary ratings"
author: "Luca Menghini, PhD, Dilara YÃ¼ksel, PhD, Devin Prouty, PhD, Fiona C Baker PhD, Christopher King, PhD, Massimiliano de Zambotti, PhD"
bibliography: [packagesAn.bib]
nocite: '@*'
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    toc_depth: 4
    css: styles.css
  pdf_document: default
  word_document: default
  theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

# Aims and content

The present document includes the analytical steps implemented to characterize and explore the antecedents of sleep patterns in a sample of older adolescents with (N = 47; 31 girls) and without (N = 46; 28 girls) DSM-5 insomnia.

The data processing pipeline is [depicted at this page](https://sri-human-sleep.github.io/INSA-home/Appendix%20B%20-%20Data%20pre-processing/insa%40home_dataProcessing.html), whereas the first part of data analysis (data preparation, psychometrics, and descriptives) is [depicted at this page](https://sri-human-sleep.github.io/INSA-home/Appendix%20C%20-%20Data%20analysis/insa%40home_dataAnalysis1.html). The latter script resulted in the following long-form `ema` and wide-form `demos` datasets:
```{r }
# removing all objets from the workspace
rm(list=ls())

# loading datasets exported at the end of the first Data Analysis script
load("emaFINAL.RData")
load("demosFINAL.RData")

# setting system time zone to GMT (for consistent temporal synchronization)
Sys.setenv(tz="GMT")
```

<br>

Here, we use **generalized linear mixed-effects regression** (GLMER) models to examine the **direct and bidirectional relationships between sleep and psychological distress**. In the following models, `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables measured at day *i* are predicted by the predictors selected in step 1 in addition to the diary ratings (`stress`, `worry`, `mood`, `PsyDist`, and `fs`) measured at day *i* (M5), and diary ratings measured at day *i+1* (M6), in order to **evaluate the direct and bidirectional relationship between sleep and psychological distress**. Finally, the **interaction** between diary ratings and *insomnia* is included in model M7.

Finally, we generate the **final outputs** reported in the main paper.

<br>

For each step and each outcome variable, models are specified by using alternative distribution families based on the nature of the outcome, inspected to evaluate **model fit**, **compared** in terms of likelihood and strength of evidence, and inspected to check the results of the selected model.

Note that all **level-1** continuous predictors are centered to the individual mean (**mean-centered**, `mc`), whereas all **level-2** continuous predictors are centered to the grand average (**grand-mean-centered**, `gmc`).

Finally, several **robustness checks** are performed to account for the arbitrariness of data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the `insomnia` variable, (2) the inclusion of `covid19` as a further covariate, (3) the exclusion of participants with extreme missing data (marked with `majMiss = 1`), (4) the exclusion of the `TotalSteps1000` variable from the analyses, (5) the use of **alternative family distributions** for those variables not showing optimal fit, and (6) the exclusion of diary ratings entered on the following day (marked with `lateResp = 1`).

<br>

The following R packages and functions are used.
```{r message=FALSE,warning=FALSE}
# required packages
packages <- c("dplyr","Rmisc","lme4","ordinal","sjPlot","ggplot2","car","knitr","MuMIn","knitr","XML","sjPlot","reshape2")

# generate packages references
knitr::write_bib(c(.packages(), packages),"packagesAn.bib")

# # run to install missing packages
# xfun::pkg_attach2(packages, message = FALSE); rm(list=ls())

# loading mainly used packages
library(lme4); library(ordinal); library(reshape2); library(MuMIn); library(sjPlot); library(ggplot2); library(Rmisc)
```

<details><summary>**`glmerAn`** (from https://github.com/Luca-Menghini/LuMenPsy.Rfunctions )</summary>
<p>
```{r }
#' @title Generalized linear (mixed-effects) regression analysis
#' @param modelType = type of model: GLM, mixed-effects (GLMER), or cumulative link mixedm odel (CLMM)
#' @param long = long-form dataset (data.frame) considered if modelType = GLMER or CLMM
#' @param wide = wide-form dataset (data.frame) 
#' @param resp = name of the response variable (character)
#' @param fix.eff = character vector of names of the predictor(s)
#' @param cluster.ID = name of the cluster variable considered if modelType = GLMER or CLMM (default: "ID")
#' @param timeVar = name of the variable indexing time, considered if modelType = GLMER (defult: "ActivityDate")
#' @param REML = argument from the lme4::lmer() function, see ?lmer
#' @param ran.eff = character string indicating the random effect by using the lme4 syntax (defult: "(1|ID)")
#' @param family = character string indicating the name of the GLM(ER) family to be used in the models (default: "normal")
#' @param link =character string indicating the name of the GLM(ER) link function to be used in the models (default: "identity")
#' @param nAGQ = argument from the lme4::glmer() function, see ?glmer
#' @param mc.predictors = character vector of names of the predictors to be mean-centered
#' @param gmc.predictors = character vector of names of the predictors to be grand-mean-centered
#' @param outputs = character vector of the desired otucomes: "fit" for model diagnostics, "mComp" for model comparison, "coeff" for the coefficient table, "plotEff" for the effect plot(s), and "key.res" for the key results
#' @param coeff.models = name of the predictor(s) whose corresponding model(s) should be considered for the "coeff" output
#' @param transform = argument from sjPlot::tab_model(), see ?tab_model
#' @param coeff.models = model(s) to be considered for the "coeff" output
#' @param plot.model = name of the predictor(s) whose model(s) should be considered for the "plotEff" output
#' @param plot.pred = name of the predictor(s) to be plotted
#' @param show.data = argument from sjPlot::plot_model(), see ?plot_model
#' @param dot.size = argument from sjPlot::plot_model(), see ?plot_model
#' @param dodge = argument from sjPlot::plot_model(), see ?plot_model
#' @param dot.size = argument from sjPlot::plot_model(), see ?plot_model
#' @param ci.lv = argument from sjPlot::plot_model(), see ?plot_model
#' @param y.lim = numeric vector of length 2 indicating the limits of the y-axis
#' @param return.plot = booean. Should the plot be returned by the function? (default: FALSE)
#' @param key.model = name of the predictor(s) whose model(s) should be considered for the "key.res" output
#' @param key.predictor = name of the predictor to be considered by the "key.res" output
#' @param digits = number of digits for all numeric ouputs
#' @param messages = boolean indicating whether a message should be printed for each operation (defult: FALSE)
glmerAn <- function(modelType=c("GLM","GLMER"),long,wide,resp,fix.eff,cluster.ID="ID",timeVar="ActivityDate",REML=FALSE,
                    ran.eff="(1|ID)",family="normal",link="identity",nAGQ=1,mc.predictors=NA,gmc.predictors=NA,
                    outputs=c("fit","mComp","coeff","plotEff","key.results"),coeff.models=NA,transform=NULL,
                    plot.model=NA,plot.pred="all",show.data=FALSE,dot.size=1,dodge=0,ci.lv=.95,y.lim=NA,return.plot=FALSE,
                    key.model=NA,key.predictor=NA,digits=3,messages=TRUE){ 
  
  if(messages==TRUE){ cat("Running",modelType,"analysis of",resp,"...") }
  
  # data preparation ..................................................................................................................
  if(messages==TRUE){ cat("\n\nPreparing data...") }
  
  # participants' ID recoding as factor
  colnames(long)[which(colnames(long)==cluster.ID)] <- colnames(wide)[which(colnames(wide)==cluster.ID)] <- "ID"
  long$ID <- as.factor(as.character(long$ID))
  wide$ID <- as.factor(as.character(wide$ID))
  wide <- wide[order(wide$ID),] # sorting wide by ID
  colnames(long)[which(colnames(long)==timeVar)] <- "time" # time variable
  long <- long[order(long$ID,long$time),] # sorting long by ID and time
  if(nlevels(long$ID)!=nlevels(wide$ID)){ stop(message="Error: different No. of participants in long and wide datasets") }
  
  # listwise deletion
  if(modelType%in%c("GLMER","CLMM")){ memory <- long 
    for(Var in c(resp,fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)])){ colnames(long)[which(colnames(long)==Var)] <- "Var"
      long <- long[!is.na(long$Var),] # removing obs. with missing response in any resp or fix.eff variable
      colnames(long)[which(colnames(long)=="Var")] <- Var }
    long$ID <- as.factor(as.character(long$ID))
    wide <- wide[wide$ID%in%levels(long$ID),] # excluding wide IDs not included in long IDs
    if(messages==TRUE){ cat("\n - Excluding",nrow(memory)-nrow(long),"incomplete observations (",
                            round(100*(nrow(memory)-nrow(long))/nrow(memory),1),
                            "% ) in the response var. or in any of the predictors,\n   and",
                            nlevels(memory$ID)-nlevels(long$ID),"participants with no complete variables") }
  } else { memory <- wide
    for(Var in c(resp,fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)])){ colnames(wide)[which(colnames(wide)==Var)] <- "Var"
      wide <- wide[!is.na(wide$Var),]
      colnames(wide)[which(colnames(wide)=="Var")] <- Var }
    if(messages==TRUE){ cat("\n - Excluding",nrow(memory)-nrow(wide),"participants with no complete variables") }}
  
  # mean-centering predictors
  if(!is.na(gmc.predictors[1])){ if(messages==TRUE){ cat("\n - Grand-mean-centering",paste(gmc.predictors,collapse=" , ")) }
    for(Var in gmc.predictors){  colnames(wide)[which(colnames(wide)==Var)] <- "Var" 
      wide$Var.gmc <- wide$Var - mean(wide$Var,na.rm=TRUE) # computing gmc values
      colnames(wide) <- gsub("Var",Var,colnames(wide))
      long <- plyr::join(long,wide[,c("ID",paste(Var,"gmc",sep="."))],type="left",by="ID") # joining gmc to long dataset
      fix.eff <- gsub(Var,paste(Var,"gmc",sep="."),fix.eff) }} # updating labels in fix.eff (from Var to Var.gmc)
  if(!is.na(mc.predictors[1])){ if(messages==TRUE){ cat("\n - Mean-centering",paste(mc.predictors,collapse=" , ")) }
    suppressMessages(suppressWarnings(require(Rmisc))) 
    for(Var in mc.predictors){ colnames(long)[which(colnames(long)==Var)] <- "Var" 
      wide$Var.cm <- suppressWarnings(summarySE(long,measurevar="Var",groupvars="ID",na.rm=TRUE)[,3]) # cluster means
      long <- plyr::join(long,wide[,c("ID","Var.cm")],type="left",by="ID") # joining cm to long dataset
      long$Var.mc <- long$Var - long$Var.cm # computing mc values
      colnames(long) <- gsub("Var",Var,colnames(long)) 
      fix.eff <- gsub(Var,paste(Var,"mc",sep="."),fix.eff) }} # updating labels in fix.eff (from Var to Var.mc)
  long <- long[,!duplicated(colnames(long))] # removing duplicated columns (don't know why)

  # modeling .........................................................................................................................
  
  # creating model formulas
  formulas <- character()
  if(modelType=="GLM"){ ran.eff <- "1" }
  null.f <- paste(resp,"~",ran.eff) # creating null model formula
  for(i in 1:length(fix.eff)){ # creating other formulas
    if(i==1){ formulas[i] <- paste(resp,"~",fix.eff[1]) } else { formulas[i] <- paste(formulas[i-1],"+",fix.eff[i])  }}
  if(modelType%in%c("GLMER","CLMM")){ if(!is.na(ran.eff)){ formulas <- paste(formulas,"+",ran.eff)
      if(substr(ran.eff,2,2)!="1"){ ranSlope <- paste(fix.eff[which(grepl(ran.eff,fix.eff))])[1]
        null.f <- gsub(ranSlope,"1",null.f)  # removing random slope from models without the related predictor
        for(i in 1:length(formulas)){ 
          if(!(grepl(ranSlope,gsub(paste(ranSlope,"[|]",sep=""),"",formulas[i])))){ 
            formulas[i] <- gsub(paste(ranSlope,"[|]",sep=""),"1|",formulas[i]) }}}
    } else { stop(message="Error: GLMER model type without ran.eff specification") }}
  if(messages==TRUE){ cat("\n\nModel specification:\n - model M0 (null):",null.f)
    for(i in 1:length(formulas)){ cat("\n - model M",i,": ",formulas[i],sep="")}}
  
  # fitting models
  models <- list()
  if(modelType=="GLM"){ if(messages==TRUE){ cat("\n\nFitting GLM models of",resp,"on",nrow(wide),"participants \n   using the",
                                                family,"family with the",link,"link function...") }
    if(family=="normal" & link=="identity"){ null.m <- lm(as.formula(null.f),data=wide) # normal family
      for(i in 1:length(formulas)){ models[[i]] <- lm(formula=as.formula(formulas[i]),data=wide) }
      } else if (family=="gamma") { null.m <- glm(as.formula(null.f),data=wide,family=Gamma(link=link),nAGQ=nAGQ) # gamma family
        for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=Gamma(link=link)) }
        } else if(family=="normal" & link!="identity"){  
          null.m <- glm(as.formula(null.f),data=wide,family=gaussian(link=link)) # normal with other link functions
          for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=gaussian(link=link)) }
        } else if(family=="binomial"){ 
          null.m <- glm(as.formula(null.f),data=wide,family=binomial(link=link)) # logistic regression
          for(i in 1:length(formulas)){ models[[i]] <- glm(formula=as.formula(formulas[i]),data=wide,family=binomial(link=link))}
        } else { stop(message="Error: only normal, gamma, and binomial family are allowed, 
                      with identity, inverse, and log link functions") }
  } else if(modelType=="GLMER"){ suppressMessages(suppressWarnings(require(lme4)))
    if(messages==TRUE){ cat("\n\nFitting",modelType,"models of",resp,"on",nrow(long),"observations from",
                            nlevels(as.factor(as.character(long$ID))),"participants \n   using the",family,
                            "family with the",link,"link function using",ifelse(REML==FALSE,"ML","REML"),"estimator...") }
    if(family=="normal" & link=="identity"){ null.m <- lmer(as.formula(null.f),data=long,REML=REML) # normal  identity
      for(i in 1:length(formulas)){ models[[i]] <- lmer(formula=as.formula(formulas[i]),data=long,REML=REML) }
      } else if (family=="gamma") { null.m <- glmer(as.formula(null.f),data=long,family=Gamma(link=link),nAGQ=nAGQ) # gamma
        for(i in 1:length(formulas)){ models[[i]]<-glmer(formula=as.formula(formulas[i]),data=long,family=Gamma(link=link),nAGQ=nAGQ) }
        } else if(family=="normal" & link!="identity"){ 
          null.m <- glmer(as.formula(null.f),data=long,family=gaussian(link=link),nAGQ=nAGQ) # normal with other links
          for(i in 1:length(formulas)){ models[[i]] <- glmer(formula=as.formula(formulas[i]),data=long,
                                                             family=gaussian(link=link),nAGQ=nAGQ) }
        } else if(family=="binomial"){ null.m <- glmer(as.formula(null.f),data=long,family=binomial(link=link),nAGQ=nAGQ) # logistic
          for(i in 1:length(formulas)){ models[[i]] <- glmer(formula=as.formula(formulas[i]),data=long,
                                                             family=binomial(link=link),nAGQ=nAGQ)}
        } else { stop(message="Error: only normal, logistic, and gamma family are allowed, 
                               with identity, inverse, and log link functions") }
  } else if(modelType=="CLMM"){ suppressMessages(suppressWarnings(require(ordinal))) # cumulative link mixed models
    if(messages==TRUE){ cat("\n\nFitting",modelType,"models of",resp,"on",nrow(long),"observations from",
                            nlevels(as.factor(as.character(long$ID))),"participants \n   using Cumulative Link Mixed Models") }
    long[,resp] <- factor(long[,resp],ordered=TRUE) # response variable as ordered factor
    null.m <- suppressWarnings(clmm(as.formula(gsub("~","~ 1 +",null.f)),data=long)) # suppress formula warning (bugged)
    for(i in 1:length(formulas)){ models[[i]] <- suppressWarnings(clmm(formula=as.formula(formulas[i]),data=long,nAGQ=nAGQ)) }
  } else { stop(message="Error: modelType can only be 'GLM', 'GLMER', or 'CLMM'") }
  
  # outputs..........................................................................................................................
  if(messages==TRUE){ cat("\n\nGenerating models outputs...") }
  
  # model diagnostics
  if("fit"%in%outputs & modelType!="CLMM"){ if(messages==TRUE){ cat("\n\n - Plotting diagnostics of the most complex model:") }
    suppressMessages(suppressWarnings(require(sjPlot))); suppressMessages(suppressWarnings(require(ggplot2)))
    fit <- models[[length(models)]] # most complex model
    if(modelType=="GLMER"){ dat <- long } else { dat <- wide } # fitted dataset
    plots <- list()
    if(family=="normal" & link=="identity"){ p <- plot_model(fit,type="diag",dot.size=dot.size) # LM(ER) diagnostics (normal)
      if(modelType=="GLMER"){ p[[2]] <- p[[2]]$ID } 
      suppressMessages(plot_grid(p,tags=TRUE,margin=c(0,0,0,0)))
    } else { if(family=="binomial"){ # logistic regression
      dat$logit <- log(predict(fit,type="response")/(1-predict(fit,type="response"))) # computing logit
      for(Var in fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)]){ # plotting logit by each continuous predictor
        if(class(dat[,Var])=="numeric"){  plots[[length(plots)+1]] <- ggplot(dat,aes_string(x=Var,y="logit")) + 
          geom_point(size=dot.size) + suppressMessages(stat_smooth(method="loess")) + ggtitle("Logit by",Var) }}
      } else { plots[[length(plots)+1]] <- ggplot(data.frame(residuals=residuals(fit,type="deviance")), # deviance residuals QQ plot
                                                  aes(sample=residuals)) + stat_qq(size=dot.size) + stat_qq_line() +
        labs(x="Theoretical qualtiles (normal distr.)",y="Sample quantiles") + ggtitle("Deviance Residuals' normal QQ plot") 
      plots[[length(plots)+1]] <- ggplot(fortify.merMod(fit), aes(.fitted, resid(fit,type="deviance"))) + geom_point() +
        suppressMessages(stat_smooth(method="loess"))+geom_hline(yintercept=0, col="red", linetype="dashed") +
        labs(x="Fitted values",y="Residuals") + ggtitle("Deviance residuals vs. fitted values") }
      p <- plot_model(fit,type="diag",dot.size=dot.size) # random effects with GLMER
      if(modelType=="GLMER"){ p <- p$ID }
      plots[[length(plots)+1]] <- p + ggtitle("Random effects' normal QQ plot") }
    if(family!="binomial"){ type <- ifelse(family=="gamma","deviance","pearson") # deviance residuals with gamma
      for(Var in fix.eff[which(grepl(":",fix.eff,fixed=TRUE)==FALSE)]){ # homoscedasticity: residuals by levels of categorical pred.
      if(class(dat[,Var])=="factor"){ Dat <- cbind(dat,residuals=resid(fit,type=type),Var=dat[,Var],Resp=dat[,resp])
         plots[[length(plots)+1]] <- ggplot(Dat,aes_string(x="Var",y="residuals")) + 
           ggtitle(paste(type,"residuals by",Var,"\n mean =",paste(round(with(Dat, tapply(Resp, Var, mean)),1),collapse=", "),
                         ", SD =",paste(round(with(Dat, tapply(Resp, Var, sd)),1),collapse=", "))) + xlab(Var) +
           geom_point(size=dot.size,position=position_jitter(),color="gray") + geom_violin(alpha=0.3) }}}
    suppressMessages(plot_grid(plots,tags=TRUE,margin=rep(0,4))) 
    cat("\n  Printing Variance Inflation Factors (VIF):\n")
    suppressMessages(suppressWarnings(require(car))) # variance inflation factors
    print(vif(fit)) }
  
  # model comparison - likelihood ratio test & Akaike weight
  if("mComp"%in%outputs | "key.results"%in%outputs){ 
    if(messages==TRUE){ cat("\n\n - Running likelihood ratio test:") } # likelihood ratio test
    suppressMessages(suppressWarnings(require(knitr))); suppressMessages(suppressWarnings(require(MuMIn))) 
    if(modelType=="CLMM"){ lrt <- as.data.frame(ordinal:::anova.clm(null.m,models[[1]])) # use anova.clm() to avoid env. issue
    } else { lrt <- as.data.frame(suppressMessages(anova(null.m,models[[1]]))) }
    for(i in 1:(length(models)-1)){ if(length(models)>=(i+1)){
      if(modelType=="CLMM"){ lrt <- rbind(lrt,as.data.frame(ordinal:::anova.clm(models[[i]],models[[i+1]]))[2,]) 
      } else { lrt <- rbind(lrt,as.data.frame(suppressMessages(anova(models[[i]],models[[i+1]])))[2,]) }}}
    rownames(lrt) <- c("Null model",fix.eff)
    for(i in nrow(lrt):2){ if(lrt[i,ncol(lrt)] < .05){ if(messages==TRUE){ cat("\n   Selected model:",rownames(lrt)[i]) }
                             break }}
    if("mComp"%in%outputs){ print(kable(round(lrt,digits))) }
    AICs <- lrt[1:2,"AIC"] # Akaike weight
    if(messages==TRUE){ cat("\n\n - Computing Aw coefficients for each model vs. all previous models:") 
      cat("\n   - null model vs.",fix.eff[1],": =",round(Weights(AICs),digits)[1],
          "\n   -",fix.eff[1],"vs. null model =",round(Weights(AICs),digits)[2]) }
    if(length(models)>1){ for(i in 3:nrow(lrt)){ AICs <- c(AICs,lrt[i,"AIC"])
      if(messages==TRUE){ cat("\n   -",row.names(lrt)[i],"=",round(Weights(AICs),digits)[length(AICs)]) }}}
    if(messages==TRUE){ cat("\n   Selected model:",row.names(lrt[which(lrt$AIC==min(lrt$AIC)),])) }
    if("key.results"%in%outputs){ 
      key <- lrt[which(grepl(key.predictor,row.names(lrt))),] # key results
      if(nrow(key)>1){ key <- key[1,] }
      key.results <- data.frame(sig.LRT=key[,ncol(key)]<0.05,higher.Aw=key$AIC==min(AICs[1:(which(fix.eff==key.predictor)+1)])) }} 
  
  # estimated parameters from key.model
  if("key.results"%in%outputs){
    modSummary <- summary(models[[which(fix.eff==key.model)]])
    modSummary <- modSummary$coefficients
    if(modelType=="CLMM"){ modSummary <- modSummary[nlevels(long[,resp]):nrow(modSummary),] }
    key <- modSummary[which(grepl(key.predictor,row.names(modSummary))),3][1] # taking only first coeff for key.results
    key.results <- cbind(key.results,t.196=abs(key)>1.96,t=key) }
  if("coeff"%in%outputs){ if(messages==TRUE){ suppressMessages(suppressWarnings(require(knitr)))
    cat("\n\n - Printing estimated coefficients for models",paste(coeff.models,collapse=" , "))}
    suppressMessages(suppressWarnings(require(XML))); suppressMessages(suppressWarnings(require(sjPlot)))
    out <- data.frame(readHTMLTable(htmlParse(tab_model(models[which(fix.eff%in%coeff.models)],transform=transform,
                                                        show.icc=FALSE,show.p=FALSE,show.stat=TRUE,show.re.var=FALSE,
                                                        show.ci=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
                                                        string.est="B (SE)",string.stat="t")))[1])
    colnames(out) <- out[1,]
    out <- out[-1,] # sorting rows and columns
    out <- rbind(out[which(!substr(out$Predictors,1,3)%in%c("SD ","Cor")),],
                 out[which(substr(out$Predictors,1,3)=="SD "),],out[which(substr(out$Predictors,1,4)=="Cor "),])
    print(knitr::kable(out)) }
  
  # plotting effects
  if("plotEff"%in%outputs){ if(messages==TRUE){ cat("\n\n - Plotting effect(s) estimated by model",which(fix.eff==plot.model)) }
    suppressMessages(suppressWarnings(require(sjPlot))); suppressMessages(suppressWarnings(require(ggplot2)))
    if(plot.pred[1]=="all"){ fix.eff.plot <- fix.eff } else { fix.eff.plot <- plot.pred }
    if(length(fix.eff.plot)==1){ if(grepl(":",plot.pred)){ 
        terms <- c(strsplit(plot.pred,split=":")[[1]][1],strsplit(plot.pred,split=":")[[1]][2]) 
      } else { terms <- fix.eff[which(fix.eff==fix.eff.plot)] } 
      p <- plot_model(models[[which(fix.eff==fix.eff.plot)]],type="pred",terms=terms,ci.lv=ci.lv,dodge=dodge,
                      show.data=show.data,dot.size=dot.size,jitter=0.15) + ggtitle(paste(resp,"by",fix.eff.plot,fix.eff.plot))
      if(!is.na(y.lim[1])){ p <- p + ylim(y.lim) }
      if(return.plot==TRUE){ return(p) } else { print(p) } # returning or printing the plot 
    } else { plots <- list()
      for(i in 1:length(fix.eff.plot)){ if(grepl(":",fix.eff.plot[i],fixed=TRUE)==FALSE){ # predicted effects conditioned on ran.eff.
          p <- plot_model(models[[i]],type="pred",terms=fix.eff.plot[i],show.data=show.data,dot.size=dot.size,ci.lv=ci.lv,
                          colors="gray",jitter=0.15,dodge=dodge)
        } else { p <- plot_model(models[[i]],type="pred",terms=strsplit(fix.eff.plot[i],split=":")[[1]],ci.lv=ci.lv,dodge=dodge) }
                 plots[[i]] <- p + ggtitle(paste(resp,"by",fix.eff.plot[i])) }
      plot_grid(plots,tags=TRUE,margin=rep(0,4)) }}
  
  # returning key results (sig. LRT, Aw higher than previous model, t > 1.96)
  if("key.results"%in%outputs){ return(key.results) }}
```
</p></details>

Fits GLM(ER) models and prints the core numeric and graphical ouputs considered for the analyses.

<details><summary>**`key.resPlot`** (from https://github.com/Luca-Menghini/LuMenPsy.Rfunctions )</summary>
<p>
```{r }
key.resPlot <- function(res=NA,robCheck=NA,levels=c(s.archit,s.timing,paste(s.variab,"c",sep=""),s.auton)){ 
  suppressMessages(suppressWarnings(require(ggplot2)))
  
  # setting color scale
  res[res$t.196==TRUE & res$sig.LRT==TRUE & res$higher.Aw==TRUE,"Value"] <- 10 # 10 = substantial effect
  res[res$t.196==TRUE & ((res$sig.LRT==FALSE & res$higher.Aw==TRUE) | 
                           res$sig.LRT==TRUE & res$higher.Aw==FALSE),"Value"] <- 7.5 # 7.5 = substantial but LRT n.s. OR lower Aw
  res[res$t.196==TRUE & res$sig.LRT==FALSE & res$higher.Aw==FALSE,"Value"] <- 5 # 5 = substantial but both LRT n.s. AND lower Aw
  res[res$t.196==FALSE & ((res$sig.LRT==TRUE & res$higher.Aw==TRUE) | (res$sig.LRT==TRUE & res$higher.Aw==FALSE) |
                            res$sig.LRT==FALSE & res$higher.Aw==TRUE),"Value"] <- 2.5 # 2.5 = unsubstantial and LRT n.s. OR lower Aw
  res[res$t.196==FALSE & res$sig.LRT==FALSE & res$higher.Aw==FALSE,"Value"] <- 1 # 1 = no evidence at all
  res$Measure <- factor(res$measure,levels=levels) # Measures as factor
  
  # plotting
  if(is.na(robCheck)){ # single set of analyses
    ggplot(res,aes(x=Measure,y=as.factor(1),fill=Value)) + geom_tile() + geom_text(aes(label=round(t,2))) +
      scale_fill_gradient2(low="red",high="lightgreen",mid="yellow",midpoint=5,limit = c(1,10), space = "Lab") + 
      labs(x="",y="") + theme(legend.position = "none",axis.text.y = element_blank(),axis.text.x=element_text(angle=45))
  } else { require(reshape2) # multiple robustness checks
    colnames(res)[which(colnames(res)==robCheck)] <- "robCheck"
    ggplot(res,aes(x=Measure, y=as.factor(robCheck), fill=Value)) + geom_tile() + geom_text(aes(label=round(t,2))) +
      scale_fill_gradient2(low="red",high="lightgreen",mid="yellow",midpoint=5,limit = c(1,10), space = "Lab") + 
      labs(x="",y="") + theme(legend.position = "none",axis.text.x=element_text(angle=45)) }}
```
</p></details>

Visualizes the key results (Aw, LRT, and *t* value) obtained with the *glmerAn* function.

<br>

# 1. Sleep by diary ratings

Here, `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables are predicted by the **predictors selected in step 1** in addition to (1) the **diary ratings** measured at **day** ***i***, and (2) the **diary ratings** measured at **day** ***i+1***, in order to evaluate the direct and bidirectional relationship between sleep and psychological distress, as well as (3) the **interaction** between previous day diary ratings and `insomnia`. A **random slope** is also included to account for the individual variability in the relationship between diary ratings and sleep.

Here, we code the **next day diary ratings**.
```{r fig.width=8,fig.height=4,warning=FALSE,message=FALSE}
# selecting all diaryVars variables
diaryVars <- c("stress","worry","mood","PsyDist","fs.w")

# computing lead variables (i.e., next day, "nd")
library(dplyr)
for(i in 1:length(diaryVars)){
  colnames(ema)[colnames(ema)==diaryVars[i]] <- "variable"
  ema <- ema %>% group_by(ID) %>% mutate(variable.nd=dplyr::lead(variable,n=1,default=NA)) # computing lead var
  ema[ema$dayNr!=ema$partdayNr,"variable.nd"] <- NA # removing lagged values in cases when dayNr != partdayNr
  colnames(ema) <- gsub("variable",diaryVars[i],colnames(ema)) }
ema <- as.data.frame(ema)
detach("package:dplyr", unload=TRUE)

# correlation between PsyDist and PsyDist.nd: .34-.50 (quite high) -> risk for multicollinearity?
cor(ema$stress,ema$stress.nd,use="complete.obs")
cor(ema$worry,ema$worry.nd,use="complete.obs")
cor(ema$mood,ema$mood.nd,use="complete.obs")
cor(ema$PsyDist,ema$PsyDist.nd,use="complete.obs")
cor(ema$fs.w,ema$fs.w.nd,use="complete.obs")

# printing info
cat(nrow(ema),"total cases\n",nrow(ema[!is.na(ema$TIB),]),"with sleep.timing\n",
    nrow(ema[!is.na(ema$TIB) & !is.na(ema$PsyDist),]),"with both sleep.timing and PsyDist\n",
    nrow(ema[!is.na(ema$TIB) & !is.na(ema$PsyDist) & !is.na(ema$PsyDist.nd),]),"with sleep.timing, PsyDist, and PsyDist.nd")

# changing variable name for better compatibility with the function below
colnames(ema)[which(colnames(ema)%in%c("stress.nd","worry.nd","mood.nd","PsyDist.nd","fs.w.nd"))] <- 
  c("s.nd","w.nd","m.nd","P.nd","f.nd")
```

<br>

## 1.1. Sleep architecture {.tabset .tabset-fade .tabset-pills}

`s.archit` variables are modeled by considering the subset of complete `s.archit` and `dailyDiary` data, whereas `dailyAct` **data are ignored** since none of the `s.archit` variables was substantially predicted by `TotalSteps1000`. `Sex` is excluded as well, since it only predicted small differences in some `s.archit`, but not in diary ratings.
```{r fig.width=12,fig.height=8}
s.archit <- c("TIB","TST","WASO","SE","light.p","deep.p","rem.p")
```

### TIB

In section 5.1, `TIB` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (shorter `TIB` for later than usual `SO`) and ***`weekday.sleep`*** (longer `TIB` during weekend). Note that the **random slope for** `stress` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
# selecting core predictors
res <- res.nd <- res.int <- list() # empty list of key results
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TIB by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" # removing random slopes due to convergence problems
     } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") } # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) } 
  
  # saving key results (considering M3 which showed higher Aw than M2 for all predictors)
  res[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff, # day i (M3)
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[2],messages=FALSE))
  res.nd[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff, # day i+1 (M3)
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE))
  res.int[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff, # interaction (M4)
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- ***`SO.num`***, ***`weekday.sleep`***, **all raw and aggregate diary ratings**, and **next day** ***`stress`*** are associated with a **significant LRT**, whereas **stronger evidence** in terms of Aw is also shown by **next day** ***`PsyDist`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** (with the weakest effect estimated for `mood`), and **next day** ***`stress`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

### TST

In section 5.1, `TST` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (shorter `TST` for later than usual `SO`) and ***`weekday.sleep`*** (longer `TST` during weekend). Note that the **random slope for** `mood` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TST by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  if(diaryVars[i]=="mood"){ ran.eff <- "(1|ID)" # removing random slopes due to convergence problems
     } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") } # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  # saving key results (considering M3 which showed higher Aw than M2 for all predictors)
  res[[i]] <- rbind(res[[i]],cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,ran.eff=ran.eff, #day i
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[2],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,ran.eff=ran.eff, #i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="TST",glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TST",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- ***`SO.num`***, ***`weekday.sleep`***, **all raw and aggregate diary ratings**, and **next day** ***`stress`*** are associated with a **significant LRT**, whereas **stronger evidence** in terms of Aw is also shown by **next day** ***`PsyDist`*** and ***`fs`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** (with the weakest effect estimated for `mood`), and **next day** ***`stress`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

- overall, the results are **highly consistent** with those reported for `TIB`

<br>

### WASO

In section 5.1, `WASO` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (shorter `WASO` for later than usual `SO`) and ***`weekday.sleep`*** (longer `WASO` during weekend). Note that the **random slope for** `mood` is not included due to **convergence problems** (singular fit).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WASO by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="mood"){ ran.eff <- "(1|ID)" } # removing random slope for mood to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  
  # saving key results (considering M3 for stress and PsyDist which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]%in%c("stress","PsyDist","fs.w"),2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,ran.eff=ran.eff, # day i
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WASO",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`SO.num`***, ***`weekday.sleep`***, ***`stress`***, ***`worry`*** (but not `mood`), ***`PsyDist`***, ***`fs`***, and **next day** ***`stress`*** are associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** with the only exception of `mood` and `stress` (only substantial in model M2 but not in the selected model M3), and for **next day** `stress`; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

### SE

In section 5.1, `SE` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`SO.num`*** (higher `SE` for later than usual `SO`). Note that the **random slope for** `worry` and `mood` are not included due to convergence problems (singular fit).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing SE by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood")){ ran.eff <- "(1|ID)" } # removing random slope for stress and mood to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }

  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,ran.eff=ran.eff, # day i
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="SE",glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))

  # showing analysis
  glmerAn(long=ema,wide=demos,resp="SE",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors, 
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite normally distributed, although a **marked deviation from normality** can be seen in the **lower tail** of the residuals distribution (i.e., SE is bounded at 100), with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- only ***`SO.num`*** is associated with a significant LRT, and showed **stronger evidence** in terms of Aw

- coherently, ***`SO.num`*** is the only predictor showing a substantial relationship with `SE`

<br>

### light.p

In section 5.1, `light.p` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`BMI`*** (lower `light.p` for participants with higher `BMI`). Note that the **random slope for** `worry` is not included due to **convergence problems** (singular fit).
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing light.p by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  if(diaryVars[i]=="worry"){ ran.eff <- "(1|ID)" # removing random slopes due to convergence problems
     } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") } # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",
                                                                   fix.eff=predictors,ran.eff=ran.eff, # day i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="light.p",glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
                                           ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="light.p",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          outputs=outputs,ran.eff=ran.eff, # including random slope 
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of both distributions) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`BMI`*** is the only predictor associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- coherently, ***`BMI`*** is the only predictor showing a substantial relationship with `light.p`

<br>

### deep.p

In section 5.1, `deep.p` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`SOL.num`*** (higher `deep.p` for later `SO` than usual). Note that **no random slopes are included** due to **convergence problems**
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing deep.p by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- "(1|ID)" # no random slopes due to convergence problems
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) } 
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",
                                                                  fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="deep.p",glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,
                                           ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,
                                           outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="deep.p",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- ***`SO.num`*** is the only predictor associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- coherently, ***`SO.num`*** is the only predictor showing a substantial relationship with `deep.p`

<br>

### rem.p

In section 5.1, `rem.p` was modeled by assuming a **normal distribution** for residuals, and it was only substantially predicted by ***`SOL.num`*** (lower `rem.p` for later than usual `SO`). Note that the **random slope for** ***`stress`*** and ***`PsyDist`*** is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing rem.p by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("stress","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slope for stress to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) } 
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="rem.p",glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="rem.p",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the residuals distribution) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`SO.num`*** is the only predictor associated with a **significant LRT**, and with **stronger evidence** in terms of Aw

- coherently, ***`SO.num`*** is the only predictor showing a substantial relationship with `rem.p`

<br>

## 1.2. Sleep timing {.tabset .tabset-fade .tabset-pills}

`s.timing` variables are modeled by considering the subset of complete `s.timing` and `dailyDiary` data, whereas `dailyAct` data are ignored since none of the `s.archit` variables was substantially predicted by `TotalSteps1000` (i.e., it negatively predicted `SO.num` but the relationship was small and not supported by the Aw and the LRT). `sex` is excluded as well, for parsimony, and since it only predicted small differences in `SO.num`, but not in diary ratings.
```{r fig.width=12,fig.height=8}
s.timing <- c("SO.num","WakeUp.num")
```

### SO.num

In section 5.1, `SO.num` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (later `SO.num` during weekend), ***`TotalSteps`*** (earlier `SO.num` in days with more steps than usual), ***`BMI`*** (earlier `SO.num` for participants with higher `BMI`), and ***`sex`*** (later `SO.num` for boys compared to girls). Here, we do not include `sex` and `TotalSteps1000` for parsimony, and because the latter was not selected based on the LRT or the Aw, and showed the less substantial effect in section 5.1.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing SO.num by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",
                                                                  fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="SO.num",glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="SO.num",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite some **marked deviations in the tails** of the residuals distribution, with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`weekday.sleep`***, ***`BMI`***, and **all raw and aggregate diary ratings** (but not next day ratings) are associated with a **significant LRT**, whereas **stronger evidence** in terms of Aw is also shown by **next day** ***`stress`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings with the only exception of** ***`stress`***; whereas neither next day ratings nor `insomnia`, or its interaction with diary ratings showed a substantial effect

<br>

### WakeUp.num

In section 5.1, `WakeUp.num` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (later `WakeUp.num` for later than usual `SO`), ***`weekday.sleep`*** (later `WakeUp.num` during weekend), and ***`BMI`*** (earlier `WakeUp.num` for participants with higher BMI). Note that the **random slope for** `stress` and `mood` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WakeUp.num by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" } # removing random slope for PsyDist to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  # saving key results (considering M3 for stress, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]=="stress",2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",
                                                                fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",
                                                                      fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WakeUp.num",glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WakeUp.num",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the tails** of the both distributions) with (3) **homogeneity** between the variances across sex and insomnia levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term

- ***`SO.num`***, ***`weekday.sleep`***, ***`BMI`***, **all raw and aggregate diary ratings**, and **next day** ***`stress`*** are associated with a **significant LRT**, and **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all raw and aggregate diary ratings** (with the weakest effect estimated for `mood`), and **next day** ***`stress`*** and ***`PsyDist`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

## 1.3. Daily variability {.tabset .tabset-fade .tabset-pills}

`s.variab` variables are modeled by considering the subset of complete `s.variab` and `dailyDiary` data, whereas `dailyAct` data are ignored since none of the `s.variab` variables was substantially predicted by `TotalSteps1000`. Note that all models are specified with `nAGQ = 0` due to **convergence problems**, implying quite conservative estimates with large standard errors.
```{r fig.width=12,fig.height=8}
s.variab <- paste(c(s.archit[1:3],s.timing),"SSD",sep=".")
```

### TIB.SSD

In section 5.1, `TIB.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `TIB.SSD` during weekend), ***`BMI`*** (higher `TIB.SSD` for participants with higher `BMI`), and ***`insomnia`*** (lower `TIB.SSD` for insomnia than controls, even when controlling for `sex`). Here, insomnia is added after diary ratings for better consistency with the other models.
```{r fig.width=12,fig.height=8}
# adding constant to each value to avoid zeros
ema$TIB.SSDc <- ema$TIB.SSD + 0.001 

for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TIB.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results (considering M3 for stress and PsyDist, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]%in%c("stress","PsyDist","fs.w"),2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",
                                             fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="TIB.SSDc",glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TIB.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          family="gamma",link="log",transform="exp",nAGQ=0,outputs=outputs,ran.eff=ran.eff, # nAGQ = 0 to reach convergence
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress*

- ***`weekday.sleep`***, ***`BMI`***, ***`insomnia`***, ***`stress`***, and **next day** ***`PsyDist`*** are associated with a **significant LRT**, whereas ***`weekday.sleep`***, ***`BMI`***, ***`insomnia`***, ***`stress`***, ***`PsyDist`***, and **next day** ***`stress`***,  ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- however, only the effects reported in section 5.1 are substantial, and ***`insomnia`*** **is no longer substantially associated** with `TIB` after the inclusion of any diary rating in the model (possibly due to `nAGQ=0`)

<br>

### TST.SSD

In section 5.1, `TST.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `TST.SSD` during weekend), ***`BMI`*** (higher `TST.SSD` for participants with higher `BMI`), and ***`insomnia`*** (lower `TST.SSD` for insomnia than controls, even when controlling for `sex`). Here, insomnia is added after diary ratings for better consistency with the other models.
```{r fig.width=12,fig.height=8}
# adding constant to each value to avoid zeros
ema$TST.SSDc <- ema$TST.SSD + 0.001

for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing TST.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep","BMI",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) } 
  
  # saving key results (considering M3 for mood and PsyDist, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]%in%c("mood","PsyDist","fs.w"),2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",
                                             fix.eff=predictors,ran.eff=ran.eff, # day i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                             family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="TST.SSDc",glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="TST.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI", # GLMER with mean-centered pred.
          family="gamma",link="log",transform="exp",nAGQ=0,outputs=outputs,ran.eff=ran.eff, # nAGQ = 0 to reach convergence
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- ***`weekday.sleep`***, ***`BMI`***, ***`stress`***, and **next day** ***`PsyDist`***, and ***`fs`*** are associated with a **significant LRT**, and showed **stronger evidence** in terms of Aw; significant LRT is also shown by **next day** ***`mood`***

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **next day** ***`Mood`***, ***`PsyDist`***, and ***`fs`***; whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect; in particular, ***`insomnia`*** **is no longer substantially associated** with *TST* after the inclusion of any diary rating in the model (possibly due to `nAGQ=0`)

<br>

### WASO.SSD

In section 5.1, `WASO.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`SO.num`*** (lower `WASO.SSD` for later than usual SO) and ***`weekday.sleep`*** (higher `WASO.SSD` during weekend).
```{r fig.width=12,fig.height=8}
# adding constant to each value to avoid zeros
ema$WASO.SSDc <- ema$WASO.SSD + 0.001

for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WASO.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",
                                             fix.eff=predictors,ran.eff=ran.eff, # day i+1
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WASO.SSDc",glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
                                          ran.eff=ran.eff,modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
                                          outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WASO.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors, # GLMER with mean-centered pred.
          family="gamma",link="log",transform="exp",nAGQ=0,outputs=outputs,ran.eff=ran.eff, # nAGQ = 0 to reach covergence
          coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- only ***`SO.num`*** and ***`weekday.sleep`*** are associated with a **significant LRT**, and showed **stronger evidence** in terms of Aw

- coherently, only the effects reported in section 5.1 are substantial

<br>

### SO.num.SSD

In section 5.1, `SO.num.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `SO.num.SSD` during weekend), and ***`insomnia`*** (lower `SO.num.SSD` for insomnia than controls, even when controlling for `sex`). Here, insomnia is added after diary ratings for better consistency with the other models.
```{r fig.width=12,fig.height=8}
# adding constant to each value to avoid zeros
ema$SO.num.SSDc <- ema$SO.num.SSD + 0.001

for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing SO.num.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results
  res[[i]] <- rbind(res[[i]],cbind(measure="SO.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,ran.eff=ran.eff, # nAGQ = 0 to reach convergence
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[1],key.model=keys[1],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="SO.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,ran.eff=ran.eff, # day i+1
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="SO.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0 to reach convergence
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **marked deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- only ***`weekday.sleep`*** and ***`insomnia`*** are associated with a **significant LRT**, whereas only ***`weekday.sleep`*** showed **stronger evidence** in terms of Aw

- coherently, only ***`weekday.sleep`*** shows a substantial effect; in particular,***`insomnia`*** **is no longer substantially associated** with `SO.num.SSD` after the inclusion of any diary rating in the model (possibly due to `nAGQ=0`)

<br>

### WakeUp.num.SSD

In section 5.1, `WakeUp.num.SSD` was modeled by assuming a **gamma distribution** with a **log link function** for residuals, and it was substantially predicted by ***`weekday.sleep`*** (higher `WakeUp.num.SSD` during weekend).
```{r fig.width=12,fig.height=8}
# adding constant to each value to avoid zeros
ema$WakeUp.num.SSDc <- ema$WakeUp.num.SSD + 0.001

for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing WakeUp.num.SSD by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c(diaryVars[i],nd) }
  
  # saving key results (considering M3, which showed sig. LRT and/or higher AW compared to M2)
  res[[i]] <- rbind(res[[i]],cbind(measure="WakeUp.num.SSDc",
       glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,nAGQ=0, # nAGQ = 0 to reach convergence
               modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",
               outputs="key.results",key.predictor=keys[1],key.model=keys[2],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="WakeUp.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,
               modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
               outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="WakeUp.num.SSDc",
      glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,ran.eff=ran.eff,
              modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0,
              outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="WakeUp.num.SSDc",fix.eff=predictors,
          modelType=c("GLMER"),mc.predictors=mc.predictors,family="gamma",link="log",transform="exp",nAGQ=0, # nAGQ = 0
          outputs=outputs,ran.eff=ran.eff, coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **deviance residuals** and (2) **random effects** are quite **normally distributed** (despite some **deviations in the lower tails** of both distributions) with (3) **no substantial linear relationship** between residuals and fitted values; although categorical factors do not show substantially different dispersion, (4) the **SD is slightly proportional to the mean** (as assumed by the gamma distribution); there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less, with the only exception of the interactive term and *stress.mc*

- ***`weekday.sleep`*** and **all next day raw and aggregate diary ratings** are associated with a **significant LRT**, whereas ***weekday.sleep***, ***`stress`***, ***`PsyDist`***, and **next day** ***`stress`***, ***`mood`***, ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, **substantial negative effects** are estimated for **all next day raw and aggregate diary ratings** (with the weakest effect estimated for `stress`), whereas neither `insomnia` nor its interaction with diary ratings showed a substantial effect

<br>

## 1.4. Sleep autonomic func. {.tabset .tabset-fade .tabset-pills}

`s.auton` variables are modeled by considering the subset of complete `s.auton`, `dailyDiary`, and `dailyAct` data.
```{r fig.width=12,fig.height=8}
s.auton <- c("HR_NREM","HR_REM")
```

### HR_NREM

In section 5.1, `HR_NREM` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`TotalSleep1000`*** (higher `HR_NREM` for higher than usual `TotalSleep1000`), ***`weekday.sleep`*** (higher `HR_NREM` during weekends), ***`BMI`*** (higher `stageHR_TST` for participants with higher `BMI`), ***`sex`*** (higher `stageHR_TST` in girls compared to boys), and the **interaction** between `insomnia` and `sex` (lower `stageHR_TST` in female insomnia compared to control insomnia). Contrarily to the other analyses, here `sex` is included (since it is an important predictor), while `insomnia` is added after diary ratings for better consistency. Note that the **random slope for** `worry` and `fs` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing HR_NREM by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("TotalSteps1000","weekday.sleep","BMI","sex",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","fs.w")){ ran.eff <- "(1|ID)" } # removing random slope for fs to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "TotalSteps1000" # selecting mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("TotalSteps1000",diaryVars[i],nd) }
  
  # saving key results (considering M3 for mood, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]=="mood",2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",
                                             fix.eff=predictors,ran.eff=ran.eff,gmc.predictors="BMI",
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",
                                             fix.eff=predictors,ran.eff=ran.eff,gmc.predictors="BMI",
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite a **marked deviation in the upper tail** of the residuals distribution, with (3) **homogeneity** between the variances across *sex* and *insomnia* levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`TotalSteps1000`***, ***`weekday.sleep`***, ***`BMI`***, ***`sex`***, ***`insomnia`***, ***`stress`***, **next day** ***`mood`***, and **the interactive terms** (but not with `mood`) are associated with a **significant LRT**, whereas ***`TotalSteps1000`***, ***`weekday.sleep`***, ***`BMI`***, ***`sex`***, ***`insomnia`***, ***`stress`***, and **the interactive term with** ***`stress`***, ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, a **substantial positive effect** is only estimated for **next day** ***`mood`***, and by the **interaction between** ***`insomnia`*** **and** ***`stress`***, ***`worry`***, **and** ***`fs`***

<br>

### HR_REM

In section 5.1, `HR_REM` was modeled by assuming a **normal distribution** for residuals, and it was substantially predicted by ***`SO.num`*** (higher `HR_REM` for later than usual `SO`), ***`TotalSleep1000`*** (higher `HR_NREM` for higher than usual `TotalSleep1000`), ***`sex`*** (higher `stageHR_TST` in girls compared to boys), and the **interaction** between `insomnia` and `sex` (lower `stageHR_TST` in female insomnia compared to control insomnia). Contrarily to the other analyses, here `sex` is included (since it is an important predictor), while `insomnia` is added after diary ratings for better consistency. Note that the **random slope for** `worry` and `mood` is not included due to **convergence problems**.
```{r fig.width=12,fig.height=8}
for(i in 1:length(diaryVars)){ cat("\n\n\n###########################################\nAnalyzing HR_REM by",diaryVars[i],
                                   "\n###########################################\n\n")
  # selecting predictors
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary rating
  predictors <- c("SO.num","TotalSteps1000","sex",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood")){ ran.eff <- "(1|ID)" } # removing random slope for mood to reach convergence
  keys <- c(paste(diaryVars[i],".mc",sep=""),paste(nd,".mc",sep=""),  # key predictors (M2, M3, and M4)
            paste(diaryVars[i],".mc:insomnia",sep="")) # fit diagnostics only for the first predictor
  if(i==1){ outputs <- c("fit","mComp","coeff","plotEff") } else { outputs <- c("mComp","coeff","plotEff") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # selecting mean-centered pred. (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    keys <- gsub(".mc","",keys) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  
  # saving key results (considering M3 for mood, which showed higher Aw than M2 for all predictors)
  key.model <- ifelse(diaryVars[i]=="mood",2,1)
  res[[i]] <- rbind(res[[i]],cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,ran.eff=ran.eff,
                                          modelType=c("GLMER"),mc.predictors=mc.predictors,
                                          outputs="key.results",key.predictor=keys[1],key.model=keys[key.model],messages=FALSE)))
  res.nd[[i]] <- rbind(res.nd[[i]],cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,ran.eff=ran.eff,
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[2],key.model=keys[2],messages=FALSE)))
  res.int[[i]] <- rbind(res.int[[i]],cbind(measure="HR_REM",glmerAn(long=ema,wide=demos,resp="HR_REM",
                                             fix.eff=predictors,ran.eff=ran.eff,gmc.predictors="BMI",
                                             modelType=c("GLMER"),mc.predictors=mc.predictors,
                                             outputs="key.results",key.predictor=keys[3],key.model=keys[3],messages=FALSE)))
  
  # showing analysis
  glmerAn(long=ema,wide=demos,resp="HR_REM",fix.eff=predictors,modelType=c("GLMER"),mc.predictors=mc.predictors,
          outputs=outputs,ran.eff=ran.eff,coeff.models=c(keys[1],keys[2],keys[3]),plot.model=keys[3],show.data=TRUE) }
```

<br>

*Comments:*

- both (1) **residuals** and (2) **random effects** are quite **normally distributed**, despite a **marked deviation in the upper tail** of the residuals distribution, with (3) **homogeneity** between the variances across *sex* and *insomnia* levels, and (4) **no substantial linear relationship** between residuals and fitted values; there is (5) **not strong evidence of multicollinearity** as all VIFs are 2 or less

- ***`SO.num`***, ***`TotalSteps1000`***, ***`sex`***, ***`insomnia`***, ***`stress`***, ***`PsyDist`***, ***`fs`***, and **next day** ***`mood`*** are associated with a **significant LRT**, whereas ***`SO.num`***, ***`TotalSteps1000`***, ***`sex`***, ***`insomnia`***, ***`stress`***, ***`PsyDist`***, ***`fs`***, and **next day** ***`stress`***, ***`PsyDist`***, and ***`fs`*** showed **stronger evidence** in terms of Aw

- in addition to the effects reported in section 5.1, a **substantial positive effect** is only estimated for ***`stress`*** and **next day** ***`mood`***

<br>

## 1.5. Summary of results {.tabset .tabset-fade .tabset-pills}

Here, we use the `key.resPlot` function to graphically summarize the results obtained from the models above. The figure below shows the t-values associated with the `*diary ratings preceding** the sleep periods by considering either model M2 (main effect of **previous day diary ratings**) or model M3 (main effect of the **next day diary ratings**). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, and |t| > 1.96 ) are shown in **green**

- those relationships showing a **|t| > 1.96** but either a nonsignificant LRT **or** a lower Aw than the previous model are shown in **light green** (or lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT **and** lower Aw than the previous models are shown in **yellow**

- those showing a **|t| < 1.96** and either a nonsignificant LRT **or** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT **and** lower Aw than the previous models are shown in **red**

### PREVIOUS DAY
```{r,fig.width=12,fig.height=4}
# all results in one data.frame
RES <- rbind(cbind(res[[1]],pred=rep("stress",16)),cbind(res[[2]],pred=rep("worry",16)),
             cbind(res[[3]],pred=rep("mood",16)),cbind(res[[4]],pred=rep("PsyDist",16)),
             cbind(res[[5]],pred=rep("fs.w",16)))
RES$pred <- factor(RES$pred,levels=c("fs.w","PsyDist","mood","worry","stress"))

# stress
key.resPlot(RES,robCheck="pred")
```

<br>

*Comments:*

- the analysis of the relationships between sleep outcomes and diary ratings highlighted **substantial negative relationships** between previous day diary ratings and `TIB` (negatively related to all ratings), `TST` and `WakeUp.num` (related to all ratings but `mood`), `WASO` (only substantially related with `worry` and `PsyDist`), and `SO.num` (only insubstantially related to `stress`)

- a substantial positive relationship is also observed between `stress` and `HR_REM`

<br>

### NEXT DAY
```{r,fig.width=12,fig.height=4}
# all results in one data.frame
RES.nd <- rbind(cbind(res.nd[[1]],pred=rep("stress",16)),cbind(res.nd[[2]],pred=rep("worry",16)),
                cbind(res.nd[[3]],pred=rep("mood",16)),cbind(res.nd[[4]],pred=rep("PsyDist",16)),
                cbind(res.nd[[5]],pred=rep("fs.w",16)))
RES.nd$pred <- factor(RES.nd$pred,levels=c("fs.w","PsyDist","mood","worry","stress"))

# stress
key.resPlot(RES.nd,robCheck="pred")
```

<br>

*Comments:*

- the analysis of the relationships between sleep outcomes and next day diary ratings highlighted **substantial negative relationships** between the **next day** `stress` ratings and `TIB`, `TST`, `WASO`, and `WakeUp.num`

- `WakeUp.num.SSD` is negatively associated with **all next day ratings** (although the relationship with `worry` is not supported by the Aw)

- `TIB.SSD` and `TST.SSD` only show some substantial negative relationships with **next day** `PsyDist`

- **next day** `mood` ratings show a negative relationship with `TST.SSD`, and a positive relationship with both `HR_NREM`, and `HR_REM`, although some of them was not supported by higher Aw than the previous model

<br>

### INTERACTION
```{r,fig.width=12,fig.height=4}
# all results in one data.frame
RES.int <- rbind(cbind(res.int[[1]],pred=rep("stress",16)),cbind(res.int[[2]],pred=rep("worry",16)),
                cbind(res.int[[3]],pred=rep("mood",16)),cbind(res.int[[4]],pred=rep("PsyDist",16)),
                cbind(res.int[[5]],pred=rep("fs.w",16)))
RES.int$pred <- factor(RES.int$pred,levels=c("fs.w","PsyDist","mood","worry","stress"))

# stress
key.resPlot(RES.int,robCheck="pred")
```

<br>

*Comments:*

- the analysis of the interactive model highlighted **substantial interactions** between `insomnia` and `stress`, `worry`, and `fs` only in predicting `HR_NREM` (i.e., stronger positive relationship between diary ratings and `HR_NREM` in `insomnia` compared to controls)

- none of the other sleep outcomes are substantially predicted by the interactive terms

<br>

## 1.6. Robustness checks {#robcheck}

Here, we conduct several **robustness checks** to account for the arbitrariness of our data processing and analytical choices, including (1) the consideration of `insomnia.group` instead of the insomnia variable, (2) the inclusion of the `covid19` variable as a further covariate, (3) the exclusion of participants with **extreme missing data**, (4) the **exclusion of** `TotalSteps1000`, (5) the use of **alternative family distributions** for the analyses.

In addition to the `glmerAn` and the `keyResPlot` functions reported in section 5.1.6, we also use the `predSelect` function to **select the covariates** of each sleep outcome, based on the results in section 5.1.

<details><summary>**show** ***predSelect***</summary>
<p>
```{r }
predSelect <- function(sleepVar){ 
  
  # SE, deep.p, and rem.p were only predicted by SO.num
  if(sleepVar%in%c("SE","deep.p","rem.p")){ 
    predictors <- c("SO.num") 
    
    # SO.num.SSDc and WakeUp.num.SSDc were only predicted by weekday.sleep
    } else if(sleepVar%in%c("SO.num.SSDc","WakeUp.num.SSDc")){
      predictors <- "weekday.sleep"
      
      # light.p was only predicted by BMI
      } else if(sleepVar=="light.p"){ 
        predictors <- "BMI"
    
        # SO.num, TIB.SSDc, and TST.SSDc were predicted by weekday.sleep and BMI
        } else if(sleepVar%in%c("SO.num","TIB.SSDc","TST.SSDc")){
          predictors <- c("weekday.sleep","BMI")
          
          # WakeUp.num was predicted by SO.num, weekday.sleep, and BMI
          } else if(sleepVar=="WakeUp.num"){ 
            predictors <- c("SO.num","weekday.sleep","BMI")
            
            # HR_NREM was predicted by TotalSteps1000, weekday.sleep, BMI, and sex
            } else if(sleepVar=="HR_NREM"){
              predictors <- c("TotalSteps1000","weekday.sleep","BMI","sex")
              
              # HR_NREM was predicted by SO.num, TotalSteps1000, and sex
              } else if(sleepVar=="HR_REM"){ 
                predictors <- c("SO.num","TotalSteps1000","sex")
                
                # all remaining sleep outcomes were predicted by SO.num and weekday.sleep
                } else { predictors <- c("SO.num","weekday.sleep") }
  
  return(predictors)}
```
</p></details>

<br>

<br>

### 1.6.1. insomnia.group

Here, we inspect the results on the ***interactive term*** obtained by considering the ***insomnia.group*** (i.e., 46 controls, 26 DSM.ins and 21 sub.ins) rather than the `insomnia` variable (i.e., 46 controls vs. 47 insomnia). 

The figure below shows the t-values associated with the interactive term for each sleep outcome and diary predictor, by considering model M4 (interactive model). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**

- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Note that the **random slope for** `stress` on `SO.num`, that for `worry` on `WASO`, and that for `fs` on `WakeUp.num`, `WASO.SSD`, and `HR_NREM` were not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia.group",paste(diaryVars[i],"insomnia.group",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(diaryVars[i],".mc:insomnia.group",sep="") 
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
sleepVars <- c(s.archit[2:length(s.archit)],s.timing,paste(s.variab,"c",sep=""),s.auton)
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    key <- paste(diaryVars[i],":insomnia.group",sep="")
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia.group",key)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" |
       (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","SO.num")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) | 
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WakeUp.num","WASO.SSDc","HR_NREM"))){ ran.eff <- "(1|ID)"
    } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    key <- paste(diaryVars[i],".mc:insomnia.group",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}

# plotting robustness check
RES.int <- list()
for(i in 1:length(res.int)){
  res.int[[i]]$robCheck <- "Original"
  res2[[i]]$robCheck <- "insomnia.group"
  RES.int[[i]] <- rbind(res.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]],robCheck = "robCheck") + ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses for most sleep outcomes

- the only difference is that even the **interactions on** `HR_NREM` **are not substantial**, and that `worry` is now **substantially associated** with both `TIB.SSD` and `TST.SSD`

<br>

### 1.6.2. COVID-19 emergency {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by including the `covid19` variable **as a further covariate**. As shown in section 1.2.8, the `covid19` factor discriminates the data collected `pre-COVID19` (63%) and the data collected `post-COVID19` (37%). The covariate is included **at the first step** (model M1, before the first predictor). 

The figures below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

#### PREVIOUS DAY

Note that the **random slope for** `stress` on `HR_NREM`, that of `worry` on `rem.p`, and that of `fs.w` on `rem.p` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  key.pred <- paste(diaryVars[i],".mc",sep="") # selecting target predictor (previous day ratings) and target model (M2 or M3)
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  key.model <- paste(nd,".mc",sep="") # selecting model including next day day rating 
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c("covid19",predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    key.pred <- paste(diaryVars[i],".mc",sep="") # M2 (previous day rating)
    if(sleepVar=="WakeUp.num.SSDc" | (diaryVars[i]=="stress"  & sleepVar%in%c("TST","WASO","WakeUp.num")) | # M3 (next day ratings)
       (diaryVars[i]=="mood"  & sleepVar%in%c("TST.SSDc","HR_NREM","HR_REM")) |
       (diaryVars[i]=="PsyDist"  & sleepVar%in%c("WakeUp.num","TIB.SSDc","TST.SSDc","WakeUp.SSDc")) |
       (diaryVars[i]=="fs.w"  & sleepVar=="TST.SSDc")){ key.model <- paste(nd,"mc",sep=".") 
       } else { key.model <- paste(diaryVars[i],"mc",sep=".") } 
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","HR_NREM")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("rem.p"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",
                               key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}

# plotting robustness check
RES.pd <- list()
for(i in 1:length(res)){
  res[[i]]$robCheck <- "Original"
  res2[[i]]$robCheck <- "covid19"
  RES.pd[[i]] <- rbind(res[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]],robCheck = "robCheck") + ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

- the only difference is highlighted for `SO.num` (showing no longer substantial relationship with `worry`)

<br>

#### NEXT DAY

Note that the **random slope for** `stress` on `HR_NREM`, that of `worry` on `rem.p`, and that of `fs.w` on `rem.p` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(nd,".mc",sep="") # selecting model including next day day rating
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c("covid19",predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key <- paste(nd,".mc",sep="") # selecting target predictor (next day rating) and target model (M3)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","rem.p","HR_NREM")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("rem.p"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}

# plotting robustness check
RES.nd <- list()
for(i in 1:length(res)){
  res.nd[[i]]$robCheck <- "Original"
  res2[[i]]$robCheck <- "covid19"
  RES.nd[[i]] <- rbind(res.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","covid19"),],
                    robCheck = "robCheck") + ggtitle(paste("Next day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

In conclusion, the results of this robustness check were **highly consistent** with those obtained with the main analyses, although **questioning the generalizability of the relationships observed between next day** `PsyDist` **and** `WakeUp.num`.

<br>

#### INTERACTION

Note that the **random slope for** `stress` on `TST`, `HR_NREM`, that of `Worry` on `rem.p`, and that of `fs` on `rem.p`, and `HR_NREM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],":insomnia",sep="")
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",key)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID) "}
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=ema,wide=demos,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M4)
    key <- paste(diaryVars[i],":insomnia",sep="")
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c("covid19",predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia",key)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","rem.p","HR_NREM","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("SE","rem.p")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("rem.p","HR_NREM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "covid19"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","covid19"),],robCheck = "robCheck") + 
          ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses for most sleep outcomes

- the main difference is that the **interactive term** for `PsyDist` is substantial on `HR_NREM` with the inclusion of *covid19* as a further covariate

<br>

### 1.6.3. Low compliance {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by **excluding seven participants** (7.5%) with **less than two weeks of valid observations in any data type**. In section 3.2, these participants were marked with `majMiss` = 1. 

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

#### PREVIOUS DAY

Note that the **random slope for** `stress` on `TST`, that for `worry` on `WASO`, that for `PsyDist` on `SE` and `light.p`, and that of `fs` on `light.p` and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# excluding participants with extreme missing data
EMA <- ema[ema$majMiss!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days, ",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    key.pred <- paste(diaryVars[i],".mc",sep="") # M2 (previous day rating)
    if(sleepVar=="WakeUp.num.SSDc" | (diaryVars[i]=="stress"  & sleepVar%in%c("TST","WASO","WakeUp.num")) | # M3 (next day ratings)
       (diaryVars[i]=="mood"  & sleepVar%in%c("TST.SSDc","HR_NREM","HR_REM")) |
       (diaryVars[i]=="PsyDist"  & sleepVar%in%c("WakeUp.num","TIB.SSDc","TST.SSDc","WakeUp.SSDc")) |
       (diaryVars[i]=="fs.w"  & sleepVar=="TST.SSDc")){ key.model <- paste(nd,"mc",sep=".") 
    } else { key.model <- paste(diaryVars[i],"mc",sep=".") }
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","SE","light.p"))|
       (diaryVars[i]=="fs.w" & sleepVar%in%c("light.p","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",
                               key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}

# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "majMiss"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `mood`, whose relationship with `TIB` is **no longer substantial** after the exclusion of participants with `majMiss`

- similarly, the relationship between `worry` and `SO.num` is **no longer substantial**

<br>

#### NEXT DAY

Note that the **random slope for** `stress` on `TST`, that for `worry` on `WASO`, that for `PsyDist` on `SE` and `light.p`, and that of `fs` on `light.p` and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(nd,".mc",sep="") # selecting model including next day day rating
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","SE","light.p"))|
       (diaryVars[i]=="fs.w" & sleepVar%in%c("light.p","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(nd,".mc",sep="") # selecting target predictor (next day rating) and target model (M3)
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # selecting family distribution
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "majMiss"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck") + 
           ggtitle(paste("Next day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the main differences are highlighted for `TST.SSD` (showing no longer substantial relationship with **next day** `mood`), `TIB.SSD` (showing no longer substantial relationship with **next day** `PsyDist`), and `WakeUp.num.SSDc` (showing no longer substantial relationship with **next day** `stress`)

<br>

#### INTERACTION

Note that the **random slope for** `stress` on `TST`, that for `worry` on `WASO` and `rem.p`, that for `mood` on `HR_NREM`, that for `PsyDist` on `SE` and `light.p`, and that of `fs` on `light.p` and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],":insomnia",sep="")
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",key)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M4)
    key <- paste(diaryVars[i],":insomnia",sep="")
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia",key)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","TST")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM","WASO","rem.p")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","SE","light.p"))|
       (diaryVars[i]=="fs.w" & sleepVar%in%c("light.p","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "majMiss"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","majMiss"),],robCheck = "robCheck") + 
          ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the only difference is that the interactions between `insomnia` and `worry` on both `rem.p` and `HR_REM` are no longer substantial (although nor really diminished) after the exclusion of `majMiss` participants

<br>

### 1.6.4. TotalStep1000 {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by **excluding** `TotalSteps1000` **from the models predictors**. This is done in order to replicate the analyses by including cases with invalid daily steps data (thus, with higher sample size). Note that for these analyses, `TotalSteps1000` was only included in `HR_NREM` models.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

#### PREVIOUS DAY

Note that the **random slope for** `mood` is not included due to **convergence problems**, in addition to the random slopes removed above.
```{r,fig.width=12,fig.height=3}
# computing key results for HR_NREM
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("weekday.sleep","BMI","sex",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="mood"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- key.pred } # model M3 only for mood
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c(diaryVars[i],nd) }
  
  # updating results
  res2[[i]] <- cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "no-TotalSteps"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the only difference is that `stress` now shows a **substantial positive relationship** with `HR_NREM`

<br>

#### NEXT DAY

Note that the **random slope for** `mood` is not included due to **convergence problems**.
```{r,fig.width=12,fig.height=3}
# computing key results for HR_NREM
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("weekday.sleep","BMI","sex",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(nd,".mc",sep="") # next day rating
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c(diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "no-TotalSteps"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck") + 
           ggtitle(paste("Next day day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **highly consistent** with the main analyses

<br>

#### INTERACTION

Note that the **random slope for** `mood` is not included due to **convergence problems**.
```{r,fig.width=12,fig.height=3}
# computing key results for HR_NREM
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],":insomnia",sep="")
  predictors <- c("weekday.sleep","BMI","sex",diaryVars[i],nd,"insomnia",key)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("worry","mood","PsyDist")){ ran.eff <- "(1|ID)" } # removing random slopes due to convergence problems
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- NA # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c(diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="HR_NREM",glmerAn(long=ema,wide=demos,resp="HR_NREM",fix.eff=predictors,ran.eff=ran.eff,
                                           modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "no-TotalSteps"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","no-TotalSteps"),],robCheck = "robCheck") + 
           ggtitle(paste("Next day day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses: the **interaction** between `insomnia` and both `worry` and `fs` are **no longer substantial**

- in contrast, the interaction between `insomnia` and `PsyDist` becomes substantial with the removal of `TotalSteps1000`

<br>

### 1.6.5. Family distribution {.tabset .tabset-fade .tabset-pills}

Here, we replicate the models predicting those variables that showed poor fit in the model diagnostics above by re-specifying the models with different distribution families and link functions. As done in section 5.1.6.6, we model:

- `WASO` and both `s.auton` outcomes by using the **gamma distribution**

- all `s.variab` outcomes by assuming a **normal distribution**

<br>

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

#### PREVIOUS DAY

Note that the **random slope for** `worry` on `SO.num.SSD`, that for `mood` and `PsyDist` on `TIB.SSD`, `TST.SSD`, and `SO.num.SSD`, that of `fs` on `TIB.SSD` and `SO.num.SSD`, and **all random slopes on** `WASO.SSD` and `WakeUp.num.SSD` are not included due to **convergence problems**. Moreover, the model predicting `TIB.SSD` by `fs` does not converge even when excluding its random slope.
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001 # adding little constant to have no zero values
res2 <- list()
for(i in 1:length(diaryVars)){
  # selecting predictors (up to model M3)
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" }
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                            family="gamma",link="log", # gamma with log link function
                                            mc.predictors=mc.predictors,
                                            outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE,
                                            nAGQ=0)) } # nAGQ = 0 to reach convergence
# computing key results for s.variab
for(sleepVar in paste(s.variab,"c",sep="")){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
    if(sleepVar=="WakeUp.num.SSDc" | (sleepVar=="TIB.SSDc" & diaryVars[i]=="PsyDist") |
       (sleepVar=="TST.SSDc" & diaryVars[i]%in%c("mood","PsyDist","fs.w"))){ key.model <- paste(nd,"mc",sep=".") 
       } else { key.model <- paste(diaryVars[i],"mc",sep=".") } 
    # removing random slopes for those models showing convergence problems
    if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc") |
       (diaryVars[i]=="worry" & sleepVar=="SO.num.SSDc") |
       (diaryVars[i]%in%c("mood","PsyDist") & sleepVar%in%c("TIB.SSDc","TST.SSDc","SO.num.SSDc")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("TIB.SSDc","SO.num.SSDc"))){ ran.eff <- "(1|ID)" 
    } else {  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")  }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
    
    # updating results
    if(!(sleepVar=="TIB.SSDc" & diaryVars[i]=="fs.w")){ # model that doesn't converge even without random slope
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="normal",link="identity", # normal with identity funct
                               outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}}

# computing key results for s.auton
for(sleepVar in s.auton){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
    if(diaryVars[i]=="mood"){ key.model <- paste(nd,"mc",sep=".") } else { key.model <- paste(diaryVars[i],"mc",sep=".") } 
    ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="gamma",link="log", # normal with identity funct
                               outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE,
                               nAGQ=0))) }} # nAGQ = 0 to reach convergence
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "familyDistr"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the main differences are highlighted for `stress`, whose relationship with `WASO` **becomes substantial** when modeled by assuming a **gamma distribution** for residuals, whereas its relationship with `HR_REM` **becomes not substantial** when modeled with the same assumption

<br>

#### NEXT DAY

Note that the **random slope for** `worry` on `SO.num.SSD`, that for `mood` and `PsyDist` on `TIB.SSD`, `TST.SSD`, and `SO.num.SSD`, that of `fs` on `TIB.SSD` and `SO.num.SSD`, and **all random slopes on** `WASO.SSD` and `WakeUp.num.SSD` are not included due to **convergence problems**. Moreover, the model predicting `TIB.SSD` by `fs` does not converge even when excluding its random slope.
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001 # adding little constant to have no zero values
res2 <- list()
for(i in 1:length(diaryVars)){
  # selecting predictors (model M3)
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="stress"){ ran.eff <- "(1|ID)" }
  key <- paste(nd,".mc",sep="")
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                            family="gamma",link="log",mc.predictors=mc.predictors,  # gamma with log link function
                                            outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                                            nAGQ=0)) } # nAGQ = 0 to reach convergence
# computing key results for s.variab
for(sleepVar in paste(s.variab,"c",sep="")){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M3)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key <- paste(nd,".mc",sep="")
    # removing random slopes for those models showing convergence problems
    if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc") |
       (diaryVars[i]=="worry" & sleepVar=="SO.num.SSDc") |
       (diaryVars[i]%in%c("mood","PsyDist") & sleepVar%in%c("TIB.SSDc","TST.SSDc","SO.num.SSDc")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("TIB.SSDc","SO.num.SSDc"))){ ran.eff <- "(1|ID)" 
    } else {  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")  }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
    
    # updating results
    if(!(sleepVar=="TIB.SSDc" & diaryVars[i]=="fs.w")){ # model that doesn't converge even without random slope
      res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="normal",link="identity", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}}

# computing key results for s.auton
for(sleepVar in s.auton){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M3)
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    key <- paste(nd,"mc",sep=".") 
    ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="gamma",link="log", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                               nAGQ=0))) }} # nAGQ = 0 to reach convergence

# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "familyDistr"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `s.variab` outcomes, with **no longer substantial relationships** between **next day** `worry` and `WakeUp.num.SSD`, between **next day** `PsyDist` and both `TIB.SSD` and `TST.SSD`, and between **next day** `fs` and `TST.SSD` when modeled by assuming a **normal** distribution for residuals

<br>

#### INTERACTION

Note that the **random slope for** `worry` on `SO.num.SSD`, that for `mood` and `PsyDist` on `TIB.SSD`, `TST.SSD`, and `SO.num.SSD`, that of `fs` on `TIB.SSD` and `SO.num.SSD`, and **all random slopes on** `WASO.SSD` and `WakeUp.num.SSD` are not included due to **convergence problems**. Moreover, the model predicting `TIB.SSD` by `fs` does not converge even when excluding its random slope.
```{r,fig.width=12,fig.height=3}
# computing key results for WASO
ema$WASOc <- ema$WASO + 0.001 # adding little constant to have no zero values
res2 <- list()
for(i in 1:length(diaryVars)){
  # selecting predictors (model M4)
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,gsub(".mc","",key))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
  # updating results
  res2[[i]] <- cbind(measure="WASO",glmerAn(long=ema,wide=demos,resp="WASOc",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                            family="gamma",link="log", # gamma with log link function
                                            mc.predictors=mc.predictors,
                                            outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                                            nAGQ=0)) } # nAGQ = 0 to reach convergence
# computing key results for s.variab
for(sleepVar in paste(s.variab,"c",sep="")){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M4)
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,gsub(".mc","",key))
    # removing random slopes for those models showing convergence problems
    if(sleepVar%in%c("WASO.SSDc","WakeUp.num.SSDc") |
       (diaryVars[i]=="worry" & sleepVar=="SO.num.SSDc") |
       (diaryVars[i]%in%c("mood","PsyDist") & sleepVar%in%c("TIB.SSDc","TST.SSDc","SO.num.SSDc")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("TIB.SSDc","SO.num.SSDc"))){ ran.eff <- "(1|ID)" 
    } else {  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")  }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- "SO.num" # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num",diaryVars[i],nd) }
    
    # updating results
    if(!(sleepVar=="TIB.SSDc" & diaryVars[i]=="fs.w")){ # model that doesn't converge even without random slope
      res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="normal",link="identity", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}}

# computing key results for s.auton
for(sleepVar in s.auton){
  for(i in 1:length(diaryVars)){
    # selecting predictors (model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    # selecting target predictor (next day rating) and target model (M4)
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,gsub(".mc","",key))
    ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=ema,wide=demos,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family="gamma",link="log", # normal with identity funct
                               outputs="key.results",key.predictor=key,key.model=key,messages=FALSE,
                               nAGQ=0))) }} # nAGQ = 0 to reach convergence
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "familyDistr"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","familyDistr"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main difference is is that the **interaction** between `insomnia` and both `worry` and `fs` are **no longer substantial** (similarly to what resulted in section 5.3.6.5), whereas the interaction with `stress` is still substantial although not supported by the Aw

<br>

### 1.6.6. Late responses {.tabset .tabset-fade .tabset-pills}

Here, we inspect the results obtained by **excluding 1,010 cases** (25.5%) in which participants **filled the diary on the following day**. In section 1.2.6, these cases were marked with `diary.nextDay` = 1.

The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of *insomnia*) or model M3 (main effect of *insomnia* and *sex*) when *sex* differences were substantial (i.e., *HR_NREM* and *HR_REM*. The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

Separate robustness checks are conducted for each effect of interest.

#### PREVIOUS DAY

Note that the **random slope for** `mood` on `TIB`, `rem.p`, and `HR_NREM`, and that of `fs` on `WASO.SSD`, `HR_NREM`, and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# excluding cases with diary responses in the next day
EMA <- ema[ema$diary.nextDay!=1,]
DEMOS <- demos[demos$ID%in%levels(as.factor(as.character(EMA$ID))),]
cat("Excluded",nrow(ema)-nrow(EMA),"days,",nrow(demos)-nrow(DEMOS),"participants")

# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") # random slope for diary rating at day i
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" } # removing random slope for mood to reach convergence
  key.pred <- paste(diaryVars[i],".mc",sep="") # previous day rating
  if(diaryVars[i]=="stress"){ key.model <- paste(nd,".mc",sep="") } else { key.model <- paste(diaryVars[i],".mc",sep="") }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key.pred <- gsub(".mc","",key.pred)
    key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key.pred,key.model=key.model,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # selecting target predictor (previous day rating) and target model (M2 or M3 based on above)
    key.pred <- paste(diaryVars[i],".mc",sep="") # M2 (previous day rating)
    if(sleepVar=="WakeUp.num.SSDc" | (diaryVars[i]=="stress"  & sleepVar%in%c("TST","WASO","WakeUp.num")) | # M3 (next day ratings)
       (diaryVars[i]=="mood"  & sleepVar%in%c("TST.SSDc","HR_NREM","HR_REM")) |
       (diaryVars[i]=="PsyDist"  & sleepVar%in%c("WakeUp.num","TIB.SSDc","TST.SSDc","WakeUp.SSDc")) |
       (diaryVars[i]=="fs.w"  & sleepVar=="TST.SSDc")){ key.model <- paste(nd,"mc",sep=".") 
       } else { key.model <- paste(diaryVars[i],"mc",sep=".") }
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","rem.p","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WASO.SSDc","HR_NREM","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key.pred <- gsub(".mc","",key.pred)
      key.model <- gsub(".mc","",key.model)} else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",
                               key.predictor=key.pred,key.model=key.model,messages=FALSE))) }}

# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "lateResp"
  RES.pd[[i]] <- rbind(RES.pd[[i]],res2[[i]])
  print(key.resPlot(RES.pd[[i]][RES.pd[[i]]$robCheck%in%c("Original","lateResp"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- the main differences are highlighted for `mood`, whose relationships with `TIB` is **no longer substantial** after the exclusion of participants with `majMiss`, similarly to the results in section 5.3.6.3.

<br>

#### NEXT DAY

Note that the **random slope for** `mood` on `TIB`, `rem.p`, and `HR_NREM`, and that of `fs` on `WASO.SSD`, `HR_NREM`, and `HR_REM` are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("SO.num","weekday.sleep",diaryVars[i],nd)
  key <- paste(nd,".mc",sep="") # selecting model including next day day rating
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M3)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd)
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","rem.p","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WASO.SSDc","HR_NREM","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(nd,".mc",sep="") # selecting target predictor (next day rating) and target model (M3)
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors (not fs)
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") } # selecting family distribution
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"),mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "lateResp"
  RES.nd[[i]] <- rbind(RES.nd[[i]],res2[[i]])
  print(key.resPlot(RES.nd[[i]][RES.nd[[i]]$robCheck%in%c("Original","lateResp"),],robCheck = "robCheck") + 
           ggtitle(paste("Previous day",diaryVars[i]))) }
```

<br>

*Comments:*

- results are **partially inconsistent** with the main analyses

- with the exclusion of **late responses`, **next day** `stress` is now negatively related with `SO.num`, `TIB.SSDc`, and `TST.SSD`

- in contrast, **next day** `mood` is no longer substantially associated with both `TST.SSD` and `HR_NREM`

- a few unsubstantial changes are observed also for the relationships between **next day** `fs` and both `TIB.SSD` and `TST.SSD`

<br>

#### INTERACTION

Note that the **random slope for** `stress` on `HR_NREM` and `HR_REM`, that of `mood` on `TIB`, `rem.p`, and `HR_NREM`, and that of `fs` on `WASO.SSD`, `HR_NREM`, and `HR_REM`, are not included due to **convergence problems**, in addition to the random slopes excluded above.
```{r,fig.width=12,fig.height=3}
# computing key results for TIB
res2 <- list()
for(i in 1:length(diaryVars)){
  nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
  predictors <- c("covid19","SO.num","weekday.sleep",diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
  key <- paste(diaryVars[i],".mc:insomnia",sep="")
  ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="")
  if(diaryVars[i]%in%c("stress","mood")){ ran.eff <- "(1|ID)" }
  if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
    ran.eff <- gsub(".mc","",ran.eff)
    key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
  res2[[i]] <- cbind(measure="TIB",glmerAn(long=EMA,wide=DEMOS,resp="TIB",fix.eff=predictors,ran.eff=ran.eff,modelType=c("GLMER"),
                                           mc.predictors=mc.predictors,gmc.predictors="BMI",
                                           outputs="key.results",key.predictor=key,key.model=key,messages=FALSE)) }

# computing key results for the following sleep outcomes
for(sleepVar in sleepVars){
  for(i in 1:length(diaryVars)){
    # selecting predictors (up to model M4)
    nd <- paste(substr(diaryVars[i],1,1),"nd",sep=".") # selecting next day diary ratings
    predictors <- c(predSelect(sleepVar=sleepVar),diaryVars[i],nd,"insomnia",paste(diaryVars[i],"insomnia",sep=":"))
    # removing random slopes for those models showing convergence problems
    if(sleepVar=="deep.p" | (diaryVars[i]=="stress" & sleepVar%in%c("rem.p","WakeUp.num","HR_NREM","HR_REM")) |
       (diaryVars[i]=="worry" & sleepVar%in%c("SE","light.p","deep.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="mood") & sleepVar%in%c("TST","WASO","SE","deep.p","WakeUp.num","HR_REM","rem.p","HR_NREM") |
       (diaryVars[i]=="PsyDist" & sleepVar%in%c("deep.p","rem.p","HR_NREM","HR_REM")) |
       (diaryVars[i]=="fs.w" & sleepVar%in%c("WASO.SSDc","HR_NREM","HR_REM"))){ ran.eff <- "(1|ID)"
       } else { ran.eff <- paste("(",diaryVars[i],".mc|ID)",sep="") }
    key <- paste(diaryVars[i],".mc:insomnia",sep="")
    if(diaryVars[i]=="fs.w"){ mc.predictors <- c("SO.num","TotalSteps1000") # mean-centered predictors
      ran.eff <- gsub(".mc","",ran.eff)
      key <- gsub(".mc","",key) } else { mc.predictors <- c("SO.num","TotalSteps1000",diaryVars[i],nd) }
    # selecting family distribution
    if(grepl("SSD",sleepVar)){ fam <- c("gamma","log") }else{ fam <- c("normal","identity") }
    
    # updating results
    res2[[i]] <- rbind(res2[[i]],cbind(measure=sleepVar,
                               glmerAn(long=EMA,wide=DEMOS,resp=sleepVar,fix.eff=predictors,ran.eff=ran.eff,nAGQ=0,
                               modelType=c("GLMER"), mc.predictors=mc.predictors,gmc.predictors="BMI",
                               family=fam[1],link=fam[2],outputs="key.results",key.predictor=key,key.model=key,messages=FALSE))) }}
# plotting robustness check
for(i in 1:length(res)){
  res2[[i]]$robCheck <- "lateResp"
  RES.int[[i]] <- rbind(RES.int[[i]],res2[[i]])
  print(key.resPlot(RES.int[[i]][RES.int[[i]]$robCheck%in%c("Original","lateResp"),],robCheck = "robCheck") + 
          ggtitle(paste("Interactive effect insomnia:",diaryVars[i],sep=""))) }
```

<br>

*Comments:*

- results are **overall consistent** with the main analyses

- the only difference is that with the removal of **lateResp** the interaction between `insomnia` and `mood` on `WASO.SSDc`, and that between `insomnia` and `PsyDist` on `HR_NREM` become **substantial**

- in contrast, the interaction with `worry` on `rem.p` is strongly diminished, becoming not substantial

<br>

### 1.6.7. Summary of results {.tabset .tabset-fade .tabset-pills}

Here, we summarize the results from all robustness checks. The figure below shows the t-values associated with the group differences between insomnia and controls for each sleep outcome, by considering either model M2 (main effect of `insomnia`) or model M3 (main effect of `insomnia` and `sex`) when `sex` differences were substantial (i.e., `HR_NREM` and `HR_REM`). The figure uses the following color code:

- **substantial relationships** (i.e., significant LRT, Aw higher than previous models, ***AND*** |t| > 1.96 ) are shown in **green**
    
- those showing a **|t| > 1.96** but nonsignificant LRT ***OR*** lower Aw than the previous model are shown in **light green** (lime)

- those showing a **|t| > 1.96** but both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **yellow**
    
- those showing a **|t| < 1.96** and either a nonsignificant LRT ***OR*** a lower Aw than the previous models are shown in **orange**
    
- those showing a **|t| < 1.96** and both nonsignificant LRT ***AND*** lower Aw than the previous models are shown in **red**

<br>

The robustness checks are separately visualized for each effect of interest.

#### PREVIOUS DAY 
```{r,fig.width=12,fig.height=5}
# stress
key.resPlot(RES.pd[[1]],robCheck = "robCheck")

# worry
key.resPlot(RES.pd[[2]],robCheck = "robCheck")

# mood
key.resPlot(RES.pd[[3]],robCheck = "robCheck")

# PsyDist
key.resPlot(RES.pd[[4]],robCheck = "robCheck")

# fs
key.resPlot(RES.pd[[5]],robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses (especially on `s.archit` and `s.variab`) are **highly consistent** across the robustness checks

- the **most consistent effects** are those of `stress`, `worry`, and `PsyDist` on `TIB`, `TST`, and `WakeUp.num`, in addition to the negative relationship between `SO.num` and both `mood` and `PsyDist`, and that between `WASO` and both `worry` and `PsyDist`

- the positive relationship between `stress` and `HR_REM` is also relatively **consistent**, but diminished by the exclusion of **lateResp** and by the use of the **gamma** distribution

- **lower consistency** is shown by the relationship between `mood` and `TIB` (not substantial in 2 out of 4 robustness checks), and that between `worry` and `SO.num` (not substantial in 2 out of 4)

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, indicating **consistent negative relationships** between diary ratings and `TIB`, `TST`, `WASO`, `SO.num`, and `WakeUp.num`, in addition to a positive relationship between `stress` and `HR_REM`.

<br>

#### NEXT DAY 
```{r,fig.width=12,fig.height=5}
# stress
key.resPlot(RES.nd[[1]],robCheck = "robCheck")

# worry
key.resPlot(RES.nd[[2]],robCheck = "robCheck")

# mood
key.resPlot(RES.nd[[3]],robCheck = "robCheck")

# PsyDist
key.resPlot(RES.nd[[4]],robCheck = "robCheck")

# fs
key.resPlot(RES.nd[[5]],robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses (especially on `s.archit` and `s.variab`) are **highly consistent** across the robustness checks

- the **most consistent effects** are those of **next day** `stress` on `TIB`, `TST`, `WASO`, and `WakeUp.num`, those of `mood` on both `HR_NREM` and `HR_REM`, and those of all diary ratings on `Wake.up.num.SSD`

- **lower consistency** is shown by the relationship between `mood` and `TST.SSD` (not substantial in 2 out of 5 robustness checks), and that between `PsyDist` and `TIB.SSD` (not substantial in 2 out of 5)

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, indicating **consistent negative relationships** between **next day** `stress` and `TIB`, `TST`, `WASO`, and `WakeUp.num`, between `mood` and both `HR_NREM` and `HR_REM`, and between `WakeUp.num.SSD` and all diary ratings.

<br>

#### INTERACTION
```{r,fig.width=12,fig.height=6}
# stress
key.resPlot(RES.int[[1]],robCheck = "robCheck")

# worry
key.resPlot(RES.int[[2]],robCheck = "robCheck")

# mood
key.resPlot(RES.int[[3]],robCheck = "robCheck")

# PsyDist
key.resPlot(RES.int[[4]],robCheck = "robCheck")

# fs
key.resPlot(RES.int[[5]],robCheck = "robCheck")
```

<br>

*Comments:*

- the **null results** observed from the main analyses are **highly consistent** across the robustness checks

- the interaction between `stress` and `insomnia` on `HR_NREM` is **quite consistent** (substantial in 6 out of 7 robustness check)

- **lower consistency** is shown by the interaction between *insomnia* and `worry` (substantial in 3 out of 7 robustness checks) and that with `fs` (substantial in 3 out of 7 robustness checks)

<br>

In conclusion, the results obtained with the main analyses are **quite robust**, indicating **consistent cross-level interactions** between `insomnia` **and** `stress` on `HR_NREM`

<br>

# 2. Final outputs

Here, we summarize the results obtained from the regression analyses conducted above.

<br>

## 2.1. Sleep characterization

First, we aimed at characterizing sleep patterns in adolescents with and without insomnia. This was done by specifying models in which 
`s.archit`, `s.timing`, `s.variab`, and `s.auton` variables were predicted by (1) meaningful covariates (`SO.num`, `TotalSteps1000`, `weekday`, and `BMI`), (2) `insomnia`, (3) participantsâ `sex`, and (4) the **interaction** between `sex` and `insomnia`.

<br>

The results indicated: 

- **no substantial relationships between** `insomnia` **and any** `s.archit` **or** `s.timing` **variable**

- most `s.archit` (i.e., `TIB`, `TST`, `WASO`) and `s.timing` (i.e., `WakeUp.num`) variables were negatively predicted by `SO.num` (whereas it positively predicted `SE`) and showed higher values during weekend compared to weekdays (also affecting `SO.num`), with boys showing shorter `TIB` and `TST`, and later `SO.num` than girls

- `deep.p` and `rem.p` variables were only predicted by `SO.num` (positively associated with %`deep` and negatively associated with %`rem` sleep)

- `BMI` negatively predicted `light.p`, `SO.num`, and `WakeUp.num`

<br>

- some `s.variab` variables, namely `TIB.SSD`, `TST.SSD`, and `SO.SSD` were **lower in** `insomnia` than in controls, although the results for `SO.SSD` showed some inconsistency after the removal of participants with extreme missing data and the inclusion of `covid19` as a further predictor

- all `s.varab` variables were higher in weekend days, with some (`TIB.SSD`, `TST.SSD`) being positively predicted by `BMI`, and others (`WASO.SSD`) being negatively predicted by `SO.num`

<br>

- **both** `s.auton` variables were substantially predicted by the **interaction between** `insomnia` **and** `sex`, with **lower HR in female insomnia than female controls** but not between males

- in contrast, the main effect of `insomnia` was less substantial and consistent

- both `s.auton` variables were positively predicted by `TotalSteps1000`, while `HR_NREM` was positively predicted by `weekday.sleep` and `BMI`, whereas `HR_REM` was positively precited by `SO.num`

<br>

**Conclusion:**

Overall, our results **do not support** a distinction between insomnia and controls in terms of objective sleep parameters, with the exception of some distinctions in terms of **night-to-night variability**.

<br>

Here, we visualize representative examples of the most substantial and consistent results.
```{r fig.width=7,fig.height=4.5,warning=FALSE,message=FALSE}
predictors <- c("TotalSteps1000","weekday.sleep","BMI","insomnia")
dat <- ema
dat$insomnia <- as.factor(gsub("1","Insomnia",gsub("0","Controls",dat$insomnia)))
dat$sex <- factor(gsub("M","Boys",gsub("F","Girls",dat$sex)),levels=c("Girls","Boys"))
library(gridExtra)
p <- grid.arrange(glmerAn(long=dat,wide=demos,resp="TST.SSDc",fix.eff=c("SO.num",predictors),modelType="GLMER",
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",family="gamma",link="log",
                       outputs="plotEff",plot.model="insomnia",plot.pred="insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=1.3) + ggtitle("") + labs(x="",y=expression(TST~SSD~(min^2))),
               glmerAn(long=dat,wide=demos,resp="SO.num.SSDc",fix.eff=predictors,modelType="GLMER",family="gamma",link="log",
                       mc.predictors=c("TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",
                       outputs="plotEff",plot.model="insomnia",plot.pred="insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=1.3) + ggtitle("") + labs(x="",y=expression(SO~SSD~(hours^2))),
               glmerAn(long=dat,wide=demos,resp="HR_NREM",fix.eff=c("SO.num",predictors,"sex","sex:insomnia"),modelType="GLMER",
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=0.5) + ggtitle("") + labs(x="",y=expression(NREM~HR~(bpm))) +
                 theme(legend.title=element_blank(),legend.position=c(0.65,0.85),
                       legend.direction = "horizontal"),
               glmerAn(long=dat,wide=demos,resp="HR_REM",fix.eff=c("SO.num",predictors,"sex","sex:insomnia"),modelType="GLMER",
                       mc.predictors=c("SO.num","TotalSteps1000"),gmc.predictors="BMI",ran.eff="(1|ID)",
                       outputs="plotEff",plot.model="sex:insomnia",plot.pred="sex:insomnia",messages=FALSE,return.plot=TRUE,
                       dot.size=3,dodge=0.5) + ggtitle("") + labs(x="",y=expression(REM~HR~(bpm))) + 
                 theme(legend.title=element_blank(),legend.position=c(0.65,0.85),
                       legend.direction = "horizontal"),nrow=2)
ggsave(filename="RESULTS/Figure3.tiff",plot=p,dpi=500) # saving figure for the manuscript
```



<br>

## 2.2. Diary ratings

Second, we aimed at characterizing the patterns of `stress`, `worry`, and `mood` among adolescents with and without insomnia. This was done by specifying models predicting diary ratings by (1) meaningful covariates (`TotalSteps1000` and `weekday`), (2) the `insomnia` group, (3) participants' `sex`, and (4) the interaction between `sex` and `insomnia` groups.

<br>

The results indicated: 

- **no substantial relationships between** `insomnia` **and any diary rating**

- however, a better examination of the three `insomnia.group` subgroups revealed a main effect of insomnia, with **higher** `stress`, `worry`, and `fs` **in the** `DSM.insomnia` **group compared to the control group**, and no difference between the partial DSM and the control group; such subgroup differences were **consistent** across all robustness checks

- in addition, lower `stress`, `worry`, and bad `mood` were predicted by `weekend` days, whereas higher-than-usual `TotalSteps1000` predicted lower `stress` and bad `mood`

<br>

**Conclusion:**

Overall, our results consistently showed **higher** `stress`, `worry`, and `fs` in the full `DSM.insomnia` subgroup compared to the control group, but **no differences when the two subgroup are joined**

<br>

## 2.3. Sleep by diary ratings

Third, we aimed at evaluating the direct and bidirectional relationship between sleep and psychological distress, and the interaction between the latter and insomnia. This was done by specifying models predicting `s.archit`, `s.timing`, `s.variab`, and `s.auton` variables measured at day `i` by the selected model in step 1 in addition to (1) `PsyDist` measured at day `i`, and (2) `PsyDist` measured at day `i+1`, as well as (3) the interaction between `PsyDist` and `insomnia`.

<br>

### 2.3.1. Previous day

The results indicated:

- substantial **negative relationships** were between some `sleep.archit` and `sleep.timing` variables (i.e., `TIB`, `TST`, and `WakeUp.num`) and `stress`, `worry`, and `PsyDist`, whereas **earlier** `SO.num` was substantially predicted by `worry` and `mood`, and shorter `WASO` was only predicted by previous day `worry` and `PsyDist`

- a **positive relationship** was also found between **previous day** `stress` ratings and `HR_REM`

- in contrast, **no substantial relationships** were found between previous diary ratings and both **sleep stages** and `s.variab` outcomes

- overall, the results obtained for previous day single item ratings were **consistent with those found for aggregate ratings**, and across the **robustness checks**, with the exception of the relationships found for `mood` (insubstantial in 2 to 3 out of 4 robustness checks) and that found between `worry` and `SO` (insubstantial in 2 out of 4 checks)

<br>

Here, we generate the outputs of representative examples of sleep outcomes only predicted by previous day ratings, that is the models predicting `TIB`, `TST`, and `WakeUp.num` by `worry`.
```{r fig.width=7,fig.height=5,warning=FALSE,message=FALSE}
# preparing data
dat <- ema[!is.na(ema$TIB) & !is.na(ema$worry),] # removing incomplete cases
demos$SO.num.cm <- summarySE(dat,measurevar="SO.num",groupvars="ID",na.rm=TRUE)[,3] # worry & SO individual means
demos$worry.cm <- summarySE(dat,measurevar="worry",groupvars="ID",na.rm=TRUE)[,3]
demos$BMI.gmc <- demos$BMI - mean(demos$BMI) # grand-mean centering BMI
dat <- plyr::join(dat,demos[,c("ID","worry.cm","SO.num.cm","BMI.gmc")],by="ID",type="left")
dat$SO.num.mc <- dat$SO.num - dat$SO.num.cm # mean-centering worry & SO
dat$worry.mc <- dat$worry - dat$worry.cm

# modeling
fit1 <- lmer(TIB ~ SO.num.mc + weekday.sleep + worry.mc + (worry.mc|ID),data=dat,REML=FALSE) # TIB by worry
fit2 <- lmer(TST ~ SO.num.mc + weekday.sleep + worry.mc + (worry.mc|ID),data=dat,REML=FALSE) # TST by worry
fit3 <- lmer(WakeUp.num ~ SO.num.mc + weekday.sleep + BMI.gmc + worry.mc + (worry.mc|ID),data=dat,REML=FALSE) # WakeUp.num by worry

# showing models
tab_model(fit1,fit2,fit3,
          show.p=FALSE,show.stat=FALSE,show.icc=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
          string.est="B (SE)")

# computing profile-likelihood CI
confint.merMod(fit1,method="profile")
confint.merMod(fit2,method="profile")
confint.merMod(fit3,method="profile")
```

<br>

### 2.3.2. Next day

The results indicated:

- some `s.archit` and `s.timing` variables (i.e., `TIB`, `TST`, and `WakeUp.num`) were **bidirectionally associated with** `stress`, with higher-than-usual previous day and next day `stress` predicting shorter `TIB` and `TST`, and earlier `WakeUp` time

- `WASO` was only (negatively) related to **next day** `stress` but not to previous day `stress`; similarly, `HR_NREM` and `HR_REM` were positively associated with **next day** `mood` but not with previous day `mood`

- `WakeUp.num.SSD` was negatively associated with **all next day diary ratings**, whereas relationships between next day ratings and other `s.variab` outcomes were less consistent

- overall, these results were **consistent across the robustness checks** but **not replicated by the aggregate diary ratings**

<br>

### 2.3.3. Interaction

The results indicated:

- a substantial **interaction** between `insomnnia` and **previous day ratings** was only found for `stress` on `HR_NREM`, such that `stress` predicted higher `HR_NREM` in the insomnia but not the control group; this result was **overall consistent** across the robustness checks, becoming not substantial only when considering the `insomnia.group`

- a similar but **less consistent** result was found for `worry` and `fs`

- none of the other diary ratings and sleep outcomes showed substantial interactions, consistently across the robustness checks

<br>

Here, we generate the outputs of representative examples of sleep outcomes predicted by the **next day** and the **interactive term**, that is the models predicting `TST`, `WakeUp.num` and `HR_NREM` by `stress`.
```{r fig.width=7,fig.height=5,warning=FALSE,message=FALSE}
# preparing data
dat1 <- ema[!is.na(ema$TST) & !is.na(ema$stress) & !is.na(ema$s.nd),] # removing incomplete cases
datwide <- summarySE(dat1,measurevar="stress",groupvars="ID",na.rm=TRUE)[,c(1,3)] # ind means
colnames(datwide)[2] <- "stress.cm"
datwide$s.nd.cm <- summarySE(dat1,measurevar="s.nd",groupvars="ID",na.rm=TRUE)[,3] # individual means
datwide <- plyr::join(datwide,demos[,c("ID","SO.num.cm","BMI.gmc")],by="ID",type="left")
dat1 <- plyr::join(dat1,datwide[,c("ID","stress.cm","s.nd.cm","SO.num.cm","BMI.gmc")],by="ID",type="left")
dat1$SO.num.mc <- dat1$SO.num - dat1$SO.num.cm # mean-centering SO and stress
dat1$stress.mc <- dat1$stress - dat1$stress.cm
dat1$s.nd.mc <- dat1$s.nd - dat1$s.nd.cm
# same operation for HR_NREM
dat2 <- ema[!is.na(ema$HR_NREM) & !is.na(ema$stress) & !is.na(ema$s.nd) & !is.na(ema$TotalSteps1000),]
datwide <- datwide[datwide$ID%in%dat2$ID,]
datwide$TotalSteps1000.cm <- summarySE(dat2,measurevar="TotalSteps1000",groupvars="ID",na.rm=TRUE)[,3] 
dat2 <- plyr::join(dat2,datwide[,c("ID","stress.cm","s.nd.cm","SO.num.cm","TotalSteps1000.cm","BMI.gmc")],
                   by="ID",type="left")
dat2$SO.num.mc <- dat2$SO.num - dat2$SO.num.cm # mean-centering SO and stress
dat2$TotalSteps1000.mc <- dat2$TotalSteps1000 - dat2$TotalSteps1000.cm
dat2$stress.mc <- dat2$stress - dat2$stress.cm
dat2$s.nd.mc <- dat2$s.nd - dat2$s.nd.cm

# modeling
fit1 <- lmer(TST ~ SO.num.mc + weekday.sleep + stress.mc + s.nd.mc + (stress.mc|ID), # TST 
             data=dat1,REML=FALSE) 
fit2 <- lmer(WakeUp.num ~ SO.num.mc + weekday.sleep + BMI.gmc + stress.mc + s.nd.mc + (stress.mc|ID), # WakeUp.num
             data=dat1,REML=FALSE)
fit3 <- lmer(HR_NREM ~ TotalSteps1000.mc + weekday.sleep + BMI.gmc + sex + insomnia + # HR_NREM
               stress.mc + s.nd.mc + stress.mc:insomnia + (stress.mc|ID),
             data=dat2,REML=FALSE)

# showing models
tab_model(fit1,fit2,fit3,
          show.p=FALSE,show.stat=FALSE,show.icc=FALSE,show.r2=FALSE,show.se=TRUE,collapse.se=TRUE,
          string.est="B (SE)")

# computing profile-likelihood CI
confint.merMod(fit1,method="profile")
confint.merMod(fit2,method="profile")
confint.merMod(fit3,method="profile")
```

<br>

# References {#ref}

- Cranford, J. A., Shrout, P. E., Iida, M., Rafaeli, E., Yip, T., & Bolger, N. (2006). A Procedure for Evaluating Sensitivity to Within-Person Change: Can Mood Measures in Diary Studies Detect Change Reliably? *Personality and Social Psychology Bulletin*, 32(7), 917â929. https://doi.org/10.1177/0146167206287721

- Geldhof, G. J., Preacher, K. J., & Zyphur, M. J. (2014). Reliability estimation in a multilevel confirmatory factor analysis framework. *Psychological Methods*, 19(1), 72â91. https://doi.org/10.1037/a0032138

- Green, J. A. (2021). Too many zeros and/or highly skewed? A tutorial on modelling health behaviour as count data with Poisson and negative binomial regression. *Health Psychology and Behavioral Medicine, 9*(1), 436-455. https://doi.org/10.1080/21642850.2021.1920416

- Hox, J. J. (2010). *Multilevel Analysis: Techniques and Applications (2nd ed.)*. Routledge.

- Jak, S., & Jorgensen, T. D. (2017). Relating Measurement Invariance, Cross-Level Invariance, and Multilevel Reliability. *Frontiers in Psychology*, 8(OCT), 1â9. https://doi.org/10.3389/fpsyg.2017.01640

- Menghini, L., Yuksel, D., Goldstone, A., Baker, F. C., & de Zambotti, M. (2021). Performance of Fitbit Charge 3 against polysomnography in measuring sleep in adolescent boys and girls. *Chronobiology International*, 38(7):1010-1022. https://doi.org/10.1080/07420528.2021.1903481

- Ng, V. K., & Cribbie, R. A. (2017). Using the gamma generalized linear model for modeling continuous, skewed and heteroscedastic outcomes in psychology. *Current Psychology, 36*(2), 225-235. https://doi.org/10.1007/s12144-015-9404-0

<br>

## R packages
